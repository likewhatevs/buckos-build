name: Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  test:
    name: build & test
    runs-on: large
    steps:
      - uses: actions/checkout@v4
        with:
          clean: false
      - name: Install buck2
        run: |
          mkdir -p "$HOME/.local/bin"
          curl -sL https://github.com/facebook/buck2/releases/download/latest/buck2-x86_64-unknown-linux-gnu.zst \
            | zstd -d -f -o "$HOME/.local/bin/buck2"
          chmod +x "$HOME/.local/bin/buck2"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Run all checks
        run: |
          buck2 targets //... &&
          failed=0
          for bxl in tests/graph/test_*.bxl; do
            name=$(basename "$bxl" .bxl)
            echo "::group::$name"
            buck2 bxl "//tests/graph/${name}.bxl:${name}" || failed=1
            echo "::endgroup::"
          done
          [ "$failed" -eq 0 ] &&
          buck2 test //tests: &&
          buck2 build //packages/linux/system:buckos-iso --out buckos.iso &&
          buck2 build //tc/bootstrap:seed-export --out seed-toolchain.tar.zst
      - uses: actions/upload-artifact@v4
        with:
          name: buckos-iso
          path: buckos.iso
      - uses: actions/upload-artifact@v4
        with:
          name: seed-toolchain
          path: seed-toolchain.tar.zst
