name: Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  test:
    name: build & test
    runs-on: [self-hosted, bigly]
    steps:
      - uses: actions/checkout@v4
        with:
          clean: false
      - uses: ./.github/actions/ci-setup
      - name: Run all checks
        run: |
          buck2 targets //... &&
          failed=0
          for bxl in tests/graph/test_*.bxl; do
            name=$(basename "$bxl" .bxl)
            echo "::group::$name"
            buck2 bxl "//tests/graph/${name}.bxl:${name}" || failed=1
            echo "::endgroup::"
          done
          [ "$failed" -eq 0 ] &&
          buck2 test //tests:
