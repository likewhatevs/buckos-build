name: Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  targets:
    name: graph parse
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/ci-setup
      - run: buck2 -c "cell_aliases.${{ secrets.PRELUDE_0 }}=buckos" -c "cell_aliases.${{ secrets.PRELUDE_1 }}=buckos" -c "cell_aliases.${{ secrets.PRELUDE_2 }}=buckos" targets //...

  bxl:
    name: bxl graph tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/ci-setup
      - name: Run BXL tests
        run: |
          failed=0
          for bxl in tests/graph/test_*.bxl; do
            name=$(basename "$bxl" .bxl)
            echo "::group::$name"
            buck2 bxl -c cell_aliases.${{ secrets.PRELUDE_0 }}=buckos -c cell_aliases.${{ secrets.PRELUDE_1 }}=buckos -c cell_aliases.${{ secrets.PRELUDE_2 }}=buckos "//tests/graph/${name}.bxl:${name}" || failed=1
            echo "::endgroup::"
          done
          exit $failed

  test:
    name: buck2 test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/ci-setup
      - run: "buck2 test -c cell_aliases.${{ secrets.PRELUDE_0 }}=buckos -c cell_aliases.${{ secrets.PRELUDE_1 }}=buckos -c cell_aliases.${{ secrets.PRELUDE_2 }}=buckos //tests:"

  required:
    name: required-checks
    runs-on: ubuntu-latest
    if: always()
    needs: [targets, bxl, test]
    steps:
      - run: |
          results=("${{ needs.targets.result }}" "${{ needs.bxl.result }}" "${{ needs.test.result }}")
          names=(targets bxl test)
          for i in "${!names[@]}"; do
            if [[ "${results[$i]}" != "success" ]]; then
              echo "::error::${names[$i]} failed: ${results[$i]}"
              exit 1
            fi
          done
