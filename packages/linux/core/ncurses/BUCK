load("@root//defs:package_defs.bzl", "autotools_package")
load("@root//defs:use_flags.bzl", "set_use_flags")

# ncurses - official tarball includes pre-generated configure
autotools_package(
    name = "ncurses",
    # No autoreconf needed - tarball has pre-generated configure
    bdepend = [],
    src_prepare = "",
    version = "6.4",
    src_uri = "https://mirrors.kernel.org/gnu/ncurses/ncurses-6.4.tar.gz",
    sha256 = "6931283d9ac87c5073f30b6290c4c75f21632bb4fc3603ac8100812bed248159",
    signature_sha256 = "243038aaef761f362cba773ad463dda8758899ff9f6530158db1972a62d0342f",
    signature_required=False,
    description = "Libraries for terminal handling",
    homepage = "https://invisible-island.net/ncurses/",
    license = "MIT",

    # Bootstrap toolchain is now included by default for all packages

    # USE flags this package supports
    iuse = [
        "ada",
        "cxx",
        "debug",
        "gpm",
        "minimal",
        "profile",
        "stack-realign",
        "static-libs",
        "threads",
        "tinfo",
        "trace",
        "unicode",
    ],

    # Default USE flags
    use_defaults = ["unicode"],  # cxx disabled due to deprecated C++ headers

    # Conditional configure arguments
    use_configure = {
        "-ada": "--without-ada",
        "-cxx": "--without-cxx",
        "-debug": "--without-debug",
        "-gpm": "--disable-gpm",
        "-minimal": "--disable-minimal",
        "-profile": "--disable-profile",
        "-stack-realign": "--disable-stack-realign",
        "-static-libs": "--without-normal",
        "-threads": "--without-pthread",
        "-tinfo": "--disable-tinfo",
        "-trace": "--disable-trace",
        "-unicode": "--disable-widec",
        "ada": "--with-ada",
        "cxx": "--with-cxx",
        "debug": "--with-debug",
        "gpm": "--enable-gpm",
        "minimal": "--enable-minimal",
        "profile": "--enable-profile",
        "stack-realign": "--enable-stack-realign",
        "static-libs": "--with-normal",
        "threads": "--with-pthread",
        "tinfo": "--enable-tinfo",
        "trace": "--enable-trace",
        "unicode": "--enable-widec",
    },

    # Base configure arguments (always applied)
    configure_args = [
        "--with-shared",
        "--enable-pc-files",
        "--with-pkg-config-libdir=/usr/lib/pkgconfig",
        # Cross-compilation: ncurses needs a native host compiler for tools (tic, infocmp)
        # Note: values must not contain spaces - EXTRA_ECONF is word-split by the shell
        "--with-build-cc=gcc",
        "--with-build-cflags=-O2",
        "--with-build-ldflags=-L/usr/lib64",
        # NOTE: --with-termlib is disabled because it causes library dependency issues
        # when RPATH is not used. Applications linking against libncursesw also need
        # to explicitly link against libtinfow, which many build systems don't handle.
        # Instead, we include all symbols in libncursesw for simplicity.
        # "--with-termlib",
    ],

    post_install = """
# Create compatibility symlinks for wide-character libraries
cd "$DESTDIR/usr/lib"
for lib in ncurses form panel menu; do
    ln -sf lib${lib}w.so lib${lib}.so
    ln -sf lib${lib}w.a lib${lib}.a
done
ln -sf libncursesw.so libcurses.so

# Create libtinfo symlinks pointing to libncurses (since we don't use --with-termlib)
ln -sf libncursesw.so libtinfo.so
ln -sf libncursesw.so libtinfow.so

# Create pkg-config symlinks for non-wide versions
if [ -d "$DESTDIR/usr/lib/pkgconfig" ]; then
    cd "$DESTDIR/usr/lib/pkgconfig"
    for lib in ncurses form panel menu; do
        if [ -f "${lib}w.pc" ]; then
            ln -sf ${lib}w.pc ${lib}.pc
        fi
    done
    # Create tinfo.pc symlink pointing to ncurses (since we don't use --with-termlib)
    if [ -f "ncursesw.pc" ]; then
        ln -sf ncursesw.pc tinfo.pc
        ln -sf ncursesw.pc tinfow.pc
    fi
fi

# Also create symlinks in lib64 if it exists
if [ -d "$DESTDIR/usr/lib64" ]; then
    cd "$DESTDIR/usr/lib64"
    for lib in ncurses form panel menu; do
        if [ -f "lib${lib}w.so" ]; then
            ln -sf lib${lib}w.so lib${lib}.so
        fi
        if [ -f "lib${lib}w.so.6" ]; then
            ln -sf lib${lib}w.so.6 lib${lib}.so.6
        fi
        if [ -f "lib${lib}w.a" ]; then
            ln -sf lib${lib}w.a lib${lib}.a
        fi
    done
    [ -f libncursesw.so ] && ln -sf libncursesw.so libcurses.so

    # Create libtinfo symlinks (compatibility)
    ln -sf libncursesw.so libtinfo.so
    ln -sf libncursesw.so libtinfow.so
    [ -f libncursesw.so.6 ] && ln -sf libncursesw.so.6 libtinfo.so.6
    [ -f libncursesw.so.6 ] && ln -sf libncursesw.so.6 libtinfow.so.6

    # Create pkg-config symlinks in lib64/pkgconfig if it exists
    if [ -d pkgconfig ]; then
        cd pkgconfig
        for lib in ncurses form panel menu; do
            if [ -f "${lib}w.pc" ]; then
                ln -sf ${lib}w.pc ${lib}.pc
            fi
        done
        if [ -f "ncursesw.pc" ]; then
            ln -sf ncursesw.pc tinfo.pc
            ln -sf ncursesw.pc tinfow.pc
        fi
    fi
fi
""",
    visibility = ["PUBLIC"],
)
