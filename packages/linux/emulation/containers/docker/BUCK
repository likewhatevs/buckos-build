load("@root//defs:package_defs.bzl", "download_source", "autotools_package", "ebuild_package")
load("@root//defs:use_flags.bzl", "set_use_flags")

# Docker CLI
download_source(
    name = "docker-cli-src",
    src_uri = "https://github.com/docker/cli/archive/refs/tags/v27.3.1.tar.gz",
    sha256 = "df7d44387166d90954e290dfbe0a278649bf71d0e89933615bdc0757580b68e4",
    signature_required = False,
)

# USE flags: See use_flags.bzl for available flags

autotools_package(
    name = "docker-cli",
    bdepend = [
        "dev-tools//build-systems/autoconf:autoconf",
        "dev-tools//build-systems/automake:automake",
        "dev-tools//build-systems/libtool:libtool",
    ],
    src_prepare = """
autoreconf -fi
""",
    source = ":docker-cli-src",
    iuse = ["hardened", "selinux"],
    use_configure = {
        "-hardened": "--disable-hardening",
        "-selinux": "--disable-selinux",
        "hardened": "--enable-hardening",
        "selinux": "--enable-selinux",
    },
    version = "27.3.1",
    description = "Docker CLI for interacting with Docker Engine",
    homepage = "https://www.docker.com/",
    license = "Apache-2.0",
    env = {
        "CGO_ENABLED": "0",
        "GO111MODULE": "on",
        "VERSION": "27.3.1",
        "GITCOMMIT": "ce12230",
        "BUILDTIME": "2024-01-01T00:00:00Z",
    },
    pre_configure = """
# Build Docker CLI
make dynbinary
    """,
    post_install = """
#!/bin/bash
set -e

# Install docker binary
mkdir -p "$DESTDIR/usr/bin"
install -m 0755 build/docker "$DESTDIR/usr/bin/docker"

# Install shell completions
mkdir -p "$DESTDIR/usr/share/bash-completion/completions"
mkdir -p "$DESTDIR/usr/share/zsh/site-functions"
mkdir -p "$DESTDIR/usr/share/fish/vendor_completions.d"

install -m 0644 contrib/completion/bash/docker "$DESTDIR/usr/share/bash-completion/completions/"
install -m 0644 contrib/completion/zsh/_docker "$DESTDIR/usr/share/zsh/site-functions/"
install -m 0644 contrib/completion/fish/docker.fish "$DESTDIR/usr/share/fish/vendor_completions.d/"
    """,
    deps = [
        "lang//go:go",
    ],
    visibility = ["PUBLIC"],
)

# Docker Engine (dockerd)
download_source(
    name = "docker-engine-src",
    src_uri = "https://github.com/moby/moby/archive/refs/tags/v27.3.1.tar.gz",
    sha256 = "d18208d9e0b6421307342cdef266193984c97c87177b9262b1113e6e9e7e020e",
    signature_required = False,
)

# USE flags: See use_flags.bzl for available flags

autotools_package(
    name = "docker-engine",
    bdepend = [
        "dev-tools//build-systems/autoconf:autoconf",
        "dev-tools//build-systems/automake:automake",
        "dev-tools//build-systems/libtool:libtool",
    ],
    src_prepare = """
autoreconf -fi
""",
    source = ":docker-engine-src",
    version = "27.3.1",
    description = "Docker Engine daemon and runtime",
    homepage = "https://www.docker.com/",
    license = "Apache-2.0",
    env = {
        "CGO_ENABLED": "1",
        "GO111MODULE": "on",
        "VERSION": "27.3.1",
        "DOCKER_GITCOMMIT": "ce12230",
        "DOCKER_BUILDTAGS": "seccomp apparmor",
    },
    pre_configure = """
# Build Docker daemon
DOCKER_BUILDTAGS='seccomp apparmor' hack/make.sh dynbinary
    """,
    post_install = """
#!/bin/bash
set -e

# Install binaries
mkdir -p "$DESTDIR/usr/bin"
install -m 0755 bundles/dynbinary-daemon/dockerd "$DESTDIR/usr/bin/"
install -m 0755 bundles/dynbinary-daemon/docker-proxy "$DESTDIR/usr/bin/"

# Install systemd service
mkdir -p "$DESTDIR/usr/lib/systemd/system"
cat > "$DESTDIR/usr/lib/systemd/system/docker.service" << 'EOF'
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
Requires=docker.socket containerd.service

[Service]
Type=notify
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process
OOMScoreAdjust=-500

[Install]
WantedBy=multi-user.target
EOF

cat > "$DESTDIR/usr/lib/systemd/system/docker.socket" << 'EOF'
[Unit]
Description=Docker Socket for the API

[Socket]
ListenStream=/var/run/docker.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
EOF

# Create docker group sysusers config
mkdir -p "$DESTDIR/usr/lib/sysusers.d"
echo 'g docker - -' > "$DESTDIR/usr/lib/sysusers.d/docker.conf"
    """,
    deps = [
        "lang//go:go",
        "emulation//containers/containerd:containerd",
        "emulation//containers/runc:runc",
        "system//libs/ipc/libseccomp:libseccomp",
        "network//firewall/iptables:iptables",
    ],
    visibility = ["PUBLIC"],
)

# Docker Compose
download_source(
    name = "docker-compose-src",
    src_uri = "https://github.com/docker/compose/archive/refs/tags/v2.30.3.tar.gz",
    sha256 = "b9b6f45ccad892a3f9353a03b6bdf3f79ea15ee2076f98bf013ef1db40034378",
    signature_required = False,
)

# USE flags: See use_flags.bzl for available flags

autotools_package(
    name = "docker-compose",
    bdepend = [
        "dev-tools//build-systems/autoconf:autoconf",
        "dev-tools//build-systems/automake:automake",
        "dev-tools//build-systems/libtool:libtool",
    ],
    src_prepare = """
autoreconf -fi
""",
    source = ":docker-compose-src",
    version = "2.30.3",
    description = "Define and run multi-container Docker applications",
    homepage = "https://docs.docker.com/compose/",
    license = "Apache-2.0",
    env = {
        "CGO_ENABLED": "0",
        "GO111MODULE": "on",
    },
    pre_configure = """
make binary
    """,
    post_install = """
#!/bin/bash
set -e

# Install as docker plugin
mkdir -p "$DESTDIR/usr/lib/docker/cli-plugins"
install -m 0755 bin/docker-compose "$DESTDIR/usr/lib/docker/cli-plugins/"

# Also install as standalone binary
mkdir -p "$DESTDIR/usr/bin"
ln -sf /usr/lib/docker/cli-plugins/docker-compose "$DESTDIR/usr/bin/docker-compose"
    """,
    deps = [
        "lang//go:go",
    ],
    visibility = ["PUBLIC"],
)

# Docker Buildx
download_source(
    name = "docker-buildx-src",
    src_uri = "https://github.com/docker/buildx/archive/refs/tags/v0.18.0.tar.gz",
    sha256 = "a935cb2715a5054d918d40ef07cdd4a6465b20a755d466248718ab59fd41c334",
    signature_required = False,
)

# USE flags: See use_flags.bzl for available flags

ebuild_package(
    name = "docker-buildx",
    source = ":docker-buildx-src",
    version = "0.18.0",
    description = "Docker CLI plugin for extended build capabilities with BuildKit",
    homepage = "https://github.com/docker/buildx",
    license = "Apache-2.0",
    env = {
        "CGO_ENABLED": "0",
        "GO111MODULE": "on",
    },
    src_compile = """
#!/bin/bash
set -e

# Build docker-buildx using go build directly
# The hack/build script outputs to $OUT which causes path issues
CGO_ENABLED=0 go build -mod=vendor -trimpath \
    -ldflags "-X github.com/docker/buildx/version.Version=${PV} -X github.com/docker/buildx/version.Package=github.com/docker/buildx" \
    -o buildx-binary ./cmd/buildx
    """,
    src_install = """
#!/bin/bash
set -e

# Install as docker plugin
mkdir -p "$DESTDIR/usr/lib/docker/cli-plugins"
install -m 0755 buildx-binary "$DESTDIR/usr/lib/docker/cli-plugins/docker-buildx"
    """,
    bdepend = [
        "lang//go:go",
    ],
    visibility = ["PUBLIC"],
)
