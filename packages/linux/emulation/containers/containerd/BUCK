load("@root//defs:package_defs.bzl", "download_source", "autotools_package")
load("@root//defs:use_flags.bzl", "set_use_flags")

# containerd - Industry-standard container runtime
download_source(
    name = "containerd-src",
    src_uri = "https://github.com/containerd/containerd/archive/refs/tags/v1.7.23.tar.gz",
    sha256 = "393bfde8ca1766a0bca3441e18eddc3f5a5c8d97ef676bde0d6c9903e1b0ec0c",
    signature_required = False,
)

# USE flags: See use_flags.bzl for available flags

autotools_package(
    name = "containerd",
    source = ":containerd-src",
    iuse = [
        "apparmor",
        "btrfs",
        "cri",
        "device-mapper",
        "hardened",
        "seccomp",
        "selinux",
    ],
    use_configure = {
        "-apparmor": "--disable-apparmor",
        "-btrfs": "--disable-btrfs",
        "-cri": "--disable-cri",
        "-device-mapper": "--disable-device-mapper",
        "-hardened": "--disable-hardening",
        "-seccomp": "--disable-seccomp",
        "-selinux": "--disable-selinux",
        "apparmor": "--enable-apparmor",
        "btrfs": "--enable-btrfs",
        "cri": "--enable-cri",
        "device-mapper": "--enable-device-mapper",
        "hardened": "--enable-hardening",
        "seccomp": "--enable-seccomp",
        "selinux": "--enable-selinux",
    },
    version = "1.7.23",
    description = "Industry-standard container runtime with emphasis on simplicity and portability",
    homepage = "https://containerd.io/",
    license = "Apache-2.0",
    env = {
        "CGO_ENABLED": "1",
        "GO111MODULE": "on",
        "GOFLAGS": "-mod=vendor",
    },
    configure_args = [],
    pre_configure = """
# Build containerd
make BUILDTAGS='seccomp apparmor' binaries
    """,
    post_install = """
#!/bin/bash
set -e

# Install binaries
mkdir -p "$DESTDIR/usr/bin"
install -m 0755 bin/containerd "$DESTDIR/usr/bin/"
install -m 0755 bin/containerd-shim "$DESTDIR/usr/bin/"
install -m 0755 bin/containerd-shim-runc-v1 "$DESTDIR/usr/bin/"
install -m 0755 bin/containerd-shim-runc-v2 "$DESTDIR/usr/bin/"
install -m 0755 bin/ctr "$DESTDIR/usr/bin/"

# Install systemd service
mkdir -p "$DESTDIR/usr/lib/systemd/system"
cat > "$DESTDIR/usr/lib/systemd/system/containerd.service" << 'EOF'
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=1048576
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF

# Create default configuration
mkdir -p "$DESTDIR/etc/containerd"
containerd config default > "$DESTDIR/etc/containerd/config.toml" 2>/dev/null || true
    """,
    deps = [
        "lang//go:go",
        "emulation//containers/runc:runc",
        "system//libs/ipc/libseccomp:libseccomp",
    ],
    visibility = ["PUBLIC"],
)
