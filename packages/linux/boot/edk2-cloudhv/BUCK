load("//defs:package_defs.bzl", "make_package")

# EDK2 Cloud Hypervisor Firmware (CLOUDHV)
#
# UEFI firmware for Cloud Hypervisor.
# This provides full UEFI boot support for Cloud Hypervisor VMs,
# including Secure Boot capabilities.
#
# Build output: CLOUDHV.fd
# Install location: /usr/share/cloud-hypervisor/CLOUDHV.fd
#
# Note: EDK2 is a complex build that requires specific toolchain setup.
# This package builds only the CLOUDHV platform target.

make_package(
    name = "edk2-cloudhv",
    version = "202411",
    src_uri = "https://github.com/tianocore/edk2/archive/refs/tags/edk2-stable202411.tar.gz",
    sha256 = "741b48f0557a99e477cba42df58996b9bc7fab1bc7a61ab729a812dc6185e682",
    signature_required = False,
    description = "UEFI firmware for Cloud Hypervisor (EDK2 CLOUDHV)",
    homepage = "https://github.com/tianocore/edk2",
    license = "BSD-2-Clause",
    bdepend = [
        "//packages/linux/lang/python:python",
        "//packages/linux/dev-tools/nasm:nasm",
        "//packages/linux/dev-tools/acpica:iasl",
    ],
    # EDK2 requires submodule initialization and specific build setup
    src_unpack = """
# Extract source
tar xf "$DISTDIR/$A"
cd edk2-edk2-stable202411 || cd edk2-stable202411

# Initialize submodules for the build
# Note: In a real build, we'd need to handle submodules
# For now, we'll use prebuilt or handle this specially

# Set up EDK2 workspace
export WORKSPACE="$PWD"
export EDK_TOOLS_PATH="$WORKSPACE/BaseTools"
export PACKAGES_PATH="$WORKSPACE"
""",
    src_configure = """
# Build BaseTools first
cd BaseTools
make -j${MAKEOPTS:-$(nproc)}
cd ..

# Source edksetup.sh to set up the build environment
. edksetup.sh
""",
    src_compile = """
# Build the CLOUDHV platform
# This builds the UEFI firmware for Cloud Hypervisor
export WORKSPACE="$PWD"
export EDK_TOOLS_PATH="$WORKSPACE/BaseTools"
export PACKAGES_PATH="$WORKSPACE"
. edksetup.sh

build -t GCC5 -a X64 -b RELEASE \\
    -p OvmfPkg/CloudHv/CloudHvX64.dsc \\
    -D SECURE_BOOT_ENABLE=FALSE \\
    -D TPM_ENABLE=FALSE \\
    -D NETWORK_IP6_ENABLE=FALSE
""",
    src_install = """
mkdir -p "$D/usr/share/cloud-hypervisor"

# The built firmware is in Build/CloudHvX64/RELEASE_GCC5/FV/
FW_PATH="Build/CloudHvX64/RELEASE_GCC5/FV/CLOUDHV.fd"
if [ -f "$FW_PATH" ]; then
    install -m 0644 "$FW_PATH" "$D/usr/share/cloud-hypervisor/CLOUDHV.fd"
else
    echo "Warning: CLOUDHV.fd not found at expected path"
    # Try alternative paths
    find Build -name "CLOUDHV.fd" -exec install -m 0644 {} "$D/usr/share/cloud-hypervisor/" \\;
fi
""",
    labels = ["buckos:firmware"],
    visibility = ["PUBLIC"],
)

# Export the firmware file for use in boot scripts
export_file(
    name = "cloudhv-fd",
    src = ":edk2-cloudhv",
    default_target_platform = "//platforms:linux-target",
    visibility = ["PUBLIC"],
)
