load("//defs:package.bzl", "package")

package(
    build_rule = "meson",
    name = "pipewire",
    version = "1.0.7",
    url = "https://github.com/PipeWire/pipewire/archive/refs/tags/1.0.7.tar.gz",
    sha256 = "9c45eef65e66224804ae8671849452a7f221e913813072b3aad346f20df666a8",
    description = "Low-latency audio/video router and processor",  # Cache: 2026-02-04 no-custom-configure
    homepage = "https://pipewire.org/",
    license = "MIT",
# systemd enabled for proper init system support
    use_configure = {
        "X": ("-Dx11=enabled -Dx11-xfixes=enabled", "-Dx11=disabled -Dx11-xfixes=disabled"),
        "alsa": ("-Dalsa=enabled -Dpipewire-alsa=enabled", "-Dalsa=disabled -Dpipewire-alsa=disabled"),
        "bluetooth": ("-Dbluez5=enabled -Dbluez5-codec-aac=enabled -Dbluez5-codec-aptx=enabled -Dbluez5-codec-ldac=enabled", "-Dbluez5=disabled -Dbluez5-codec-aac=disabled -Dbluez5-codec-aptx=disabled -Dbluez5-codec-ldac=disabled"),
        "doc": ("-Ddocs=enabled -Dman=enabled", "-Ddocs=disabled -Dman=disabled"),
        "examples": ("-Dexamples=enabled", "-Dexamples=disabled"),
        "ffmpeg": ("-Dffmpeg=enabled", "-Dffmpeg=disabled"),
        "gstreamer": ("-Dgstreamer=enabled -Dgstreamer-device-provider=enabled", "-Dgstreamer=disabled -Dgstreamer-device-provider=disabled"),
        "jack": ("-Djack=enabled -Dpipewire-jack=enabled", "-Djack=disabled -Dpipewire-jack=disabled"),
        "libcamera": ("-Dlibcamera=enabled", "-Dlibcamera=disabled"),
        "pulseaudio": ("-Dlibpulse=enabled", "-Dlibpulse=disabled"),
        "systemd": ("-Dsystemd=enabled -Dsystemd-system-service=enabled -Dsystemd-user-service=enabled", "-Dsystemd=disabled -Dsystemd-system-service=disabled -Dsystemd-user-service=disabled"),
        "test": ("-Dtests=enabled -Dinstalled_tests=enabled -Dtest=enabled", "-Dtests=disabled -Dinstalled_tests=disabled -Dtest=disabled"),
        "v4l2": ("-Dv4l2=enabled -Dpipewire-v4l2=enabled -Dvideoconvert=enabled -Dvideotestsrc=enabled", "-Dv4l2=disabled -Dpipewire-v4l2=disabled -Dvideoconvert=disabled -Dvideotestsrc=disabled"),
        "vulkan": ("-Dvulkan=enabled", "-Dvulkan=disabled"),
    },
    use_deps = {
        "alsa": "//packages/linux/system/libs/audio/alsa-lib:alsa-lib",
        "bluetooth": "//packages/linux/system/bluetooth/bluez:bluez",
        "gstreamer": "//packages/linux/graphics/video/gstreamer:gstreamer",
        "ffmpeg": "//packages/linux/media/video/ffmpeg:ffmpeg",
        "systemd": [
            "//packages/linux/system/init/systemd:systemd",
            "//packages/linux/system/libs/ipc/libcap:libcap",  # libsystemd.so needs libcap
        ],
        "pulseaudio": "//packages/linux/audio/daemons/pulseaudio:pulseaudio",
    },
    configure_args = [
        "-Dspa-plugins=enabled",
        "-Daudiomixer=enabled",
        "-Daudioconvert=enabled",
        "-Dcontrol=enabled",
        "-Daudiotestsrc=enabled",
        "-Dsupport=enabled",
        "-Devl=disabled",
        "-Dvolume=enabled",
        "-Dpw-cat=enabled",
        "-Dudev=enabled",
        "-Dudevrulesdir=/lib/udev/rules.d",
        "-Dsdl2=disabled",
        "-Dsndfile=enabled",
        "-Droc=disabled",
        "-Davahi=disabled",
        "-Decho-cancel-webrtc=disabled",
        "-Dlibusb=disabled",
        "-Dsession-managers=[]",
        "-Draop=disabled",
        "-Dlv2=disabled",
        "-Dlibcanberra=disabled",
        "-Dflatpak=disabled",
        "-Drlimits-install=false",
    ],
    deps = [
        "//packages/linux/system/libs/ipc/dbus:dbus",
        "//packages/linux/system/init/eudev:eudev",
        "//packages/linux/system/libs/audio/libsndfile:libsndfile",
        "//packages/linux/system/libs/audio/flac:flac",
        "//packages/linux/system/libs/audio/libogg:libogg",
        "//packages/linux/system/libs/audio/libvorbis:libvorbis",
        "//packages/linux/system/libs/audio/opus:opus",
    ],
)
