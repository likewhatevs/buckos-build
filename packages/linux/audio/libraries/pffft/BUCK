load("//defs:package.bzl", "package")

genrule(
    name = "pffft-src",
    srcs = glob(["src/*"]),
    out = "pffft-source",
    cmd = """
        mkdir -p $OUT
        cp $SRCS $OUT/
    """,
)

package(
    build_rule = "binary",
    name = "pffft",
    version = "1",
    local_only = True,
    source = ":pffft-src",
    description = "Pretty Fast FFT - a small, fast FFT library with SIMD support",
    homepage = "https://bitbucket.org/jpommier/pffft",
    license = "BSD-2-Clause",
    install_script = """
mkdir -p "$OUT"
BUILD=$(mktemp -d)
cp -a "$SRCS"/. "$BUILD/"
cd "$BUILD"

# PFFFT is a simple single-file library
# Compile with SIMD optimizations enabled
${CC:-gcc} ${CFLAGS:--O3} -fPIC -c pffft.c -o pffft.o

# Create static library
ar rcs libpffft.a pffft.o

# Create shared library
${CC:-gcc} -shared -o libpffft.so.0.0.0 pffft.o -lm
ln -sf libpffft.so.0.0.0 libpffft.so.0
ln -sf libpffft.so.0 libpffft.so

# Install libraries
mkdir -p "$OUT/usr/lib64"
cp libpffft.a "$OUT/usr/lib64/"
cp libpffft.so.0.0.0 "$OUT/usr/lib64/"
ln -sf libpffft.so.0.0.0 "$OUT/usr/lib64/libpffft.so.0"
ln -sf libpffft.so.0 "$OUT/usr/lib64/libpffft.so"

# Install headers
mkdir -p "$OUT/usr/include"
cp pffft.h "$OUT/usr/include/"

# Create pkg-config file
mkdir -p "$OUT/usr/lib64/pkgconfig"
cat > "$OUT/usr/lib64/pkgconfig/pffft.pc" << 'EOF'
prefix=/usr
exec_prefix=${prefix}
libdir=${exec_prefix}/lib64
includedir=${prefix}/include

Name: pffft
Description: Pretty Fast FFT - a small, fast FFT library with SIMD support
Version: 1
Cflags: -I${includedir}
Libs: -L${libdir} -lpffft -lm
EOF
""",
    visibility = ["PUBLIC"],
)
