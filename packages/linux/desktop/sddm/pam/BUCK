# SDDM PAM Configuration
# Separate PAM files for SDDM display manager

genrule(
    name = "sddm-pam-gen",
    out = "sddm",
    cmd = """
cat > $OUT << 'PAM_EOF'
#%PAM-1.0

auth        include     system-login
-auth       optional    pam_gnome_keyring.so
-auth       optional    pam_kwallet5.so

account     include     system-login

password    include     system-login
-password   optional    pam_gnome_keyring.so    use_authtok

session     optional    pam_keyinit.so          force revoke
session     include     system-login
-session    optional    pam_gnome_keyring.so    auto_start
-session    optional    pam_kwallet5.so         auto_start
PAM_EOF
""",
)

genrule(
    name = "sddm-autologin-pam-gen",
    out = "sddm-autologin",
    cmd = """
cat > $OUT << 'PAM_EOF'
#%PAM-1.0
# Autologin PAM configuration for SDDM (live ISO)
# Uses pam_systemd to create proper user session

auth      required    pam_permit.so

account   required    pam_permit.so

password  required    pam_permit.so

# Session setup
session   required    pam_env.so
session   required    pam_limits.so
session   required    pam_unix.so
session   required    pam_loginuid.so
# pam_systemd creates user session, XDG_RUNTIME_DIR, and starts user@.service
session   required    pam_systemd.so
PAM_EOF
""",
)

genrule(
    name = "sddm-greeter-pam-gen",
    out = "sddm-greeter",
    cmd = """
cat > $OUT << 'PAM_EOF'
#%PAM-1.0

# Load environment from /etc/environment and ~/.pam_environment
auth        required pam_env.so

# Always let the greeter start without authentication
auth        required pam_permit.so

# No action required for account management
account     required pam_permit.so

# Can't change password
password    required pam_deny.so

# Setup session - pam_systemd for systemd integration (optional for live ISO)
-session    optional pam_unix.so
-session    optional pam_systemd.so
PAM_EOF
""",
)

genrule(
    name = "sddm-pam",
    out = "sddm-pam",
    srcs = [":sddm-pam-gen", ":sddm-autologin-pam-gen", ":sddm-greeter-pam-gen"],
    cmd = """
mkdir -p $OUT/etc/pam.d
cp $(location :sddm-pam-gen) $OUT/etc/pam.d/sddm
cp $(location :sddm-autologin-pam-gen) $OUT/etc/pam.d/sddm-autologin
cp $(location :sddm-greeter-pam-gen) $OUT/etc/pam.d/sddm-greeter
chmod 644 $OUT/etc/pam.d/*
""",
)
