load("//defs:package_defs.bzl", "meson_package", "autotools_package")

# GTK3 - GIMP Toolkit version 3
autotools_package(
    name = "gtk3",
    version = "3.24.41",
    src_uri = "https://download.gnome.org/sources/gtk+/3.24/gtk+-3.24.41.tar.xz",
    sha256 = "47da61487af3087a94bc49296fd025ca0bc02f96ef06c556e7c8988bd651b6fa",
    signature_required = False,
    description = "Multi-platform toolkit for creating graphical user interfaces",
    homepage = "https://www.gtk.org/",
    license = "LGPL-2.1+",
    iuse = ["introspection", "X", "wayland", "broadway", "cups", "cloudprint", "colord", "doc", "test", "examples", "demos"],
    use_defaults = ["X", "wayland"],
    use_configure = {
        "introspection": "-Dintrospection=true",
        "-introspection": "-Dintrospection=false",
        "X": "-Dx11-backend=true",
        "-X": "-Dx11-backend=false",
        "wayland": "-Dwayland-backend=true",
        "-wayland": "-Dwayland-backend=false",
        "broadway": "-Dbroadway-backend=true",
        "-broadway": "-Dbroadway-backend=false",
        "cups": "-Dprint-backends=cups",
        "-cups": "-Dprint-backends=file",
        "cloudprint": "-Dcloudproviders=true",
        "-cloudprint": "-Dcloudproviders=false",
        "colord": "-Dcolord=yes",
        "-colord": "-Dcolord=no",
        "doc": "-Dgtk_doc=true",
        "-doc": "-Dgtk_doc=false",
        "test": "-Dtests=true",
        "-test": "-Dtests=false",
        "examples": "-Dexamples=true",
        "-examples": "-Dexamples=false",
        "demos": "-Ddemos=true",
        "-demos": "-Ddemos=false",
    },
    use_deps = {
        "wayland": ["//packages/linux/system/libs/utility/libffi:libffi", "//packages/linux/graphics/rendering/wayland:wayland"],
        "cups": ["//packages/linux/system/printing/cups:cups"],
        "colord": ["//packages/linux/system/color/colord:colord"],
    },
    src_configure = """
# Force reconfigure to use at-spi2-core's atk instead of separate atk
rm -rf build
meson setup build --prefix=/usr \
    --libdir=/usr/lib64 \
    -Dintrospection=false \
    -Dx11_backend=true \
    -Dwayland_backend=true \
    -Dbroadway_backend=false \
    -Dprint_backends=file \
    -Dcloudproviders=false \
    -Dcolord=no \
    -Dgtk_doc=false \
    -Dtests=false \
    -Dexamples=false \
    -Ddemos=false
""",
    src_compile = """
meson compile -C build -j${MAKEOPTS:-$(nproc)}
""",
    src_install = """
DESTDIR="$DESTDIR" meson install -C build --no-rebuild
""",
    deps = [
        "//packages/linux/dev-libs/glib:glib",
        # glib's transitive deps needed for pkg-config
        "//packages/linux/system/libs/utility/pcre2:pcre2",
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/core/zlib:zlib",
        # Cairo and its transitive deps
        "//packages/linux/system/libs/graphics/cairo:cairo",
        "//packages/linux/system/security/auth/biometric:pixman",
        "//packages/linux/system/libs/font/fontconfig:fontconfig",
        "//packages/linux/system/libs/data/expat:expat",
        "//packages/linux/system/libs/image/libpng:libpng",
        # X11 deps for cairo and GTK
        "//packages/linux/graphics/xorg/libX11:libX11",
        "//packages/linux/graphics/xorg/libXext:libXext",
        "//packages/linux/graphics/xorg/libXrender:libXrender",
        "//packages/linux/graphics/xorg/libXrandr:libXrandr",
        "//packages/linux/graphics/xorg/libXi:libXi",
        "//packages/linux/graphics/xorg/libXfixes:libXfixes",
        "//packages/linux/graphics/xorg/libXcursor:libXcursor",
        "//packages/linux/graphics/xorg/libXdamage:libXdamage",
        "//packages/linux/graphics/xorg/libXcomposite:libXcomposite",
        "//packages/linux/graphics/xorg/libXinerama:libXinerama",
        "//packages/linux/graphics/xorg/xorgproto:xorgproto",
        "//packages/linux/graphics/xorg/libxcb:libxcb",
        "//packages/linux/graphics/xorg/xcb-proto:xcb-proto",
        "//packages/linux/graphics/xorg/libXau:libXau",
        "//packages/linux/graphics/xorg/libXdmcp:libXdmcp",
        # Pango transitive deps
        "//packages/linux/system/libs/compression/brotli:brotli",
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/font/fribidi:fribidi",
        "//packages/linux/system/libs/font/harfbuzz:harfbuzz",
        # gdk-pixbuf transitive deps
        "//packages/linux/desktop/shared-mime-info:shared-mime-info",
        "//packages/linux/system/libs/data/libxml2:libxml2",
        "//packages/linux/system/libs/image/libjpeg-turbo:libjpeg-turbo",
        "//packages/linux/system/libs/image/libtiff:libtiff",
        # OpenGL/EGL deps
        "//packages/linux/graphics/libepoxy:libepoxy",
        "//packages/linux/desktop/mesa:mesa",
        # Accessibility (at-spi2-core >= 2.46 includes atk)
        "//packages/linux/desktop/at-spi2-core:at-spi2-core",
        "//packages/linux/graphics/xorg/libXtst:libXtst",
        "//packages/linux/system/libs/ipc/dbus:dbus",
        "//packages/linux/system/init/systemd:systemd",
        "//packages/linux/system/security/capabilities:libcap",
        # Input
        "//packages/linux/system/libs/input/libxkbcommon:libxkbcommon",
        # Wayland
        "//packages/linux/graphics/rendering/wayland:wayland",
        "//packages/linux/graphics/rendering/wayland-protocols:wayland-protocols",
        # GTK deps
        "//packages/linux/system/libs/font/freetype:freetype",
        "//packages/linux/fonts/libraries/pango:pango",
        "//packages/linux/desktop/gdk-pixbuf:gdk-pixbuf",
    ],
    visibility = ["PUBLIC"],
)

# GTK4 - GIMP Toolkit version 4
autotools_package(
    name = "gtk4",
    version = "4.14.1",
    src_uri = "https://download.gnome.org/sources/gtk/4.14/gtk-4.14.1.tar.xz",
    sha256 = "fcefb3f132f8cc4711a9efa5b353c9ae9bb5eeff0246fa74dbc2f2f839b9e308",
    signature_required = False,
    description = "Multi-platform toolkit for creating graphical user interfaces (GTK4)",
    homepage = "https://www.gtk.org/",
    license = "LGPL-2.1+",
    iuse = ["introspection", "X", "wayland", "broadway", "vulkan", "gstreamer", "cloudprint", "colord", "cups", "doc", "test", "examples", "demos"],
    use_defaults = ["X", "wayland", "vulkan"],
    use_configure = {
        "introspection": "-Dintrospection=enabled",
        "-introspection": "-Dintrospection=disabled",
        "X": "-Dx11-backend=true",
        "-X": "-Dx11-backend=false",
        "wayland": "-Dwayland-backend=true",
        "-wayland": "-Dwayland-backend=false",
        "broadway": "-Dbroadway-backend=true",
        "-broadway": "-Dbroadway-backend=false",
        "vulkan": "-Dvulkan=enabled",
        "-vulkan": "-Dvulkan=disabled",
        "gstreamer": "-Dmedia-gstreamer=enabled",
        "-gstreamer": "-Dmedia-gstreamer=disabled",
        "cloudprint": "-Dcloudproviders=enabled",
        "-cloudprint": "-Dcloudproviders=disabled",
        "colord": "-Dcolord=enabled",
        "-colord": "-Dcolord=disabled",
        "cups": "-Dprint-cups=enabled",
        "-cups": "-Dprint-cups=disabled",
        "doc": "-Dgtk_doc=true",
        "-doc": "-Dgtk_doc=false",
        "test": "-Dbuild-tests=true",
        "-test": "-Dbuild-tests=false",
        "examples": "-Dbuild-examples=true",
        "-examples": "-Dbuild-examples=false",
        "demos": "-Dbuild-demos=true",
        "-demos": "-Dbuild-demos=false",
    },
    use_deps = {
        "wayland": ["//packages/linux/system/libs/utility/libffi:libffi", "//packages/linux/graphics/rendering/wayland:wayland"],
        "gstreamer": ["//packages/linux/graphics/video/gstreamer:gstreamer"],
        "colord": ["//packages/linux/system/color/colord:colord"],
        "cups": ["//packages/linux/system/printing/cups:cups"],
    },
    pre_configure = """
mkdir -p build
cd build
# USE flags: introspection, X, wayland, broadway, vulkan, gstreamer, cloudprint, colord, cups, doc, test, examples, demos
meson setup .. --prefix=/usr \
    $CONFIGURE_ARGS
""",
    deps = [
        "//packages/linux/dev-libs/glib:glib",
        "//packages/linux/system/libs/font/freetype:freetype",
        "//packages/linux/fonts/libraries/pango:pango",
        "//packages/linux/system/libs/graphics/cairo:cairo",
        "//packages/linux/desktop/gdk-pixbuf:gdk-pixbuf",
    ],
    visibility = ["PUBLIC"],
)
