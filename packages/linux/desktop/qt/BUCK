load("//defs:package.bzl", "package")

# =============================================================================
# Qt6 - Cross-platform application framework (required for KDE Plasma 6)
# =============================================================================
#
# USE flags:
#   X         - Enable X11/XCB support
#   wayland   - Enable Wayland support
#   opengl    - Enable OpenGL support
#   eglfs     - Enable EGL fullscreen platform
#   dbus      - Enable D-Bus support
#   widgets   - Enable Qt Widgets
#   cups      - Enable printing support
#   ssl       - Enable OpenSSL support
#   sqlite    - Enable SQLite support
#   vulkan    - Enable Vulkan support

# =============================================================================
# Qt6 Native - Minimal build for host tools (syncqt, moc, rcc, etc.)
# Used when cross-compiling Qt6 for aarch64/other architectures
# =============================================================================

package(
    build_rule = "cmake",
    name = "qt6-native",
    version = "6.8.3",
    url = "https://download.qt.io/official_releases/qt/6.8/6.8.3/single/qt-everywhere-src-6.8.3.tar.xz",
    sha256 = "cdd3a69967208276bb01af7ace7dba0ba53e679f886a4cbe624225c60fb73f2c",
    description = "Qt6 native host tools for cross-compilation",
    homepage = "https://www.qt.io/",
    license = "LGPL-3.0-or-later OR GPL-3.0-or-later",

    # Extract qt5compat module into source tree
    pre_configure_cmds = ['''
# Qt5Compat not included in native build (not needed for host tools)
echo "Qt5Compat not included in native build"

# Disable qdoc and linguist - they require LLVM/libclang which may have
# incompatible C++ library (libc++ vs libstdc++) on the host system.
# We only need qttools for UiTools/designer, not for documentation/translation.
if [ -f "$S/qttools/src/CMakeLists.txt" ]; then
    echo "Patching qttools to disable qdoc and linguist..."
    sed -i 's|add_subdirectory(qdoc)|# add_subdirectory(qdoc) # Disabled - requires libclang|g' "$S/qttools/src/CMakeLists.txt"
    sed -i 's|add_subdirectory(linguist)|# add_subdirectory(linguist) # Disabled - requires libclang|g' "$S/qttools/src/CMakeLists.txt"
    echo "qdoc and linguist disabled in qttools"
    grep -n -E "(qdoc|linguist)" "$S/qttools/src/CMakeLists.txt" || true
fi
''', """
# Qt5Compat is already included in the qt-everywhere-src tarball
echo "Qt5Compat already included in Qt single tarball"

# Remove any leftover qt5compat-everywhere-src directory from previous extraction attempts
if [ -d "$S/qt5compat-everywhere-src-6.8.3" ]; then
    echo "Removing leftover qt5compat-everywhere-src-6.8.3 directory..."
    rm -rf "$S/qt5compat-everywhere-src-6.8.3"
fi

# Also remove nested leftover directory inside qt5compat from previous extractions
if [ -d "$S/qt5compat/qt5compat-everywhere-src-6.8.3" ]; then
    echo "Removing nested leftover qt5compat/qt5compat-everywhere-src-6.8.3 directory..."
    rm -rf "$S/qt5compat/qt5compat-everywhere-src-6.8.3"
fi

# Find mesa library path from CMAKE_PREFIX_PATH (already set before src_prepare runs)
MESA_PATH=$(echo "$CMAKE_PREFIX_PATH" | tr ';' '\\n' | grep mesa)
if [ -n "$MESA_PATH" ]; then
    EGL_LIB="$MESA_PATH/lib64/libEGL.so"
    GLESV2_LIB="$MESA_PATH/lib64/libGLESv2.so"
    EGL_INCLUDE="$MESA_PATH/include"

    echo "=== EGL/GLESv2 Configuration ==="
    echo "MESA_PATH=$MESA_PATH"
    echo "EGL_LIB=$EGL_LIB"
    echo "GLESV2_LIB=$GLESV2_LIB"
    echo "EGL_INCLUDE=$EGL_INCLUDE"
    ls -la "$EGL_LIB" "$GLESV2_LIB" 2>/dev/null || echo "Warning: Some libs not found"

    # Patch Qt's main CMakeLists.txt to add EGL and GLESv2 target definitions at the very beginning
    # This ensures the targets exist globally before any find_package calls
    # Use UNKNOWN library type to avoid "platform does not support dynamic linking" warning
    cat > /tmp/egl_targets.cmake << EOF
# EGL and GLESv2 targets for cross-compilation (auto-injected)
# Using UNKNOWN type to work around cross-compilation warnings
if(NOT TARGET EGL::EGL)
    add_library(EGL::EGL UNKNOWN IMPORTED GLOBAL)
    set_target_properties(EGL::EGL PROPERTIES
        IMPORTED_LOCATION "$EGL_LIB"
        INTERFACE_INCLUDE_DIRECTORIES "$EGL_INCLUDE"
    )
endif()

if(NOT TARGET GLESv2::GLESv2)
    add_library(GLESv2::GLESv2 UNKNOWN IMPORTED GLOBAL)
    set_target_properties(GLESv2::GLESv2 PROPERTIES
        IMPORTED_LOCATION "$GLESV2_LIB"
        INTERFACE_INCLUDE_DIRECTORIES "$EGL_INCLUDE"
    )
endif()

# Also create OpenGL::EGL and OpenGL::GLESv2 targets that Qt6 expects
if(NOT TARGET OpenGL::EGL)
    add_library(OpenGL::EGL ALIAS EGL::EGL)
endif()

if(NOT TARGET OpenGL::GLESv2)
    add_library(OpenGL::GLESv2 ALIAS GLESv2::GLESv2)
endif()

# Set cache variables that Qt's FindEGL/FindGLESv2 would set
set(EGL_FOUND TRUE CACHE BOOL "EGL found" FORCE)
set(EGL_INCLUDE_DIR "$EGL_INCLUDE" CACHE PATH "EGL include dir" FORCE)
set(EGL_LIBRARY "$EGL_LIB" CACHE FILEPATH "EGL library" FORCE)
set(EGL_opengl_LIBRARY "$EGL_LIB" CACHE FILEPATH "EGL library" FORCE)
set(GLESv2_FOUND TRUE CACHE BOOL "GLESv2 found" FORCE)
set(GLESv2_INCLUDE_DIR "$EGL_INCLUDE" CACHE PATH "GLESv2 include dir" FORCE)
set(GLESv2_LIBRARY "$GLESV2_LIB" CACHE FILEPATH "GLESv2 library" FORCE)
set(OpenGL_EGL_FOUND TRUE CACHE BOOL "OpenGL EGL found" FORCE)
set(OpenGL_GLESv2_FOUND TRUE CACHE BOOL "OpenGL GLES found" FORCE)
set(OpenGL_GLES2_FOUND TRUE CACHE BOOL "OpenGL GLES2 found" FORCE)
set(OpenGL_GLES3_FOUND TRUE CACHE BOOL "OpenGL GLES3 found" FORCE)
set(OPENGL_FOUND TRUE CACHE BOOL "OpenGL found" FORCE)
set(OPENGL_egl_LIBRARY "$EGL_LIB" CACHE FILEPATH "EGL library" FORCE)
set(OPENGL_gles2_LIBRARY "$GLESV2_LIB" CACHE FILEPATH "GLES2 library" FORCE)
EOF

    # Insert the EGL targets after the first cmake_minimum_required line in Qt's main CMakeLists.txt
    if [ -f "$S/CMakeLists.txt" ]; then
        # Create backup
        cp "$S/CMakeLists.txt" "$S/CMakeLists.txt.orig"
        # Insert our target definitions after cmake_minimum_required (sed 'a' adds on next line)
        sed -i '/^cmake_minimum_required/a include(/tmp/egl_targets.cmake)' "$S/CMakeLists.txt"
        echo "Patched CMakeLists.txt to include EGL/GLESv2 targets"
        head -15 "$S/CMakeLists.txt"
    fi
fi

# Disable qdoc and linguist - they require LLVM/libclang which may have
# incompatible C++ library (libc++ vs libstdc++) on the host system.
# We only need qttools for UiTools/designer, not for documentation/translation.
if [ -f "$S/qttools/src/CMakeLists.txt" ]; then
    echo "Patching qttools to disable qdoc and linguist..."
    sed -i 's|add_subdirectory(qdoc)|# add_subdirectory(qdoc) # Disabled - requires libclang|g' "$S/qttools/src/CMakeLists.txt"
    sed -i 's|add_subdirectory(linguist)|# add_subdirectory(linguist) # Disabled - requires libclang|g' "$S/qttools/src/CMakeLists.txt"
    echo "qdoc and linguist disabled in qttools"
    grep -n -E "(qdoc|linguist)" "$S/qttools/src/CMakeLists.txt" || true
fi

# For cross-compilation only: Remove optional Qt modules that require native tools
# Qt's CMakeLists.txt checks dependencies before honoring -DBUILD_* flags
# So we physically remove the modules from the source tree to avoid dependency errors
# NOTE: qt5compat is kept - needed by kwin
# NOTE: qttools is kept - needed by kwin for Qt6UiTools
if [ "${CROSS_COMPILING:-false}" = "true" ]; then
    echo "Cross-compiling: Removing optional Qt modules that require native tools..."
    for module in qtquick3d qtquick3dphysics qt3d qtlanguageserver \
                  qtquicktimeline qtactiveqt qtcharts qtcoap qtconnectivity \
                  qtdatavis3d qtgraphs qtgrpc qthttpserver qtlocation qtlottie qtmqtt \
                  qtnetworkauth qtopcua qtquickeffectmaker qtremoteobjects \
                  qtscxml qtserialbus qtserialport qtvirtualkeyboard \
                  qtwebchannel qtwebsockets qtmultimedia qtspeech qtwebengine qtwebview \
                  qttranslations qtdoc qtimageformats; do
        if [ -d "$S/$module" ]; then
            echo "  Removing $module"
            rm -rf "$S/$module"
        fi
    done

    # Remove qt declarative tools directory entirely - contains qmlpreview/qmlprofiler that fail to link with zstd
    # These are development/debugging tools not needed for runtime
    if [ -d "$S/qtdeclarative/tools" ]; then
        echo "Removing qtdeclarative/tools directory for cross-compilation..."
        # Keep only the essential qmlcachegen and qmlaotstats that other parts depend on
        mkdir -p "$S/qtdeclarative/tools-temp"
        if [ -d "$S/qtdeclarative/tools/qmlcachegen" ]; then
            mv "$S/qtdeclarative/tools/qmlcachegen" "$S/qtdeclarative/tools-temp/"
        fi
        if [ -d "$S/qtdeclarative/tools/qmlaotstats" ]; then
            mv "$S/qtdeclarative/tools/qmlaotstats" "$S/qtdeclarative/tools-temp/"
        fi
        rm -rf "$S/qtdeclarative/tools"
        mv "$S/qtdeclarative/tools-temp" "$S/qtdeclarative/tools"
    fi
else
    echo "Native build: Keeping all Qt modules"
fi
"""],

    # Force clean reconfigure to ensure feature flags take effect

    # Minimal build - only qtbase for host tools
    # Disable ALL optional modules to avoid dependency cascades
    configure_args = [
        "-DCMAKE_INSTALL_PREFIX=/usr",
        "-DCMAKE_BUILD_TYPE=Release",
        "-DINSTALL_BINDIR=lib64/qt6/bin",
        "-DINSTALL_LIBDIR=lib64",
        "-DINSTALL_ARCHDATADIR=lib64/qt6",
        "-DQT_FEATURE_gui=ON",   # Need for qtshadertools (qsb tool)
        "-DQT_FEATURE_widgets=OFF",
        "-DQT_FEATURE_dbus=ON",  # Need for Qt6DBusTools (qdbuscpp2xml, qdbusxml2cpp) used by KDE
        "-DQT_FEATURE_network=OFF",
        "-DQT_FEATURE_sql=OFF",
        "-DQT_FEATURE_testlib=OFF",
        "-DQT_FEATURE_xml=OFF",
        "-DQT_FEATURE_zstd=OFF",
        "-DQT_FEATURE_icu=OFF",
        # Disable X11/OpenGL for minimal native build
        "-DQT_FEATURE_xcb=OFF",
        "-DQT_FEATURE_opengl=OFF",
        "-DINPUT_opengl=no",
        "-DQT_FEATURE_libinput=OFF",  # Disable libinput support (no libinput package available)
        "-DCMAKE_DISABLE_FIND_PACKAGE_ICU=ON",
        "-DCMAKE_DISABLE_FIND_PACKAGE_WrapZSTD=ON",
        "-DQT_BUILD_EXAMPLES=OFF",
        "-DQT_BUILD_TESTS=OFF",
        "-DQT_FORCE_FIND_TOOLS=OFF",  # Don't search for external tools, build our own
        "-DQT_BUILD_TOOLS_BY_DEFAULT=ON",  # Ensure tools packages (Qt6*Tools) are created
        # Disable ALL optional Qt modules - only build qtbase
        "-DBUILD_qtwayland=ON",  # Need qtwaylandscanner host tool for cross-compiling qtwayland
        "-DBUILD_qtdoc=OFF",
        "-DBUILD_qttranslations=OFF",
        "-DBUILD_qtimageformats=OFF",
        "-DBUILD_qtlanguageserver=OFF",
        "-DBUILD_qtshadertools=ON",  # Need for qsb (Qt Shader Baker) host tool
        "-DBUILD_qtsvg=OFF",
        "-DBUILD_qtdeclarative=ON",  # Need for qmltyperegistrar host tool
        "-DBUILD_qtquicktimeline=OFF",
        "-DBUILD_qtquick3d=OFF",
        "-DBUILD_qtmultimedia=OFF",
        "-DBUILD_qt3d=OFF",
        "-DBUILD_qtactiveqt=OFF",
        "-DBUILD_qtcharts=OFF",
        "-DBUILD_qtcoap=OFF",
        "-DBUILD_qtconnectivity=OFF",
        "-DBUILD_qtdatavis3d=OFF",
        "-DBUILD_qtgraphs=OFF",
        "-DBUILD_qtgrpc=OFF",
        "-DBUILD_qtwebsockets=OFF",
        "-DBUILD_qthttpserver=OFF",
        "-DBUILD_qtserialport=OFF",
        "-DBUILD_qtpositioning=OFF",
        "-DBUILD_qtlocation=OFF",
        "-DBUILD_qtlottie=OFF",
        "-DBUILD_qtmqtt=OFF",
        "-DBUILD_qtnetworkauth=OFF",
        "-DBUILD_qtopcua=OFF",
        "-DBUILD_qtquick3dphysics=OFF",
        "-DBUILD_qtquickeffectmaker=OFF",
        "-DBUILD_qtremoteobjects=OFF",
        "-DBUILD_qtscxml=OFF",
        "-DBUILD_qtsensors=OFF",
        "-DBUILD_qtserialbus=OFF",
        "-DBUILD_qtspeech=OFF",
        "-DBUILD_qtwebengine=OFF",
        "-DBUILD_qtwebview=OFF",
        "-DBUILD_qtvirtualkeyboard=OFF",
        # Only build qtbase for host tools
        "-DQT_HOST_PATH=",
    ],

    # Minimal deps for native build
    # GUI feature enabled for qtshadertools (qsb tool)
    # X11 and OpenGL disabled for minimal native build
    # DBus enabled for Qt6DBusTools needed by KDE
    deps = [
        "//packages/linux/core/zlib:zlib",
                "//packages/linux/system/libs/utility/pcre2:pcre2",
                "//packages/linux/dev-libs/glib:glib",
                # Minimal GUI deps for qtshadertools
        "//packages/linux/system/libs/image/libpng:libpng",
                "//packages/linux/system/libs/image/libjpeg-turbo:libjpeg-turbo",
                # Platform libraries for Unix GUI backend
        "//packages/linux/system/libs/font/fontconfig:fontconfig",
                "//packages/linux/system/libs/font/freetype:freetype",
                "//packages/linux/system/libs/font/harfbuzz:harfbuzz",
                "//packages/linux/system/libs/input/libxkbcommon:libxkbcommon",
                "//packages/linux/desktop/libdrm:libdrm",
                "//packages/linux/system/libs/data/expat:expat",
                # DBus for Qt6DBusTools (also needs systemd for libsystemd)
        "//packages/linux/system/libs/ipc/dbus:dbus",
                "//packages/linux/system/init/systemd:systemd",
                "//packages/linux/system/libs/ipc/libcap:libcap",
                # systemd depends on libcap
        # Wayland for qtwayland (qtwaylandscanner host tool)
        "//packages/linux/graphics/rendering/wayland:wayland",
                "//packages/linux/graphics/rendering/wayland-protocols:wayland-protocols",
                "//packages/linux/system/libs/compression/bzip2:bzip2",
                # transitive: freetype links libbz2,
                ":qt6-native"
    ],

    # Create Qt6QuickTools package for cross-compilation

    visibility = ["PUBLIC"],
)

package(
    build_rule = "cmake",
    name = "qt6",
    url = "https://download.qt.io/official_releases/qt/6.8/6.8.3/single/qt-everywhere-src-6.8.3.tar.xz",
    sha256 = "cdd3a69967208276bb01af7ace7dba0ba53e679f886a4cbe624225c60fb73f2c",
    version = "6.8.3",
    description = "Qt6 - Cross-platform application framework",
    homepage = "https://www.qt.io/",
    license = "LGPL-3.0-or-later OR GPL-3.0-or-later",

    # src_prepare: Patch Qt's CMakeLists.txt to define EGL and GLESv2 targets for cross-compilation
    # NOTE: qt5compat is already included in the Qt "single" tarball, no need to extract it

    # Add native Qt6 as exec_bdepend for cross-compilation host tools

    # Custom src_configure: Set QT_HOST_PATH for cross-compilation

    # Custom src_compile: Qt6 builds host tools (rcc, moc, etc.) that need to find
    # shared libraries from our dependencies at runtime. Set LD_LIBRARY_PATH from
    # LIBRARY_PATH so host tools can find libraries like libdouble-conversion.

    # USE flags this package supports

    # Default USE flags - Wayland-focused, no X11
    # OpenGL enabled via EGL+GLES2 for Wayland (Mesa)
    # dbus is required for KDE Frameworks

    configure_args = [
        "-DCMAKE_INSTALL_PREFIX=/usr",
        "-DCMAKE_BUILD_TYPE=Release",
        "-DINSTALL_BINDIR=lib64/qt6/bin",
        "-DINSTALL_INCLUDEDIR=include/qt6",
        "-DINSTALL_LIBDIR=lib64",
        "-DINSTALL_ARCHDATADIR=lib64/qt6",
        "-DINSTALL_DATADIR=share/qt6",
        "-DINSTALL_DOCDIR=share/doc/qt6",
        "-DINSTALL_EXAMPLESDIR=share/doc/qt6/examples",
        "-DINSTALL_MKSPECSDIR=lib64/qt6/mkspecs",
        "-DINSTALL_PLUGINSDIR=lib64/qt6/plugins",
        "-DINSTALL_QMLDIR=lib64/qt6/qml",
        "-DINSTALL_SYSCONFDIR=/etc/xdg",
        "-DINSTALL_TRANSLATIONSDIR=share/qt6/translations",
        # Force system libraries
        "-DQT_FEATURE_relocatable=OFF",
        # Enable fontconfig so Qt can find system fonts
        # Qt fontconfig REQUIRES system_freetype to be ON - the feature condition is:
        # "NOT APPLE AND NOT WIN32 AND QT_FEATURE_system_freetype AND Fontconfig_FOUND"
        "-DQT_FEATURE_fontconfig=ON",
        "-DQT_FEATURE_harfbuzz=ON",
        "-DQT_FEATURE_system_harfbuzz=OFF",  # Use bundled harfbuzz
        "-DQT_FEATURE_freetype=ON",
        "-DQT_FEATURE_system_freetype=ON",   # REQUIRED for fontconfig to work
        # Core modules always built
        "-DQT_FEATURE_concurrent=ON",
        "-DQT_FEATURE_gui=ON",
        "-DQT_FEATURE_network=ON",
        "-DQT_FEATURE_testlib=ON",
        "-DQT_FEATURE_xml=ON",
        # OpenGL configured via USE flags (opengl -> EGL+GLES2)
        # Disable features we don't need
        "-DQT_FEATURE_journald=OFF",
        "-DQT_FEATURE_syslog=OFF",
        "-DBUILD_TESTING=OFF",
        "-DQT_BUILD_EXAMPLES=OFF",
        "-DQT_BUILD_TESTS=OFF",
        "-DBUILD_qttools=ON",
        # Disable clang-based tools (lupdate-pro, qdoc clang integration) to avoid
        # linking against host LLVM/libclang which may be built with libc++
        "-DQT_FEATURE_clang=OFF",
        # Explicitly disable qdoc - it requires libclang/LLVM and we don't need docs
        "-DQT_BUILD_STANDALONE_TESTS=OFF",
        "-DQT_FORCE_FIND_TOOLS=OFF",
        "-DCMAKE_DISABLE_FIND_PACKAGE_Clang=ON",
        "-DCMAKE_DISABLE_FIND_PACKAGE_LLVM=ON",
        "-DBUILD_qtdoc=OFF",
        "-DBUILD_qttranslations=OFF",
        # Disable qtimageformats (tiff, webp, etc.) - requires complex dependencies
        "-DBUILD_qtimageformats=OFF",
        # Disable QtWebEngine and QtWebView - not needed for KDE, requires chromium dependencies
        "-DBUILD_qtwebengine=OFF",
        "-DBUILD_qtwebview=OFF",
        # Disable Qt Multimedia - requires PulseAudio which we don't have yet
        "-DBUILD_qtmultimedia=OFF",
        # qtspeech depends on qtmultimedia
        "-DBUILD_qtspeech=OFF",
        # Disable Qt3D and related 3D modules - not needed for KDE desktop
        "-DBUILD_qt3d=OFF",
        "-DBUILD_qtquick3d=OFF",
        "-DBUILD_qtquick3dphysics=OFF",
        "-DBUILD_qtshadertools=ON",  # Needed for Qt6Quick (shader compilation)
        # Disable other optional modules not needed for KDE
        "-DBUILD_qtlanguageserver=OFF",
        "-DBUILD_qtquicktimeline=OFF",
        "-DBUILD_qt5compat=ON",  # Needed by kwin - force rebuild v3
        "-DQT_BUILD_EXAMPLES=OFF",  # Explicitly disable examples
        "-DBUILD_qtactiveqt=OFF",
        "-DBUILD_qtcharts=OFF",
        "-DBUILD_qtcoap=OFF",
        "-DBUILD_qtconnectivity=OFF",
        "-DBUILD_qtdatavis3d=OFF",
        "-DBUILD_qtgraphs=OFF",
        "-DBUILD_qtgrpc=OFF",
        "-DBUILD_qthttpserver=OFF",
        "-DBUILD_qtlocation=OFF",
        "-DBUILD_qtlottie=OFF",
        "-DBUILD_qtmqtt=OFF",
        "-DBUILD_qtnetworkauth=OFF",
        "-DBUILD_qtopcua=OFF",
        "-DBUILD_qtpositioning=OFF",
        "-DBUILD_qtquickeffectmaker=OFF",
        "-DBUILD_qtremoteobjects=OFF",
        "-DBUILD_qtscxml=OFF",
        "-DBUILD_qtsensors=OFF",
        "-DBUILD_qtserialbus=OFF",
        "-DBUILD_qtserialport=OFF",
        "-DBUILD_qtvirtualkeyboard=OFF",
        "-DBUILD_qtwebchannel=OFF",
        "-DBUILD_qtwebsockets=OFF",
    ],

    deps = [
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/dev-libs/glib:glib",
        "//packages/linux/dev-libs/misc/double-conversion:double-conversion",
        "//packages/linux/system/libs/utility/pcre2:pcre2",
        "//packages/linux/system/libs/compression/zstd:zstd",
        "//packages/linux/system/libs/utility/icu:icu",
        "//packages/linux/system/libs/image/libpng:libpng",
        "//packages/linux/system/libs/image/libjpeg-turbo:libjpeg-turbo",
        "//packages/linux/desktop/libdrm:libdrm",
        "//packages/linux/system/libs/input/libxkbcommon:libxkbcommon",
        "//packages/linux/system/libs/font/freetype:freetype",
        "//packages/linux/system/libs/font/fontconfig:fontconfig",
        "//packages/linux/system/libs/data/expat:expat",
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        # X11 (from use_deps)
        "//packages/linux/graphics/xorg/libX11:libX11",
        "//packages/linux/graphics/xorg/libxcb:libxcb",
        "//packages/linux/graphics/xorg/xcb-util-cursor:xcb-util-cursor",
        "//packages/linux/graphics/xorg/xcb-util-image:xcb-util-image",
        "//packages/linux/graphics/xorg/xcb-util-keysyms:xcb-util-keysyms",
        "//packages/linux/graphics/xorg/xcb-util-renderutil:xcb-util-renderutil",
        "//packages/linux/graphics/xorg/xcb-util-wm:xcb-util-wm",
        "//packages/linux/graphics/xorg/libICE:libICE",
        "//packages/linux/graphics/xorg/libSM:libSM",
        # Wayland (from use_deps)
        "//packages/linux/graphics/rendering/wayland:wayland",
        "//packages/linux/graphics/rendering/wayland-protocols:wayland-protocols",
        # OpenGL/Mesa (from use_deps)
        "//packages/linux/desktop/mesa:mesa",
        # "//packages/linux/core/llvm:llvm",  # disabled: long build, not needed yet
        "//packages/linux/dev-libs/elfutils:elfutils",
        "//packages/linux/system/libs/data/libxml2:libxml2",
        # SQLite (from use_deps)
        "//packages/linux/system/libs/database/sqlite:sqlite",
        # D-Bus (from use_deps)
        "//packages/linux/system/libs/ipc/dbus:dbus",
        "//packages/linux/system/init/systemd:systemd",
        "//packages/linux/system/libs/ipc/libcap:libcap",
    ],

    visibility = ["PUBLIC"],
)

# =============================================================================
# Qt5 - Cross-platform application framework (legacy)
# =============================================================================

package(
    build_rule = "binary",
    name = "qt5",
    url = "https://download.qt.io/archive/qt/5.15/5.15.12/single/qt-everywhere-opensource-src-5.15.12.tar.xz",
    sha256 = "93f2c0889ee2e9cdf30c170d353c3f829de5f29ba21c119167dee5995e48ccce",
    version = "5.15.12",
    description = "Cross-platform application framework",
    homepage = "https://www.qt.io/",
    license = "LGPL-3.0-or-later OR GPL-3.0-or-later",
    install_script = """
        # Find the Qt source directory in $SRCS
        cd "$SRCS"
        QT_DIR=$(ls -d qt-everywhere-* 2>/dev/null | head -1)
        if [ -z "$QT_DIR" ]; then
            # Source may be extracted directly (top-level stripped)
            if [ -f "$SRCS/qt.pro" ] || [ -d "$SRCS/qtbase" ]; then
                QT_DIR="."
            else
                echo "ERROR: Cannot find Qt source directory in SRCS=$SRCS"
                ls -la "$SRCS"
                exit 1
            fi
        fi
        echo "Using Qt source directory: $QT_DIR"
        cd "$QT_DIR"
        ./configure \
            -prefix $PREFIX \
            -opensource \
            -confirm-license \
            -release \
            -shared \
            -nomake examples \
            -nomake tests \
            -no-separate-debug-info \
            -no-pch \
            -no-use-gold-linker
        make -j${MAKEOPTS:-$(nproc)}
        make install
    """,
    deps = [
        "//packages/linux/desktop/libdrm:libdrm",
        "//packages/linux/system/libs/font/fontconfig:fontconfig",
        "//packages/linux/system/libs/font/freetype:freetype",
        "//packages/linux/system/libs/font/harfbuzz:harfbuzz",
        "//packages/linux/dev-libs/glib:glib",
        "//packages/linux/dev-libs/misc/double-conversion:double-conversion",
    ],
    visibility = ["PUBLIC"],
)

# =============================================================================
# polkit-qt - Qt wrapper around polkit-1 client libraries
# =============================================================================

package(
    build_rule = "cmake",
    name = "polkit-qt",
    url = "https://download.kde.org/stable/polkit-qt-1/polkit-qt-1-0.200.0.tar.xz",

    sha256 = "5d3b611c062d2b76a93750bb10c907bfd21d1ff08d0a15dc2cf63e278e1677fb",
    version = "0.200.0",
    description = "Qt6 wrapper around polkit-1 client libraries",
    homepage = "https://api.kde.org/polkit-qt-1/html/",
    license = "LGPL-2",

    cmake_defines = [
        "QT_MAJOR_VERSION=6",
        "QT_NO_PACKAGE_VERSION_CHECK=TRUE",
        "BUILD_EXAMPLES=OFF",
    ],

    deps = [
        ":qt6",
        "//packages/linux/dev-libs/glib:glib",
        "//packages/linux/system/security/auth/privilege:polkit",
        "//packages/linux/desktop/mesa:mesa",
        "//packages/linux/system/libs/utility/pcre2:pcre2",
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/core/zlib:zlib",
    ],

    visibility = ["PUBLIC"],
)
