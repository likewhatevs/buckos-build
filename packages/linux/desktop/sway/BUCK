load("@root//defs:package_defs.bzl", "download_source", "meson_package")
load("@root//defs:use_flags.bzl", "set_use_flags")

# =============================================================================
# Sway - i3-compatible Wayland compositor
# =============================================================================
#
# USE flags:
#   xwayland        - Enable XWayland support (default: enabled)
#   man-pages       - Build man pages
#   bash-completion - Install bash completions
#   zsh-completion  - Install zsh completions
#   fish-completion - Install fish completions

meson_package(
    name = "sway",
    version = "1.9",
    src_uri = "https://github.com/swaywm/sway/releases/download/1.9/sway-1.9.tar.gz",
    sha256 = "a63b2df8722ee595695a0ec6c84bf29a055a9767e63d8e4c07ff568cb6ee0b51",
    signature_required = False,
    description = "Sway - i3-compatible Wayland compositor",
    homepage = "https://swaywm.org/",
    license = "MIT",
    iuse = [
        "X",
        "bash-completion",
        "fish-completion",
        "man",
        "man-pages",
        "swaybar",
        "swaynag",
        "tray",
        "wallpapers",
        "xwayland",
        "zsh-completion",
    ],
    use_defaults = [],  # No xwayland for pure Wayland build
    # Work around pkg-config path resolution issues in cross-compilation
    env = {"CFLAGS": "-Wno-missing-include-dirs"},
    meson_args = [
        "-Ddefault-wallpaper=false",
        "-Dwerror=false",
    ],
    use_meson = {
        "-X": "-Dxwayland=disabled",
        "-bash-completion": "-Dbash-completions=false",
        "-fish-completion": "-Dfish-completions=false",
        "-man": "-Dman-pages=disabled",
        "-man-pages": "-Dman-pages=disabled",
        "-swaybar": "-Dswaybar=false",
        "-swaynag": "-Dswaynag=false",
        "-tray": "-Dtray=disabled",
        "-wallpapers": "-Ddefault-wallpaper=false",
        "-xwayland": "-Dxwayland=disabled",
        "-zsh-completion": "-Dzsh-completions=false",
        "X": "-Dxwayland=enabled",
        "bash-completion": "-Dbash-completions=true",
        "fish-completion": "-Dfish-completions=true",
        "man": "-Dman-pages=enabled",
        "man-pages": "-Dman-pages=enabled",
        "swaybar": "-Dswaybar=true",
        "swaynag": "-Dswaynag=true",
        "tray": "-Dtray=enabled",
        "wallpapers": "-Ddefault-wallpaper=true",
        "xwayland": "-Dxwayland=enabled",
        "zsh-completion": "-Dzsh-completions=true",
    },
    deps = [
        "core//libffi:libffi",
        "core//zlib:zlib",
        "core//expat:expat",
        "system//libs/image/libpng:libpng",
        "system//libs/compression/brotli:brotli",
        "system//libs/input/libevdev:libevdev",
        "system//init/eudev:eudev",
        "fonts//libraries/freetype:freetype",
        "fonts//libraries/fontconfig:fontconfig",
        "fonts//libraries/harfbuzz:harfbuzz",
        "graphics//rendering/wayland:wayland",
        "graphics//rendering/wayland-protocols:wayland-protocols",
        "graphics//xorg/libxkbcommon:libxkbcommon",
        "desktop//mesa:mesa",
        "desktop//libinput:libinput",
        "desktop//libdrm:libdrm",
        "system//libs/graphics/pixman:pixman",
        "system//libs/data/json-c:json-c",
        "system//libs/utility/pcre2:pcre2",
        "desktop//cairo:cairo",
        "fonts//libraries/pango:pango",
        "dev-libs//glib:glib",
        "system//libs/font/fribidi:fribidi",
        "desktop//sway:wlroots",
    ],
    visibility = ["PUBLIC"],
)

download_source(
    name = "wlroots-src",
    src_uri = "https://gitlab.freedesktop.org/wlroots/wlroots/-/releases/0.17.1/downloads/wlroots-0.17.1.tar.gz",
    sha256 = "d58d68e3f90d92de4d49fa43b4d75dc78f8af1d920d090729331cefbdfcf361b",
    signature_required=False,
)

meson_package(
    name = "wlroots",
    source = ":wlroots-src",
    version = "0.17.1",
    description = "wlroots - Modular Wayland compositor library",
    homepage = "https://gitlab.freedesktop.org/wlroots/wlroots",
    license = "MIT",
    # Work around pkg-config path resolution issues in cross-compilation
    # where Mesa's dri.pc references libdrm but the resolved include path
    # ends up pointing to mesa/usr/include/libdrm (which doesn't exist)
    env = {"CFLAGS": "-Wno-missing-include-dirs"},
    meson_args = [
        "-Dexamples=false",
        "-Dwerror=false",  # Also disable -Werror for cross-compilation safety
    ],
    deps = [
        "core//libffi:libffi",
        "graphics//rendering/wayland:wayland",
        "graphics//rendering/wayland-protocols:wayland-protocols",
        "graphics//xorg/libxkbcommon:libxkbcommon",
        "desktop//mesa:mesa",
        "desktop//libinput:libinput",
        "desktop//libdrm:libdrm",
        "system//libs/graphics/pixman:pixman",
    ],
    visibility = ["PUBLIC"],
)

# Sway meta-package
filegroup(
    name = "sway-desktop",
    srcs = [
        ":sway",
        ":wlroots",
        "graphics//rendering/wayland:wayland",
        "desktop//mesa:mesa",
    ],
    default_target_platform = "root//platforms:linux-target",
    visibility = ["PUBLIC"],
)
