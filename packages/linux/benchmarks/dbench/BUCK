load("//defs:package.bzl", "package")

# dbench - Database-style benchmark for filesystems
#
# dbench comes with configure.in but not a pre-built configure script,
# and autoreconf fails due to Automake module issues. We use a custom
# build that regenerates the configure script properly.

package(
    build_rule = "binary",
    name = "dbench",
    version = "4.0",
    url = "https://samba.org/ftp/tridge/dbench/dbench-4.0.tar.gz",
    sha256 = "6001893f34e68a3cfeb5d424e1f2bfef005df96a22d86f35dc770c5bccf3aa8a",
    description = "Database-style benchmark for filesystems",
    homepage = "https://samba.org/ftp/tridge/dbench/",
    license = "GPL-3.0",
    deps = [
        "//packages/linux/system/security/cryptsetup:popt",
        "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
        "//packages/linux/dev-tools/build-systems/automake:automake",
        "//packages/linux/dev-tools/build-systems/libtool:libtool",
    ],
    pre_configure_cmds = [
        # dbench needs autoconf to generate configure from configure.in
        "autoconf",
    ],
    install_script = """
mkdir -p "$OUT"
BUILD=$(mktemp -d)
cp -a "$SRCS"/. "$BUILD/"
cd "$BUILD"

./configure --prefix=/usr
make -j${MAKEOPTS:-$(nproc)}

# dbench install target doesn't support DESTDIR properly, install manually
mkdir -p "$OUT/usr/bin"
mkdir -p "$OUT/usr/share"
mkdir -p "$OUT/usr/share/man"

cp dbench tbench tbench_srv "$OUT/usr/bin/"
cp client.txt "$OUT/usr/share/"
cp dbench.1 "$OUT/usr/share/man/"
ln -sf dbench.1 "$OUT/usr/share/man/tbench.1"
ln -sf dbench.1 "$OUT/usr/share/man/tbench_srv.1"
""",
    visibility = ["PUBLIC"],
)
