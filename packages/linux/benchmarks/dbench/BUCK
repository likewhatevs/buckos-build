load("//defs:package_defs.bzl", "download_source", "ebuild_package")

# dbench - Database-style benchmark for filesystems
#
# dbench comes with configure.in but not a pre-built configure script,
# and autoreconf fails due to Automake module issues. We use a custom
# build that regenerates the configure script properly.

download_source(
    name = "dbench-src",
    src_uri = "https://samba.org/ftp/tridge/dbench/dbench-4.0.tar.gz",
    sha256 = "6001893f34e68a3cfeb5d424e1f2bfef005df96a22d86f35dc770c5bccf3aa8a",
    signature_required = False,
)

ebuild_package(
    name = "dbench",
    source = ":dbench-src",
    version = "4.0",
    category = "benchmarks",
    description = "Database-style benchmark for filesystems",
    homepage = "https://samba.org/ftp/tridge/dbench/",
    license = "GPL-3.0",
    depend = [
        "//packages/linux/system/libs/ipc/popt:popt",
    ],
    bdepend = [
        "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
        "//packages/linux/dev-tools/build-systems/automake:automake",
        "//packages/linux/dev-tools/build-systems/libtool:libtool",
    ],

    src_prepare = '''
# dbench needs autoconf to generate configure from configure.in
autoconf
''',

    src_configure = '''
./configure --prefix=/usr
''',

    src_compile = '''
make -j$(nproc)
''',

    src_install = '''
# dbench install target doesn't support DESTDIR properly, install manually
mkdir -p "$DESTDIR/usr/bin"
mkdir -p "$DESTDIR/usr/share"
mkdir -p "$DESTDIR/usr/share/man"

cp dbench tbench tbench_srv "$DESTDIR/usr/bin/"
cp client.txt "$DESTDIR/usr/share/"
cp dbench.1 "$DESTDIR/usr/share/man/"
ln -sf dbench.1 "$DESTDIR/usr/share/man/tbench.1"
ln -sf dbench.1 "$DESTDIR/usr/share/man/tbench_srv.1"
''',

    visibility = ["PUBLIC"],
)
