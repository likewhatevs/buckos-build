load("@root//defs:package_defs.bzl", "download_source", "binary_package")

download_source(
    name = "scx-scheds-src",
    src_uri = "https://github.com/sched-ext/scx/archive/refs/tags/v1.0.7.tar.gz",
    sha256 = "379bc6adb99ea638f9452f2b735e3f4aae586c9a4b9c44cb0deec74de3f36a83",
    signature_required = False,
)

binary_package(
    name = "scx-scheds",
    srcs = [":scx-scheds-src"],
    version = "1.0.7",
    description = "sched_ext schedulers and tools - BPF-based CPU schedulers",
    homepage = "https://github.com/sched-ext/scx",
    license = "GPL-2.0",
    install_script = """
        cd $SRCS

        # Add Rust/Cargo to PATH from dependencies
        for dep in $DEPS; do
            if [ -x "$dep/usr/bin/cargo" ]; then
                export PATH="$dep/usr/bin:$PATH"
                echo "Found Cargo at $dep/usr/bin"
            fi
        done

        echo "PATH=$PATH"
        echo "Using cargo: $(which cargo || echo 'NOT FOUND')"

        # Find libbpf.a in dependency paths
        LIBBPF_A=""
        for dep in $DEPS; do
            if [ -f "$dep/usr/lib/libbpf.a" ]; then
                LIBBPF_A="$dep/usr/lib/libbpf.a"
                break
            fi
        done

        # If not found, use system libbpf if available, or build without static
        if [ -z "$LIBBPF_A" ] && [ -f "/usr/lib64/libbpf.a" ]; then
            LIBBPF_A="/usr/lib64/libbpf.a"
        fi

        LIBBPF_OPT=""
        if [ -n "$LIBBPF_A" ]; then
            echo "Using libbpf.a: $LIBBPF_A"
            LIBBPF_OPT="-Dlibbpf_a=$LIBBPF_A"
        else
            echo "WARNING: libbpf.a not found, using dynamic linking"
        fi

        # Build scx schedulers using meson
        # Let it fetch and build its own bpftool/libbpf for proper integration
        meson setup build \
            --prefix=/usr \
            -Dsystemd=disabled \
            -Doffline=false \
            $LIBBPF_OPT

        # Add built bpftool to PATH before compile
        export PATH="$(pwd)/build/bpftool/src:$PATH"

        meson compile -C build

        # Install
        mkdir -p $OUT/usr/bin $OUT/usr/share/scx

        # Install scheduler binaries
        for sched in build/scheds/rust/scx_*; do
            if [ -f "$sched" ] && [ -x "$sched" ]; then
                cp "$sched" $OUT/usr/bin/
            fi
        done

        # Install C schedulers if present
        for sched in build/scheds/c/scx_*; do
            if [ -f "$sched" ] && [ -x "$sched" ]; then
                cp "$sched" $OUT/usr/bin/
            fi
        done

        # Install scx_loader if present
        if [ -f build/rust/scx_loader/scx_loader ]; then
            cp build/rust/scx_loader/scx_loader $OUT/usr/bin/
        fi
    """,
    deps = [
        "core//zlib:zlib",
        "dev-tools//dev-utils/elfutils:elfutils",
        "system//libs/bpf/libbpf:libbpf",
        "lang//rust:rust",
    ],
    visibility = ["PUBLIC"],
)
