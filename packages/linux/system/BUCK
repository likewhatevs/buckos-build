load("//defs:package_defs.bzl", "binary_package", "rootfs", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags")
load("//defs:package_defs.bzl", "binary_package", "rootfs", "initramfs", "dracut_initramfs", "qemu_boot_script", "iso_image", "stage3_tarball", "autotools_package")

# =============================================================================
# Helper files for live environment
export_file(
    name = "plasma-env-sh",
    src = "files/plasma-env.sh",
    visibility = ["PUBLIC"],
)

# =============================================================================
# Base system files - Essential configuration and scripts
# Init script for BusyBox init
genrule(
    name = "init-scripts-gen",
    out = "init-scripts",
    cmd = """
mkdir -p $OUT/etc/init.d
mkdir -p $OUT/etc/rc.d
# Create inittab for busybox init
cat > $OUT/etc/inittab << 'INITTAB'
# /etc/inittab - BusyBox init configuration
# System initialization
::sysinit:/etc/init.d/rcS
# Start a shell on the console
::respawn:/bin/sh
# What to do when restarting the init process
::restart:/sbin/init
# What to do before rebooting
::ctrlaltdel:/sbin/reboot
::shutdown:/bin/umount -a -r
::shutdown:/sbin/swapoff -a
INITTAB
# Create rcS startup script
cat > $OUT/etc/init.d/rcS << 'RCS'
#!/bin/sh
# System initialization script
echo "BuckOs Linux - Booting..."
# Mount essential filesystems
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs devtmpfs /dev || mount -t tmpfs tmpfs /dev
# Create essential device nodes if devtmpfs failed
if [ ! -c /dev/null ]; then
    mknod -m 666 /dev/null c 1 3
    mknod -m 666 /dev/zero c 1 5
    mknod -m 666 /dev/random c 1 8
    mknod -m 666 /dev/urandom c 1 9
    mknod -m 600 /dev/console c 5 1
    mknod -m 666 /dev/tty c 5 0
    mknod -m 660 /dev/ttyS0 c 4 64
fi
# Mount /dev/pts for pseudo-terminals
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts
# Mount /run
mount -t tmpfs tmpfs /run
# Set hostname
hostname buckos
# Configure loopback
ip link set lo up
echo "System initialization complete."
RCS
chmod +x $OUT/etc/init.d/rcS
# Create fstab
cat > $OUT/etc/fstab << 'FSTAB'
# /etc/fstab - Static file system information
# <file system>  <mount point>  <type>  <options>         <dump>  <pass>
proc             /proc          proc    defaults          0       0
sysfs            /sys           sysfs   defaults          0       0
devtmpfs         /dev           devtmpfs defaults         0       0
tmpfs            /tmp           tmpfs   defaults,nodev    0       0
tmpfs            /run           tmpfs   defaults,nodev    0       0
FSTAB
# Create passwd
cat > $OUT/etc/passwd << 'PASSWD'
root:x:0:0:root:/root:/bin/sh
bin:x:1:1:bin:/dev/null:/bin/false
daemon:x:2:2:daemon:/dev/null:/bin/false
messagebus:x:81:81:System Message Bus:/dev/null:/bin/false
systemd-journal:x:190:190:systemd Journal:/dev/null:/bin/false
systemd-network:x:192:192:systemd Network Management:/dev/null:/bin/false
systemd-resolve:x:193:193:systemd Resolver:/dev/null:/bin/false
systemd-timesync:x:194:194:systemd Time Synchronization:/dev/null:/bin/false
nobody:x:65534:65534:Nobody:/:/bin/false
PASSWD
# Create group
cat > $OUT/etc/group << 'GROUP'
root:x:0:
bin:x:1:
daemon:x:2:
sys:x:3:
adm:x:4:
tty:x:5:
disk:x:6:
lp:x:7:
mem:x:8:
kmem:x:9:
wheel:x:10:root,live
cdrom:x:11:
mail:x:12:
man:x:15:
dialout:x:18:
floppy:x:19:
games:x:20:
utmp:x:22:
tape:x:26:
video:x:27:
audio:x:29:
messagebus:x:81:
input:x:97:
kvm:x:78:
render:x:109:
sgx:x:106:
users:x:100:
systemd-journal:x:190:
systemd-network:x:192:
systemd-resolve:x:193:
systemd-timesync:x:194:
nobody:x:65534:
GROUP
# Create shadow (empty password for root - LOGIN REQUIRES SETTING PASSWORD)
cat > $OUT/etc/shadow << 'SHADOW'
root::0:0:99999:7:::
bin:!:0:0:99999:7:::
daemon:!:0:0:99999:7:::
messagebus:!:0:0:99999:7:::
systemd-journal:!:0:0:99999:7:::
systemd-network:!:0:0:99999:7:::
systemd-resolve:!:0:0:99999:7:::
systemd-timesync:!:0:0:99999:7:::
nobody:!:0:0:99999:7:::
SHADOW
chmod 640 $OUT/etc/shadow
# Create shells
cat > $OUT/etc/shells << 'SHELLS'
/bin/sh
/bin/ash
/bin/bash
/usr/bin/bash
SHELLS
# Create hostname
echo "buckos" > $OUT/etc/hostname
# Create hosts
cat > $OUT/etc/hosts << 'HOSTS'
127.0.0.1   localhost
127.0.1.1   buckos
::1         localhost ip6-localhost ip6-loopback
HOSTS
# Create resolv.conf
cat > $OUT/etc/resolv.conf << 'RESOLV'
# DNS configuration
nameserver 8.8.8.8
nameserver 8.8.4.4
RESOLV
# Create os-release
cat > $OUT/etc/os-release << 'OSRELEASE'
NAME="BuckOs Linux"
VERSION="0.1"
ID=buckos
ID_LIKE=gentoo
PRETTY_NAME="BuckOs Linux 0.1"
HOME_URL="https://github.com/hodgesds/buckos-build"
OSRELEASE
# Create profile
cat > $OUT/etc/profile << 'PROFILE'
# /etc/profile - System-wide shell profile
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export PS1='\\u@\\h:\\w\\$ '
export TERM=linux
# Set up home directory
cd ~
PROFILE
# Create issue (login banner)
cat > $OUT/etc/issue << 'ISSUE'
BuckOs Linux 0.1
Kernel \\r on \\m
ISSUE
""",
    visibility = ["PUBLIC"],
)
# Package the init scripts
filegroup(
    name = "init-scripts",
    srcs = [":init-scripts-gen"],
    default_target_platform = "//platforms:linux-target",
    visibility = ["PUBLIC"],
)

# Baselayout - Core filesystem layout
genrule(
    name = "baselayout-gen",
    out = "baselayout",
    cmd = """
mkdir -p $OUT
# Create merged-usr FHS directory structure
# First create the real directories in /usr
mkdir -p $OUT/usr/bin
mkdir -p $OUT/usr/sbin
mkdir -p $OUT/usr/lib
mkdir -p $OUT/usr/lib64
# Then create symlinks from / to /usr (merged-usr layout)
ln -s usr/bin $OUT/bin
ln -s usr/sbin $OUT/sbin
ln -s usr/lib $OUT/lib
ln -s usr/lib64 $OUT/lib64
# Create /usr/bin/sh symlink to bash (required for #!/bin/sh scripts in initramfs)
ln -s bash $OUT/usr/bin/sh
mkdir -p $OUT/usr/share
mkdir -p $OUT/usr/include
mkdir -p $OUT/usr/local/bin
mkdir -p $OUT/usr/local/sbin
mkdir -p $OUT/usr/local/lib
mkdir -p $OUT/etc
mkdir -p $OUT/var/log
mkdir -p $OUT/var/tmp
mkdir -p $OUT/tmp
mkdir -p $OUT/proc
mkdir -p $OUT/sys
mkdir -p $OUT/dev
mkdir -p $OUT/run
mkdir -p $OUT/run/lock
mkdir -p $OUT/run/user
mkdir -p $OUT/root
mkdir -p $OUT/home
mkdir -p $OUT/mnt
mkdir -p $OUT/opt
mkdir -p $OUT/boot
# Create systemd-compatible symlinks (fixes systemd taints)
ln -s ../run $OUT/var/run
ln -s ../run/lock $OUT/var/lock
# Set permissions
chmod 1777 $OUT/tmp
chmod 1777 $OUT/var/tmp
chmod 700 $OUT/root

# Create /etc/shells - list of valid login shells
cat > $OUT/etc/shells << 'SHELLS'
/bin/sh
/bin/bash
/usr/bin/sh
/usr/bin/bash
SHELLS

# Create locale.conf - UTF-8 locale required for KDE and GUI applications
cat > $OUT/etc/locale.conf << 'LOCALECONF'
LANG=en_US.UTF-8
LC_COLLATE=C
LOCALECONF

# Create locale.gen for locale generation
cat > $OUT/etc/locale.gen << 'LOCALEGEN'
en_US.UTF-8 UTF-8
en_US ISO-8859-1
LOCALEGEN

# Create tmpfiles.d directory and utmp configuration
mkdir -p $OUT/usr/lib/tmpfiles.d
cat > $OUT/usr/lib/tmpfiles.d/utmp.conf << 'UTMPCONF'
# utmp/wtmp/lastlog files for login records
# f = create file if it doesn't exist
# Format: f path mode user group age argument
# Use /run/utmp (NOT /var/run/utmp) since /var/run is a symlink to /run
f /run/utmp 0664 root utmp -
f /var/log/wtmp 0664 root utmp -
f /var/log/lastlog 0664 root utmp -
UTMPCONF
""",
    visibility = ["PUBLIC"],
)

filegroup(
    name = "baselayout",
    srcs = [":baselayout-gen"],
    default_target_platform = "//platforms:linux-target",
    visibility = ["PUBLIC"],
)

# =============================================================================
# Live ISO Configuration Targets
# =============================================================================

# DBus session policy for live environment
genrule(
    name = "live-dbus-policy-gen",
    out = "live-dbus-policy",
    cmd = """
mkdir -p $OUT/etc/dbus-1/system.d

cat > $OUT/etc/dbus-1/system.d/10-allow-session-creation.conf << 'DBUSEOF'
<?xml version="1.0"?>
<!DOCTYPE busconfig PUBLIC "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
        "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
<busconfig>
        <!-- Allow all users to create sessions via pam_systemd -->
        <policy context="default">
                <allow send_destination="org.freedesktop.login1"
                       send_interface="org.freedesktop.login1.Manager"
                       send_member="CreateSession"/>
                <allow send_destination="org.freedesktop.login1"
                       send_interface="org.freedesktop.login1.Manager"
                       send_member="CreateSessionWithPIDFD"/>
        </policy>
</busconfig>
DBUSEOF
""",
    visibility = ["PUBLIC"],
)

# Plasma Login Manager configuration (like CachyOS)
genrule(
    name = "live-plasmalogin-config-gen",
    out = "live-plasmalogin-config",
    cmd = """
# Main plasmalogin.conf
mkdir -p $OUT/etc
cat > $OUT/etc/plasmalogin.conf << 'PLASMALOGINCFG'
[Autologin]
User=live
Session=plasma.desktop
Relogin=false

[Users]
MinimumUid=100
MaximumUid=60000
PLASMALOGINCFG

# Autologin drop-in (like CachyOS)
mkdir -p $OUT/etc/plasmalogin.conf.d
cat > $OUT/etc/plasmalogin.conf.d/autologin.conf << 'AUTOLOGINEOF'
[Autologin]
User=live
Session=plasma.desktop
Relogin=false

[Users]
MinimumUid=100
MaximumUid=60000
AUTOLOGINEOF

# Create custom wayland-session wrapper that sets XDG_RUNTIME_DIR and starts D-Bus
mkdir -p $OUT/usr/local/bin
cat > $OUT/usr/local/bin/wayland-session-wrapper << 'WRAPPEREOF'
#!/bin/sh
# Wayland session wrapper for BuckOS live environment
# Sets XDG_RUNTIME_DIR and starts D-Bus session

# Set XDG_RUNTIME_DIR for live user (UID 1000)
export XDG_RUNTIME_DIR="/run/user/1000"

# Ensure the directory exists with correct permissions
if [ ! -d "/run/user/1000" ]; then
    mkdir -p /run/user/1000 2>/dev/null || true
    chmod 700 /run/user/1000 2>/dev/null || true
    chown 1000:1000 /run/user/1000 2>/dev/null || true
fi

# Set XDG base directories
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_CACHE_HOME="$HOME/.cache"
export XDG_STATE_HOME="$HOME/.local/state"

# Create XDG directories
mkdir -p "$XDG_CONFIG_HOME" "$XDG_DATA_HOME" "$XDG_CACHE_HOME" "$XDG_STATE_HOME" 2>/dev/null || true

# Start D-Bus session if not already running
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    # Start dbus-daemon directly and export its address
    eval `dbus-launch --sh-syntax`
    export DBUS_SESSION_BUS_ADDRESS
fi

# Now exec the actual session command directly (bypass plasma-dbus-run-session-if-needed)
# The session command is passed as the first argument
SESSION_CMD="$1"
shift

# If session command contains plasma-dbus-run-session-if-needed, skip it and run startplasma directly
case "$SESSION_CMD" in
    *plasma-dbus-run-session-if-needed*)
        # Extract the actual command (startplasma-wayland)
        exec /usr/bin/startplasma-wayland
        ;;
    *)
        exec $SESSION_CMD "$@"
        ;;
esac
WRAPPEREOF
chmod 755 $OUT/usr/local/bin/wayland-session-wrapper

# Create script to ensure runtime directories exist before plasmalogin starts
mkdir -p $OUT/usr/local/bin
cat > $OUT/usr/local/bin/plasmalogin-pre-start.sh << 'PRESTARTEOF'
#!/bin/bash
set -x  # Debug output

# Run ALL tmpfiles.d configs to set up directories with proper ownership
systemd-tmpfiles --create 2>/dev/null || true

# Fix polkit directories - must be owned by polkitd (UID 87)
mkdir -p /etc/polkit-1/rules.d
mkdir -p /usr/share/polkit-1/rules.d
chown -R 87:87 /etc/polkit-1/rules.d
chown -R 87:87 /usr/share/polkit-1/rules.d
chmod 700 /etc/polkit-1/rules.d
chmod 700 /usr/share/polkit-1/rules.d

# Ensure /run/user directory exists
mkdir -p /run/user
chmod 755 /run/user

# Ensure /run/user/1000 exists for live user (UID 1000)
mkdir -p /run/user/1000
chown 1000:1000 /run/user/1000
chmod 700 /run/user/1000

# Ensure home directories exist with correct ownership
mkdir -p /home/live/Desktop
chown -R 1000:1000 /home/live

# Restart polkit now that permissions are fixed
systemctl restart polkit 2>/dev/null || true

echo "plasmalogin pre-start completed"
PRESTARTEOF
chmod 755 $OUT/usr/local/bin/plasmalogin-pre-start.sh

# kwin_wayland service override (from CachyOS) - disables lockscreen for live environment
mkdir -p "$OUT/etc/skel/.config/systemd/user/plasma-login-kwin_wayland.service.d"
cat > "$OUT/etc/skel/.config/systemd/user/plasma-login-kwin_wayland.service.d/override.conf" << 'KWINEOF'
[Service]
ExecStart=
ExecStart=/usr/bin/kwin_wayland --no-lockscreen --no-global-shortcuts --no-kactivities --locale1
KWINEOF

# Also put it in home/live directly
mkdir -p "$OUT/home/live/.config/systemd/user/plasma-login-kwin_wayland.service.d"
cp "$OUT/etc/skel/.config/systemd/user/plasma-login-kwin_wayland.service.d/override.conf" \
   "$OUT/home/live/.config/systemd/user/plasma-login-kwin_wayland.service.d/override.conf"

# logind config to not suspend (like CachyOS)
mkdir -p "$OUT/etc/systemd/logind.conf.d"
cat > "$OUT/etc/systemd/logind.conf.d/do-not-suspend.conf" << 'LOGINDEOF'
[Login]
HandleSuspendKey=ignore
HandleHibernateKey=ignore
HandleLidSwitch=ignore
LOGINDEOF

# Module loading for hardware support (WiFi, USB, etc.)
mkdir -p "$OUT/etc/modules-load.d"

# Common WiFi modules
cat > "$OUT/etc/modules-load.d/wifi.conf" << 'WIFIEOF'
# Common WiFi drivers
cfg80211
mac80211
# Intel WiFi
iwlwifi
iwlmvm
# Atheros
ath9k
ath10k_pci
# Realtek
rtw88_pci
rtw89_pci
# Broadcom (open source)
brcmfmac
WIFIEOF

# USB modules
cat > "$OUT/etc/modules-load.d/usb.conf" << 'USBEOF'
# USB storage
usb_storage
uas
# USB HID (keyboard, mouse)
usbhid
hid_generic
USBEOF

# Input modules
cat > "$OUT/etc/modules-load.d/input.conf" << 'INPUTEOF'
# Input devices
evdev
uinput
INPUTEOF

# DRM/Graphics modules
# Note: drm, drm_kms_helper, virtio_gpu, bochs, qxl are built-in (=y) in live kernel
# Only list actual modules here
cat > "$OUT/etc/modules-load.d/drm.conf" << 'DRMEOF'
# i915 for Intel GPUs (if present as module)
# i915
# nouveau for NVIDIA GPUs (if present as module)
# nouveau
# amdgpu for AMD GPUs (if present as module)
# amdgpu
DRMEOF

# Network modules
cat > "$OUT/etc/modules-load.d/network.conf" << 'NETEOF'
# Virtio network for QEMU
virtio_net
# Common Ethernet drivers
e1000e
r8169
igc
NETEOF

# =============================================================================
# Systemd getty auto-login (since we don't have plasma-login-manager)
# =============================================================================

# Create getty@tty1 override for auto-login
mkdir -p "$OUT/etc/systemd/system/getty@tty1.service.d"
cat > "$OUT/etc/systemd/system/getty@tty1.service.d/autologin.conf" << 'GETTYEOF'
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin live --noclear %I $TERM
Type=idle
GETTYEOF

# Create .bash_profile for live user to start Plasma Wayland on tty1
mkdir -p "$OUT/home/live"
cat > "$OUT/home/live/.bash_profile" << 'PROFILEEOF'
# BuckOS Live - Auto-start Plasma Wayland on tty1

# Only start on tty1 and if not already in a graphical session
if [ "`tty`" = "/dev/tty1" ] && [ -z "$WAYLAND_DISPLAY" ] && [ -z "$DISPLAY" ]; then
    # Set up XDG runtime directory
    export XDG_RUNTIME_DIR="/run/user/1000"

    # Ensure runtime directory exists
    if [ ! -d "$XDG_RUNTIME_DIR" ]; then
        sudo mkdir -p "$XDG_RUNTIME_DIR"
        sudo chown 1000:1000 "$XDG_RUNTIME_DIR"
        sudo chmod 700 "$XDG_RUNTIME_DIR"
    fi

    # Set XDG base directories
    export XDG_CONFIG_HOME="$HOME/.config"
    export XDG_DATA_HOME="$HOME/.local/share"
    export XDG_CACHE_HOME="$HOME/.cache"
    export XDG_STATE_HOME="$HOME/.local/state"

    # Create directories if needed
    mkdir -p "$XDG_CONFIG_HOME" "$XDG_DATA_HOME" "$XDG_CACHE_HOME" "$XDG_STATE_HOME"

    # Qt and KDE paths
    export QT_PLUGIN_PATH="/usr/lib64/plugins:/usr/lib64/qt6/plugins"
    export QML_IMPORT_PATH="/usr/lib64/qml"
    export QML2_IMPORT_PATH="/usr/lib64/qml"
    export XDG_DATA_DIRS="/usr/share:/usr/local/share"

    # Start Plasma Wayland session
    export PLASMA_SKIP_SPLASH=1  # Skip splash screen to avoid KSplash wait timeout
    echo "Starting Plasma Wayland session..."
    exec dbus-run-session startplasma-wayland
fi

# Source .bashrc for interactive shells
if [ -f ~/.bashrc ]; then
    . ~/.bashrc
fi
PROFILEEOF

# Also create it in /etc/skel
mkdir -p "$OUT/etc/skel"
cp "$OUT/home/live/.bash_profile" "$OUT/etc/skel/.bash_profile"

# Enable getty@tty1 (create symlink for systemd)
mkdir -p "$OUT/etc/systemd/system/getty.target.wants"
ln -sf /lib/systemd/system/getty@.service "$OUT/etc/systemd/system/getty.target.wants/getty@tty1.service"

# Create symlink for pam_systemd.so (systemd installs to lib64, pam looks in lib)
mkdir -p "$OUT/usr/lib/security"
ln -sf ../../lib64/security/pam_systemd.so "$OUT/usr/lib/security/pam_systemd.so"

# Fix user@.service to set XDG_RUNTIME_DIR (needed for user systemd instance)
mkdir -p "$OUT/etc/systemd/system/user@.service.d"
cat > "$OUT/etc/systemd/system/user@.service.d/runtime.conf" << 'USERSERVICEEOF'
[Service]
Environment=XDG_RUNTIME_DIR=/run/user/%i
USERSERVICEEOF
""",
    visibility = ["PUBLIC"],
)

# Users and groups for live environment
# This is the authoritative source for /etc/passwd, /etc/group, /etc/shadow
# Contains all system users and proper group memberships for the live user
genrule(
    name = "live-users-gen",
    out = "live-users",
    cmd = """
mkdir -p $OUT/etc
mkdir -p $OUT/home/live
mkdir -p $OUT/var/empty
mkdir -p $OUT/root

echo "buckos-live" > $OUT/etc/hostname

# Complete passwd with all system users
cat > $OUT/etc/passwd << 'PASSWDEOF'
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/dev/null:/bin/false
daemon:x:2:2:daemon:/dev/null:/bin/false
messagebus:x:81:81:System Message Bus:/dev/null:/bin/false
polkitd:x:87:87:PolicyKit Daemon:/var/empty:/sbin/nologin
systemd-journal:x:190:190:systemd Journal:/dev/null:/bin/false
systemd-network:x:192:192:systemd Network Management:/dev/null:/bin/false
systemd-resolve:x:193:193:systemd Resolver:/dev/null:/bin/false
systemd-timesync:x:194:194:systemd Time Synchronization:/dev/null:/bin/false
live:x:1000:1000:Live User:/home/live:/bin/bash
nobody:x:65534:65534:Nobody:/:/bin/false
PASSWDEOF

# Complete group with all system groups and live user memberships
# CRITICAL: live user MUST be in wheel, video, audio, input, render, etc.
cat > $OUT/etc/group << 'GROUPEOF'
root:x:0:
bin:x:1:
daemon:x:2:
sys:x:3:live
adm:x:4:
tty:x:5:live
disk:x:6:
lp:x:7:live
mem:x:8:
kmem:x:9:
wheel:x:10:root,live
cdrom:x:11:live
mail:x:12:
man:x:15:
dialout:x:18:live
floppy:x:19:
games:x:20:
utmp:x:22:live
tape:x:26:
video:x:27:live,root
audio:x:29:live,root
messagebus:x:81:
polkitd:x:87:
network:x:90:live
storage:x:91:live
rfkill:x:92:live
kvm:x:78:live
input:x:97:live,root
users:x:100:live
sgx:x:106:
render:x:109:live,root
systemd-journal:x:190:
systemd-network:x:192:
systemd-resolve:x:193:
systemd-timesync:x:194:
seat:x:985:root
live:x:1000:
nopasswdlogin:x:1001:live
autologin:x:1002:live
nobody:x:65534:
GROUPEOF

# Shadow file - password for root and live is "buckos"
# Hash: python3 -c "import crypt; print(crypt.crypt('buckos', crypt.mksalt(crypt.METHOD_SHA512)))"
cat > $OUT/etc/shadow << 'SHADOWEOF'
root:$6$XxYSRB9p2uZQDqdN$5y91468svaBTNkjBI9Z18f/Tw019c6QmeyhcWpa4FcHHdleWagixJvhK0tWMNW20XZwzn0AWw9iTSYN7Ed1zF/:19000:0:99999:7:::
bin:!:0:0:99999:7:::
daemon:!:0:0:99999:7:::
messagebus:!:0:0:99999:7:::
polkitd:!:19000::::::
systemd-journal:!:0:0:99999:7:::
systemd-network:!:0:0:99999:7:::
systemd-resolve:!:0:0:99999:7:::
systemd-timesync:!:0:0:99999:7:::
live:$6$XxYSRB9p2uZQDqdN$5y91468svaBTNkjBI9Z18f/Tw019c6QmeyhcWpa4FcHHdleWagixJvhK0tWMNW20XZwzn0AWw9iTSYN7Ed1zF/:19000:0:99999:7:::
nobody:!:0:0:99999:7:::
SHADOWEOF
chmod 640 $OUT/etc/shadow
chmod 755 $OUT/home/live
chmod 755 $OUT/var/empty
""",
    visibility = ["PUBLIC"],
)

# Systemd tmpfiles configuration for live environment
genrule(
    name = "live-tmpfiles-gen",
    out = "live-tmpfiles",
    cmd = """
mkdir -p $OUT/etc/tmpfiles.d
cat > $OUT/etc/tmpfiles.d/live-session.conf << 'TMPFILESEOF'
# Session tracking files for PAM - owned by utmp group for login records
# Use /run/utmp (NOT /var/run/utmp) since /var/run is a symlink to /run
f /run/utmp 0664 root utmp -
f /var/log/wtmp 0664 root utmp -
f /var/log/lastlog 0664 root utmp -

# XDG Runtime Directory for live user
# This ensures /run/user/1000 exists before systemd-logind tries to use it
# systemd-logind will set proper permissions when pam_systemd runs
d /run/user 0755 root root -
d /run/user/1000 0700 live live -

# Live user home directory
d /home/live 0755 live live -
d /home/live/Desktop 0755 live live -
d /home/live/.cache 0755 live live -
d /home/live/.config 0755 live live -
d /home/live/.local 0755 live live -
d /home/live/.local/share 0755 live live -

# Fontconfig cache directory (writable for font caching)
d /var/cache/fontconfig 0755 root root -
TMPFILESEOF

# Create PAM environment configuration to ensure XDG_RUNTIME_DIR is set
mkdir -p $OUT/etc/security
cat > $OUT/etc/security/pam_env.conf << 'PAMENVEOF'
# PAM environment variables configuration
# Ensure XDG_RUNTIME_DIR is set for all users
XDG_RUNTIME_DIR DEFAULT=/run/user/@{UID}
PAMENVEOF

# Configure UTF-8 locale - use C.UTF-8 which is built into glibc 2.35+
# No locale generation needed - C.UTF-8 is always available
mkdir -p $OUT/etc
cat > $OUT/etc/locale.conf << 'LOCALEEOF'
LANG=C.UTF-8
LOCALEEOF

# Set environment variables for UTF-8 locale system-wide
mkdir -p $OUT/etc/profile.d
cat > $OUT/etc/profile.d/locale.sh << 'PROFILEEOF'
export LANG=C.UTF-8
PROFILEEOF
chmod 755 $OUT/etc/profile.d/locale.sh

""",
    visibility = ["PUBLIC"],
)

# System-wide environment configuration (must be applied after PAM to override its empty /etc/environment)
genrule(
    name = "live-environment-gen",
    out = "live-environment",
    cmd = """
mkdir -p $OUT/etc
# Set LANG for all systemd services and user sessions
cat > $OUT/etc/environment << 'ENVEOF'
# System-wide locale configuration
# This file is read by pam_env and systemd
LANG=C.UTF-8
ENVEOF

# Also create the locale directory structure
mkdir -p $OUT/usr/lib/locale
""",
    visibility = ["PUBLIC"],
)

# Fontconfig symlinks to enable installed fonts
genrule(
    name = "fontconfig-symlinks-gen",
    out = "fontconfig-symlinks",
    cmd = """
mkdir -p $OUT/etc/fonts/conf.d

# Enable dejavu fonts configuration
for conf in 57-dejavu-sans.conf 57-dejavu-sans-mono.conf 57-dejavu-serif.conf \
            20-unhint-small-dejavu-sans.conf 20-unhint-small-dejavu-sans-mono.conf 20-unhint-small-dejavu-serif.conf; do
    ln -sf ../conf.avail/$conf $OUT/etc/fonts/conf.d/$conf 2>/dev/null || true
done

# Enable liberation fonts configuration if available
for conf in 60-liberation.conf; do
    ln -sf ../conf.avail/$conf $OUT/etc/fonts/conf.d/$conf 2>/dev/null || true
done

# Create fonts cache directory
mkdir -p $OUT/var/cache/fontconfig

# Set up default cursor theme (breeze_cursors)
mkdir -p $OUT/usr/share/icons/default
cat > $OUT/usr/share/icons/default/index.theme << 'CURSOREOF'
[Icon Theme]
Name=Default
Comment=Default Cursor Theme
Inherits=breeze_cursors
CURSOREOF

# Also create cursor symlink for X compatibility
mkdir -p $OUT/usr/share/cursors/xorg-x11
ln -sf ../../icons/breeze_cursors $OUT/usr/share/cursors/xorg-x11/default 2>/dev/null || true

# Create local.conf for additional font settings
mkdir -p $OUT/etc/fonts
cat > $OUT/etc/fonts/local.conf << 'LOCALCONFEOF'
<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "urn:fontconfig:fonts.dtd">
<fontconfig>
  <!-- Prefer DejaVu fonts for common generic families -->
  <alias>
    <family>sans-serif</family>
    <prefer>
      <family>DejaVu Sans</family>
      <family>Liberation Sans</family>
    </prefer>
  </alias>
  <alias>
    <family>serif</family>
    <prefer>
      <family>DejaVu Serif</family>
      <family>Liberation Serif</family>
    </prefer>
  </alias>
  <alias>
    <family>monospace</family>
    <prefer>
      <family>DejaVu Sans Mono</family>
      <family>Liberation Mono</family>
    </prefer>
  </alias>
  <!-- Enable antialiasing and hinting -->
  <match target="font">
    <edit name="antialias" mode="assign"><bool>true</bool></edit>
    <edit name="hinting" mode="assign"><bool>true</bool></edit>
    <edit name="hintstyle" mode="assign"><const>hintslight</const></edit>
    <edit name="rgba" mode="assign"><const>rgb</const></edit>
    <edit name="lcdfilter" mode="assign"><const>lcddefault</const></edit>
  </match>
</fontconfig>
LOCALCONFEOF

# Create KDE configuration for cursor theme
mkdir -p $OUT/etc/xdg
cat > $OUT/etc/xdg/kcminputrc << 'KCMINPUTEOF'
[Mouse]
cursorTheme=breeze_cursors
cursorSize=24
KCMINPUTEOF

# Create KDE kdeglobals for fonts and general settings
cat > $OUT/etc/xdg/kdeglobals << 'KDEGLOBALSEOF'
[General]
fixed=DejaVu Sans Mono,10,-1,5,50,0,0,0,0,0
font=DejaVu Sans,10,-1,5,50,0,0,0,0,0
menuFont=DejaVu Sans,10,-1,5,50,0,0,0,0,0
smallestReadableFont=DejaVu Sans,8,-1,5,50,0,0,0,0,0
toolBarFont=DejaVu Sans,10,-1,5,50,0,0,0,0,0

[Icons]
Theme=breeze

[KDE]
LookAndFeelPackage=org.kde.breeze.desktop
SingleClick=false
widgetStyle=breeze
KDEGLOBALSEOF

# Create KWin cursor configuration
cat > $OUT/etc/xdg/kwinrc << 'KWINRCEOF'
[Wayland]
InputMethod=

[org.kde.kdecoration2]
library=org.kde.breeze
theme=Breeze
KWINRCEOF

# Create Plasma desktop theme configuration
cat > $OUT/etc/xdg/plasmarc << 'PLASMARCEOF'
[Theme]
name=breeze-light
PLASMARCEOF
""",
    visibility = ["PUBLIC"],
)

# Polkit rules for live session (allow session management without authentication)
genrule(
    name = "polkit-live-rules-gen",
    out = "polkit-live-rules",
    cmd = """
mkdir -p $OUT/etc/polkit-1/rules.d
mkdir -p $OUT/usr/share/polkit-1/rules.d
mkdir -p $OUT/etc/tmpfiles.d

# Allow all actions for wheel group members (like CachyOS live ISO)
cat > $OUT/etc/polkit-1/rules.d/49-nopasswd-wheel.rules << 'POLKITRULES'
/* Allow members of the wheel group to execute any actions
 * without password authentication, similar to "sudo NOPASSWD:"
 * This is required for live session where the user needs full access.
 */
polkit.addRule(function(action, subject) {
    if (subject.isInGroup("wheel")) {
        return polkit.Result.YES;
    }
});
POLKITRULES
chmod 644 $OUT/etc/polkit-1/rules.d/49-nopasswd-wheel.rules

# Create tmpfiles.d config to set correct polkit ownership at boot
# polkitd user (UID 87) must own the rules.d directories
cat > $OUT/etc/tmpfiles.d/polkit-rules.conf << 'TMPFILESEOF'
# Polkit rules directories must be owned by polkitd
d /etc/polkit-1/rules.d 0700 polkitd polkitd -
d /usr/share/polkit-1/rules.d 0700 polkitd polkitd -
TMPFILESEOF
""",
    visibility = ["PUBLIC"],
)

# Login tracking files (utmp/wtmp/btmp) for live session
# NOTE: Do NOT create static utmp files here - they must be created at runtime
# by systemd-tmpfiles on the tmpfs-mounted /run, otherwise they'll be read-only
# in the squashfs layer and cause "permission denied" errors.
# See live-tmpfiles-gen for the tmpfiles.d config that creates these at boot.
genrule(
    name = "live-utmp-gen",
    out = "live-utmp",
    cmd = """
# Create directory structure for log files (but NOT the files themselves for /run)
# /run is mounted as tmpfs by systemd, so files there are created by tmpfiles.d
mkdir -p $OUT/var/log

# Create wtmp/btmp/lastlog in /var/log (these are on the overlay, not tmpfs)
# They need to exist and be writable
touch $OUT/var/log/wtmp
touch $OUT/var/log/btmp
touch $OUT/var/log/lastlog
chmod 664 $OUT/var/log/wtmp
chmod 600 $OUT/var/log/btmp
chmod 664 $OUT/var/log/lastlog

# Ensure /var/run is a symlink to /run (standard FHS)
mkdir -p $OUT/var
ln -sf ../run $OUT/var/run
""",
    visibility = ["PUBLIC"],
)

# Desktop installer shortcut
genrule(
    name = "live-desktop-gen",
    out = "live-desktop",
    srcs = [":plasma-env-sh"],
    cmd = """
mkdir -p $OUT/home/live/Desktop

# Create sudoers rule for buckos-installer (allows live user to run without password)
mkdir -p $OUT/etc/sudoers.d
cat > $OUT/etc/sudoers.d/buckos-installer << 'SUDOERSEOF'
# Allow live user to run buckos-installer without password
live ALL=(root) NOPASSWD: /usr/bin/buckos-installer
# Also allow wheel group as fallback
%wheel ALL=(root) NOPASSWD: /usr/bin/buckos-installer
SUDOERSEOF
chmod 440 $OUT/etc/sudoers.d/buckos-installer

cat > $OUT/home/live/Desktop/Install-BuckOS.desktop << 'DESKTOPEOF'
[Desktop Entry]
Type=Application
Name=Install BuckOS
Comment=Install BuckOS to your computer
Exec=sudo /usr/bin/buckos-installer
Icon=system-software-install
Terminal=false
Categories=System;
DESKTOPEOF
chmod 755 $OUT/home/live/Desktop/Install-BuckOS.desktop

# Set up live user profile with XDG_RUNTIME_DIR
cat > $OUT/home/live/.profile << 'PROFILEEOF'
# ~/.profile - Live user environment

# Set XDG_RUNTIME_DIR for the live user (UID 1000)
export XDG_RUNTIME_DIR=/run/user/1000

# Ensure the directory exists with correct permissions
if [ ! -d "$XDG_RUNTIME_DIR" ]; then
    mkdir -p "$XDG_RUNTIME_DIR" 2>/dev/null || true
    chmod 700 "$XDG_RUNTIME_DIR" 2>/dev/null || true
fi

# Set other XDG directories
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_CACHE_HOME="$HOME/.cache"
export XDG_STATE_HOME="$HOME/.local/state"

# D-Bus session address (if not already set by systemd)
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    export DBUS_SESSION_BUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"
fi
PROFILEEOF
chmod 644 $OUT/home/live/.profile

# Also create .bash_profile to source .profile
cat > $OUT/home/live/.bash_profile << 'BASHPROFILEEOF'
# ~/.bash_profile - Source .profile for bash login shells
if [ -f ~/.profile ]; then
    . ~/.profile
fi
if [ -f ~/.bashrc ]; then
    . ~/.bashrc
fi
BASHPROFILEEOF
chmod 644 $OUT/home/live/.bash_profile

chown -R 1000:1000 $OUT/home/live 2>/dev/null || true

# Copy debug/env script for manual testing from serial console
cp $SRCS $OUT/home/live/plasma-env.sh
chmod +x $OUT/home/live/plasma-env.sh

# Create Qt font directory symlink (Qt looks in /usr/lib/fonts)
mkdir -p $OUT/usr/lib
ln -sf ../share/fonts $OUT/usr/lib/fonts

# Create environment.d for Qt and cursor settings
mkdir -p $OUT/etc/environment.d
cat > $OUT/etc/environment.d/60-qt-fonts.conf << 'QTFONTEOF'
# Qt font directory
QT_QPA_FONTDIR=/usr/share/fonts
QTFONTEOF

cat > $OUT/etc/environment.d/60-xcursor.conf << 'XCURSOREOF'
# Cursor theme settings
XCURSOR_PATH=/usr/share/icons
XCURSOR_SIZE=24
XCURSOR_THEME=breeze_cursors
XCURSOREOF

# Libseat backend for DRM access via logind
cat > $OUT/etc/environment.d/60-libseat.conf << 'LIBSEATEOF'
# Use logind backend for libseat (required for Wayland DRM access)
LIBSEAT_BACKEND=logind
LIBSEATEOF

# GPU rendering - ensure hardware acceleration is used
cat > $OUT/etc/environment.d/60-gpu-render.conf << 'GPURENDEREOF'
# Ensure hardware GPU rendering (not software llvmpipe)
LIBGL_ALWAYS_SOFTWARE=0
# AMD GPU: use radeonsi gallium driver
GALLIUM_DRIVER=radeonsi
# KWin DRM settings for better compatibility
KWIN_DRM_USE_MODIFIERS=1
GPURENDEREOF

# Locale settings for Qt and KDE
cat > $OUT/etc/environment.d/50-locale.conf << 'LOCALEEOF'
# UTF-8 locale for Qt applications
LANG=C.UTF-8
LC_ALL=C.UTF-8
LOCALEEOF

# Qt and KDE paths
cat > $OUT/etc/environment.d/60-kde-paths.conf << 'KDEPATHSEOF'
# Qt/KDE plugin and QML paths
# KDE installs to /usr/lib64/, Qt to /usr/
QT_PLUGIN_PATH=/usr/lib64/plugins:/usr/plugins
QML_IMPORT_PATH=/usr/lib64/qml:/usr/qml
QML2_IMPORT_PATH=/usr/lib64/qml:/usr/qml
XDG_DATA_DIRS=/usr/share:/usr/local/share
XDG_CONFIG_DIRS=/etc/xdg
KDEPATHSEOF

# Force classic boot for Plasma (disable systemd boot)
# With dbus-run-session, the D-Bus session is isolated from systemd --user,
# so startplasma-wayland can't communicate with systemd user services.
# Classic boot runs plasma_session directly which starts plasmashell.
mkdir -p $OUT/etc/xdg
cat > $OUT/etc/xdg/startkderc << 'STARTKDEEOF'
[General]
systemdBoot=false
STARTKDEEOF

# XDG runtime directory for user sessions - use profile.d for dynamic $UID
mkdir -p $OUT/etc/profile.d
cat > $OUT/etc/profile.d/xdg-runtime.sh << 'XDGEOF'
# Set XDG_RUNTIME_DIR dynamically per user
if [ -z "$XDG_RUNTIME_DIR" ]; then
    export XDG_RUNTIME_DIR="/run/user/$UID"
fi
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ] && [ -S "$XDG_RUNTIME_DIR/bus" ]; then
    export DBUS_SESSION_BUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"
fi
XDGEOF
chmod +x $OUT/etc/profile.d/xdg-runtime.sh

# Systemd user environment generator for XDG_RUNTIME_DIR
# This runs when systemd --user starts and sets environment for user services
mkdir -p $OUT/usr/lib/systemd/user-environment-generators
cat > $OUT/usr/lib/systemd/user-environment-generators/50-xdg-runtime << 'GENEOF'
#!/bin/sh
# Generate XDG_RUNTIME_DIR for systemd user instance
MYUID=`id -u`
echo "XDG_RUNTIME_DIR=/run/user/$MYUID"
if [ -S "/run/user/$MYUID/bus" ]; then
    echo "DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$MYUID/bus"
fi
GENEOF
chmod +x $OUT/usr/lib/systemd/user-environment-generators/50-xdg-runtime

# Create tmpfiles.d to ensure /run/user/1000 exists at boot for live user
mkdir -p $OUT/etc/tmpfiles.d
cat > $OUT/etc/tmpfiles.d/live-user-runtime.conf << 'TMPFILESEOF'
# Create runtime directory for live user (UID 1000)
d /run/user/1000 0700 1000 1000 -
TMPFILESEOF

# Fix kwin_wayland_wrapper - the binary passes --xwayland which kwin doesn't support
# Replace with a simple shell script that filters out unsupported options
mkdir -p $OUT/usr/bin $OUT/usr/sbin
cat > $OUT/usr/bin/kwin_wayland_wrapper << 'KWRAPPER'
#!/bin/bash
# Wrapper replacement: filter out unsupported --xwayland flag
ARGS=()
for arg in "$@"; do
    case "$arg" in
        --xwayland) ;; # Skip this unsupported option
        *) ARGS+=("$arg") ;;
    esac
done
exec /usr/bin/kwin_wayland "${ARGS[@]}"
KWRAPPER
chmod +x $OUT/usr/bin/kwin_wayland_wrapper
cp $OUT/usr/bin/kwin_wayland_wrapper $OUT/usr/sbin/kwin_wayland_wrapper

# Create XDG menu symlink (KDE uses plasma-applications.menu, but some tools expect applications.menu)
mkdir -p $OUT/etc/xdg/menus
ln -sf plasma-applications.menu $OUT/etc/xdg/menus/applications.menu
""",
    visibility = ["PUBLIC"],
)

# SSH configuration for live environment
genrule(
    name = "live-ssh-config-gen",
    out = "live-ssh-config",
    cmd = """
mkdir -p $OUT/etc/ssh/sshd_config.d
cat > $OUT/etc/ssh/sshd_config.d/live.conf << 'SSHDEOF'
# Allow root login for live environment only
PermitRootLogin yes
SSHDEOF
""",
    visibility = ["PUBLIC"],
)

# Systemd services for live environment
genrule(
    name = "live-systemd-config-gen",
    out = "live-systemd-config",
    cmd = """
mkdir -p $OUT/etc/systemd/system
mkdir -p $OUT/etc/systemd/system/multi-user.target.wants
mkdir -p $OUT/etc/systemd/system/graphical.target.wants
mkdir -p $OUT/etc/systemd/system/sockets.target.wants
mkdir -p $OUT/etc/systemd
mkdir -p $OUT/etc/systemd/system/user@.service.d

# Configure systemd-logind to not create user instances for system users
cat > $OUT/etc/systemd/logind.conf << 'LOGINDEOF'
[Login]
# Don't kill user processes on logout (useful for live environment)
KillUserProcesses=no
# Only create user instances for regular users (UID >= 1000)
# System users (messagebus, polkitd, etc.) should not have user instances
UserTasksMax=12288
LOGINDEOF

# Prevent user@ instances for system users (UID < 1000)
# System users should not have systemd user instances
cat > $OUT/etc/systemd/system/user@.service.d/10-no-system-users.conf << 'USERSERVICEEOF'
[Unit]
# Only allow user instances for regular users (UID >= 1000)
# This prevents "Operation not permitted" errors for system users
ConditionUser=!0-999
USERSERVICEEOF

# Set graphical.target as default
ln -sf /usr/lib/systemd/system/graphical.target $OUT/etc/systemd/system/default.target

# Enable DBus (required for systemd-logind and KDE)
ln -sf /usr/lib/systemd/system/dbus.service $OUT/etc/systemd/system/multi-user.target.wants/dbus.service
ln -sf /usr/lib/systemd/system/dbus.socket $OUT/etc/systemd/system/sockets.target.wants/dbus.socket

# Enable polkit (required for systemd-logind authorization)
ln -sf /usr/lib/systemd/system/polkit.service $OUT/etc/systemd/system/multi-user.target.wants/polkit.service

# Enable systemd-logind (required for loginctl and PAM sessions)
ln -sf /usr/lib/systemd/system/systemd-logind.service $OUT/etc/systemd/system/multi-user.target.wants/systemd-logind.service

# =============================================================================
# Plasma Wayland Live Session - Startup Flow Documentation
# =============================================================================
#
# This service starts a Plasma Wayland session on tty1 without a display manager.
#
# STARTUP CHAIN:
# 1. systemd starts this service (plasma-wayland-live.service) at graphical.target
# 2. dbus-run-session creates an isolated D-Bus session bus
# 3. kwin_wayland starts as the Wayland compositor (DRM backend on real hardware)
#    - --no-lockscreen: Disables the lock screen for live environment
#    - --exit-with-session: Runs startplasma-wayland and exits when it exits
# 4. kwin_wayland launches startplasma-wayland as its session application
# 5. startplasma-wayland sets up KDE environment variables and either:
#    a) Uses systemd boot: Starts plasma-workspace-wayland.target (if systemd user available)
#    b) Uses classic boot: Runs plasma_session directly (fallback for live environments)
# 6. plasma_session (or systemd targets) starts:
#    - plasmashell: The desktop shell (panels, desktop, widgets)
#    - ksmserver: KDE session manager
#    - Various other Plasma services
#
# IMPORTANT: startplasma-wayland must NOT be run directly - it doesn't start kwin.
# The compositor (kwin_wayland) must be running first, then it launches the session.
#
# Environment variables:
# - XDG_* vars: Required for KDE/Qt to find resources, configs, and data files
# - QT_PLUGIN_PATH/QML_IMPORT_PATH: Qt plugin locations (Qt6 uses /usr/plugins, /usr/qml)
# - LIBSEAT_BACKEND=logind: Required for kwin to get seat access via systemd-logind
# - HOME: Explicit home directory for the live user
#
mkdir -p $OUT/usr/lib/systemd/system
cat > $OUT/usr/lib/systemd/system/plasma-wayland-live.service << 'PLASMASERVICEEOF'
[Unit]
Description=Plasma Wayland Session (Live)
After=systemd-user-sessions.service dbus.service polkit.service systemd-logind.service
Wants=dbus.service polkit.service systemd-logind.service
Conflicts=getty@tty1.service

[Service]
Type=simple
User=live
Group=live
PAMName=login
TTYPath=/dev/tty1
TTYReset=yes
TTYVHangup=yes
TTYVTDisallocate=yes
StandardInput=tty
StandardOutput=tty
StandardError=journal
# XDG environment for KDE/Qt resource discovery
Environment=XDG_SESSION_TYPE=wayland
Environment=XDG_RUNTIME_DIR=/run/user/1000
Environment=XDG_DATA_DIRS=/usr/share:/usr/local/share
Environment=XDG_CONFIG_DIRS=/etc/xdg
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus
# Qt/KDE environment
Environment=QT_QPA_PLATFORM=wayland
Environment=QML_IMPORT_PATH=/usr/lib64/qml:/usr/qml
Environment=QML2_IMPORT_PATH=/usr/lib64/qml:/usr/qml
Environment=QT_PLUGIN_PATH=/usr/lib64/plugins:/usr/plugins
# Seat access via logind (required for kwin to access DRM/input devices)
Environment=LIBSEAT_BACKEND=logind
# Skip splash screen for faster boot
Environment=PLASMA_SKIP_SPLASH=1
# Explicit home directory
Environment=HOME=/home/live
# Cursor theme settings
Environment=XCURSOR_THEME=breeze_cursors
Environment=XCURSOR_SIZE=24
Environment=XCURSOR_PATH=/usr/share/icons
# Font configuration
Environment=QT_QPA_FONTDIR=/usr/share/fonts
Environment=FONTCONFIG_FILE=/etc/fonts/fonts.conf
Environment=FONTCONFIG_PATH=/etc/fonts
# Locale/encoding (required for proper text rendering)
Environment=LANG=C.UTF-8
Environment=LC_ALL=C.UTF-8
# Setup runtime directory
ExecStartPre=/bin/mkdir -p /run/user/1000
ExecStartPre=/bin/chown 1000:1000 /run/user/1000
ExecStartPre=/bin/chmod 700 /run/user/1000
# Build font cache (optional, continues on failure)
ExecStartPre=-/usr/bin/fc-cache -f
# Start kwin_wayland as compositor with plasmashell as the session
# Skip startplasma-wayland/plasma_session since they weren't auto-starting plasmashell
ExecStart=/usr/bin/dbus-run-session /usr/bin/kwin_wayland --no-lockscreen --exit-with-session /usr/bin/plasmashell
Restart=on-failure
RestartSec=3

[Install]
WantedBy=graphical.target
PLASMASERVICEEOF

# Enable plasma-wayland-live service
ln -sf /usr/lib/systemd/system/plasma-wayland-live.service $OUT/etc/systemd/system/graphical.target.wants/plasma-wayland-live.service

# Disable getty on tty1 (plasma-wayland-live will use it)
ln -sf /dev/null $OUT/etc/systemd/system/getty@tty1.service

# Disable screen locker for live session
mkdir -p $OUT/home/live/.config
cat > $OUT/home/live/.config/kscreenlockerrc << 'LOCKEREOF'
[Daemon]
Autolock=false
LockOnResume=false
Timeout=0
LOCKEREOF

# User-level cursor theme configuration
cat > $OUT/home/live/.config/kcminputrc << 'USERINPUTEOF'
[Mouse]
cursorTheme=breeze_cursors
cursorSize=24
USERINPUTEOF

# User-level KDE globals (fonts, icons, etc)
cat > $OUT/home/live/.config/kdeglobals << 'USERKDEGLOBALSEOF'
[General]
fixed=DejaVu Sans Mono,10,-1,5,50,0,0,0,0,0
font=DejaVu Sans,10,-1,5,50,0,0,0,0,0
menuFont=DejaVu Sans,10,-1,5,50,0,0,0,0,0
smallestReadableFont=DejaVu Sans,8,-1,5,50,0,0,0,0,0
toolBarFont=DejaVu Sans,10,-1,5,50,0,0,0,0,0

[Icons]
Theme=breeze

[KDE]
LookAndFeelPackage=org.kde.breeze.desktop
SingleClick=false
widgetStyle=breeze
USERKDEGLOBALSEOF

# Konsole profile with explicit font configuration
mkdir -p $OUT/home/live/.local/share/konsole
cat > $OUT/home/live/.local/share/konsole/Profile1.profile << 'KONSOLEPROFILEEOF'
[Appearance]
Font=DejaVu Sans Mono,10,-1,5,400,0,0,0,0,0,0,0,0,0,0,1

[General]
Name=Profile 1
Parent=FALLBACK/
KONSOLEPROFILEEOF

# Set Konsole to use the profile by default
cat > $OUT/home/live/.config/konsolerc << 'KONSOLERCEOF'
[Desktop Entry]
DefaultProfile=Profile1.profile

[MainWindow]
MenuBar=Disabled
ToolBarsMovable=Disabled
KONSOLERCEOF

# User-level kwinrc (cursor theme for wayland compositor)
cat > $OUT/home/live/.config/kwinrc << 'USERKWINEOF'
[Wayland]
InputMethod=

[TabBox]
LayoutName=org.kde.breeze.desktop

[org.kde.kdecoration2]
library=org.kde.breeze
theme=Breeze
USERKWINEOF

# User-level Plasma theme
cat > $OUT/home/live/.config/plasmarc << 'USERPLASMAEOF'
[Theme]
name=breeze-light
USERPLASMAEOF

chown -R 1000:1000 $OUT/home/live/.config

# Also set a known password for live user in case lock screen appears
# Password is "live"
mkdir -p $OUT/etc
# Use openssl to generate password hash for "live"
# This is pre-computed: live -> $6$rounds=5000$salt$hash
sed -i 's|^live:!:|live:$6$xyz$LH0pTsMhKj5X5VQrDvKxQ8Kj7FqNJvGqKxjQh3CqZ8nD6s5R2lVpLlZ.K9J4X5.iY8J6m.tQ3H4D5v6W7x8Y9z0:0|' $OUT/etc/shadow 2>/dev/null || true

# Note: sshd is NOT enabled by default - it needs host keys generated first
# To enable SSH access, run: systemctl start sshd (after generating keys with ssh-keygen -A)
# ln -sf /usr/lib/systemd/system/sshd.service $OUT/etc/systemd/system/multi-user.target.wants/sshd.service

# Note: XDG_RUNTIME_DIR setup moved to live-desktop-gen with dynamic $UID
""",
    visibility = ["PUBLIC"],
)

# Root filesystem assembly
rootfs(
    name = "buckos-rootfs",
    packages = [
        ":init-scripts-gen",
        ":baselayout-gen",
        # C runtime (required for all dynamically-linked binaries)
        "//packages/linux/core/glibc:glibc",
        # Core system
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/editors/grep:grep",
        "//packages/linux/system/libs/cpio:cpio",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/zlib:zlib",
        # Shell and terminal
        "//packages/linux/system/terminal/ncurses:ncurses",
        "//packages/linux/system/terminal/readline:readline",
        "//packages/linux/core/bash:bash",
        "//packages/linux/core/less:less",
        # Compression
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        # System utilities
        "//packages/linux/core/procps-ng:procps-ng",
        "//packages/linux/core/file:file",
        # User management (REQUIRED for installer)
        "//packages/linux/system/apps/shadow:shadow",
        # Networking
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/network/curl:curl",
        # TODO: OpenSSH 9.9p1 has build issues with cross-compilation (arc4random, strlcpy)
        # "//packages/linux/network/openssh:openssh",
        "//packages/linux/network/iproute2:iproute2",
        "//packages/linux/network/dhcpcd:dhcpcd",
    ],
    visibility = ["PUBLIC"],
)

# =============================================================================
# Initramfs images for QEMU testing
# =============================================================================

# Minimal initramfs for QEMU testing
initramfs(
    name = "buckos-initramfs",
    rootfs = ":buckos-rootfs",
    compression = "gz",
    init = "/sbin/init",
    visibility = ["PUBLIC"],
)

# Initramfs with xz compression (smaller but slower)
initramfs(
    name = "buckos-initramfs-xz",
    rootfs = ":buckos-rootfs",
    compression = "xz",
    init = "/sbin/init",
    visibility = ["PUBLIC"],
)

# Bootable initramfs with full system - commented out until buckos-bootable is defined
# initramfs(
#     name = "buckos-bootable-initramfs",
#     rootfs = ":buckos-bootable",
#     compression = "gz",
#     init = "/sbin/init",
#     visibility = ["PUBLIC"],
# )

# =============================================================================
# QEMU boot scripts for testing
# =============================================================================

# Basic QEMU boot script for testing
qemu_boot_script(
    name = "qemu-boot",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel",
    initramfs = ":buckos-initramfs",
    arch = "x86_64",
    memory = "2G",
    cpus = "2",
    kernel_args = "console=ttyS0 rdinit=/init",
    visibility = ["PUBLIC"],
)

# QEMU boot with more memory for development
qemu_boot_script(
    name = "qemu-boot-dev",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel",
    initramfs = ":buckos-initramfs",
    arch = "x86_64",
    memory = "2G",
    cpus = "4",
    kernel_args = "console=ttyS0 rdinit=/init loglevel=7",
    extra_args = ["-enable-kvm"],
    visibility = ["PUBLIC"],
)

# QEMU boot with full bootable system - commented out until buckos-bootable is defined
# qemu_boot_script(
#     name = "qemu-boot-full",
#     kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel",
#     initramfs = ":buckos-bootable-initramfs",
#     arch = "x86_64",
#     memory = "1G",
#     cpus = "2",
#     kernel_args = "console=ttyS0 rdinit=/init",
#     visibility = ["PUBLIC"],
# )

# QEMU boot with networking
qemu_boot_script(
    name = "qemu-boot-net",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel",
    initramfs = ":buckos-initramfs",
    arch = "x86_64",
    memory = "2G",
    cpus = "2",
    kernel_args = "console=ttyS0 rdinit=/init",
    extra_args = [
        "-netdev user,id=net0,hostfwd=tcp::2222-:22",
        "-device virtio-net-pci,netdev=net0",
    ],
    visibility = ["PUBLIC"],
)

# =============================================================================
# ISO images for distribution
# =============================================================================

# Minimal bootable ISO image
iso_image(
    name = "buckos-iso",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel",
    initramfs = ":buckos-initramfs",
    boot_mode = "hybrid",
    volume_label = "BUCKOS",
    kernel_args = "quiet rdinit=/init",
    visibility = ["PUBLIC"],
)

# ISO with BIOS-only boot (for older systems)
iso_image(
    name = "buckos-iso-bios",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel",
    initramfs = ":buckos-initramfs",
    boot_mode = "bios",
    volume_label = "BUCKOS",
    kernel_args = "quiet rdinit=/init",
    visibility = ["PUBLIC"],
)

# ISO with EFI-only boot (for modern systems)
iso_image(
    name = "buckos-iso-efi",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel",
    initramfs = ":buckos-initramfs",
    boot_mode = "efi",
    volume_label = "BUCKOS",
    kernel_args = "quiet rdinit=/init",
    visibility = ["PUBLIC"],
)

# Live ISO with full rootfs (squashfs compressed)
iso_image(
    name = "buckos-live-iso",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel",
    initramfs = ":buckos-initramfs",
    rootfs = ":buckos-rootfs",
    boot_mode = "hybrid",
    volume_label = "BUCKOS_LIVE",
    kernel_args = "quiet rdinit=/init",
    visibility = ["PUBLIC"],
)

# Full bootable ISO with dracut initramfs - commented out until buckos-bootable is defined
# iso_image(
#     name = "buckos-full-iso",
#     kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel",
#     initramfs = ":buckos-bootable-initramfs",
#     rootfs = ":buckos-bootable",
#     boot_mode = "hybrid",
#     volume_label = "BUCKOS_FULL",
#     kernel_args = "quiet rdinit=/init",
#     visibility = ["PUBLIC"],
# )

# Development ISO with verbose boot
iso_image(
    name = "buckos-iso-dev",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel",
    initramfs = ":buckos-initramfs",
    boot_mode = "hybrid",
    volume_label = "BUCKOS_DEV",
    kernel_args = "rdinit=/init loglevel=7 debug",
    visibility = ["PUBLIC"],
)

# =============================================================================
# Stage3 Tarballs for Distribution
# =============================================================================
# Stage3 tarballs for bootstrapping new BuckOS installations.
# Users download a stage3, extract it, chroot in, and build additional packages.

# Stage3 minimal rootfs - core system only (no toolchain)
rootfs(
    name = "stage3-minimal-rootfs",
    packages = [
        ":init-scripts-gen",
        ":baselayout-gen",
        # Core system
        "//packages/linux/core/glibc:glibc",
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/procps-ng:procps-ng",
        "//packages/linux/system/apps/shadow:shadow",
        "//packages/linux/core/file:file",
        # Shell and terminal
        "//packages/linux/core/bash:bash",
        "//packages/linux/system/terminal/readline:readline",
        "//packages/linux/system/terminal/ncurses:ncurses",
        "//packages/linux/core/less:less",
        # Compression
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/system/libs/compression/gzip:gzip",
        "//packages/linux/system/apps/tar:tar",
        # Basic libraries
        "//packages/linux/core/zlib:zlib",
    ],
    visibility = ["PUBLIC"],
)

# Stage3 base rootfs - includes GCC toolchain for building packages
rootfs(
    name = "stage3-base-rootfs",
    packages = [
        ":init-scripts-gen",
        ":baselayout-gen",
        # Everything from minimal
        "//packages/linux/core/glibc:glibc",
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/procps-ng:procps-ng",
        "//packages/linux/system/apps/shadow:shadow",
        "//packages/linux/core/file:file",
        "//packages/linux/core/bash:bash",
        "//packages/linux/system/terminal/readline:readline",
        "//packages/linux/system/terminal/ncurses:ncurses",
        "//packages/linux/core/less:less",
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/system/libs/compression/gzip:gzip",
        "//packages/linux/system/apps/tar:tar",
        "//packages/linux/core/zlib:zlib",
        # Additional libraries
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/system/libs/data/expat:expat",
        # Networking basics
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/network/curl:curl",
        "//packages/linux/network/iproute2:iproute2",
        # Build essentials
        "//packages/linux/system/apps/patch:patch",
        "//packages/linux/system/apps/sed:sed",
        "//packages/linux/system/apps/gawk:gawk",
        "//packages/linux/editors/grep:grep",
        "//packages/linux/system/apps/diffutils:diffutils",
        "//packages/linux/system/apps/findutils:findutils",
        # Build systems
        "//packages/linux/dev-tools/build-systems/make:make",
        # Note: Additional toolchain packages (gcc, binutils, etc.) would be added
        # once those packages are available in the build system
    ],
    visibility = ["PUBLIC"],
)

# Stage3 developer rootfs - modern build systems and dev tools
rootfs(
    name = "stage3-developer-rootfs",
    packages = [
        ":init-scripts-gen",
        ":baselayout-gen",
        # Everything from base
        "//packages/linux/core/glibc:glibc",
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/procps-ng:procps-ng",
        "//packages/linux/system/apps/shadow:shadow",
        "//packages/linux/core/file:file",
        "//packages/linux/core/bash:bash",
        "//packages/linux/system/terminal/readline:readline",
        "//packages/linux/system/terminal/ncurses:ncurses",
        "//packages/linux/core/less:less",
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/system/libs/compression/gzip:gzip",
        "//packages/linux/system/apps/tar:tar",
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/system/libs/data/expat:expat",
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/network/curl:curl",
        "//packages/linux/network/iproute2:iproute2",
        "//packages/linux/system/apps/patch:patch",
        "//packages/linux/system/apps/sed:sed",
        "//packages/linux/system/apps/gawk:gawk",
        "//packages/linux/editors/grep:grep",
        "//packages/linux/system/apps/diffutils:diffutils",
        "//packages/linux/system/apps/findutils:findutils",
        "//packages/linux/dev-tools/build-systems/make:make",
        # Modern build systems
        "//packages/linux/dev-tools/build-systems/cmake:cmake",
        # VCS
        "//packages/linux/dev-tools/vcs/git:git",
        # Editors
        "//packages/linux/editors/vim:vim",
        # SSH for remote development
        # TEMPORARILY DISABLED for aarch64 cross-compilation (Fix #22)
        # "//packages/linux/network/openssh:openssh",
    ],
    visibility = ["PUBLIC"],
)

# =============================================================================
# Stage3 Tarballs
# =============================================================================

# Minimal stage3 tarball
stage3_tarball(
    name = "stage3-minimal",
    rootfs = ":stage3-minimal-rootfs",
    variant = "minimal",
    arch = "amd64",
    libc = "glibc",
    compression = "xz",
    visibility = ["PUBLIC"],
)

# Base stage3 tarball (with toolchain)
stage3_tarball(
    name = "stage3-base",
    rootfs = ":stage3-base-rootfs",
    variant = "base",
    arch = "amd64",
    libc = "glibc",
    compression = "xz",
    visibility = ["PUBLIC"],
)

# Developer stage3 tarball
stage3_tarball(
    name = "stage3-developer",
    rootfs = ":stage3-developer-rootfs",
    variant = "developer",
    arch = "amd64",
    libc = "glibc",
    compression = "xz",
    visibility = ["PUBLIC"],
)

# =============================================================================
# Live CD/USB System - KDE Plasma Desktop with Installer
# =============================================================================
# This section defines the components needed for a bootable live system
# that can run from CD/USB and install BuckOS to disk.

# Live system init scripts - specialized for live boot environment
# Uses external script to generate all config files
genrule(
    name = "live-init-scripts-gen",
    out = "live-init-scripts",
    cmd = "bash $(location //defs/scripts:generate-live-init-scripts) $OUT",
    visibility = ["PUBLIC"],
)

filegroup(
    name = "live-init-scripts",
    srcs = [":live-init-scripts-gen"],
    default_target_platform = "//platforms:linux-target",
    visibility = ["PUBLIC"],
)

# =============================================================================
# Live Root Filesystem - Full desktop environment
# =============================================================================

# BuckOS source repository for the live environment
# Downloads from GitHub to get the full buckos-build repository
# The buckos CLI expects /var/db/repos/buckos-build with defs/ and packages/ directories
# Also downloads buck2 prebuilt binary for building packages
genrule(
    name = "buckos-repo-gen",
    out = "buckos-repo",
    cmd = """
mkdir -p "$OUT/var/db/repos/buckos-build"
mkdir -p "$OUT/usr/bin"
# Create empty etc directory to trigger fast tar merge path in assemble.sh
# Without this, the assemble script recursively processes thousands of directories
mkdir -p "$OUT/etc"

# Download the buckos-build tarball from GitHub
TARBALL=`mktemp`
curl -sL "https://github.com/buck-os/buckos-build/archive/refs/heads/main.tar.gz" -o "$TARBALL"
# Extract defs/ directory (required by buckos CLI)
tar -xzf "$TARBALL" --strip-components=1 -C "$OUT/var/db/repos/buckos-build" "buckos-build-main/defs"
# Extract packages/linux directory
mkdir -p "$OUT/var/db/repos/buckos-build/packages"
tar -xzf "$TARBALL" --strip-components=2 -C "$OUT/var/db/repos/buckos-build/packages" "buckos-build-main/packages/linux"
rm -f "$TARBALL"

# Download buck2 prebuilt static binary (x86_64)
BUCK2_ZST=`mktemp`
curl -sL "https://github.com/facebook/buck2/releases/download/2026-01-02/buck2-x86_64-unknown-linux-gnu.zst" -o "$BUCK2_ZST"
zstd -d "$BUCK2_ZST" -o "$OUT/usr/bin/buck2"
chmod +x "$OUT/usr/bin/buck2"
rm -f "$BUCK2_ZST"
""",
    visibility = ["PUBLIC"],
)

# Live rootfs with KDE Plasma desktop (systemd-only, no eudev)
rootfs(
    name = "buckos-live-kde-rootfs",
    packages = [
        ":live-init-scripts-gen",
        ":baselayout-gen",
        ":buckos-repo-gen",
        ":live-dbus-policy-gen",
        ":polkit-live-rules-gen",
        ":live-utmp-gen",
        ":live-users-gen",
        ":live-tmpfiles-gen",
        ":live-desktop-gen",
        ":live-ssh-config-gen",
        ":live-plasmalogin-config-gen",
        ":live-systemd-config-gen",
        # Kernel modules (needed for hardware support at runtime)
        "//packages/linux/kernel/buckos-kernel:buckos-kernel-live",
        # System groups (automatically merged into /etc/group)
        "//packages/acct-group/tty:tty",
        "//packages/acct-group/disk:disk",
        "//packages/acct-group/lp:lp",
        "//packages/acct-group/kmem:kmem",
        "//packages/acct-group/wheel:wheel",
        "//packages/acct-group/cdrom:cdrom",
        "//packages/acct-group/uucp:uucp",
        "//packages/acct-group/dialout:dialout",
        "//packages/acct-group/audio:audio",
        "//packages/acct-group/video:video",
        "//packages/acct-group/input:input",
        "//packages/acct-group/utmp:utmp",
        "//packages/acct-group/usb:usb",
        "//packages/acct-group/kvm:kvm",
        "//packages/acct-group/render:render",
        "//packages/acct-group/systemd-journal:systemd-journal",
        "//packages/acct-group/sgx:sgx",
        "//packages/acct-group/tape:tape",
        # C/C++ runtime (required for all dynamically-linked binaries)
        "//packages/linux/core/glibc:glibc",
        "//packages/linux/lang/gcc:gcc-runtime",  # Provides libstdc++.so.6, libgcc_s.so.1 for C++ apps

        # Core system utilities
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/system/apps/which:which",
        "//packages/linux/lang/binutils:binutils",  # Provides strings, nm, objdump, etc.
        "//packages/linux/editors/grep:grep",
        "//packages/linux/system/libs/cpio:cpio",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/terminal/ncurses:ncurses",
        "//packages/linux/system/terminal/readline:readline",
        "//packages/linux/core/bash:bash",
        "//packages/linux/core/less:less",
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/system/libs/compression/lz4:lz4",
        "//packages/linux/system/libs/compression/zstd:zstd",
        "//packages/linux/core/procps-ng:procps-ng",
        "//packages/linux/core/file:file",
        "//packages/linux/system/apps/findutils:findutils",
        # strace requires libunwind which needs stdatomic.h - skipped for now
        "//packages/linux/system/apps/shadow:shadow",
        "//packages/linux/system/apps/sudo:sudo",  # Required for installer and admin tasks
        # PAM runtime dependencies (required for login/authentication)
        "//packages/linux/system/libs/ipc/libtirpc:libtirpc",
        "//packages/linux/system/libs/network/libnsl:libnsl",
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/network/curl:curl",
        "//packages/linux/network/openssh:openssh",
        "//packages/linux/network/iproute2:iproute2",
        "//packages/linux/network/dhcpcd:dhcpcd",
        "//packages/linux/system/libs/kmod:kmod",  # Provides modprobe, lsmod, etc.

        # Security and capabilities (required by systemd)
        "//packages/linux/system/libs/ipc/libseccomp:libseccomp",
        "//packages/linux/system/libs/ipc/libcap:libcap",
        "//packages/linux/system/libs/ipc/attr:attr",
        "//packages/linux/system/libs/crypto/libxcrypt:libxcrypt",
        "//packages/linux/system/libs/crypto/argon2:argon2",
        "//packages/linux/system/security/auth/privilege:polkit",  # Required for systemd-logind session creation

        # Init system (systemd includes udevd, so no separate eudev needed)
        "//packages/linux/system/init/systemd:systemd",

        # Device management and session
        # Note: eudev removed - systemd provides systemd-udevd
        "//packages/linux/system/libs/libseat:libseat",
        "//packages/linux/system/libs/ipc/dbus:dbus",
        "//packages/linux/system/libs/kmod:kmod",

        # Firmware (required for GPU, WiFi, etc. on real hardware)
        "//packages/linux/system/firmware/linux-firmware:linux-firmware",

        # Graphics stack
        "//packages/linux/desktop/mesa:mesa",
        # Mesa's radeonsi driver depends on LLVM at runtime
        "//packages/linux/core/llvm:llvm",
        "//packages/linux/dev-libs/elfutils:elfutils",
        "//packages/linux/system/libs/data/libxml2:libxml2",
        "//packages/linux/graphics/rendering/wayland:wayland",
        "//packages/linux/graphics/rendering/wayland-protocols:wayland-protocols",
        "//packages/linux/system/libs/input/libinput:libinput",
        "//packages/linux/desktop/libdrm:libdrm",
        "//packages/linux/system/security/auth/biometric:pixman",
        "//packages/linux/system/libs/image/libpng:libpng",
        "//packages/linux/system/libs/graphics/cairo:cairo",
        "//packages/linux/system/libs/data/expat:expat",
        "//packages/linux/system/libs/data/json-c:json-c",
        "//packages/linux/system/libs/utility/pcre2:pcre2",
        "//packages/linux/dev-libs/glib:glib",

        # Input handling
        "//packages/linux/system/libs/input/libxkbcommon:libxkbcommon",
        "//packages/linux/system/libs/input/libevdev:libevdev",
        "//packages/linux/graphics/xorg/xkeyboard-config:xkeyboard-config",  # XKB data for keyboard layouts

        # Font rendering and fonts
        "//packages/linux/system/libs/font/freetype:freetype",
        "//packages/linux/system/libs/font/fontconfig:fontconfig",
        "//packages/linux/system/libs/font/harfbuzz:harfbuzz",
        # TEMPORARILY DISABLED for aarch64 cross-compilation (Fix #23 - x86 SSE2 flags)
        # "//packages/linux/system/libs/font/graphite2:graphite2",
        "//packages/linux/system/libs/font/fribidi:fribidi",
        "//packages/linux/fonts/libraries/pango:pango",
        "//packages/linux/fonts/collections/dejavu-fonts:dejavu-fonts",
        "//packages/linux/fonts/collections/liberation-fonts:liberation-fonts",
        ":fontconfig-symlinks-gen",  # Enable font configurations

        # KDE Plasma Desktop
        "//packages/linux/desktop/kde:kde-plasma",
        "//packages/linux/desktop/kde:plasma-desktop",  # Provides org.kde.plasma.desktop shell
        "//packages/linux/desktop/kde/apps:konsole",
        "//packages/linux/desktop/kde/apps:dolphin",
        "//packages/linux/desktop/kde/apps:kate",
        # KDE Frameworks (QML modules required for Plasma)
        "//packages/linux/desktop/kde:kirigami",
        "//packages/linux/desktop/kde:kcmutils",
        "//packages/linux/desktop/kde:kdeclarative",
        "//packages/linux/desktop/kde:kitemmodels",
        "//packages/linux/desktop/kde:ksvg",
        "//packages/linux/desktop/kde:krunner",
        "//packages/linux/desktop/kde:kpackage",
        "//packages/linux/desktop/kde:plasma-activities",
        "//packages/linux/desktop/kde:kactivitymanagerd",
        "//packages/linux/desktop/kde:breeze",
        "//packages/linux/desktop/kde:breeze-icons",
        "//packages/linux/desktop/kde:kiconthemes",
        # KDE/Graphics libraries (explicit dependencies - not auto-pulled from filegroup)
        "//packages/linux/desktop/kde:libplasma",
        "//packages/linux/desktop/kde:plasma5support",
        "//packages/linux/desktop/kde:kdecoration2",
        "//packages/linux/desktop/kde:kwayland",
        "//packages/linux/desktop/kde:kscreenlocker",
        "//packages/linux/desktop/kde:kglobalacceld",
        "//packages/linux/desktop/kde:layer-shell-qt",
        "//packages/linux/desktop/kde:kquickcharts",
        "//packages/linux/desktop/kde:kholidays",
        "//packages/linux/desktop/kde:kirigami-addons",
        "//packages/linux/desktop/kde:milou",
        # plasma-integration requires X11 - skip for Wayland-only build
        # knighttime is new in Plasma 6.5.x - not available in 6.2.4
        "//packages/linux/graphics/libepoxy:libepoxy",
        # Graphics/Display libraries required by KWin
        "//packages/linux/system/libs/graphics/lcms2:lcms2",
        "//packages/linux/graphics/xorg/libxcvt:libxcvt",
        "//packages/linux/graphics/utilities/libdisplay-info:libdisplay-info",
        "//packages/linux/graphics/xorg/xcb-util-cursor:xcb-util-cursor",
        "//packages/linux/graphics/xorg/xcb-util-image:xcb-util-image",
        "//packages/linux/graphics/xorg/xcb-util-renderutil:xcb-util-renderutil",

        # Note: Using getty autologin + startplasma-wayland instead of plasma-login-manager
        # (plasma-login-manager 6.5.91 requires PlasmaQuick 6.5.90, but we have 6.2.4)

        # Audio (PipeWire with systemd support)
        "//packages/linux/audio/daemons/pipewire:pipewire",
        "//packages/linux/system/libs/audio/alsa-lib:alsa-lib",

        # Development tools (for post-install)
        "//packages/linux/dev-tools/vcs/git:git",
        "//packages/linux/editors/vim:vim",

        # BuckOS tools (uses cargo_workspace_package with vendor tarball)
        "//packages/linux/apps/buckos-tools/installer:buckos-installer",
        "//packages/linux/apps/buckos-tools/cli:buckos-cli",

        # Installer dependencies - filesystem tools
        "//packages/linux/system/filesystem/native/e2fsprogs:e2fsprogs",  # mkfs.ext4
        "//packages/linux/system/filesystem/management/parted:parted",  # parted
        "//packages/linux/system/filesystem/native/btrfs-progs:btrfs-progs",  # mkfs.btrfs
        # xfsprogs requires libinih - TODO: add libinih package
        "//packages/linux/system/filesystem/native/dosfstools:dosfstools",  # mkfs.vfat (EFI)
        "//packages/linux/system/filesystem/management/cryptsetup:cryptsetup",  # LUKS encryption
        "//packages/linux/system/security/cryptsetup:lvm2",  # LVM2 utilities

        # Installer dependencies - file operations
        "//packages/linux/system/apps/rsync:rsync",  # rsync (file sync during install)
        "//packages/linux/system/apps/psmisc:psmisc",  # fuser, killall, pstree
        "//packages/linux/system/apps/lsof:lsof",  # lsof (list open files)

        # Installer dependencies - hardware detection
        "//packages/linux/system/hardware/pciutils:pciutils",  # lspci (GPU detection)
        "//packages/linux/system/hardware/usbutils:usbutils",  # lsusb (USB/Bluetooth detection)

        # Installer dependencies - bootloader
        "//packages/linux/boot/grub:grub",  # grub-install, grub-mkconfig

        # IMPORTANT: This must be LAST to override PAM's /etc/environment file
        ":live-environment-gen",
    ],
    visibility = ["PUBLIC"],
)

# Minimal live rootfs with Sway (lighter alternative)
rootfs(
    name = "buckos-live-sway-rootfs",
    packages = [
        ":live-init-scripts-gen",
        ":baselayout-gen",
        # C runtime (required for all dynamically-linked binaries)
        "//packages/linux/core/glibc:glibc",
        # Core system utilities
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/editors/grep:grep",
        "//packages/linux/system/libs/cpio:cpio",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/terminal/ncurses:ncurses",
        "//packages/linux/system/terminal/readline:readline",
        "//packages/linux/core/bash:bash",
        "//packages/linux/core/less:less",
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/core/procps-ng:procps-ng",
        "//packages/linux/core/file:file",
        "//packages/linux/system/apps/shadow:shadow",
        # PAM runtime dependencies (pam_unix.so needs these)
        "//packages/linux/system/libs/ipc/libtirpc:libtirpc",
        "//packages/linux/system/libs/network/libnsl:libnsl",
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/network/curl:curl",
        # TODO: OpenSSH 9.9p1 has build issues with cross-compilation (arc4random, strlcpy)
        # "//packages/linux/network/openssh:openssh",
        "//packages/linux/network/iproute2:iproute2",
        "//packages/linux/network/dhcpcd:dhcpcd",
        "//packages/linux/network/net-tools:net-tools",
        # Init system
        "//packages/linux/system/init/systemd:systemd",
        # Device management and session (systemd provides libudev and udevd)
        "//packages/linux/system/libs/libseat:libseat",
        "//packages/linux/system/libs/ipc/dbus:dbus",
        "//packages/linux/system/libs/kmod:kmod",
        # Graphics stack
        "//packages/linux/desktop/mesa:mesa",
        "//packages/linux/graphics/rendering/wayland:wayland",
        "//packages/linux/graphics/rendering/wayland-protocols:wayland-protocols",
        "//packages/linux/system/libs/input/libinput:libinput",
        "//packages/linux/desktop/libdrm:libdrm",
        "//packages/linux/system/security/auth/biometric:pixman",
        "//packages/linux/system/libs/image/libpng:libpng",
        "//packages/linux/system/libs/graphics/cairo:cairo",
        "//packages/linux/system/libs/data/expat:expat",
        "//packages/linux/system/libs/data/json-c:json-c",
        "//packages/linux/system/libs/utility/pcre2:pcre2",
        "//packages/linux/dev-libs/glib:glib",
        # Input handling
        "//packages/linux/system/libs/input/libxkbcommon:libxkbcommon",
        "//packages/linux/system/libs/input/libevdev:libevdev",
        "//packages/linux/graphics/xorg/xkeyboard-config:xkeyboard-config",  # XKB data for keyboard layouts
        # Font rendering and fonts
        "//packages/linux/system/libs/font/freetype:freetype",
        "//packages/linux/system/libs/font/fontconfig:fontconfig",
        "//packages/linux/system/libs/font/harfbuzz:harfbuzz",
        # TEMPORARILY DISABLED for aarch64 cross-compilation (Fix #23 - x86 SSE2 flags)
        # "//packages/linux/system/libs/font/graphite2:graphite2",
        "//packages/linux/system/libs/font/fribidi:fribidi",
        "//packages/linux/fonts/libraries/pango:pango",
        "//packages/linux/system/libs/font/fcft:fcft",
        "//packages/linux/system/libs/data/tllist:tllist",
        "//packages/linux/fonts/collections/dejavu-fonts:dejavu-fonts",
        "//packages/linux/fonts/collections/liberation-fonts:liberation-fonts",
        # Sway compositor
        "//packages/linux/desktop/sway:sway",
        "//packages/linux/desktop/sway:wlroots",
        # Terminal
        "//packages/linux/terminals/foot:foot",
        # Development tools
        "//packages/linux/dev-tools/vcs/git:git",
        "//packages/linux/editors/vim:vim",
    ],
    visibility = ["PUBLIC"],
)

# =============================================================================
# Live Initramfs - Specialized for live boot
# =============================================================================

# Static init wrapper - a minimal statically-linked init that bootstraps the system
# This avoids dynamic linking issues that can occur on some hardware
genrule(
    name = "static-init-gen",
    out = "static-init",
    cmd = """
mkdir -p $OUT/usr/bin

# Create a minimal static init using direct syscalls - NO glibc!
# This avoids AVX/VEX instructions that cause "invalid opcode" on older CPUs.
# Force rebuild v4 - disable CET, simplify code
cat > /tmp/init.c << 'INITC'
// Minimal init using direct syscalls - no glibc
// Uses only basic x86-64 instructions, no CET, no SSE, no AVX

// Syscall numbers for x86-64
#define SYS_write   1
#define SYS_open    2
#define SYS_execve  59
#define SYS_exit    60
#define SYS_mkdir   83
#define SYS_mount   165

// Inline syscall - 3 args
static inline long syscall3(long n, long a1, long a2, long a3) {
    long ret;
    __asm__ volatile (
        "syscall"
        : "=a" (ret)
        : "a" (n), "D" (a1), "S" (a2), "d" (a3)
        : "rcx", "r11", "memory"
    );
    return ret;
}

// Inline syscall - 5 args (for mount)
static inline long syscall5(long n, long a1, long a2, long a3, long a4, long a5) {
    long ret;
    register long r10 __asm__("r10") = a4;
    register long r8 __asm__("r8") = a5;
    __asm__ volatile (
        "syscall"
        : "=a" (ret)
        : "a" (n), "D" (a1), "S" (a2), "d" (a3), "r" (r10), "r" (r8)
        : "rcx", "r11", "memory"
    );
    return ret;
}

static inline void sys_exit(int code) {
    __asm__ volatile (
        "syscall"
        :
        : "a" (SYS_exit), "D" (code)
    );
    __builtin_unreachable();
}

static inline long sys_write(int fd, const char *buf, unsigned long len) {
    return syscall3(SYS_write, fd, (long)buf, len);
}

static inline long sys_open(const char *path, int flags, int mode) {
    return syscall3(SYS_open, (long)path, flags, mode);
}

static inline long sys_execve(const char *path, char *const argv[], char *const envp[]) {
    return syscall3(SYS_execve, (long)path, (long)argv, (long)envp);
}

static inline long sys_mkdir(const char *path, int mode) {
    return syscall3(SYS_mkdir, (long)path, mode, 0);
}

static inline long sys_mount(const char *src, const char *dst, const char *fs, unsigned long flags, const void *data) {
    return syscall5(SYS_mount, (long)src, (long)dst, (long)fs, flags, (long)data);
}

// Simple strlen
static unsigned long my_strlen(const char *s) {
    const char *p = s;
    while (*p) p++;
    return p - s;
}

// Write string to fd
static void puts_fd(int fd, const char *s) {
    sys_write(fd, s, my_strlen(s));
}

// Global strings to avoid stack-allocated string literals
static const char str_dev_console[] = "/dev/console";
static const char str_dev_tty0[] = "/dev/tty0";
static const char str_starting[] = "\\n[init] Starting...\\n";
static const char str_proc[] = "proc";
static const char str_proc_path[] = "/proc";
static const char str_sysfs[] = "sysfs";
static const char str_sys[] = "/sys";
static const char str_devtmpfs[] = "devtmpfs";
static const char str_dev[] = "/dev";
static const char str_mounted[] = "[init] Mounted /proc /sys /dev\\n";
static const char str_devpts[] = "devpts";
static const char str_dev_pts[] = "/dev/pts";
static const char str_tmpfs[] = "tmpfs";
static const char str_run[] = "/run";
static const char str_exec[] = "[init] Exec /bin/sh...\\n";
static const char str_bin_sh[] = "/bin/sh";
static const char str_c[] = "-c";
static const char str_script[] = "exec /usr/bin/live-init-script";
static const char str_home[] = "HOME=/";
static const char str_term[] = "TERM=linux";
static const char str_path[] = "PATH=/usr/bin:/bin:/usr/sbin:/sbin";
static const char str_sh_fail[] = "[init] sh failed\\n";
static const char str_bin_bash[] = "/bin/bash";
static const char str_fatal[] = "[init] FATAL\\n";

void _start(void) {
    int fd;

    // Try to open console
    fd = sys_open(str_dev_console, 2, 0);
    if (fd < 0) fd = sys_open(str_dev_tty0, 2, 0);
    if (fd < 0) fd = 1;

    puts_fd(fd, str_starting);

    // Mount essential filesystems
    sys_mount(str_proc, str_proc_path, str_proc, 0, 0);
    sys_mount(str_sysfs, str_sys, str_sysfs, 0, 0);
    sys_mount(str_devtmpfs, str_dev, str_devtmpfs, 0, 0);

    puts_fd(fd, str_mounted);

    // Create directories and mount additional filesystems
    sys_mkdir(str_dev_pts, 0755);
    sys_mkdir(str_run, 0755);
    sys_mount(str_devpts, str_dev_pts, str_devpts, 0, 0);
    sys_mount(str_tmpfs, str_run, str_tmpfs, 0, 0);

    puts_fd(fd, str_exec);

    // Exec /bin/sh
    char *argv[] = { (char*)str_bin_sh, (char*)str_c, (char*)str_script, 0 };
    char *envp[] = { (char*)str_home, (char*)str_term, (char*)str_path, 0 };
    sys_execve(str_bin_sh, argv, envp);

    puts_fd(fd, str_sh_fail);

    // Try bash as fallback
    argv[0] = (char*)str_bin_bash;
    sys_execve(str_bin_bash, argv, envp);

    puts_fd(fd, str_fatal);

    // Hang forever
    for (;;) {
        __asm__ volatile ("hlt");
    }
}
INITC

# Compile with NO libc, NO CET, NO stack protection, NO AVX - pure baseline x86-64
gcc -nostdlib -nostartfiles -static \\
    -march=x86-64 -mtune=generic \\
    -mno-avx -mno-avx2 -mno-sse4.2 -mno-sse4.1 -mno-ssse3 \\
    -fno-tree-vectorize \\
    -fcf-protection=none \\
    -fno-stack-protector \\
    -fno-pie -no-pie \\
    -fomit-frame-pointer \\
    -O2 \\
    -o $OUT/usr/bin/static-init /tmp/init.c
chmod 755 $OUT/usr/bin/static-init
rm /tmp/init.c
""",
    visibility = ["PUBLIC"],
)

# Copy live-init script to initramfs location
genrule(
    name = "live-init-script-gen",
    out = "live-init-script",
    srcs = ["//defs/scripts:live-init"],
    cmd = """
mkdir -p $OUT/usr/bin
cp $(location //defs/scripts:live-init) $OUT/usr/bin/live-init-script
chmod +x $OUT/usr/bin/live-init-script
""",
    visibility = ["PUBLIC"],
)

# Rootfs with static init for the initramfs
rootfs(
    name = "buckos-initramfs-rootfs",
    packages = [
        ":baselayout-gen",
        ":static-init-gen",
        ":live-init-script-gen",
        # C runtime (required for dynamically-linked binaries)
        "//packages/linux/core/glibc:glibc",
        # Core utilities
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/bash:bash",
        # Compression (squashfs is mounted via kernel, not userspace tools)
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/system/libs/compression/zstd:zstd",
        "//packages/linux/core/zlib:zlib",
    ],
    visibility = ["PUBLIC"],
)

# Shell script init wrapper - uses bash instead of custom binary for better hardware compatibility
genrule(
    name = "shell-init-gen",
    out = "shell-init",
    cmd = """
mkdir -p $OUT/usr/bin
cat > $OUT/usr/bin/shell-init << 'SHELLINIT'
#!/bin/bash
# Simple shell-based init wrapper
# Mounts essential filesystems then execs the live-init-script

# Mount essential filesystems
mount -t proc proc /proc 2>/dev/null
mount -t sysfs sysfs /sys 2>/dev/null
mount -t devtmpfs devtmpfs /dev 2>/dev/null

# Create required directories
mkdir -p /dev/pts /run 2>/dev/null
mount -t devpts devpts /dev/pts 2>/dev/null
mount -t tmpfs tmpfs /run 2>/dev/null

# Execute the live boot script
exec /usr/bin/live-init-script
SHELLINIT
chmod +x $OUT/usr/bin/shell-init
""",
    visibility = ["PUBLIC"],
)

# Initramfs for live system with shell init (uses bash for better hardware compatibility)
initramfs(
    name = "buckos-live-initramfs-dynamic",
    rootfs = ":buckos-initramfs-rootfs-shell",
    compression = "gz",
    init = "/usr/bin/shell-init",
    visibility = ["PUBLIC"],
)

# Rootfs for shell-based initramfs (dynamic, needs glibc)
rootfs(
    name = "buckos-initramfs-rootfs-shell",
    packages = [
        ":baselayout-gen",
        ":shell-init-gen",
        ":live-init-script-gen",
        # C runtime (required for dynamically-linked binaries)
        "//packages/linux/core/glibc:glibc",
        # Core utilities
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/bash:bash",
        # Compression (squashfs is mounted via kernel, not userspace tools)
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/system/libs/compression/zstd:zstd",
        "//packages/linux/core/zlib:zlib",
    ],
    visibility = ["PUBLIC"],
)

# =============================================================================
# Static Busybox Initramfs (no glibc, no dynamic linking)
# =============================================================================

# Live init script for static busybox - creates proper rootfs structure with /init
# The rootfs merge logic looks for usr/, bin/, lib/, etc. to identify package dirs
# So we create a minimal structure with usr/bin to trigger the merge
genrule(
    name = "busybox-live-init-gen",
    out = "rootfs",
    srcs = ["//defs/scripts:busybox-live-init"],
    cmd = "mkdir -p $OUT/usr/bin && cp $(location //defs/scripts:busybox-live-init) $OUT/init && chmod +x $OUT/init",
    visibility = ["PUBLIC"],
)

# Rootfs for static busybox initramfs (NO glibc - fully static)
rootfs(
    name = "buckos-initramfs-rootfs-static",
    packages = [
        ":baselayout-gen",
        ":busybox-live-init-gen",
        # Static busybox - the ONLY binary needed
        "//packages/linux/core/busybox:busybox-static",
    ],
    visibility = ["PUBLIC"],
)

# Static busybox initramfs for live system with custom live boot init
initramfs(
    name = "buckos-live-initramfs-busybox",
    rootfs = ":buckos-initramfs-rootfs-static",
    compression = "gz",
    init = "/init",
    init_script = "//defs/scripts:busybox-live-init",
    visibility = ["PUBLIC"],
)

# =============================================================================
# Systemd-based Initramfs for Live Boot
# =============================================================================

# Genrule to create systemd unit files structure for initramfs
genrule(
    name = "systemd-live-units-gen",
    out = "systemd-live-units",
    srcs = [
        "//defs/scripts:initrd-live-media-service",
        "//defs/scripts:initrd-live-media-script",
    ],
    cmd = """
        mkdir -p $OUT/usr/lib/systemd/system/initrd.target.wants
        mkdir -p $OUT/usr/lib/systemd/scripts

        # Install service unit
        cp $(location //defs/scripts:initrd-live-media-service) $OUT/usr/lib/systemd/system/initrd-live-media.service

        # Install script
        cp $(location //defs/scripts:initrd-live-media-script) $OUT/usr/lib/systemd/scripts/initrd-live-media.sh
        chmod +x $OUT/usr/lib/systemd/scripts/initrd-live-media.sh

        # Enable the service for initrd targets
        mkdir -p $OUT/usr/lib/systemd/system/initrd.target.wants
        mkdir -p $OUT/usr/lib/systemd/system/initrd-root-fs.target.requires
        ln -sf ../initrd-live-media.service $OUT/usr/lib/systemd/system/initrd.target.wants/initrd-live-media.service
        ln -sf ../initrd-live-media.service $OUT/usr/lib/systemd/system/initrd-root-fs.target.requires/initrd-live-media.service

        # Set initrd.target as the default target for initrd
        mkdir -p $OUT/etc/systemd/system
        ln -sf /usr/lib/systemd/system/initrd.target $OUT/etc/systemd/system/default.target

        # Create a sysroot.mount override that is satisfied by our script
        mkdir -p $OUT/etc/systemd/system/sysroot.mount.d
        cat > $OUT/etc/systemd/system/sysroot.mount.d/live.conf << 'SYSROOTCONF'
[Unit]
# Allow sysroot.mount to succeed even though we're mounting from our script
ConditionPathIsMountPoint=
AssertPathIsMountPoint=
After=initrd-live-media.service
Requires=initrd-live-media.service
SYSROOTCONF

        # Create a drop-in for initrd-root-fs.target to remove its assertions
        mkdir -p $OUT/etc/systemd/system/initrd-root-fs.target.d
        cat > $OUT/etc/systemd/system/initrd-root-fs.target.d/live.conf << 'ROOTFSTARGET'
[Unit]
# Remove assertions for live boot - our script handles mounting
AssertPathIsMountPoint=
After=initrd-live-media.service
Requires=initrd-live-media.service
ROOTFSTARGET

        # Create /etc/initrd-release - systemd's initrd-switch-root.service checks for this
        mkdir -p $OUT/etc
        cat > $OUT/etc/initrd-release << 'INITRDRELEASE'
NAME="BuckOS Live"
ID=buckos
VERSION_ID=1.0
PRETTY_NAME="BuckOS Live Boot Environment"
INITRDRELEASE

        # Create drop-in for initrd-switch-root.service to remove assertions and add our deps
        mkdir -p $OUT/etc/systemd/system/initrd-switch-root.service.d
        cat > $OUT/etc/systemd/system/initrd-switch-root.service.d/live.conf << 'SWITCHROOTCONF'
[Unit]
# Clear assertions that may fail in live boot
AssertPathExists=
# Ensure we run after live media is mounted
After=initrd-live-media.service
Requires=initrd-live-media.service
SWITCHROOTCONF

        # Make initrd-root-fs.target want switch-root.service (not initrd.target)
        # This ensures switch-root only runs AFTER root fs is mounted
        mkdir -p $OUT/usr/lib/systemd/system/initrd-root-fs.target.wants
        ln -sf ../initrd-switch-root.service $OUT/usr/lib/systemd/system/initrd-root-fs.target.wants/initrd-switch-root.service

        # Create symlink for init
        mkdir -p $OUT/usr/sbin
        ln -sf ../lib/systemd/systemd $OUT/usr/sbin/init

        # Create /init symlink (kernel looks for this)
        ln -sf usr/lib/systemd/systemd $OUT/init
    """,
    visibility = ["PUBLIC"],
)

# Rootfs with systemd for initramfs (minimal set for live boot)
rootfs(
    name = "buckos-initramfs-rootfs-systemd",
    packages = [
        ":baselayout-gen",
        ":systemd-live-units-gen",
        # Core system
        "//packages/linux/core/glibc:glibc",
        "//packages/linux/core/bash:bash",
        # systemd for init
        "//packages/linux/system/init/systemd:systemd",
        # udev for device detection (systemd includes this)
        # Basic utilities
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/core/util-linux:util-linux",
        # kmod for module loading
        "//packages/linux/system/libs/kmod:kmod",
        # Static busybox as fallback and for blkid
        "//packages/linux/core/busybox:busybox-static",
    ],
    visibility = ["PUBLIC"],
)

# Systemd-based initramfs for live boot
initramfs(
    name = "buckos-live-initramfs-systemd",
    rootfs = ":buckos-initramfs-rootfs-systemd",
    compression = "gz",
    init = "/usr/lib/systemd/systemd",
    visibility = ["PUBLIC"],
)

# =============================================================================
# Dracut-based Initramfs (recommended for live boot)
# =============================================================================

# Rootfs with dracut and all dependencies for initramfs generation
rootfs(
    name = "buckos-dracut-builder-rootfs",
    packages = [
        ":baselayout-gen",
        # Dracut and its dependencies
        "//packages/linux/system/initramfs/dracut:dracut",
        # Core system
        "//packages/linux/core/glibc:glibc",
        "//packages/linux/core/bash:bash",
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/core/util-linux:util-linux",
        # systemd for initrd
        "//packages/linux/system/init/systemd:systemd",
        # udev for device detection
        "//packages/linux/system/init/eudev:eudev",
        # Compression utilities
        "//packages/linux/system/libs/compression/gzip:gzip",
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/system/libs/compression/zstd:zstd",
        # kmod for module loading
        "//packages/linux/system/libs/kmod:kmod",
        # Other utilities dracut needs
        "//packages/linux/system/apps/findutils:findutils",
        "//packages/linux/editors/sed:sed",
        "//packages/linux/editors/grep:grep",
        "//packages/linux/system/libs/cpio:cpio",
        # Device-mapper for dmsquash-live (dmsetup)
        "//packages/linux/system/security/cryptsetup:lvm2",
        # Network utilities (ip command)
        "//packages/linux/network/iproute2:iproute2",
        # ncurses for bash/readline (libtinfow)
        "//packages/linux/system/terminal/ncurses:ncurses",
        # awk for various scripts
        "//packages/linux/editors/gawk:gawk",
        # tar for img-lib module
        "//packages/linux/system/apps/tar:tar",
    ],
    visibility = ["PUBLIC"],
)

# Dracut-generated initramfs with dmsquash-live for live boot
dracut_initramfs(
    name = "buckos-live-initramfs",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-live",
    dracut = "//packages/linux/system/initramfs/dracut:dracut",
    rootfs = ":buckos-dracut-builder-rootfs",
    add_modules = ["dmsquash-live", "livenet", "systemd", "systemd-initrd"],
    compression = "gzip",
    visibility = ["PUBLIC"],
)

# =============================================================================
# Live Installer ISO Images
# =============================================================================

# Live ISO with KDE Plasma desktop (hybrid BIOS+UEFI boot)
iso_image(
    name = "buckos-live-installer-kde",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-live",
    initramfs = ":buckos-live-initramfs-systemd",
    rootfs = ":buckos-live-kde-rootfs",
    boot_mode = "hybrid",
    volume_label = "BUCKOS_LIVE",
    # Systemd initrd boot parameters (no serial console - causes hangs on AMD laptops)
    kernel_args = "console=tty0 loglevel=7 rd.systemd.show_status=true",
    visibility = ["PUBLIC"],
)

# Live ISO with Sway (lighter alternative)
iso_image(
    name = "buckos-live-installer-sway",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-live",
    initramfs = ":buckos-live-initramfs",
    rootfs = ":buckos-live-sway-rootfs",
    boot_mode = "hybrid",
    volume_label = "BUCKOS_LIVE",
    kernel_args = "console=tty0 console=ttyS0,115200 rdinit=/init nokaslr",
    visibility = ["PUBLIC"],
)

# Live ISO with KDE Plasma desktop for aarch64 (UEFI boot)
iso_image(
    name = "buckos-live-installer-kde-aarch64",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-live",
    initramfs = ":buckos-live-initramfs",
    rootfs = ":buckos-live-kde-rootfs",
    boot_mode = "uefi",  # ARM boards typically use UEFI
    volume_label = "BUCKOS_LIVE_ARM64",
    kernel_args = "console=tty0 console=ttyAMA0,115200 init=/init quiet systemd.unified_cgroup_hierarchy=1",
    default_target_platform = "//platforms:linux-aarch64-target",
    visibility = ["PUBLIC"],
)

# Main live installer ISO (defaults to KDE x86_64)
alias(
    name = "buckos-live-installer",
    actual = ":buckos-live-installer-kde",
    visibility = ["PUBLIC"],
)

# =============================================================================
# QEMU Test Scripts for Live System
# =============================================================================

qemu_boot_script(
    name = "qemu-boot-live-kde",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-live",
    initramfs = ":buckos-live-initramfs",
    arch = "x86_64",
    memory = "4G",
    cpus = "4",
    kernel_args = "console=ttyS0 rdinit=/init",
    extra_args = [
        "-enable-kvm",
        "-vga virtio",
        "-display gtk",
    ],
    visibility = ["PUBLIC"],
)

qemu_boot_script(
    name = "qemu-boot-live-sway",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-live",
    initramfs = ":buckos-live-initramfs",
    arch = "x86_64",
    memory = "2G",
    cpus = "2",
    kernel_args = "console=ttyS0 rdinit=/init",
    extra_args = [
        "-enable-kvm",
        "-vga virtio",
        "-display gtk",
    ],
    visibility = ["PUBLIC"],
)

# =============================================================================
# ARM64 (aarch64) System Targets
# =============================================================================
# Cross-compiled system images for ARM64 architecture.
# Build with: buck2 build //packages/linux/system:buckos-rootfs-aarch64 \
#             --target-platforms //platforms:linux-aarch64-target
#
# These targets produce ARM64 binaries that can run on:
# - QEMU aarch64 VMs
# - AWS Graviton instances
# - Azure Ampere instances
# - Raspberry Pi 4 and similar ARM64 SBCs
# =============================================================================

# ARM64 baselayout - Core filesystem layout for aarch64
# Note: ARM64 uses 'lib' instead of 'lib64'
# Create symlinks lib64 -> lib so packages configured for x86_64 paths still work
genrule(
    name = "baselayout-aarch64-gen",
    out = "baselayout-aarch64",
    default_target_platform = "//platforms:linux-aarch64-target",
    cmd = """
mkdir -p $OUT
# Create merged-usr FHS directory structure for ARM64
# First create the real directories in /usr
mkdir -p $OUT/usr/bin
mkdir -p $OUT/usr/sbin
mkdir -p $OUT/usr/lib
# Then create symlinks from / to /usr (merged-usr layout)
ln -s usr/bin $OUT/bin
ln -s usr/sbin $OUT/sbin
ln -s usr/lib $OUT/lib
# Create /usr/bin/sh symlink to bash (required for #!/bin/sh scripts in initramfs)
ln -s bash $OUT/usr/bin/sh
mkdir -p $OUT/usr/share
mkdir -p $OUT/usr/include
mkdir -p $OUT/usr/local/bin
mkdir -p $OUT/usr/local/sbin
mkdir -p $OUT/usr/local/lib
mkdir -p $OUT/etc
mkdir -p $OUT/var/log
mkdir -p $OUT/var/tmp
mkdir -p $OUT/tmp
mkdir -p $OUT/proc
mkdir -p $OUT/sys
mkdir -p $OUT/dev
mkdir -p $OUT/run
mkdir -p $OUT/run/lock
mkdir -p $OUT/run/user
mkdir -p $OUT/root
mkdir -p $OUT/home
mkdir -p $OUT/mnt
mkdir -p $OUT/opt
mkdir -p $OUT/boot
# Create systemd-compatible symlinks (fixes systemd taints)
ln -s ../run $OUT/var/run
ln -s ../run/lock $OUT/var/lock
# NOTE: Do NOT create lib64 symlinks here. The rootfs assembly script handles
# merging lib64 contents into lib and creating symlinks AFTER all packages are copied.
# Creating symlinks here causes cp -a to fail when copying package lib64 directories.
# Set permissions
chmod 1777 $OUT/tmp
chmod 1777 $OUT/var/tmp
chmod 700 $OUT/root
""",
    visibility = ["PUBLIC"],
)

filegroup(
    name = "baselayout-aarch64",
    srcs = [":baselayout-aarch64-gen"],
    default_target_platform = "//platforms:linux-aarch64-target",
    visibility = ["PUBLIC"],
)

# ARM64 Minimal rootfs
rootfs(
    name = "buckos-rootfs-aarch64",
    packages = [
        ":init-scripts-gen",
        ":baselayout-aarch64-gen",
        # C runtime (required for all dynamically-linked binaries)
        "//packages/linux/core/glibc:glibc",
        # Core system
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/system/libs/cpio:cpio",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/zlib:zlib",
        # Shell and terminal
        "//packages/linux/system/terminal/ncurses:ncurses",
        "//packages/linux/system/terminal/readline:readline",
        "//packages/linux/core/bash:bash",
        "//packages/linux/core/less:less",
        # Compression
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        # System utilities
        "//packages/linux/core/procps-ng:procps-ng",
        "//packages/linux/core/file:file",
        # User management
        "//packages/linux/system/apps/shadow:shadow",
        # Networking
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/network/curl:curl",
        # TODO: OpenSSH 9.9p1 has build issues with cross-compilation (arc4random, strlcpy)
        # "//packages/linux/network/openssh:openssh",
        "//packages/linux/network/iproute2:iproute2",
        "//packages/linux/network/dhcpcd:dhcpcd",
        "//packages/linux/network/net-tools:net-tools",
    ],
    default_target_platform = "//platforms:linux-aarch64-target",
    visibility = ["PUBLIC"],
)

# ARM64 initramfs
initramfs(
    name = "buckos-initramfs-aarch64",
    rootfs = ":buckos-rootfs-aarch64",
    compression = "gz",
    init = "/sbin/init",
    default_target_platform = "//platforms:linux-aarch64-target",
    visibility = ["PUBLIC"],
)

# ARM64 QEMU boot script
qemu_boot_script(
    name = "qemu-boot-aarch64",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-aarch64",
    initramfs = ":buckos-initramfs-aarch64",
    arch = "aarch64",
    memory = "2G",
    cpus = "2",
    kernel_args = "console=ttyAMA0 rdinit=/init",
    visibility = ["PUBLIC"],
)

# ARM64 QEMU boot with more resources
qemu_boot_script(
    name = "qemu-boot-aarch64-dev",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-aarch64",
    initramfs = ":buckos-initramfs-aarch64",
    arch = "aarch64",
    memory = "4G",
    cpus = "4",
    kernel_args = "console=ttyAMA0 rdinit=/init loglevel=7",
    visibility = ["PUBLIC"],
)

# =============================================================================
# ARM64 Stage3 Tarballs
# =============================================================================

# ARM64 Stage3 minimal rootfs
rootfs(
    name = "stage3-minimal-rootfs-aarch64",
    packages = [
        ":init-scripts-gen",
        ":baselayout-aarch64-gen",
        # Core system
        "//packages/linux/core/glibc:glibc",
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/procps-ng:procps-ng",
        "//packages/linux/system/apps/shadow:shadow",
        "//packages/linux/core/file:file",
        # Shell and terminal
        "//packages/linux/core/bash:bash",
        "//packages/linux/system/terminal/readline:readline",
        "//packages/linux/system/terminal/ncurses:ncurses",
        "//packages/linux/core/less:less",
        # Compression
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/system/libs/compression/gzip:gzip",
        "//packages/linux/system/apps/tar:tar",
        # Basic libraries
        "//packages/linux/core/zlib:zlib",
    ],
    default_target_platform = "//platforms:linux-aarch64-target",
    visibility = ["PUBLIC"],
)

# ARM64 minimal stage3 tarball
stage3_tarball(
    name = "stage3-arm64-minimal",
    rootfs = ":stage3-minimal-rootfs-aarch64",
    variant = "minimal",
    arch = "arm64",
    libc = "glibc",
    compression = "xz",
    visibility = ["PUBLIC"],
)

# ARM64 Stage3 base rootfs (with build tools)
rootfs(
    name = "stage3-base-rootfs-aarch64",
    packages = [
        ":init-scripts-gen",
        ":baselayout-aarch64-gen",
        # Core system
        "//packages/linux/core/glibc:glibc",
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/procps-ng:procps-ng",
        "//packages/linux/system/apps/shadow:shadow",
        "//packages/linux/core/file:file",
        "//packages/linux/core/bash:bash",
        "//packages/linux/system/terminal/readline:readline",
        "//packages/linux/system/terminal/ncurses:ncurses",
        "//packages/linux/core/less:less",
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/system/libs/compression/gzip:gzip",
        "//packages/linux/system/apps/tar:tar",
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/system/libs/data/expat:expat",
        # Networking
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/network/curl:curl",
        "//packages/linux/network/iproute2:iproute2",
        # Build essentials
        "//packages/linux/system/apps/patch:patch",
        "//packages/linux/system/apps/sed:sed",
        "//packages/linux/system/apps/gawk:gawk",
        "//packages/linux/editors/grep:grep",
        "//packages/linux/system/apps/diffutils:diffutils",
        "//packages/linux/system/apps/findutils:findutils",
        "//packages/linux/dev-tools/build-systems/make:make",
    ],
    default_target_platform = "//platforms:linux-aarch64-target",
    visibility = ["PUBLIC"],
)

# ARM64 base stage3 tarball
stage3_tarball(
    name = "stage3-arm64-base",
    rootfs = ":stage3-base-rootfs-aarch64",
    variant = "base",
    arch = "arm64",
    libc = "glibc",
    compression = "xz",
    visibility = ["PUBLIC"],
)

# =============================================================================
# ARM64 Live CD/USB System
# =============================================================================
# Live system for ARM64 with Sway desktop (lightweight, works well on ARM)
# Boots via UEFI on ARM64 hardware and QEMU

# ARM64 Live init scripts
filegroup(
    name = "live-init-scripts-aarch64",
    srcs = [":live-init-scripts-gen"],
    default_target_platform = "//platforms:linux-aarch64-target",
    visibility = ["PUBLIC"],
)

# ARM64 Live rootfs with Sway desktop
# Matches x86 buckos-live-sway-rootfs with systemd init
rootfs(
    name = "buckos-live-sway-rootfs-aarch64",
    packages = [
        ":live-init-scripts-gen",
        ":baselayout-aarch64-gen",
        # C runtime (required for all dynamically-linked binaries)
        "//packages/linux/core/glibc:glibc",
        # Core system utilities
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/editors/grep:grep",
        "//packages/linux/system/libs/cpio:cpio",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/terminal/ncurses:ncurses",
        "//packages/linux/system/terminal/readline:readline",
        "//packages/linux/core/bash:bash",
        "//packages/linux/core/less:less",
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/core/procps-ng:procps-ng",
        "//packages/linux/core/file:file",
        "//packages/linux/system/apps/shadow:shadow",
        # PAM runtime dependencies (pam_unix.so needs these)
        "//packages/linux/system/libs/ipc/libtirpc:libtirpc",
        "//packages/linux/system/libs/network/libnsl:libnsl",
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/network/curl:curl",
        # TODO: OpenSSH 9.9p1 has build issues with cross-compilation (arc4random, strlcpy)
        # "//packages/linux/network/openssh:openssh",
        "//packages/linux/network/iproute2:iproute2",
        "//packages/linux/network/dhcpcd:dhcpcd",
        "//packages/linux/network/net-tools:net-tools",
        # Init system
        "//packages/linux/system/init/systemd:systemd",
        # Device management and session (systemd provides libudev and udevd)
        "//packages/linux/system/libs/libseat:libseat",
        "//packages/linux/system/libs/ipc/dbus:dbus",
        "//packages/linux/system/libs/kmod:kmod",
        # Graphics stack
        "//packages/linux/desktop/mesa:mesa",
        "//packages/linux/graphics/rendering/wayland:wayland",
        "//packages/linux/graphics/rendering/wayland-protocols:wayland-protocols",
        "//packages/linux/system/libs/input/libinput:libinput",
        "//packages/linux/desktop/libdrm:libdrm",
        # Sway compositor (lightweight, good for ARM)
        "//packages/linux/desktop/sway:sway-desktop",
        # Terminal
        "//packages/linux/terminals/foot:foot",
        # Development tools
        "//packages/linux/dev-tools/vcs/git:git",
        "//packages/linux/editors/vim:vim",
    ],
    default_target_platform = "//platforms:linux-aarch64-target",
    visibility = ["PUBLIC"],
)

# ARM64 Live initramfs
# Uses the initramfs-init script for live boot from CD/USB
# The script mounts the boot media, finds squashfs, sets up overlay, and switches root
initramfs(
    name = "buckos-live-initramfs-aarch64",
    rootfs = ":buckos-rootfs-aarch64",
    compression = "gz",
    init = "/init",  # Use /init for initramfs (standard location)
    init_script = "//defs/scripts:initramfs-init",  # Live boot script
    default_target_platform = "//platforms:linux-aarch64-target",
    visibility = ["PUBLIC"],
)

# ARM64 Live ISO with Sway
# Uses EFI boot mode (standard for ARM64)
iso_image(
    name = "buckos-live-installer-aarch64-iso",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-aarch64",
    initramfs = ":buckos-live-initramfs-aarch64",
    rootfs = ":buckos-live-sway-rootfs-aarch64",
    boot_mode = "efi",  # ARM64 uses UEFI
    volume_label = "BUCKOS_ARM64",
    kernel_args = "quiet splash rdinit=/init",
    arch = "aarch64",
    visibility = ["PUBLIC"],
)

# ARM64 Live ISO (alias)
alias(
    name = "buckos-live-iso-aarch64",
    actual = ":buckos-live-installer-aarch64-iso",
    visibility = ["PUBLIC"],
)

# =============================================================================
# ARM64 QEMU Test Scripts for Live System
# =============================================================================

# QEMU boot for ARM64 live system with graphics
qemu_boot_script(
    name = "qemu-boot-live-aarch64",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-aarch64",
    initramfs = ":buckos-live-initramfs-aarch64",
    arch = "aarch64",
    memory = "2G",
    cpus = "4",
    kernel_args = "console=ttyAMA0 rdinit=/init",
    extra_args = [
        "-device virtio-gpu-pci",
        "-display gtk",
    ],
    visibility = ["PUBLIC"],
)

# QEMU boot for ARM64 live with full desktop (needs more RAM)
qemu_boot_script(
    name = "qemu-boot-live-aarch64-desktop",
    kernel = "//packages/linux/kernel/buckos-kernel:buckos-kernel-aarch64",
    initramfs = ":buckos-live-initramfs-aarch64",
    arch = "aarch64",
    memory = "4G",
    cpus = "4",
    kernel_args = "console=ttyAMA0 rdinit=/init",
    extra_args = [
        "-device virtio-gpu-pci",
        "-device usb-ehci",
        "-device usb-kbd",
        "-device usb-mouse",
        "-display gtk",
    ],
    visibility = ["PUBLIC"],
)

