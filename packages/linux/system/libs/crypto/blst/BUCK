load("@root//defs:package_defs.bzl","make_package")

# blst - BLS12-381 signature library
#
# blst (pronounced 'blast') is a BLS12-381 signature library focused on
# performance and security. It is written in C and assembly.
#
# This library uses a custom build.sh script rather than autotools/cmake.
# The build process compiles assembly and C sources into static and shared libraries.
#
# USE flags:
#   static-libs - Build and install static libraries
#   portable    - Build portable version (no CPU-specific optimizations)

make_package(
    name = "blst",
    version = "0.3.7",
    src_uri = "https://github.com/supranational/blst/archive/refs/tags/v0.3.7.tar.gz",
    sha256 = "b70876c7f97dee3a6933e56fb0cfa52bb77f6e92c0961a429b73784ab2254b8d",
    description = "BLS12-381 signature library focused on performance and security",
    homepage = "https://github.com/supranational/blst",
    license = "Apache-2.0",
    iuse = ["static-libs", "portable"],
    use_defaults = ["static-libs"],
    deps = [],
    use_deps = {},

    # blst uses build.sh, not autotools configure

    # Custom compilation using build.sh
    src_compile = """
# Build blst library using build.sh
# The -shared flag builds both static and shared libraries
export CFLAGS="${CFLAGS} -O2 -fPIC"
if use portable; then
    export CFLAGS="${CFLAGS} -D__BLST_PORTABLE__"
fi

# Build shared and static libraries
./build.sh -shared
""",

    # Custom installation
    src_install = """
# Install libraries
install -d "${DESTDIR}/usr/lib"
install -m 644 libblst.a "${DESTDIR}/usr/lib/"
install -m 755 libblst.so "${DESTDIR}/usr/lib/"

# Install headers
install -d "${DESTDIR}/usr/include/blst"
install -m 644 bindings/blst.h "${DESTDIR}/usr/include/blst/"
install -m 644 bindings/blst_aux.h "${DESTDIR}/usr/include/blst/"

# Remove static library if not requested
if ! use static-libs; then
    rm -f "${DESTDIR}/usr/lib/libblst.a"
fi
""",

    visibility = ["PUBLIC"],
)
