load("@root//defs:package_defs.bzl", "download_source", "autotools_package")
load("@root//defs:use_flags.bzl", "set_use_flags")

autotools_package(
    name = "zstd",
    version = "1.5.6",
    src_uri = "https://github.com/facebook/zstd/releases/download/v1.5.6/zstd-1.5.6.tar.gz",
    sha256 = "8c29e06cf42aacc1eafc4077ae2ec6c6fcb96a626157e0593d5e82a34fd403c1",
    signature_sha256 = "9c2287421e09619e243d07bf0fbdb0aa56d4e38ee24cb8d0ca6dc58f4d381d99",
    signature_required = False,
    description = "Fast lossless compression algorithm",
    homepage = "https://facebook.github.io/zstd/",
    license = "BSD-3-Clause",
    iuse = ["static-libs", "lz4", "zlib", "lzma", "threads"],
    use_defaults = ["threads"],
    use_configure = {},
    use_deps = {
        "lz4": ["system//libs/compression/lz4:lz4"],
        "zlib": ["core//zlib:zlib"],
        "lzma": ["system//libs/compression/xz:xz"],
    },
    configure_args = [],
    # zstd doesn't use autotools - skip configure phase
    src_configure = """
# zstd uses plain Makefile, no configure needed
# Setup environment for build
export PREFIX=/usr

# Build flags for optional features
if [ "${USE_lz4}" = "1" ]; then
    export HAVE_LZ4=1
fi
if [ "${USE_zlib}" = "1" ]; then
    export HAVE_ZLIB=1
fi
if [ "${USE_lzma}" = "1" ]; then
    export HAVE_LZMA=1
fi
if [ "${USE_threads}" = "1" ]; then
    export ZSTD_LEGACY_SUPPORT=0
    export HAVE_PTHREAD=1
fi

echo "zstd: Skipping configure (Makefile-only package)"
""",
    # Build zstd - both static and shared libraries
    src_compile = """
# Build both static and shared libraries
# Pass cross-compiler flags to make (CC is set by ebuild environment)
echo "Building zstd with CC=$CC"
cd lib
# Set BUILD_DIR explicitly to avoid recursive make losing CC/AR/RANLIB variables
# The Makefile's SET_CACHE_DIRECTORY recursive call doesn't pass CC/AR/RANLIB
mkdir -p obj/build/static obj/build/dynamic
make -j${MAKEOPTS:-$(nproc)} PREFIX=/usr \
    BUILD_DIR=obj/build \
    CFLAGS="$CFLAGS -fPIC" \
    CPPFLAGS="$CPPFLAGS" \
    CC="$CC" \
    AR="$AR" \
    RANLIB="$RANLIB" \
    libzstd.a libzstd
ls -la libzstd.* 2>/dev/null || echo "No libzstd files found in lib/"
ls -la obj/build/dynamic/ 2>/dev/null || echo "No files in dynamic/"
# Copy shared library to lib/ for the programs build to find
cp -a obj/build/dynamic/libzstd.so* . 2>/dev/null || true
ls -la libzstd.* 2>/dev/null || echo "No libzstd files after copy"
cd ../programs
make -j${MAKEOPTS:-$(nproc)} PREFIX=/usr CC="$CC" CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS -L../lib -Wl,-rpath,." zstd
""",
    # Install both programs and libraries
    src_install = """
# Use lib64 for x86_64 consistency
LIBDIR="${LIBDIR:-lib64}"
install -d "$DESTDIR/usr/$LIBDIR"
install -d "$DESTDIR/usr/include"
install -d "$DESTDIR/usr/bin"
install -d "$DESTDIR/usr/$LIBDIR/pkgconfig"

# Install library
cd lib
echo "Installing from lib directory:"
ls -la libzstd.* 2>/dev/null || echo "Warning: No libzstd files in lib/"
ls -la obj/build/dynamic/ 2>/dev/null || echo "Warning: No files in obj/build/dynamic/"

# Install static library from BUILD_DIR
if [ -f "obj/build/static/libzstd.a" ]; then
    install -m644 obj/build/static/libzstd.a "$DESTDIR/usr/$LIBDIR/"
    echo "Installed: libzstd.a"
fi

# Install shared library from BUILD_DIR/dynamic
# The shared library is built as libzstd.so.X.Y.Z in obj/build/dynamic/
for f in obj/build/dynamic/libzstd.so.*; do
    if [ -f "$f" ] && [ ! -L "$f" ]; then
        install -m755 "$f" "$DESTDIR/usr/$LIBDIR/"
        echo "Installed: $(basename $f)"
    fi
done

# Create symlinks for shared library
FULL_SO=$(ls obj/build/dynamic/libzstd.so.* 2>/dev/null | grep -v '\.so\.[0-9]*$' | head -1)
if [ -n "$FULL_SO" ]; then
    BASENAME=$(basename "$FULL_SO")
    # Extract major version (e.g., libzstd.so.1.5.6 -> 1)
    MAJOR=$(echo "$BASENAME" | sed 's/libzstd.so.\([0-9]*\).*/\1/')
    # Create versioned symlink (libzstd.so.1)
    ln -sf "$BASENAME" "$DESTDIR/usr/$LIBDIR/libzstd.so.$MAJOR"
    echo "Created symlink: libzstd.so.$MAJOR -> $BASENAME"
    # Create unversioned symlink (libzstd.so)
    ln -sf "$BASENAME" "$DESTDIR/usr/$LIBDIR/libzstd.so"
    echo "Created symlink: libzstd.so -> $BASENAME"
fi

install -m644 zstd.h zdict.h zstd_errors.h "$DESTDIR/usr/include/"
# Generate pkg-config file
cat > "$DESTDIR/usr/$LIBDIR/pkgconfig/libzstd.pc" << EOF
prefix=/usr
exec_prefix=\${prefix}
libdir=\${prefix}/$LIBDIR
includedir=\${prefix}/include

Name: zstd
Description: fast lossless compression algorithm library
URL: https://facebook.github.io/zstd/
Version: $PV
Libs: -L\${libdir} -lzstd
Cflags: -I\${includedir}
EOF

# Install program
cd ../programs
install -m755 zstd "$DESTDIR/usr/bin/"
ln -sf zstd "$DESTDIR/usr/bin/zstdcat"
ln -sf zstd "$DESTDIR/usr/bin/unzstd"
ln -sf zstd "$DESTDIR/usr/bin/zstdmt"
""",
    post_install = """
# Remove static library if USE flag is disabled
if [ "${USE_static_libs}" != "1" ]; then
    rm -f "$DESTDIR/usr/lib/libzstd.a" "$DESTDIR/usr/lib64/libzstd.a"
    echo "Removed static libraries (USE_static_libs not enabled)"
fi

# Fix pkg-config file - zstd's Makefile generates incorrect relative libdir
# This causes libtool to fail when trying to resolve -Llib64 as an absolute path
if [ -f "$DESTDIR/usr/lib64/pkgconfig/libzstd.pc" ]; then
    sed -i 's|^libdir=lib64$|libdir=${prefix}/lib64|' "$DESTDIR/usr/lib64/pkgconfig/libzstd.pc"
    echo "Fixed libzstd.pc to use absolute libdir path"
fi
""",
    deps = [],
    visibility = ["PUBLIC"],
)
