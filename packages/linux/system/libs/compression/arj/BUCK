load("//defs:package_defs.bzl","download_source", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags")

# arj - ARJ archive utility
autotools_package(
    name = "arj",
    src_uri = "https://downloads.sourceforge.net/arj/arj-3.10.22.tar.gz",

    sha256 = "589e4c9bccc8669e7b6d8d6fcd64e01f6a2c21fe10aad56a83304ecc3b96a7db",
    version = "3.10.22",
    description = "Open-source ARJ archiver",
    homepage = "https://arj.sourceforge.net",
    license = "GPL-2",
    bdepend = [],
    src_prepare = """
# Update config.sub and config.guess in the gnu directory
if [ -d gnu ]; then
    # Try to find modern config.sub and config.guess from automake
    found=0
    for dir in /usr/share/automake-* /usr/share/automake /usr/share/misc /usr/share/gnuconfig; do
        if [ -f "$dir/config.sub" ] && [ -f "$dir/config.guess" ]; then
            echo "Copying config.sub and config.guess from $dir"
            cp -f "$dir/config.sub" gnu/config.sub
            cp -f "$dir/config.guess" gnu/config.guess
            chmod +x gnu/config.sub gnu/config.guess
            found=1
            break
        fi
    done

    if [ $found -eq 0 ]; then
        echo "Warning: Could not find config.sub and config.guess, trying alternative locations"
        # Try to use automake's config scripts via automake package
        if command -v automake >/dev/null 2>&1; then
            automake_dir=$(automake --print-libdir 2>/dev/null || echo "")
            if [ -n "$automake_dir" ] && [ -f "$automake_dir/config.sub" ]; then
                echo "Using automake's config files from $automake_dir"
                cp -f "$automake_dir/config.sub" gnu/config.sub
                cp -f "$automake_dir/config.guess" gnu/config.guess
                chmod +x gnu/config.sub gnu/config.guess
            fi
        fi
    fi

    # Make configure executable
    if [ -f gnu/configure ]; then
        chmod +x gnu/configure
    fi
fi
""",
    src_configure = """
cd gnu
if [ -f configure ]; then
    ./configure --prefix=/usr
fi
cd ..
""",
    src_compile = """
# ARJ builds in the gnu/ subdirectory
cd gnu
make -j${MAKEOPTS:-$(nproc)} ${EXTRA_EMAKE:-}
cd ..
""",
    src_install = """
# ARJ installs from the gnu/ subdirectory
cd gnu
make DESTDIR="$D" install
cd ..
""",
    deps = [
    ],
    visibility = ["PUBLIC"],
)
