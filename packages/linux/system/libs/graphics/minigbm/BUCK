load("@root//defs:package_defs.bzl","download_source", "make_package")
load("@root//defs:use_flags.bzl", "set_use_flags")

# NOTE: Using intel/minigbm GitHub mirror as chromium.googlesource blocks CI/CD
download_source(
    name = "minigbm-src",
    src_uri = "https://github.com/intel/minigbm/archive/refs/heads/master.tar.gz",
    sha256 = "8244c0eea5c9fb39a8f8bf8c8e7522b171a83cb6bf2c402719d86ab5bb0dc87a",
    signature_required = False,
)

make_package(
    name = "minigbm",
    source = ":minigbm-src",
    version = "main",
    description = "Mini GBM implementation for ChromeOS",
    homepage = "https://chromium.googlesource.com/chromiumos/platform/minigbm",
    license = "BSD-3-Clause",
    bdepend = [
        "dev-tools//build-systems/pkg-config:pkg-config",
    ],
    env = {
        # Disable problematic drivers that require platform-specific headers
        # Only build generic/minimal drivers: evdi, nouveau, udl, vgem, virtio_gpu
        # Disabled: DRV_I915 (requires i915_private.h functions)
        #           DRV_AMDGPU, DRV_EXYNOS, DRV_MARVELL, DRV_MEDIATEK
        #           DRV_MESON, DRV_MSM, DRV_RADEON, DRV_ROCKCHIP
        #           DRV_SYNAPTICS, DRV_TEGRA, DRV_VC4
        "CFLAGS": "${CFLAGS:-} -Wno-error -Wno-implicit-function-declaration -Wno-maybe-uninitialized",
    },
    src_compile = """
# Build without i915 driver which requires proprietary headers
make -j$(nproc) \\
    DRV_I915=0 \\
    DRV_AMDGPU=0 \\
    DRV_EXYNOS=0 \\
    DRV_MARVELL=0 \\
    DRV_MEDIATEK=0 \\
    DRV_MESON=0 \\
    DRV_MSM=0 \\
    DRV_RADEON=0 \\
    DRV_ROCKCHIP=0 \\
    DRV_SYNAPTICS=0 \\
    DRV_TEGRA=0 \\
    DRV_VC4=0
""",
    make_args = [
        "DESTDIR=$DESTDIR",
        "PREFIX=/usr",
        "LIBDIR=/usr/lib",
    ],
    deps = [
        "desktop//libdrm:libdrm",
    ],
    visibility = ["PUBLIC"],
)
