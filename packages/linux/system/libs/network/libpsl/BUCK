load("//defs:package.bzl", "package")

package(
    build_rule = "meson",
    name = "libpsl",
    version = "0.21.5",
    url = "https://github.com/rockdaboot/libpsl/releases/download/0.21.5/libpsl-0.21.5.tar.gz",
    sha256 = "1dcc9ceae8b128f3c0b3f654decd0e1e891afc6ff81098f227ef260449dae208",

    description = "Public Suffix List library",  # Cache invalidation: 2026-01-30
    homepage = "https://github.com/rockdaboot/libpsl",
    license = "MIT",

    # USE flags:
    # static-libs - Build static libraries
    # builtin - Use built-in PSL data instead of loading at runtime
    # idn - Enable IDN/Unicode support (libidn2)
    # icu - Use ICU library for Unicode support

    # Use meson_args instead of use_options for boolean options
    # use_options generates enabled/disabled but builtin needs true/false

    use_deps = {
        "idn": "//packages/linux/network/dns/libraries/libidn2:libidn2",
        "icu": "//packages/linux/system/libs/utility/icu:icu",
    },

    configure_args = [
        "-Dtests=false",
        "-Dbuiltin=true",  # Use built-in PSL data
        "-Druntime=no",    # No runtime PSL loading - avoids ICU/IDN linking issues
    ],

    # Force proper source extraction
    pre_configure_cmds = ["""
echo "Preparing libpsl source..."
"""],

    deps = [],

)
