load("//defs:package.bzl", "package")

# Two-factor and multi-factor authentication packages
# TOTP/HOTP, FIDO2/WebAuthn, YubiKey, and related tools

# oath-toolkit - TOTP/HOTP authentication
package(
    build_rule = "autotools",
    name = "oath-toolkit",
    pre_configure_cmds = ["""
autoreconf -fi
""", """
autoreconf -fi
""", """
autoreconf -fi
""", """
autoreconf -fi
""", """
autoreconf -fi
""", """
autoreconf -fi
""", """
autoreconf -fi
""", """
autoreconf -fi
"""],
    url = "https://download.savannah.nongnu.org/releases/oath-toolkit/oath-toolkit-2.6.9.tar.gz",

    sha256 = "333ac831c8f1a6dbd7feb897339bba453ff34d3b0f4cfaa6b5a20dba55c8e985",
    use_configure = {
        "pam": ("-DENABLE_PAM=ON", "-DENABLE_PAM=OFF"),
        "static-libs": ("-DBUILD_STATIC_LIBS=ON", "-DBUILD_STATIC_LIBS=OFF"),
    },
    version = "2.6.9",
    description = "OATH one-time password toolkit",
    homepage = "https://www.nongnu.org/oath-toolkit/",
    license = "GPL-3.0+",
    configure_args = [
        "--prefix=/usr",
        "--sysconfdir=/etc",
        "--localstatedir=/var",
        "--enable-pam",
        "--with-pam-dir=/lib/security",
    ],
    post_install_cmds = ["""
        mkdir -p "$OUT/etc/users.oath"
    """, """
        mkdir -p "$OUT/usr/bin"
        ln -sf ../lib/python3/site-packages/bin/ykman "$OUT/usr/bin/ykman" || true
    """],
    deps = [
        "//packages/linux/system/security/encryption:linux-pam",
                "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
                "//packages/linux/dev-tools/build-systems/automake:automake",
                "//packages/linux/dev-tools/build-systems/libtool:libtool",
                "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
                "//packages/linux/dev-tools/build-systems/automake:automake",
                "//packages/linux/dev-tools/build-systems/libtool:libtool",
                "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
                "//packages/linux/dev-tools/build-systems/automake:automake",
                "//packages/linux/dev-tools/build-systems/libtool:libtool",
                "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
                "//packages/linux/dev-tools/build-systems/automake:automake",
                "//packages/linux/dev-tools/build-systems/libtool:libtool",
                "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
                "//packages/linux/dev-tools/build-systems/automake:automake",
                "//packages/linux/dev-tools/build-systems/libtool:libtool",
                "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
                "//packages/linux/dev-tools/build-systems/automake:automake",
                "//packages/linux/dev-tools/build-systems/libtool:libtool",
                "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
                "//packages/linux/dev-tools/build-systems/automake:automake",
                "//packages/linux/dev-tools/build-systems/libtool:libtool",
                "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
                "//packages/linux/dev-tools/build-systems/automake:automake",
                "//packages/linux/dev-tools/build-systems/libtool:libtool"
    ],
    visibility = ["PUBLIC"],
)

# Google Authenticator PAM module
package(
    build_rule = "autotools",
    name = "google-authenticator",
    url = "https://github.com/google/google-authenticator-libpam/archive/refs/tags/1.10.tar.gz",

    sha256 = "6fe08e7a73ed8f176569c3ad6ad95a5677873e59300d463a2d962c92685a8596",
    version = "1.10",
    description = "Google Authenticator PAM module for two-factor authentication",
    homepage = "https://github.com/google/google-authenticator-libpam",
    license = "Apache-2.0",
    configure_args = [
        "--prefix=/usr",
        "--libdir=/lib/security",
    ],
    deps = [
        "//packages/linux/system/security/encryption:linux-pam",
    ],
    visibility = ["PUBLIC"],
)

# libfido2 - FIDO2/WebAuthn library
package(
    build_rule = "cmake",
    name = "libfido2",
    version = "1.14.0",
    url = "https://developers.yubico.com/libfido2/Releases/libfido2-1.14.0.tar.gz",
    sha256 = "3601792e320032d428002c4cce8499a4c7b803319051a25a0c9f1f138ffee45a",
    description = "Library for FIDO2/WebAuthn operations",
    homepage = "https://developers.yubico.com/libfido2/",
    license = "BSD-2-Clause",
    cmake_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DCMAKE_INSTALL_PREFIX=/usr",
        "-DBUILD_EXAMPLES=OFF",
        "-DBUILD_MANPAGES=OFF",
        "-DBUILD_STATIC_LIBS=OFF",
    ],
    deps = [
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/libusb:libusb",
        ":libcbor",
    ],
    visibility = ["PUBLIC"],
)

# libcbor - CBOR encoding/decoding library
package(
    build_rule = "cmake",
    name = "libcbor",
    version = "0.11.0",
    url = "https://github.com/PJK/libcbor/archive/refs/tags/v0.11.0.tar.gz",
    sha256 = "89e0a83d16993ce50651a7501355453f5250e8729dfc8d4a251a78ea23bb26d7",
    description = "CBOR protocol implementation for C",
    homepage = "https://github.com/PJK/libcbor",
    license = "MIT",
    cmake_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DCMAKE_INSTALL_PREFIX=/usr",
        "-DCMAKE_MINIMUM_REQUIRED_VERSION=3.5",
        "-DBUILD_SHARED_LIBS=ON",
        "-DCBOR_PRETTY_PRINTER=ON",
    ],
    visibility = ["PUBLIC"],
)

# pam-u2f - U2F PAM module
package(
    build_rule = "autotools",
    name = "pam-u2f",
    url = "https://developers.yubico.com/pam-u2f/Releases/pam_u2f-1.3.0.tar.gz",

    sha256 = "72360c6875485eb4df409da8f8f52b17893f05e4d998529c238814480e115220",
    version = "1.3.0",
    description = "PAM module for U2F and FIDO2 authentication",
    homepage = "https://developers.yubico.com/pam-u2f/",
    license = "BSD-2-Clause",
    configure_args = [
        "--prefix=/usr",
        "--with-pam-dir=/lib/security",
    ],
    deps = [
        "//packages/linux/system/security/encryption:linux-pam",
        ":libfido2",
    ],
    visibility = ["PUBLIC"],
)

# YubiKey Manager
package(
    build_rule = "autotools",
    name = "yubikey-manager",
    url = "https://github.com/Yubico/yubikey-manager/archive/refs/tags/5.4.0.tar.gz",

    sha256 = "babd34dffbc53445416d1e27e5e5859c95615252f066d0a22cb51653f546af17",
    version = "5.4.0",
    description = "YubiKey configuration and management tool",
    homepage = "https://developers.yubico.com/yubikey-manager/",
    license = "BSD-2-Clause",
    configure_args = [],
    deps = [
        "//packages/linux/lang/python:python",
        "//packages/linux/system/security/encryption:pcsc-lite",
        ":libfido2",
    ],
    visibility = ["PUBLIC"],
)

# yubico-pam - YubiKey PAM module
package(
    build_rule = "autotools",
    name = "yubico-pam",
    url = "https://developers.yubico.com/yubico-pam/Releases/pam_yubico-2.27.tar.gz",

    sha256 = "63d02788852644d871746e1a7a1d16c272c583c226f62576f5ad232a6a44e18c",
    version = "2.27",
    description = "YubiKey PAM module for OTP and challenge-response authentication",
    homepage = "https://developers.yubico.com/yubico-pam/",
    license = "BSD-2-Clause",
    configure_args = [
        "--prefix=/usr",
        "--with-pam-dir=/lib/security",
    ],
    deps = [
        "//packages/linux/system/security/encryption:linux-pam",
        ":ykclient",
        ":ykpers",
    ],
    visibility = ["PUBLIC"],
)

# ykclient - Yubico client library
package(
    build_rule = "autotools",
    name = "ykclient",
    url = "https://developers.yubico.com/yubico-c-client/Releases/ykclient-2.15.tar.gz",

    sha256 = "f461cdefe7955d58bbd09d0eb7a15b36cb3576b88adbd68008f40ea978ea5016",
    version = "2.15",
    description = "Yubico client C library",
    homepage = "https://developers.yubico.com/yubico-c-client/",
    license = "BSD-2-Clause",
    configure_args = [
        "--prefix=/usr",
        "--sysconfdir=/etc",
        "--enable-shared",
        "--disable-static",
    ],
    deps = [
        "//packages/linux/system/libs/network/curl:curl",
    ],
    visibility = ["PUBLIC"],
)

# ykpers - YubiKey personalization library
package(
    build_rule = "autotools",
    name = "ykpers",
    url = "https://developers.yubico.com/yubikey-personalization/Releases/ykpers-1.20.0.tar.gz",

    sha256 = "0ec84d0ea862f45a7d85a1a3afe5e60b8da42df211bb7d27a50f486e31a79b93",
    version = "1.20.0",
    description = "YubiKey personalization library and tools",
    homepage = "https://developers.yubico.com/yubikey-personalization/",
    license = "BSD-2-Clause",
    configure_args = [
        "--prefix=/usr",
        "--sysconfdir=/etc",
        "--enable-shared",
        "--disable-static",
    ],
    deps = [
        "//packages/linux/system/security/encryption:libusb",
        ":libyubikey",
    ],
    visibility = ["PUBLIC"],
)

# libyubikey - YubiKey low-level library
package(
    build_rule = "autotools",
    name = "libyubikey",
    url = "https://developers.yubico.com/yubico-c/Releases/libyubikey-1.13.tar.gz",

    sha256 = "04edd0eb09cb665a05d808c58e1985f25bb7c5254d2849f36a0658ffc51c3401",
    version = "1.13",
    description = "YubiKey C library for low-level operations",
    homepage = "https://developers.yubico.com/yubico-c/",
    license = "BSD-2-Clause",
    configure_args = [
        "--prefix=/usr",
        "--sysconfdir=/etc",
        "--enable-shared",
        "--disable-static",
    ],
    deps = [
    ],
    visibility = ["PUBLIC"],
)
