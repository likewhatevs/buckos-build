# Privilege escalation packages
# PolicyKit and related authorization tools

load("//defs:package_defs.bzl", "download_source", "ebuild_package", "gen_pkgconfig", "meson_package", "autotools_package")

# PolicyKit - Authorization framework
# NOTE: systemd session tracking is hardcoded in meson_args for libsystemd-login support
meson_package(
    name = "polkit",
    version = "124",
    iuse = [
        "examples",
        "gtk",
        "introspection",
        "kde",
        "nls",
        "pam",
        "selinux",
    ],
    src_uri = "https://github.com/polkit-org/polkit/archive/refs/tags/124/polkit-124.tar.gz",
    sha256 = "72457d96a0538fd03a3ca96a6bf9b7faf82184d4d67c793eb759168e4fd49e20",
    signature_required = False,
    description = "Application-level authorization toolkit",
    homepage = "https://github.com/polkit-org/polkit",
    license = "LGPL-2.0+",
    meson_args = [
        "-Djs_engine=duktape",
        "-Dpam_module_dir=/lib/security",
        "-Dpam_include=system-auth",
        "-Dman=false",
        "-Dtests=false",
        "-Dsession_tracking=ConsoleKit",  # Cannot use libsystemd-login yet due to missing libcap dependency
    ],
    src_install = """
# Run default meson install
meson install -C "${BUILD_DIR:-build}" --destdir="$DESTDIR"

# Fix DBus service file path - move from nested buck-out path to correct location
if [ -d "$DESTDIR/data/buckos-build/buck-out" ]; then
    DBUS_SERVICE_FILE=$(find "$DESTDIR/data" -name "org.freedesktop.PolicyKit1.service" 2>/dev/null | head -1)
    if [ -n "$DBUS_SERVICE_FILE" ]; then
        mkdir -p "$DESTDIR/usr/share/dbus-1/system-services"
        mv "$DBUS_SERVICE_FILE" "$DESTDIR/usr/share/dbus-1/system-services/"
        # Clean up nested directory
        rm -rf "$DESTDIR/data"
    fi
fi
""",
    use_meson = {
        "examples": "-Dexamples=true",
        "-examples": "-Dexamples=false",
        "gtk": "-Dgtk_doc=true",
        "-gtk": "-Dgtk_doc=false",
        "introspection": "-Dintrospection=true",
        "-introspection": "-Dintrospection=false",
    },
    deps = [
        "//packages/linux/system/libs/ipc/dbus:dbus",
        "//packages/linux/dev-libs/glib:glib",
        "//packages/linux/system/security/linux-pam:linux-pam",
        ":duktape",
        "//packages/linux/system/libs/utility/pcre2:pcre2",
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/libs/data/expat:expat",
    ],
    visibility = ["PUBLIC"],
)

# Duktape - Embeddable JavaScript engine (for polkit)
download_source(
    name = "duktape-src",
    src_uri = "https://duktape.org/duktape-2.7.0.tar.xz",
    sha256 = "90f8d2fa8b5567c6899830ddef2c03f3c27960b11aca222fa17aa7ac613c2890",
    signature_required = False,
)

ebuild_package(
    name = "duktape",
    source = ":duktape-src",
    version = "2.7.0",
    description = "Embeddable JavaScript engine",
    homepage = "https://duktape.org/",
    license = "MIT",
    src_compile = """
make -f Makefile.sharedlibrary INSTALL_PREFIX=/usr
""",
    src_install = """
mkdir -p "$DESTDIR/usr/lib" "$DESTDIR/usr/include"
cp libduktape.so* "$DESTDIR/usr/lib/"
# Create unversioned symlink for linking
cd "$DESTDIR/usr/lib"
ln -sf libduktape.so.207.20700 libduktape.so.207
ln -sf libduktape.so.207 libduktape.so
cd -
cp src/duktape.h src/duk_config.h "$DESTDIR/usr/include/"
""" + gen_pkgconfig(
        name = "duktape",
        description = "Embeddable JavaScript engine",
        destvar = "DESTDIR",
        libdir = "lib",
    ),
    visibility = ["PUBLIC"],
)
