load("@root//defs:package_defs.bzl", "download_source", "ebuild_package")

download_source(
    name = "reflect-src",
    src_uri = "https://github.com/qlibs/reflect/archive/refs/tags/v1.2.4.tar.gz",
    sha256 = "8844faf7e282d9b9841fdee89b3ccfa80a800d7c35b6575c5f64cfa5946e0854",
)

ebuild_package(
    name = "reflect",
    source = ":reflect-src",
    version = "1.2.4",
    description = "C++20 Static Reflection library",
    homepage = "https://github.com/qlibs/reflect",
    license = "MIT",
    src_configure = ":",
    src_compile = ":",
    src_install = '''
mkdir -p "$DESTDIR/usr/include/qlibs"
# Install main header file (may be named 'reflect' or 'reflect.hpp')
if [ -f reflect ]; then
    install -m 0644 reflect "$DESTDIR/usr/include/qlibs/"
elif [ -f reflect.hpp ]; then
    install -m 0644 reflect.hpp "$DESTDIR/usr/include/qlibs/"
else
    echo "Error: Could not find reflect header file"
    ls -la
    exit 1
fi
# Install reflect_mixin if it exists (optional)
if [ -f reflect_mixin ]; then
    install -m 0644 reflect_mixin "$DESTDIR/usr/include/qlibs/"
fi
# Install any .hpp files in include/ subdirectory if present
if [ -d include ]; then
    cp -r include/* "$DESTDIR/usr/include/qlibs/" 2>/dev/null || true
fi
''',
    visibility = ["PUBLIC"],
)
