load("//defs:package_defs.bzl", "cmake_package")

# =============================================================================
# SPIRV-Headers - Machine-readable files for the SPIR-V Registry
# =============================================================================
#
# Required by spirv-tools. Provides SPIR-V headers, grammar files, and
# instruction/type definitions used for processing SPIR-V shaders.

cmake_package(
    name = "spirv-headers",
    version = "1.4.335.0",
    src_uri = "https://github.com/KhronosGroup/SPIRV-Headers/archive/vulkan-sdk-1.4.335.0.tar.gz",
    sha256 = "1c47ca6342ebe86f57b46b8dbeb266fa655a1ca8e10d07e45370ff2d9c36312e",
    signature_required = False,
    description = "Machine-readable files for the SPIR-V Registry",
    homepage = "https://github.com/KhronosGroup/SPIRV-Headers",
    license = "MIT",
    cmake_args = [
        "-DSPIRV_HEADERS_ENABLE_TESTS=OFF",
        "-DSPIRV_HEADERS_ENABLE_INSTALL=ON",
    ],
    visibility = ["PUBLIC"],
)

# =============================================================================
# SPIRV-Tools - API and commands for processing SPIR-V modules
# =============================================================================
#
# Required by mesa 26.0.0 for SPIR-V shader compilation.
# Provides spirv-opt, spirv-val, spirv-link and other shader tools.

cmake_package(
    name = "spirv-tools",
    version = "1.4.335.0",
    src_uri = "https://github.com/KhronosGroup/SPIRV-Tools/archive/vulkan-sdk-1.4.335.0.tar.gz",
    sha256 = "8b3d5637061b52675e506ffa1100740031e38bdd96b8177978acfd898a705da2",
    signature_required = False,
    description = "Provides an API and commands for processing SPIR-V modules",
    homepage = "https://github.com/KhronosGroup/SPIRV-Tools",
    license = "Apache-2.0",
    # Pre-configure: Set up SPIRV-Headers path from dependencies
    pre_configure = '''
# Find spirv-headers installation directory
IFS=':' read -ra DEP_ARRAY <<< "$DEP_BASE_DIRS"
for dep_dir in "${DEP_ARRAY[@]}"; do
    if [ -d "$dep_dir/usr/include/spirv" ]; then
        SPIRV_HEADERS_DIR="$dep_dir/usr"
        echo "Found SPIRV-Headers: $SPIRV_HEADERS_DIR"
        break
    fi
done
''',
    cmake_args = [
        "-DSPIRV_WERROR=OFF",
        "-DSPIRV_SKIP_TESTS=ON",
        "-DSPIRV_TOOLS_BUILD_STATIC=OFF",
    ],
    # Need to tell CMake where to find spirv-headers
    src_configure = '''
# Find spirv-headers installation directory
IFS=':' read -ra DEP_ARRAY <<< "$DEP_BASE_DIRS"
SPIRV_HEADERS_DIR=""
for dep_dir in "${DEP_ARRAY[@]}"; do
    if [ -d "$dep_dir/usr/include/spirv" ]; then
        SPIRV_HEADERS_DIR="$dep_dir/usr"
        echo "Found SPIRV-Headers: $SPIRV_HEADERS_DIR"
        break
    fi
done

if [ -z "$SPIRV_HEADERS_DIR" ]; then
    echo "ERROR: Could not find SPIRV-Headers in dependencies"
    exit 1
fi

# Configure with CMake
mkdir -p "${BUILD_DIR:-build}"
cd "${BUILD_DIR:-build}"

cmake .. \
    -DCMAKE_INSTALL_PREFIX="${EPREFIX:-/usr}" \
    -DCMAKE_INSTALL_LIBDIR="${LIBDIR:-lib64}" \
    -DCMAKE_BUILD_TYPE=Release \
    -DSPIRV-Headers_SOURCE_DIR="$SPIRV_HEADERS_DIR" \
    -DSPIRV_WERROR=OFF \
    -DSPIRV_SKIP_TESTS=ON \
    -DSPIRV_TOOLS_BUILD_STATIC=OFF \
    -DCMAKE_C_FLAGS="${CFLAGS:-} -DNDEBUG" \
    -DCMAKE_CXX_FLAGS="${CXXFLAGS:-} -DNDEBUG" \
    ${CMAKE_EXTRA_ARGS:-}
''',
    deps = [
        ":spirv-headers",
    ],
    visibility = ["PUBLIC"],
)
