load("//defs:package.bzl", "package")

# glew - OpenGL Extension Wrangler Library
# NOTE: GLEW is specifically for GLX (X11 OpenGL). It does NOT support Wayland.
# For Wayland OpenGL, use libepoxy or direct EGL calls instead.
package(
    name = "glew",
    build_rule = "binary",
    version = "2.2.0",
    url = "https://github.com/nigels-com/glew/releases/download/glew-2.2.0/glew-2.2.0.tgz",
    sha256 = "d4fc82893cfb00109578d0a1a2337fb8ca335b3ceccf97b97e5cc7f08e4353e1",
    description = "OpenGL Extension Wrangler Library (GLX/X11 only)",
    homepage = "http://glew.sourceforge.net/",
    license = "BSD-3-Clause",
    install_script = """
mkdir -p "$OUT"
BUILD=$(mktemp -d)
cp -a "$SRCS"/. "$BUILD/"
cd "$BUILD"

mkdir -p lib

# Build with EGL support (no X11)
echo "Building GLEW with EGL support (no X11)..."
make -j$(nproc) SYSTEM=linux-egl GLEW_DEST=/usr GLEW_NO_GLX=1

mkdir -p "$OUT/usr/lib64" "$OUT/usr/include/GL"

# Install library
if ls lib/libGLEW.so.* 1>/dev/null 2>&1; then
    cp -P lib/libGLEW.so* "$OUT/usr/lib64/"
fi
if [ -f lib/libGLEW.a ]; then
    cp lib/libGLEW.a "$OUT/usr/lib64/"
fi

# Install headers
cp include/GL/*.h "$OUT/usr/include/GL/"

# Generate pkg-config file
mkdir -p "$OUT/usr/lib64/pkgconfig"
cat > "$OUT/usr/lib64/pkgconfig/glew.pc" << EOF
prefix=/usr
exec_prefix=\${prefix}
libdir=\${prefix}/lib64
includedir=\${prefix}/include

Name: glew
Description: OpenGL Extension Wrangler Library
Version: $PV
Libs: -lGLEW
Cflags: -I\${includedir}
EOF
""",
    visibility = ["PUBLIC"],
)
