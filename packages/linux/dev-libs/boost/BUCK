load("//defs:package.bzl", "package")

# boost - Peer-reviewed C++ libraries
# USE flags: python, mpi, icu, zstd, bzip2, lzma, context, coroutine
# Default: icu, zstd, bzip2, lzma

package(
    build_rule = "binary",
    name = "boost",
    version = "1.84.0",
    url = "https://boostorg.jfrog.io/artifactory/main/release/1.84.0/source/boost_1_84_0.tar.bz2",
    sha256 = "1c162b579a423fa6876c6c5bc16d39ab4bc05e28898977a0a6af345f523f6357",
    description = "Free peer-reviewed portable C++ source libraries",
    homepage = "https://www.boost.org/",
    license = "BSL-1.0",
    install_script = """
        # Sources are in $SRCS, work in $SRCS to build
        cd "$SRCS"
        ls -la
        # Find the boost directory
        if [ -f bootstrap.sh ]; then
            # Already in the right directory
            echo "Found bootstrap.sh in current directory"
        elif [ -d boost_1_84_0 ]; then
            echo "Found boost_1_84_0 directory"
            cd boost_1_84_0
        else
            # Try to find boost directory
            BOOST_DIR=$(find . -maxdepth 2 -name "bootstrap.sh" -type f | head -1 | xargs dirname)
            if [ -n "$BOOST_DIR" ]; then
                echo "Found boost in: $BOOST_DIR"
                cd "$BOOST_DIR"
            else
                echo "Cannot find boost directory with bootstrap.sh"
                exit 1
            fi
        fi
        ./bootstrap.sh --prefix=/usr --with-toolset=gcc
        ./b2 install \
            --prefix="$OUT/usr" \
            --without-python \
            --without-mpi \
            variant=release \
            link=shared \
            threading=multi \
            runtime-link=shared \
            -j${MAKEOPTS:-$(nproc)}
    """,
    deps = [
        "//packages/linux/system/libs/compression/zstd:zstd",
        "//packages/linux/system/libs/compression/bzip2:bzip2",
        "//packages/linux/system/libs/compression/xz:xz",
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/libs/utility/icu:icu",
    ],
    visibility = ["PUBLIC"],
)
