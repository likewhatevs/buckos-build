load("@root//defs:package_defs.bzl", "download_source", "ebuild_package")

download_source(
    name = "usockets-src",
    src_uri = "https://github.com/uNetworking/uSockets/archive/refs/tags/v0.8.8.tar.gz",
    sha256 = "d14d2efe1df767dbebfb8d6f5b52aa952faf66b30c822fbe464debaa0c5c0b17",
    signature_required = False,
)

ebuild_package(
    name = "usockets",
    source = ":usockets-src",
    version = "0.8.8",
    description = "Tiny evented I/O library for Linux and other platforms",
    homepage = "https://github.com/uNetworking/uSockets",
    license = "Apache-2.0",

    src_compile = """
make WITH_LIBUV=1 WITH_OPENSSL=1 -j$(nproc)
""",

    src_install = """
install -d "$DESTDIR/usr/lib64"
install -m644 uSockets.a "$DESTDIR/usr/lib64/libuSockets.a"
install -d "$DESTDIR/usr/include/usockets"
cp -r src/*.h "$DESTDIR/usr/include/usockets/"
""",

    bdepend = [
        "dev-libs//misc/libuv:libuv",
        "system//libs/crypto/openssl:openssl",
        "core//zlib:zlib",
    ],
    rdepend = [
        "dev-libs//misc/libuv:libuv",
        "system//libs/crypto/openssl:openssl",
        "core//zlib:zlib",
    ],
    visibility = ["PUBLIC"],
)
