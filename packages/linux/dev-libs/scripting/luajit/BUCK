load("@root//defs:package_defs.bzl", "autotools_package")

autotools_package(
    name = "luajit",
    version = "2.1.0-beta3",
    iuse = ["lua52compat", "static-libs"],
    use_configure = {
        "-lua52compat": "--disable-lua52compat",
        "-static-libs": "--disable-static",
        "lua52compat": "--enable-lua52compat",
        "static-libs": "--enable-static",
    },
    src_uri = "https://github.com/LuaJIT/LuaJIT/archive/refs/tags/v2.1.0-beta3.tar.gz",
    sha256 = "409f7fe570d3c16558e594421c47bdd130238323c9d6fd6c83dedd2aaeb082a8",
    signature_required = False,
    description = "Just-In-Time Compiler for Lua",
    homepage = "https://luajit.org/",
    license = "MIT",
    src_configure = "true",
    src_compile = """
make -j$(nproc) PREFIX=/usr INSTALL_LIB=/usr/lib amalg
""",
    src_install = """
# LuaJIT requires DESTDIR to be set for all directory creation
make install DESTDIR="$DESTDIR" PREFIX=/usr INSTALL_LIB="$DESTDIR/usr/lib" INSTALL_BIN="$DESTDIR/usr/bin" INSTALL_INC="$DESTDIR/usr/include/luajit-2.1" INSTALL_SHARE="$DESTDIR/usr/share/luajit-2.1.0-beta3" INSTALL_MAN="$DESTDIR/usr/share/man/man1" INSTALL_PKGCONFIG="$DESTDIR/usr/lib/pkgconfig" INSTALL_LMOD="$DESTDIR/usr/share/lua/5.1" INSTALL_CMOD="$DESTDIR/usr/lib/lua/5.1"
ln -sf luajit-2.1.0-beta3 "$DESTDIR/usr/bin/luajit"
""",
    visibility = ["PUBLIC"],
)
