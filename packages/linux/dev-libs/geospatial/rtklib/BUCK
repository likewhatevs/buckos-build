load("//defs:package.bzl", "package")

package(
    name = "rtklib",
    build_rule = "binary",
    version = "demo5-b34b",
    url = "https://github.com/rtklibexplorer/RTKLIB/archive/f1543bf9dc5f179298c7bf7fb34cc5c05220eec7.tar.gz",
    sha256 = "99a9e40967075f3fd9d1fcb2c83f623bca768c96205f4c110100f8185df9df8c",
    description = "RTKLIB: An Open Source Program Package for GNSS Positioning",
    homepage = "https://github.com/rtklibexplorer/RTKLIB",
    license = "BSD-2",
    install_script = """
mkdir -p "$OUT"
BUILD=$(mktemp -d)
cp -a "$SRCS"/. "$BUILD/"
cd "$BUILD"

SRCROOT=$(pwd)
cd app/consapp
export OPTS="-DTRACE -DENAGLO -DENAQZS -DENAGAL -DENACMP -DENAIRN -DNFREQ=2"
export CFLAGS="-Wall -O3 -ansi -pedantic -Wno-unused-but-set-variable -I$SRCROOT/src $OPTS"
export LDLIBS="-lm -lrt"

for dir in pos2kml str2str rnx2rtkp convbin rtkrcv; do
    make -C $dir/gcc CC="${CC:-gcc}" CFLAGS="$CFLAGS" LDLIBS="$LDLIBS"
done

mkdir -p "$OUT/usr/bin"
mkdir -p "$OUT/usr/lib"
mkdir -p "$OUT/usr/include/rtklib"

for bin in pos2kml str2str rnx2rtkp convbin rtkrcv; do
    if [ -f $bin/gcc/$bin ]; then
        cp $bin/gcc/$bin "$OUT/usr/bin/"
    fi
done

cd ../..
cp src/rtklib.h "$OUT/usr/include/rtklib/"
""",
    visibility = ["PUBLIC"],
)
