load("@root//defs:package_defs.bzl", "download_source", "binary_package", "gen_pkgconfig_headeronly")

# SMF - State Machine Framework from Zephyr RTOS
# A hierarchical state machine library originally from Zephyr OS

download_source(
    name = "smf-src",
    src_uri = "https://github.com/zephyrproject-rtos/zephyr/archive/refs/tags/v3.3.0.tar.gz",
    sha256 = "4370d2348a4d1092fa6f0be8a8146ea26fc740b7d3e07d587d178061bf566222",
    signature_required = False,
)

binary_package(
    name = "smf",
    srcs = [":smf-src"],
    version = "3.3.0",
    description = "State Machine Framework - hierarchical state machine library from Zephyr RTOS (headers only)",
    homepage = "https://docs.zephyrproject.org/latest/services/smf/index.html",
    license = "Apache-2.0",
    install_script = """
        cd "$SRCS"

        # GitHub archive extracts to zephyr-3.3.0/ subdirectory
        if [ -d zephyr-3.3.0 ]; then
            cd zephyr-3.3.0
        fi

        # Find smf.h - should be at include/zephyr/smf.h
        SMF_H=$(find . -name "smf.h" -path "*/include/zephyr/*" | head -1)
        SMF_C=$(find . -name "smf.c" -path "*/lib/smf/*" | head -1)

        if [ -z "$SMF_H" ] || [ -z "$SMF_C" ]; then
            echo "Warning: Could not find smf.h or smf.c"
            echo "Searched in: $(pwd)"
            find . -name "smf.*" 2>/dev/null | head -10
            exit 1
        fi

        echo "Found SMF_H: $SMF_H"
        echo "Found SMF_C: $SMF_C"

        # Install header - this is from Zephyr RTOS, provided as API reference
        # NOTE: The library cannot be compiled standalone - it requires Zephyr RTOS headers
        # This package provides the SMF API header and source for reference/embedding
        mkdir -p "$OUT/usr/include/smf"
        cp "$SMF_H" "$OUT/usr/include/smf/"

        # Also provide the source file for embedding into projects
        mkdir -p "$OUT/usr/share/smf"
        cp "$SMF_C" "$OUT/usr/share/smf/"

        # Create a README explaining usage
        cat > "$OUT/usr/share/smf/README.md" << 'EOF'
# SMF - State Machine Framework

This is the State Machine Framework from Zephyr RTOS.

## Usage

The SMF library from Zephyr cannot be compiled as a standalone library because
it depends on Zephyr RTOS headers (kernel.h, toolchain.h, etc).

To use SMF in your project:

1. For Zephyr RTOS projects: Use the built-in SMF module
2. For standalone projects: Copy smf.c and create compatible header stubs

The header file at /usr/include/smf/smf.h provides the API reference.
The source file at /usr/share/smf/smf.c can be embedded in your project.
EOF
    """ + gen_pkgconfig_headeronly(
        name = "smf",
        description = "State Machine Framework from Zephyr RTOS (header-only reference)",
        libdir = "lib64",
    ),
    deps = [],
    visibility = ["PUBLIC"],
)
