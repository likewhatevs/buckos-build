load("//defs:package.bzl", "package")

package(
    build_rule = "binary",
    name = "asmjit",
    version = "0.0.0",
    url = "https://github.com/asmjit/asmjit/archive/64a88ed1d8abb2e2b17a938a5ce7c1b66dabb695.tar.gz",
    sha256 = "51893abd0ea200783cf7e3de73648a5193da8b9982f61f3dc8fe0c8cf6ac56d5",
    description = "Machine code generation for C++",
    homepage = "https://asmjit.com/",
    license = "Zlib",
    install_script = """
        # Find the directory containing CMakeLists.txt
        CMAKE_DIR=$(find "$SRCS" -name "CMakeLists.txt" -type f -print -quit | xargs dirname 2>/dev/null)
        if [ -z "$CMAKE_DIR" ]; then
            echo "Error: CMakeLists.txt not found in $SRCS"
            find "$SRCS" -type f -name "*.txt" | head -10
            exit 1
        fi
        echo "Found CMakeLists.txt in: $CMAKE_DIR"
        cd "$CMAKE_DIR"
        mkdir -p build && cd build
        cmake .. \\
            -DCMAKE_INSTALL_PREFIX=/usr \\
            -DCMAKE_INSTALL_LIBDIR=lib64 \\
            -DCMAKE_BUILD_TYPE=Release \\
            -DBUILD_SHARED_LIBS=ON \\
            -DASMJIT_TEST=OFF
        make -j${MAKEOPTS:-$(nproc)}
        make install DESTDIR="$OUT"
    """,
    deps = [],
)
