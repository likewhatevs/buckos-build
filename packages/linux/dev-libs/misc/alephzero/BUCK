load("//defs:package.bzl", "package")
load("//defs/rules:source.bzl", "extract_source")

http_file(
    name = "yyjson-archive",
    urls = ["https://github.com/ibireme/yyjson/archive/refs/tags/0.10.0.tar.gz"],
    sha256 = "0d901cb2c45c5586e3f3a4245e58c2252d6b24bf4b402723f6179523d389b165",
    out = "0.10.0.tar.gz",
)

extract_source(
    name = "yyjson-src",
    source = ":yyjson-archive",
)

package(
    name = "alephzero",
    build_rule = "binary",
    version = "0_git",
    url = "https://github.com/alephzero/alephzero/archive/refs/heads/master.tar.gz",
    sha256 = "e2d950cc25f14dc7719687279d485eaffaa3c8c5168d5dc5359df42ecb923e76",
    description = "Simple, Robust, Fast IPC library",
    homepage = "https://github.com/alephzero/alephzero",
    license = "Unlicense",
    deps = [":yyjson-src"],
    install_script = """
mkdir -p "$OUT"
BUILD=$(mktemp -d)
cp -a "$SRCS"/. "$BUILD/"
cd "$BUILD"

# Initialize yyjson submodule from dep source
mkdir -p third_party/yyjson

# Find yyjson source in dep outputs (passed via CFLAGS -I paths)
YYJSON_SRC=""
for inc in $CFLAGS; do
    case "$inc" in
        -I*)
            dir="${inc#-I}"
            base="${dir%/usr/include}"
            if [ -f "$base/src/yyjson.h" ]; then
                YYJSON_SRC="$base"
                break
            elif [ -f "$base/yyjson.h" ]; then
                YYJSON_SRC="$base"
                break
            fi
            ;;
    esac
done

if [ -n "$YYJSON_SRC" ]; then
    echo "Copying yyjson from $YYJSON_SRC"
    cp -r "$YYJSON_SRC"/* third_party/yyjson/ || true
else
    echo "ERROR: yyjson source not found in deps"
    exit 1
fi

make -j$(nproc) CC="${CC:-gcc}" lib/libalephzero.a lib/libalephzero.so
make DESTDIR="$OUT" PREFIX=/usr install
""",
)
