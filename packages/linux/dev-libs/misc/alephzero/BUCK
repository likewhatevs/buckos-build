load("//defs:package_defs.bzl", "download_source", "ebuild_package")

download_source(
    name = "alephzero-src",
    src_uri = "https://github.com/alephzero/alephzero/archive/refs/heads/master.tar.gz",
    sha256 = "e2d950cc25f14dc7719687279d485eaffaa3c8c5168d5dc5359df42ecb923e76",
    signature_required = False,
)

download_source(
    name = "yyjson-src",
    src_uri = "https://github.com/ibireme/yyjson/archive/refs/tags/0.10.0.tar.gz",
    sha256 = "0d901cb2c45c5586e3f3a4245e58c2252d6b24bf4b402723f6179523d389b165",
    signature_required = False,
)

ebuild_package(
    name = "alephzero",
    source = ":alephzero-src",
    version = "0_git",
    category = "dev-libs/misc",
    slot = "0",
    description = "Simple, Robust, Fast IPC library",
    homepage = "https://github.com/alephzero/alephzero",
    license = "Unlicense",

    src_prepare = '''
# Initialize yyjson submodule from downloaded source
mkdir -p third_party/yyjson

# Find yyjson from bdepend source directories (in DEP_BASE_DIRS)
YYJSON_SRC=""
IFS=':' read -ra DEP_DIRS <<< "$DEP_BASE_DIRS"
for dep_dir in "${DEP_DIRS[@]}"; do
    # Look for yyjson source (has src/yyjson.h or yyjson.h)
    if [ -z "$YYJSON_SRC" ]; then
        if [ -f "$dep_dir/src/yyjson.h" ]; then
            YYJSON_SRC="$dep_dir"
        elif [ -f "$dep_dir/yyjson.h" ]; then
            YYJSON_SRC="$dep_dir"
        fi
    fi
done

if [ -n "$YYJSON_SRC" ]; then
    echo "Copying yyjson from $YYJSON_SRC"
    cp -r "$YYJSON_SRC"/* third_party/yyjson/ || true
else
    echo "ERROR: yyjson source not found in DEP_BASE_DIRS"
    echo "DEP_BASE_DIRS=$DEP_BASE_DIRS"
    exit 1
fi
''',

    src_compile = '''
make -j$(nproc) CC="${CC:-gcc}" lib/libalephzero.a lib/libalephzero.so
''',

    src_install = '''
make DESTDIR="$DESTDIR" PREFIX=/usr install
''',

    bdepend = [":yyjson-src"],
    depend = [],
    visibility = ["PUBLIC"],
)
