load("//defs:package_defs.bzl", "download_source", "autotools_package")

download_source(
    name = "apr-util-src",
    src_uri = "https://archive.apache.org/dist/apr/apr-util-1.6.3.tar.gz",
    sha256 = "2b74d8932703826862ca305b094eef2983c27b39d5c9414442e9976a9acf1983",
    signature_required = False,
)

autotools_package(
    name = "apr-util",
    source = ":apr-util-src",
    iuse = [
        "berkdb",
        "gdbm",
        "ldap",
        "mysql",
        "nss",
        "odbc",
        "openssl",
        "postgres",
        "sqlite",
        "static-libs",
    ],
    use_configure = {
        "-berkdb": "--disable-berkdb",
        "-gdbm": "--disable-gdbm",
        "-ldap": "--disable-ldap",
        "-mysql": "--disable-mysql",
        "-nss": "--disable-nss",
        "-odbc": "--disable-odbc",
        "-openssl": "--without-openssl",
        "-postgres": "--disable-postgres",
        "-sqlite": "--disable-sqlite",
        "-static-libs": "--disable-static",
        "berkdb": "--enable-berkdb",
        "gdbm": "--enable-gdbm",
        "ldap": "--enable-ldap",
        "mysql": "--enable-mysql",
        "nss": "--enable-nss",
        "odbc": "--enable-odbc",
        "openssl": "--with-openssl",
        "postgres": "--enable-postgres",
        "sqlite": "--enable-sqlite",
        "static-libs": "--enable-static",
    },
    version = "1.6.3",
    description = "Apache Portable Runtime Utility library",
    homepage = "https://apr.apache.org/",
    license = "Apache-2.0",
    bdepend = [
        "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
        "//packages/linux/dev-tools/build-systems/automake:automake",
        "//packages/linux/dev-tools/build-systems/libtool:libtool",
    ],
    deps = [
        "//packages/linux/dev-libs/misc/apr:apr",
        "//packages/linux/core/expat:expat",
    ],
    # apr-1-config should be in PATH from the apr dependency
    src_prepare = """
# Rename configure.in to configure.ac for modern autoconf
if [ -f configure.in ] && [ ! -f configure.ac ]; then
    mv configure.in configure.ac
fi
autoreconf -fi
""",
    src_configure = """
# Find apr-1-config in PATH (set by build system from deps)
APR_CONFIG=$(which apr-1-config 2>/dev/null || true)

if [ -z "$APR_CONFIG" ]; then
    # Fallback: search in common locations
    for dir in /usr "$PWD/../__apr__/apr" "$PWD/../apr"; do
        if [ -x "$dir/bin/apr-1-config" ]; then
            APR_CONFIG="$dir/bin/apr-1-config"
            break
        fi
    done
fi

if [ -z "$APR_CONFIG" ] || [ ! -x "$APR_CONFIG" ]; then
    echo "Error: apr-1-config not found in PATH or standard locations"
    echo "PATH: $PATH"
    exit 1
fi

APR_DIR=$(dirname $(dirname "$APR_CONFIG"))
echo "Found APR at: $APR_DIR (config: $APR_CONFIG)"

./configure --prefix=/usr --disable-static --with-apr="$APR_DIR" --with-expat=/usr

# Fix build/rules.mk to use the correct paths from APR dependency
# The apr_builddir and apr_builders need to point to the actual APR install
if [ -f build/rules.mk ]; then
    # Replace the builddir paths with APR_DIR paths
    sed -i -e "s|^apr_builddir=.*|apr_builddir=$APR_DIR/share/apr-1/build|" build/rules.mk
    sed -i -e "s|^apr_builders=.*|apr_builders=$APR_DIR/share/apr-1/build|" build/rules.mk
    sed -i -e "s|^top_builddir=.*|top_builddir=$PWD|" build/rules.mk
fi
""",
    visibility = ["PUBLIC"],
)
