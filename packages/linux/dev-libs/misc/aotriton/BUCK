load("//defs:package.bzl", "package")

# AOTriton - Ahead-of-Time Triton Compiler for AMD GPUs
# AOTriton is a compiler that converts Triton kernels into GPU code ahead of time,
# particularly targeting AMD ROCm GPUs. It's used by PyTorch for optimized attention operations.

package(
    build_rule = "binary",
    name = "aotriton",
    version = "0.3b",
    url = "https://github.com/ROCm/aotriton/archive/refs/tags/0.3b.tar.gz",
    sha256 = "b5585b4f052dfbb816d0c1d08620d4e86f7d217839d94fa59564333216df3ace",
    description = "Ahead-of-Time Triton compiler for AMD ROCm GPUs",
    homepage = "https://github.com/ROCm/aotriton",
    license = "MIT",
    install_script = """
        cd "$SRCS"

        # AOTriton requires ROCm/HIP to be available
        # Set up build directory
        mkdir -p build && cd build

        # Configure with CMake
        # Note: This build requires hipcc from ROCm and Python with specific packages
        cmake .. \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_INSTALL_LIBDIR=lib64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DAOTRITON_BUILD_V2=ON \
            -DAOTRITON_NO_SHARED=ON \
            -DAOTRITON_NO_PYTHON=ON \
            -DAOTRITON_COMPRESS_KERNEL=OFF \
            -DTARGET_GPUS="MI200;MI300X"

        # Build - note that 'make install' runs the full build process
        make install DESTDIR="$OUT"
    """ + gen_pkgconfig(
        name = "aotriton",
        description = "Ahead-of-Time Triton compiler for AMD ROCm GPUs",
        libs = "-laotriton_v2",
    ),
    deps = [
        "//packages/linux/system/gpu/libraries/rocm:rocm",
        "//packages/linux/system/libs/compression/zstd:zstd",
        "//packages/linux/dev-libs/python/core/python3:python3",
    ],
    labels = ["buckos:hw:rocm"],
    visibility = ["PUBLIC"],
)
