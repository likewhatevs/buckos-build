load("@root//defs:package_defs.bzl", "download_source", "binary_package", "gen_pkgconfig")

# AOTriton - Ahead-of-Time Triton Compiler for AMD GPUs
# AOTriton is a compiler that converts Triton kernels into GPU code ahead of time,
# particularly targeting AMD ROCm GPUs. It's used by PyTorch for optimized attention operations.

download_source(
    name = "aotriton-src",
    src_uri = "https://github.com/ROCm/aotriton/archive/9044fe5eb16130e49a0a1f781ea15037353ad542.tar.gz",
    sha256 = "536feb34725f2ba79def02f626d1a52b80f379046268ad6d6f47ffff49ed577d",
    signature_required = False,
)

binary_package(
    name = "aotriton",
    srcs = [":aotriton-src"],
    version = "0.3b",
    description = "Ahead-of-Time Triton compiler for AMD ROCm GPUs",
    homepage = "https://github.com/ROCm/aotriton",
    license = "MIT",
    install_script = """
        cd "$SRCS"

        # AOTriton requires ROCm/HIP to be available
        # Set up build directory
        mkdir -p build && cd build

        # Configure with CMake
        # Note: This build requires hipcc from ROCm and Python with specific packages
        cmake .. \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_INSTALL_LIBDIR=lib64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DAOTRITON_BUILD_V2=ON \
            -DAOTRITON_NO_SHARED=ON \
            -DAOTRITON_NO_PYTHON=ON \
            -DAOTRITON_COMPRESS_KERNEL=OFF \
            -DTARGET_GPUS="MI200;MI300X"

        # Build - note that 'make install' runs the full build process
        make install DESTDIR="$OUT"
    """ + gen_pkgconfig(
        name = "aotriton",
        description = "Ahead-of-Time Triton compiler for AMD ROCm GPUs",
        libs = "-laotriton_v2",
    ),
    deps = [
        "system//gpu/libraries/rocm:rocm",
        "system//libs/compression/zstd:zstd",
        "dev-libs//python/core/python3:python3",
    ],
    visibility = ["PUBLIC"],
)
