load("@root//defs:package_defs.bzl", "cmake_package")

# RocksDB - A Persistent Key-Value Store from Meta

cmake_package(
    name = "rocksdb",
    version = "8.10.0",
    src_uri = "https://github.com/facebook/rocksdb/archive/refs/tags/v8.10.0.tar.gz",
    sha256 = "2dc107551cc864dbcf7908fdee96f2318cbb680df2b3fe1f85b0d545c2b5673b",
    description = "A Persistent Key-Value Store for Flash and RAM Storage",
    homepage = "https://rocksdb.org/",
    license = "Apache-2.0",
    iuse = [
        "bzip2",
        "jemalloc",
        "lz4",
        "numa",
        "snappy",
        "static-libs",
        "tbb",
        "zlib",
        "zstd",
    ],
    use_defaults = ["lz4", "zstd", "snappy", "zlib"],
    deps = [
        "dev-libs//google/gflags:gflags",
    ],
    use_deps = {
        "lz4": ["system//libs/compression/lz4:lz4"],
        "zstd": ["system//libs/compression/zstd:zstd"],
        "snappy": ["system//libs/compression/snappy:snappy"],
        "bzip2": ["system//libs/compression/bzip2:bzip2"],
        "zlib": ["core//zlib:zlib"],
        "tbb": ["dev-libs//misc/tbb:tbb"],
        "jemalloc": ["dev-libs//allocators/jemalloc:jemalloc"],
    },
    cmake_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DBUILD_SHARED_LIBS=ON",
        "-DWITH_TESTS=OFF",
        "-DWITH_BENCHMARK_TOOLS=OFF",
        "-DWITH_TOOLS=OFF",
        "-DFAIL_ON_WARNINGS=OFF",
    ],
    use_cmake = {
        "-bzip2": "-DWITH_BZ2=OFF",
        "-jemalloc": "-DWITH_JEMALLOC=OFF",
        "-lz4": "-DWITH_LZ4=OFF",
        "-numa": "-DENABLE_NUMA=OFF",
        "-snappy": "-DWITH_SNAPPY=OFF",
        "-static-libs": "-DBUILD_STATIC_LIBS=OFF",
        "-tbb": "-DWITH_TBB=OFF",
        "-zlib": "-DWITH_ZLIB=OFF",
        "-zstd": "-DWITH_ZSTD=OFF",
        "bzip2": "-DWITH_BZ2=ON",
        "jemalloc": "-DWITH_JEMALLOC=ON",
        "lz4": "-DWITH_LZ4=ON",
        "numa": "-DENABLE_NUMA=ON",
        "snappy": "-DWITH_SNAPPY=ON",
        "static-libs": "-DBUILD_STATIC_LIBS=ON",
        "tbb": "-DWITH_TBB=ON",
        "zlib": "-DWITH_ZLIB=ON",
        "zstd": "-DWITH_ZSTD=ON",
    },
    visibility = ["PUBLIC"],
)
