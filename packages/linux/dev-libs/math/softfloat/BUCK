load("@root//defs:package_defs.bzl", "download_source", "ebuild_package")

download_source(
    name = "softfloat-src",
    src_uri = "https://www.jhauser.us/arithmetic/SoftFloat-3e.zip",
    sha256 = "21130ce885d35c1fe73fc1e1bf2244178167e05c6747cad5f450cc991714c746",
)

ebuild_package(
    name = "softfloat",
    version = "3e",
    source = ":softfloat-src",
    src_configure = ":",
    src_compile = """
        # Source extracts to SoftFloat-3e/ subdirectory
        if [ ! -d SoftFloat-3e/build/Linux-x86_64-GCC ]; then
            echo "Error: SoftFloat-3e/build/Linux-x86_64-GCC directory not found"
            echo "Available directories:"
            find . -type d -name "*x86*" -o -name "*GCC*" -o -name "*Linux*" | head -20
            exit 1
        fi
        cd SoftFloat-3e/build/Linux-x86_64-GCC
        # Override COMPILE_C since Makefile defaults to just 'c' not '$(CC)'
        # Use CC env var with gcc fallback
        : ${CC:=gcc}
        make SOURCE_DIR=../../source CC="$CC" COMPILE_C='$(CC) -c -fPIC -Werror-implicit-function-declaration -DSOFTFLOAT_FAST_INT64 -DSOFTFLOAT_ROUND_ODD -DINLINE_LEVEL=5 -DSOFTFLOAT_FAST_DIV32TO16 -DSOFTFLOAT_FAST_DIV64TO32 -I. -I../../source/8086-SSE -I../../source/include'
    """,
    src_install = """
        mkdir -p "$DESTDIR/usr/lib" "$DESTDIR/usr/include/softfloat"
        cp SoftFloat-3e/build/Linux-x86_64-GCC/softfloat.a "$DESTDIR/usr/lib/libsoftfloat.a"
        cp SoftFloat-3e/source/include/*.h "$DESTDIR/usr/include/softfloat/"
    """,
    visibility = ["PUBLIC"],
)
