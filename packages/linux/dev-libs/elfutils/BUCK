load("//defs:package_defs.bzl", "autotools_package")

# =============================================================================
# elfutils - Libraries/utilities to handle ELF objects
# =============================================================================
#
# Provides libelf, libdw, and utilities for working with ELF binaries.
# Required by mesa's radeonsi driver for shader debugging info.

autotools_package(
    name = "elfutils",
    version = "0.194",
    src_uri = "https://sourceware.org/elfutils/ftp/0.194/elfutils-0.194.tar.bz2",
    sha256 = "09e2ff033d39baa8b388a2d7fbc5390bfde99ae3b7c67c7daaf7433fbcf0f01e",
    signature_required = False,
    description = "Libraries/utilities to handle ELF objects (libelf, libdw)",
    homepage = "https://sourceware.org/elfutils/",
    license = "GPL-2+ LGPL-3+",
    # Fix: Remove C++ includes from CPPFLAGS - they cause C stdatomic.h to be shadowed
    # by the C++ version which doesn't define atomic_size_t for C code
    src_configure = '''
# Filter out C++ includes from CPPFLAGS
CPPFLAGS_FIXED=""
for flag in $CPPFLAGS; do
    case "$flag" in
        *include/c++*) ;;  # Skip C++ include paths
        *) CPPFLAGS_FIXED="$CPPFLAGS_FIXED $flag" ;;
    esac
done
export CPPFLAGS="$CPPFLAGS_FIXED"
echo "Fixed CPPFLAGS: $CPPFLAGS"

./configure \\
    --prefix="${EPREFIX:-/usr}" \\
    --host="${CHOST:-}" \\
    --build="${CBUILD:-}" \\
    ${CONFIGURE_ARGS:-}
''',
    configure_args = [
        "--disable-debuginfod",
        "--disable-libdebuginfod",
        "--disable-nls",
        "--disable-valgrind",
        "--disable-valgrind-annotations",
        "--program-prefix=eu-",
        "--with-zlib",
        "--without-bzlib",
        "--without-lzma",
        "--with-zstd",
    ],
    # Only build and install libraries, not the utils (which require C++)
    src_compile = '''
# Build only the required libraries, skip the C++ utils
make -j${MAKEOPTS:-$(nproc)} -C lib
make -j${MAKEOPTS:-$(nproc)} -C libelf
make -j${MAKEOPTS:-$(nproc)} -C libebl
make -j${MAKEOPTS:-$(nproc)} -C backends
make -j${MAKEOPTS:-$(nproc)} -C libdw
make -j${MAKEOPTS:-$(nproc)} -C libasm
''',
    src_install = '''
# Manual install since elfutils Makefiles don't handle DESTDIR well
mkdir -p "${DESTDIR}/usr/lib64" "${DESTDIR}/usr/include" "${DESTDIR}/usr/include/elfutils" "${DESTDIR}/usr/lib64/pkgconfig"

# Install libelf
cp -P libelf/libelf.so* "${DESTDIR}/usr/lib64/"
cp libelf/libelf.a "${DESTDIR}/usr/lib64/"
cp libelf/libelf.h libelf/gelf.h libelf/nlist.h "${DESTDIR}/usr/include/"
cp libelf/elf-knowledge.h "${DESTDIR}/usr/include/elfutils/"

# Install libdw
cp -P libdw/libdw.so* "${DESTDIR}/usr/lib64/"
cp libdw/libdw.a "${DESTDIR}/usr/lib64/"
cp libdw/dwarf.h "${DESTDIR}/usr/include/"
cp libdw/libdw.h libdw/known-dwarf.h "${DESTDIR}/usr/include/elfutils/"

# Install libasm
cp -P libasm/libasm.so* "${DESTDIR}/usr/lib64/"
cp libasm/libasm.a "${DESTDIR}/usr/lib64/"
cp libasm/libasm.h "${DESTDIR}/usr/include/elfutils/"

# Install pkg-config files
for pc in config/libelf.pc config/libdw.pc; do
    if [ -f "$pc" ]; then
        sed "s|@prefix@|/usr|g; s|@exec_prefix@|/usr|g; s|@libdir@|/usr/lib64|g; s|@includedir@|/usr/include|g; s|@PACKAGE_VERSION@|0.194|g" "$pc" > "${DESTDIR}/usr/lib64/pkgconfig/$(basename $pc)"
    fi
done
''',
    deps = [
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/libs/compression/zstd:zstd",
    ],
    visibility = ["PUBLIC"],
)
