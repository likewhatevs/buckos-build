load("@root//defs:package_defs.bzl", "meson_package")
load("@root//defs:use_flags.bzl", "set_use_flags", "use_dep")

meson_package(
    name = "glib",
    version = "2.80.0",
    iuse = [
        "debug",
        "elf",
        "introspection",
        "selinux",
        "static-libs",
        "sysprof",
        "systemtap",
        "xattr",
    ],
    # use_meson for meson option mapping (not use_configure which is for autotools)
    use_meson = {
        "-debug": "-Dglib_debug=disabled",
        "-elf": "-Dlibelf=disabled",
        "-introspection": "-Dintrospection=disabled",
        "-selinux": "-Dselinux=disabled",
        "-static-libs": "-Ddefault_library=shared",
        "-sysprof": "-Dsysprof=disabled",
        "-systemtap": "-Dsystemtap=false",
        "-xattr": "-Dxattr=false",
        "debug": "-Dglib_debug=enabled",
        "elf": "-Dlibelf=enabled",
        "introspection": "-Dintrospection=enabled",
        "selinux": "-Dselinux=enabled",
        "static-libs": "-Ddefault_library=both",
        "sysprof": "-Dsysprof=enabled",
        "systemtap": "-Dsystemtap=true",
        "xattr": "-Dxattr=true",
    },
    src_uri = "https://download.gnome.org/sources/glib/2.80/glib-2.80.0.tar.xz",
    sha256 = "8228a92f92a412160b139ae68b6345bd28f24434a7b5af150ebe21ff587a561d",
    signature_required = False,
    description = "Low-level core library for GNOME projects",
    homepage = "https://wiki.gnome.org/Projects/GLib",
    license = "LGPL-2.1+",
    meson_args = [
        "-Dgtk_doc=false",
        "-Dtests=false",
        "-Ddtrace=false",
        "-Dlibmount=disabled",  # Requires util-linux libmount
    ],
    # Custom install that makes .pc files relocatable using ${pcfiledir}
    # This allows packages that depend on glib to find tools like glib-mkenums
    src_install = """
        # Run standard meson install
        DESTDIR="$DESTDIR" meson install -C "${BUILD_DIR:-build}"

        # Fix .pc files to use relocatable paths with ${pcfiledir}
        # ${pcfiledir} is a pkg-config variable that expands to the directory containing the .pc file
        for pc_file in "$DESTDIR"/usr/lib64/pkgconfig/*.pc; do
            if [ -f "$pc_file" ]; then
                # Replace prefix=/usr with prefix using pcfiledir (../../ from lib64/pkgconfig to usr)
                sed -i \
                    -e 's|^prefix=/usr$|prefix=${pcfiledir}/../..|' \
                    -e 's|^bindir=.*|bindir=${prefix}/bin|' \
                    "$pc_file"
            fi
        done
    """,
    bdepend = [
        "dev-libs//python/packaging:packaging",
    ],
    deps = [
        "core//libffi:libffi",
        "core//zlib:zlib",
        "system//libs/utility/pcre2:pcre2",
    ],
    visibility = ["PUBLIC"],
)
