load("//defs:package.bzl", "package")

package(
    build_rule = "binary",
    name = "genicam",
    version = "3.4.0",
    local_only = True,
    filename = "GenICam_Package_2022.06.tar.gz",
    description = "GenICam reference implementation - standard for machine vision cameras",
    homepage = "https://www.emva.org/standards-technology/genicam/",
    license = "GenICam-License",
    install_script = """
        cd "$SRCS"

        # Navigate to the package directory
        cd "GenICam_Package_2022.06/Reference Implementation"

        # Extract runtime libraries (Linux 64-bit x86_64)
        mkdir -p "$OUT/opt/genicam/lib"
        tar -xzf GenICam_V3_4_0-Linux64_x64_gcc48-Runtime.tgz -C "$OUT/opt/genicam"
        mv "$OUT/opt/genicam/bin/Linux64_x64"/*.so* "$OUT/opt/genicam/lib/" 2>/dev/null || true
        rm -rf "$OUT/opt/genicam/bin"

        # Extract SDK headers
        tar -xzf GenICam_V3_4_0-Linux64_x64_gcc48-SDK.tgz -C "$OUT/opt/genicam"
        mkdir -p "$OUT/usr/include/genicam"
        cp -r "$OUT/opt/genicam/library/CPP/include"/* "$OUT/usr/include/genicam/"

        # Create symlinks in /usr/lib64
        mkdir -p "$OUT/usr/lib64"
        for lib in "$OUT/opt/genicam/lib"/*.so*; do
            if [ -f "$lib" ]; then
                ln -sf "/opt/genicam/lib/$(basename "$lib")" "$OUT/usr/lib64/"
            fi
        done

        # Generate pkg-config file
        mkdir -p "$OUT/usr/lib64/pkgconfig"
        cat > "$OUT/usr/lib64/pkgconfig/genicam.pc" << EOF
prefix=/usr
exec_prefix=${prefix}
libdir=${prefix}/lib64
includedir=${prefix}/include

Name: genicam
Description: GenICam reference implementation for machine vision cameras
Version: $PV
Libs: -L/opt/genicam/lib -lGenApi_gcc48_v3_4 -lGCBase_gcc48_v3_4
Cflags: -I${includedir}/genicam
EOF
    """,
)
