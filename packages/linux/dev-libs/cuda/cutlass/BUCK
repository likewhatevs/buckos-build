load("//defs:package.bzl", "package")

# NVIDIA CUTLASS - CUDA Templates for Linear Algebra Subroutines
# CUTLASS is a collection of CUDA C++ template abstractions for implementing
# high-performance matrix-multiplication (GEMM) and related computations at all levels
# and scales within CUDA. It incorporates strategies for hierarchical decomposition and
# data movement similar to those used to implement cuBLAS and cuDNN.

package(
    build_rule = "cmake",
    name = "cutlass",
    version = "3.9.2",
    url = "https://github.com/NVIDIA/cutlass/archive/refs/tags/v3.9.2.tar.gz",
    sha256 = "4b97bd6cece9701664eec3a634a1f2f2061d85bf76d843fa5799e1a692b4db0d",
    description = "CUDA Templates for Linear Algebra Subroutines",
    homepage = "https://github.com/NVIDIA/cutlass",
    license = "BSD-3-Clause",

    # CUTLASS requires C++17 and CUDA 11.4+
    # It's primarily a header-only library with optional examples/tests
    use_configure = {
        "clang-cuda": ("-DENABLE_CLANG_CUDA=ON", "-DENABLE_CLANG_CUDA=OFF"),
        "cublas": ("-DENABLE_CUBLAS=ON", "-DENABLE_CUBLAS=OFF"),
        "cudnn": ("-DENABLE_CUDNN=ON", "-DENABLE_CUDNN=OFF"),
        "dot": ("-DENABLE_DOT=ON", "-DENABLE_DOT=OFF"),
        "headers-only": ("-DENABLE_HEADERS_ONLY=ON", "-DENABLE_HEADERS_ONLY=OFF"),
        "jumbo-build": ("-DENABLE_JUMBO_BUILD=ON", "-DENABLE_JUMBO_BUILD=OFF"),
        "performance": ("-DENABLE_PERFORMANCE=ON", "-DENABLE_PERFORMANCE=OFF"),
        "profiler": ("-DENABLE_PROFILER=ON", "-DENABLE_PROFILER=OFF"),
    },

    # Dependencies - CUTLASS requires CUDA toolkit
    # Note: You'll need to add the CUDA toolkit dependency when available
    deps = [
        # "//packages/linux/system/gpu/libraries/cuda-toolkit:cuda-toolkit",
    ],

    # CMake configuration
    configure_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DCMAKE_CXX_STANDARD=17",
        "-DCMAKE_CUDA_STANDARD=17",
        "-DCUTLASS_ENABLE_HEADERS_ONLY=ON",  # Header-only by default
        "-DCUTLASS_ENABLE_EXAMPLES=OFF",
        "-DCUTLASS_ENABLE_TOOLS=OFF",
        "-DCUTLASS_ENABLE_LIBRARY=OFF",
        "-DCUTLASS_ENABLE_TESTS=OFF",
        "-DCUTLASS_ENABLE_PROFILER=OFF",
        "-DCUTLASS_NVCC_ARCHS=80;86;89;90",  # Common architectures (Ampere, Ada, Hopper)
    ],

    # USE flag -> CMake options mapping

    # Additional dependencies when USE flags are enabled
    use_deps = {
        "tests": [
            # Google Test dependency if tests are enabled
            # "//packages/linux/dev-libs/testing/googletest:googletest"
        ],
    },

    visibility = ["PUBLIC"],
    labels = ["buckos:hw:cuda"],
)
