load("//defs:package.bzl", "package")
load("//defs:package_defs.bzl", "gen_pkgconfig")

package(
    build_rule = "binary",
    name = "nvcomp",
    version = "4.2.0.11",
    local_only = True,
    filename = "nvcomp-4.2.0.11-Linux-x86_64.tar.gz",
    description = "NVIDIA GPU-accelerated data compression library",
    homepage = "https://developer.nvidia.com/nvcomp",
    license = "NVIDIA SDK",
    install_script = """
cd $SRCS

# Find the extracted directory
SRC_DIR=$(find . -maxdepth 2 -type d -name "include" | head -1 | xargs dirname)
if [ -z "$SRC_DIR" ]; then
    echo "Cannot find nvcomp source directory"
    exit 1
fi
cd "$SRC_DIR"

# Install headers
mkdir -p "$OUT/usr/include"
cp -r include/* "$OUT/usr/include/"

# Install libraries
mkdir -p "$OUT/usr/lib64"
cp lib/libnvcomp.so.4.2.0.11 "$OUT/usr/lib64/"
cp lib/libnvcomp_cpu.so.4.2.0.11 "$OUT/usr/lib64/"
cp lib/libnvcomp_static.a "$OUT/usr/lib64/"
cp lib/libnvcomp_cpu_static.a "$OUT/usr/lib64/"
cp lib/libnvcomp_device_static.a "$OUT/usr/lib64/"

# Create symlinks
cd "$OUT/usr/lib64"
ln -sf libnvcomp.so.4.2.0.11 libnvcomp.so.4
ln -sf libnvcomp.so.4 libnvcomp.so
ln -sf libnvcomp_cpu.so.4.2.0.11 libnvcomp_cpu.so.4
ln -sf libnvcomp_cpu.so.4 libnvcomp_cpu.so

# Install CMake config files
mkdir -p "$OUT/usr/lib64/cmake/nvcomp"
cp -r "$SRC_DIR/lib/cmake/nvcomp/"* "$OUT/usr/lib64/cmake/nvcomp/" 2>/dev/null || true

echo "nvcomp $PV installed successfully"
""" + gen_pkgconfig(
        name = "nvcomp",
        description = "NVIDIA GPU-accelerated data compression library",
        cflags = "-I${includedir} -DNVCOMP_STATIC_DEFINE",
        requires = "cuda",
        libs_private = "-lnvcomp_cpu",
    ),
    deps = [
        "//packages/linux/system/gpu/libraries/cuda-toolkit:cuda-toolkit",
    ],
    visibility = ["PUBLIC"],
    labels = ["buckos:hw:cuda"],
)
