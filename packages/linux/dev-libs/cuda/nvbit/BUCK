load("@root//defs:package_defs.bzl", "download_source", "binary_package", "gen_pkgconfig")

download_source(
    name = "nvbit-src",
    src_uri = "https://mirror.buckos.org/n/nvbit-Linux-x86_64-1.7.6.tar.bz2",
    sha256 = "dba61708b702ff4562343716bb8b38a2d14aae5991b9719aece097afe505467f",
    signature_required = False,
)

binary_package(
    name = "nvbit",
    srcs = [":nvbit-src"],
    version = "1.7.6",
    description = "NVidia Binary Instrumentation Tool for dynamic GPU analysis",
    homepage = "https://github.com/NVlabs/NVBit",
    license = "NVIDIA EULA",
    install_script = """
cd $SRCS

# Find the extracted nvbit directory
if [ -d nvbit_release ]; then
    cd nvbit_release
elif [ -d nvbit-Linux-x86_64-1.7.6 ]; then
    cd nvbit-Linux-x86_64-1.7.6
else
    SRC_DIR=$(find . -maxdepth 2 -name "core" -type d | head -1 | xargs dirname)
    if [ -n "$SRC_DIR" ]; then
        cd "$SRC_DIR"
    else
        echo "Cannot find nvbit source directory"
        exit 1
    fi
fi

# Install headers from core directory
mkdir -p "$OUT/usr/include/nvbit"
cp core/*.h "$OUT/usr/include/nvbit/" 2>/dev/null || true
cp core/*.hpp "$OUT/usr/include/nvbit/" 2>/dev/null || true
cp core/*.cuh "$OUT/usr/include/nvbit/" 2>/dev/null || true

# Install utils headers if present
if [ -d core/utils ]; then
    cp -r core/utils "$OUT/usr/include/nvbit/"
fi

# Install static library
mkdir -p "$OUT/usr/lib64"
cp core/libnvbit.a "$OUT/usr/lib64/"

echo "NVBit $PV installed successfully"
""" + gen_pkgconfig(
        name = "nvbit",
        description = "NVidia Binary Instrumentation Tool",
        libs = "-lnvbit",
        cflags = "-I${includedir}/nvbit",
        requires = "cuda",
    ),
    deps = [
        "//packages/linux/system/gpu/libraries/cuda-toolkit:cuda-toolkit",
    ],
    visibility = ["PUBLIC"],
)
