load("//defs:package.bzl", "package")

# =============================================================================
# NVIDIA CUTLASS v4 - CUDA Templates for Linear Algebra Subroutines
# =============================================================================
# CUTLASS is a collection of CUDA C++ template abstractions for implementing
# high-performance matrix-matrix multiplication (GEMM), matrix-vector
# multiplication (GEMV), and related computations at all levels of the CUDA
# programming model. It incorporates strategies for hierarchical decomposition
# and data movement similar to those used to implement cuBLAS and cuDNN.

package(
    build_rule = "binary",
    name = "cutlass4",
    version = "4.2.1",
    url = "https://github.com/NVIDIA/cutlass/archive/refs/tags/v4.2.1.tar.gz",
    sha256 = "a4513ba33ae82fd754843c6d8437bee1ac71a6ef1c74df886de2338e3917d4df",
    description = "NVIDIA CUTLASS v4 - CUDA Templates for Linear Algebra Subroutines and Tensor Operations",
    homepage = "https://github.com/NVIDIA/cutlass",
    license = "BSD-3-Clause",
    install_script = """
cd $SRCS

# Find the source directory
if [ -d cutlass-4.2.1 ]; then
    cd cutlass-4.2.1
else
    # Try to find the directory
    SRC_DIR=$(find . -maxdepth 2 -name "include" -type d | head -1 | xargs dirname)
    if [ -n "$SRC_DIR" ]; then
        echo "Found source in: $SRC_DIR"
        cd "$SRC_DIR"
    else
        echo "Cannot find source directory"
        exit 1
    fi
fi

# CUTLASS is primarily a header-only library when configured for headers-only mode
# Install the main include directories
mkdir -p "$OUT/usr/include"
cp -r include/cutlass "$OUT/usr/include/"
cp -r include/cute "$OUT/usr/include/"

# Install CMake configuration files
mkdir -p "$OUT/usr/lib/cmake/CUTLASS"

cat > "$OUT/usr/lib/cmake/CUTLASS/CUTLASSConfig.cmake" << 'EOF'
# CUTLASS CMake configuration file

if(NOT TARGET nvidia::cutlass::cutlass)
    add_library(nvidia::cutlass::cutlass INTERFACE IMPORTED)
    add_library(CUTLASS ALIAS nvidia::cutlass::cutlass)

    set_target_properties(nvidia::cutlass::cutlass PROPERTIES
        INTERFACE_INCLUDE_DIRECTORIES "${CMAKE_CURRENT_LIST_DIR}/../../../include"
        INTERFACE_COMPILE_FEATURES cxx_std_17
    )

    # CUTLASS requires C++17
    target_compile_features(nvidia::cutlass::cutlass INTERFACE cxx_std_17)

    # Add CUDA-specific properties if CUDA is available
    if(CMAKE_CUDA_COMPILER)
        set_property(TARGET nvidia::cutlass::cutlass PROPERTY
            INTERFACE_COMPILE_OPTIONS $<$<COMPILE_LANGUAGE:CUDA>:--expt-relaxed-constexpr>)
    endif()
endif()

set(CUTLASS_VERSION "4.2.1")
set(CUTLASS_VERSION_MAJOR 4)
set(CUTLASS_VERSION_MINOR 2)
set(CUTLASS_VERSION_PATCH 1)
EOF

cat > "$OUT/usr/lib/cmake/CUTLASS/CUTLASSConfigVersion.cmake" << 'EOF'
set(PACKAGE_VERSION "4.2.1")

if(PACKAGE_VERSION VERSION_LESS PACKAGE_FIND_VERSION)
    set(PACKAGE_VERSION_COMPATIBLE FALSE)
else()
    set(PACKAGE_VERSION_COMPATIBLE TRUE)
    if(PACKAGE_FIND_VERSION STREQUAL PACKAGE_VERSION)
        set(PACKAGE_VERSION_EXACT TRUE)
    endif()
endif()
EOF

echo "CUTLASS v4.2.1 installed successfully"

# Generate pkg-config file
mkdir -p "$OUT/usr/lib/pkgconfig"
cat > "$OUT/usr/lib/pkgconfig/cutlass.pc" << EOF
prefix=/usr
exec_prefix=${prefix}
includedir=${prefix}/include

Name: cutlass
Description: NVIDIA CUTLASS - CUDA Templates for Linear Algebra Subroutines
Version: $PV
Requires: cuda
Cflags: -I${includedir}
EOF
""",
    deps = [
        "//packages/linux/system/gpu/libraries/cuda-toolkit:cuda-toolkit",
    ],
    labels = ["buckos:hw:cuda"],
)
