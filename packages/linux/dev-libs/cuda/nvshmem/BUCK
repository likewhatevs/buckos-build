load("@root//defs:package_defs.bzl", "cmake_package")

cmake_package(
    name = "nvshmem",
    version = "3.4.5",
    src_uri = "https://github.com/NVIDIA/nvshmem/archive/refs/tags/v3.4.5-0.tar.gz",
    sha256 = "74047b0b572d677a6c072c9e5486514d19fe7dff1252a2548ee08ce8d68b6bc5",
    cmake_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DBUILD_SHARED_LIBS=ON",
        "-DCMAKE_CUDA_ARCHITECTURES=70;75;80;86;89;90",
        "-DNVSHMEM_USE_NCCL=ON",
        "-DNVSHMEM_MPI_SUPPORT=OFF",
        "-DNVSHMEM_IBRC_SUPPORT=ON",
        "-DNVSHMEM_IBDEVX_SUPPORT=ON",
        "-DNVSHMEM_UCX_SUPPORT=OFF",
        "-DNVSHMEM_BUILD_PYTHON_LIB=OFF",
    ],
    deps = [
        "system//gpu/libraries/nccl:nccl",
        "network//libs/rdma-core:rdma-core",
    ],
    visibility = ["PUBLIC"],
)
