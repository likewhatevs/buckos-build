load("//defs:package_defs.bzl", "meson_package", "download_source")

download_source(
    name = "dspatch-src",
    src_uri = "https://github.com/cross-platform/dspatch/archive/refs/tags/11.4.1.tar.gz",
    sha256 = "10095b582994b446631cfd13f0038903f89f80afcf3699f213a2779d065ea888",
)

download_source(
    name = "fast_any-src",
    src_uri = "https://github.com/cross-platform/fast_any/archive/d2e46b7eeb504e1141dafa7def52fb33e090b4a1.tar.gz",
    sha256 = "a8162a41d5518e042ac4eb49d7001550c3cdbf1d65033653a6b8722e16d988f5",
    signature_required = False,
)

meson_package(
    name = "dspatch",
    source = ":dspatch-src",
    version = "11.4.1",
    meson_args = [
        "-Dcpp_std=c++17",
    ],
    src_prepare = '''
# Extract fast_any submodule
mkdir -p "$S/include/fast_any"
if [ -f "../__fast_any-src__/fast_any-src" ]; then
    tar -xzf "../__fast_any-src__/fast_any-src" -C "$S/include/fast_any" --strip-components=1
elif [ -d "../__fast_any-src__" ]; then
    cp -r "../__fast_any-src__"/* "$S/include/fast_any/"
fi
''',
    extra_sources = [":fast_any-src"],
)
