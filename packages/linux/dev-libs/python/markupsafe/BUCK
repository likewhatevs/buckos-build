load("@root//defs:package_defs.bzl", "python_package")

# MarkupSafe - Safe string markup library for Python
# Dependency for mako and other templating libraries

python_package(
    name = "markupsafe",
    version = "3.0.2",
    src_uri = "https://files.pythonhosted.org/packages/source/m/markupsafe/markupsafe-3.0.2.tar.gz",
    sha256 = "ee55d3edf80167e48ea11a923c7386f4669df67d7994554387f84e7d8b0a2bf0",
    visibility = ["PUBLIC"],
    # Fix setuptools compatibility for older versions that don't have CCompilerError
    src_prepare = '''
# Patch setup.py to handle older setuptools that lacks CCompilerError
cat > setup.py << 'SETUP_EOF'
import os
import platform
import sys

from setuptools import Extension
from setuptools import setup
from setuptools.command.build_ext import build_ext

# Handle older setuptools versions that don't have these in setuptools.errors
try:
    from setuptools.errors import CCompilerError, ExecError, PlatformError
except ImportError:
    try:
        from distutils.errors import CCompilerError, DistutilsExecError as ExecError, DistutilsPlatformError as PlatformError
    except ImportError:
        # Fallback: define empty exception classes
        class CCompilerError(Exception): pass
        class ExecError(Exception): pass
        class PlatformError(Exception): pass

ext_modules = [Extension("markupsafe._speedups", ["src/markupsafe/_speedups.c"])]


class BuildFailed(Exception):
    pass


class ve_build_ext(build_ext):
    """This class allows C extension building to fail."""

    def run(self):
        try:
            super().run()
        except PlatformError as e:
            raise BuildFailed() from e

    def build_extension(self, ext):
        try:
            super().build_extension(ext)
        except (CCompilerError, ExecError, PlatformError) as e:
            raise BuildFailed() from e
        except ValueError as e:
            if "'path'" in str(sys.exc_info()[1]):
                raise BuildFailed() from e
            raise


def run_setup(with_binary):
    setup(
        cmdclass={"build_ext": ve_build_ext},
        ext_modules=ext_modules if with_binary else [],
    )


def show_message(*lines):
    print("=" * 74)
    for line in lines:
        print(line)
    print("=" * 74)


supports_speedups = platform.python_implementation() not in {
    "PyPy",
    "Jython",
    "GraalVM",
}

if os.environ.get("CIBUILDWHEEL", "0") == "1" and supports_speedups:
    run_setup(True)
elif supports_speedups:
    try:
        run_setup(True)
    except BuildFailed:
        show_message(
            "WARNING: The C extension could not be compiled, speedups"
            " are not enabled.",
            "Failure information, if any, is above.",
            "Retrying the build without the C extension now.",
        )
        run_setup(False)
        show_message(
            "WARNING: The C extension could not be compiled, speedups"
            " are not enabled.",
            "Plain-Python build succeeded.",
        )
else:
    run_setup(False)
    show_message(
        "WARNING: C extensions are not supported on this Python"
        " platform, speedups are not enabled.",
        "Plain-Python build succeeded.",
    )
SETUP_EOF
''',
)
