load("@root//defs:package_defs.bzl", "download_source", "ebuild_package")

# Download pre-built wheel (avoids flit_core bootstrap dependency)
# The wheel is a zip file that download_source extracts automatically
download_source(
    name = "packaging-src",
    src_uri = "https://files.pythonhosted.org/packages/88/ef/eb23f262cca3c0c4eb7ab1933c3b1f03d021f2c48f54763065b6f0e321be/packaging-24.2-py3-none-any.whl",
    sha256 = "09abb1bccd265c01f4a3aa3f7a7db064b36514d2cba19a2f694fe6150451a759",
)

# Install pre-built wheel directly (no build required)
ebuild_package(
    name = "packaging",
    source = ":packaging-src",
    version = "24.2",
    src_configure = """
# Verify Python is available for getting site-packages path
echo "Python: $(which python3 2>/dev/null || echo 'not found')"
python3 --version || { echo "ERROR: python3 not found in PATH"; exit 1; }
""",
    src_compile = """
# No build needed - wheel is already extracted
echo "Using pre-built wheel, no compilation required"
ls -la "$S"
""",
    src_install = """
# Get Python site-packages directory
SITE_PACKAGES="$DESTDIR/usr/lib/python3.12/site-packages"
mkdir -p "$SITE_PACKAGES"

# Copy the extracted wheel contents directly
# The wheel file was extracted by download_source since .whl is a zip file
cp -r "$S/packaging" "$SITE_PACKAGES/"
cp -r "$S/packaging-24.2.dist-info" "$SITE_PACKAGES/"

echo "Installed packaging to $SITE_PACKAGES"
ls -la "$SITE_PACKAGES"
""",
    # Python only needed at runtime (not for build since we don't use pip)
    depend = ["lang//python:python"],
    visibility = ["PUBLIC"],
)
