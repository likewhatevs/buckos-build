load("//defs:package.bzl", "package")

# Download pre-built wheel (avoids flit_core bootstrap dependency)
# Install pre-built wheel directly (no build required)
package(
    name = "packaging",
    build_rule = "binary",
    version = "24.2",
    url = "https://files.pythonhosted.org/packages/88/ef/eb23f262cca3c0c4eb7ab1933c3b1f03d021f2c48f54763065b6f0e321be/packaging-24.2-py3-none-any.whl",
    sha256 = "09abb1bccd265c01f4a3aa3f7a7db064b36514d2cba19a2f694fe6150451a759",
    strip_components = 0,
    description = "Core utilities for Python packages",
    license = "Apache-2.0 OR BSD-2-Clause",
    deps = ["//packages/linux/lang/python:python"],
    install_script = """
mkdir -p "$OUT"

# Set LD_LIBRARY_PATH so python3 can find libpython
for inc in $CFLAGS; do
    case "$inc" in
        -I*)
            dir="${inc#-I}"
            base="${dir%/usr/include}"
            if ls "$base"/usr/lib64/libpython3*.so* &>/dev/null; then
                export LD_LIBRARY_PATH="$base/usr/lib64${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
                echo "Set LD_LIBRARY_PATH for Python: $base/usr/lib64"
                break
            fi
            ;;
    esac
done

echo "Python: $(which python3 2>/dev/null || echo 'not found')"
python3 --version || { echo "ERROR: python3 not found in PATH"; exit 1; }

# Get Python version dynamically
_PYVER=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")' 2>/dev/null || echo "3.12")
SITE_PACKAGES="$OUT/usr/lib/python${_PYVER}/site-packages"
mkdir -p "$SITE_PACKAGES"

# Copy the extracted wheel contents directly
cp -r "$SRCS/packaging" "$SITE_PACKAGES/"
cp -r "$SRCS/packaging-24.2.dist-info" "$SITE_PACKAGES/"

echo "Installed packaging to $SITE_PACKAGES"
ls -la "$SITE_PACKAGES"
""",
    visibility = ["PUBLIC"],
)
