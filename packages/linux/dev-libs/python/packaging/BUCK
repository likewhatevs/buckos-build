load("//defs:package_defs.bzl", "download_source", "ebuild_package")

# Download pre-built wheel (avoids flit_core bootstrap dependency)
# The wheel is a zip file that download_source extracts automatically
# Install pre-built wheel directly (no build required)
ebuild_package(
    name = "packaging",
    src_uri = "https://files.pythonhosted.org/packages/88/ef/eb23f262cca3c0c4eb7ab1933c3b1f03d021f2c48f54763065b6f0e321be/packaging-24.2-py3-none-any.whl",

    sha256 = "09abb1bccd265c01f4a3aa3f7a7db064b36514d2cba19a2f694fe6150451a759",
    version = "24.2",
    src_configure = """
# Set LD_LIBRARY_PATH so python3 can find libpython during cross-compilation
# (the ebuild system intentionally doesn't set LD_LIBRARY_PATH during cross-builds)
IFS=':' read -ra _DEP_ARRAY <<< "${DEP_BASE_DIRS:-}"
for _dep in "${_DEP_ARRAY[@]}"; do
    if ls "$_dep"/usr/lib64/libpython3*.so* &>/dev/null; then
        export LD_LIBRARY_PATH="$_dep/usr/lib64${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
        echo "Set LD_LIBRARY_PATH for Python: $_dep/usr/lib64"
        break
    fi
done
echo "Python: $(which python3 2>/dev/null || echo 'not found')"
python3 --version || { echo "ERROR: python3 not found in PATH"; exit 1; }
""",
    src_compile = """
# No build needed - wheel is already extracted
echo "Using pre-built wheel, no compilation required"
ls -la "$S"
""",
    src_install = """
# Set LD_LIBRARY_PATH for Python (phases run in separate subshells)
IFS=':' read -ra _DEP_ARRAY <<< "${DEP_BASE_DIRS:-}"
for _dep in "${_DEP_ARRAY[@]}"; do
    if ls "$_dep"/usr/lib64/libpython3*.so* &>/dev/null; then
        export LD_LIBRARY_PATH="$_dep/usr/lib64${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
        break
    fi
done
# Get Python version dynamically
_PYVER=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")' 2>/dev/null || echo "3.12")
SITE_PACKAGES="$DESTDIR/usr/lib/python${_PYVER}/site-packages"
mkdir -p "$SITE_PACKAGES"

# Copy the extracted wheel contents directly
# The wheel file was extracted by download_source since .whl is a zip file
cp -r "$S/packaging" "$SITE_PACKAGES/"
cp -r "$S/packaging-24.2.dist-info" "$SITE_PACKAGES/"

echo "Installed packaging to $SITE_PACKAGES"
ls -la "$SITE_PACKAGES"
""",
    # Python only needed at runtime (not for build since we don't use pip)
    depend = ["//packages/linux/lang/python:python"],
    visibility = ["PUBLIC"],
)
