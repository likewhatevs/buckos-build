load("@root//defs:package_defs.bzl", "make_package")

make_package(
    name = "bzip2",
    version = "1.0.8",
    src_uri = "https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz",
    sha256 = "ab5a03176ee106d3f0fa90e381da478ddae405918153cca248e682cd0c4a2269",
    deps = [],
    make_args = [
        "CC=${CC:-gcc}",
        "PREFIX=/usr",
    ],
    make_install_args = [
        "PREFIX=/usr",
        "DESTDIR=$DESTDIR",
    ],
    # bzip2 also needs to build the shared library
    src_compile = """
# Build shared library first (needs -fPIC)
make -j$MAKE_JOBS CC="${CC:-gcc}" CFLAGS="-fPIC -O2 -g -D_FILE_OFFSET_BITS=64" PREFIX=/usr -f Makefile-libbz2_so
# Move the shared library object files
mv *.o sharedobj/ 2>/dev/null || mkdir -p sharedobj && mv *.o sharedobj/
# Build static library and binaries
make -j$MAKE_JOBS CC="${CC:-gcc}" PREFIX=/usr libbz2.a bzip2 bzip2recover
# Restore shared library files
mv sharedobj/*.o .
rmdir sharedobj 2>/dev/null || true
""",
    src_install = """
make PREFIX=/usr DESTDIR="$DESTDIR" install
# Install shared library
install -Dm755 libbz2.so.1.0.8 "$DESTDIR/usr/lib/libbz2.so.1.0.8"
ln -sf libbz2.so.1.0.8 "$DESTDIR/usr/lib/libbz2.so.1.0"
ln -sf libbz2.so.1.0.8 "$DESTDIR/usr/lib/libbz2.so.1"
ln -sf libbz2.so.1.0.8 "$DESTDIR/usr/lib/libbz2.so"
""",
    visibility = ["PUBLIC"],
)
