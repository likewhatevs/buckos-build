load("//defs:package_defs.bzl", "cmake_package")

cmake_package(
    name = "isobmff",
    version = "1.0.0",
    src_uri = "https://github.com/DigiDNA/ISOBMFF/archive/59bb0f99ea3a21ab8823dd22e3bc935788ddabd3.tar.gz",
    sha256 = "f1e912d0103bf02e3c19bcd42fd2ea8e8c56f1ed8e77b31f95585c8c990e6abe",
    description = "C++ library for parsing ISO Base Media File Format (ISOBMFF)",
    homepage = "https://github.com/DigiDNA/ISOBMFF",
    license = "MIT",
    deps = [],
    pre_configure = """
        cat > CMakeLists.txt << 'EOF'
cmake_minimum_required(VERSION 3.10)
project(ISOBMFF VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Collect all source files
file(GLOB SOURCES "ISOBMFF/source/*.cpp")

# Create shared library
add_library(ISOBMFF SHARED ${SOURCES})

target_include_directories(ISOBMFF PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/ISOBMFF/include>
    $<INSTALL_INTERFACE:include>
)

target_compile_definitions(ISOBMFF PRIVATE
    PRODUCT_LIB=libISOBMFF
    PRODUCT_DYLIB=libISOBMFF
    PRODUCT_FRAMEWORK=ISOBMFF
)

target_compile_options(ISOBMFF PRIVATE
    -Wall
    -fno-strict-aliasing
)

set_target_properties(ISOBMFF PROPERTIES
    VERSION 1.0.0
    SOVERSION 1
    OUTPUT_NAME ISOBMFF
)

# Install library
install(TARGETS ISOBMFF
    EXPORT ISOBMFFTargets
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
    RUNTIME DESTINATION bin
    INCLUDES DESTINATION include
)

# Install headers
install(FILES ISOBMFF/include/ISOBMFF.hpp DESTINATION include)
install(DIRECTORY ISOBMFF/include/ISOBMFF DESTINATION include)

# Install CMake config files
include(CMakePackageConfigHelpers)

configure_package_config_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/cmake/ISOBMFFConfig.cmake.in
    ${CMAKE_CURRENT_BINARY_DIR}/ISOBMFFConfig.cmake
    INSTALL_DESTINATION lib/cmake/ISOBMFF
)

write_basic_package_version_file(
    ${CMAKE_CURRENT_BINARY_DIR}/ISOBMFFConfigVersion.cmake
    VERSION 1.0.0
    COMPATIBILITY SameMajorVersion
)

install(EXPORT ISOBMFFTargets
    FILE ISOBMFFTargets.cmake
    NAMESPACE ISOBMFF::
    DESTINATION lib/cmake/ISOBMFF
)

install(FILES
    ${CMAKE_CURRENT_BINARY_DIR}/ISOBMFFConfig.cmake
    ${CMAKE_CURRENT_BINARY_DIR}/ISOBMFFConfigVersion.cmake
    DESTINATION lib/cmake/ISOBMFF
)
EOF

        mkdir -p cmake
        cat > cmake/ISOBMFFConfig.cmake.in << 'EOF'
@PACKAGE_INIT@

include("${CMAKE_CURRENT_LIST_DIR}/ISOBMFFTargets.cmake")

check_required_components(ISOBMFF)
EOF
    """,
    cmake_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DBUILD_SHARED_LIBS=ON",
    ],
    visibility = ["PUBLIC"],
)
