load("@root//defs:package_defs.bzl", "cmake_package")

# fpng - Very fast C++ PNG image reader/writer for 24/32bpp images
# fpng is optimized for speed over compression ratio

cmake_package(
    name = "fpng",
    version = "1.0.5",
    src_uri = "https://github.com/richgel999/fpng/archive/6926f5a0a78f22d42b074a0ab8032e07736babd4.tar.gz",
    sha256 = "f57d2f7ddd44fd8a2676afba656e91f2925227742aaf7911937c933782efb444",  # Run: curl -sL <src_uri> | sha256sum
    description = "Very fast C++ PNG image reader/writer for 24/32bpp images",
    homepage = "https://github.com/richgel999/fpng",
    license = "Unlicense",
    deps = [],
    pre_configure = """
        # Create a proper CMakeLists.txt for library installation
        cat > CMakeLists.txt << 'EOF'
cmake_minimum_required(VERSION 3.0)
project(fpng VERSION 1.0.5 LANGUAGES CXX)

option(BUILD_SHARED_LIBS "Build shared libraries" ON)
option(FPNG_NO_SSE "Disable SSE support" OFF)

# Source files
set(FPNG_SOURCES
    src/fpng.cpp
)

set(FPNG_HEADERS
    src/fpng.h
)

# Create library target
add_library(fpng ${FPNG_SOURCES})

# Set include directories
target_include_directories(fpng
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src>
        $<INSTALL_INTERFACE:include>
)

# Set compile features and options
target_compile_features(fpng PUBLIC cxx_std_11)

# Platform-specific settings
if(NOT MSVC)
    target_compile_options(fpng PRIVATE
        -fvisibility=hidden
        -fPIC
        -fno-strict-aliasing
        -Wall
        -Wextra
    )

    # SSE support for x86/x64
    if(NOT FPNG_NO_SSE)
        include(CheckCXXSourceCompiles)
        set(CMAKE_REQUIRED_FLAGS "-msse4.1 -mpclmul")
        check_cxx_source_compiles("
            #include <smmintrin.h>
            #include <wmmintrin.h>
            int main() { return 0; }
        " HAVE_SSE41)

        if(HAVE_SSE41)
            target_compile_options(fpng PRIVATE -msse4.1 -mpclmul)
            target_compile_definitions(fpng PRIVATE FPNG_NO_SSE=0)
        else()
            target_compile_definitions(fpng PRIVATE FPNG_NO_SSE=1)
        endif()
    else()
        target_compile_definitions(fpng PRIVATE FPNG_NO_SSE=1)
    endif()

    target_link_libraries(fpng PRIVATE m pthread)
endif()

# Set library properties
set_target_properties(fpng PROPERTIES
    VERSION ${PROJECT_VERSION}
    SOVERSION 1
    PUBLIC_HEADER "${FPNG_HEADERS}"
)

# Installation rules
include(GNUInstallDirs)

install(TARGETS fpng
    EXPORT fpngTargets
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    PUBLIC_HEADER DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/fpng
)

# Install cmake config files
install(EXPORT fpngTargets
    FILE fpngTargets.cmake
    NAMESPACE fpng::
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/fpng
)

# Create and install config file
include(CMakePackageConfigHelpers)
configure_package_config_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/fpngConfig.cmake.in
    ${CMAKE_CURRENT_BINARY_DIR}/fpngConfig.cmake
    INSTALL_DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/fpng
)

write_basic_package_version_file(
    ${CMAKE_CURRENT_BINARY_DIR}/fpngConfigVersion.cmake
    VERSION ${PROJECT_VERSION}
    COMPATIBILITY SameMajorVersion
)

install(FILES
    ${CMAKE_CURRENT_BINARY_DIR}/fpngConfig.cmake
    ${CMAKE_CURRENT_BINARY_DIR}/fpngConfigVersion.cmake
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/fpng
)

# Optionally build test executable
option(BUILD_TESTS "Build test executable" OFF)
if(BUILD_TESTS)
    add_executable(fpng_test
        src/fpng_test.cpp
        src/lodepng.cpp
    )
    target_link_libraries(fpng_test PRIVATE fpng)
    install(TARGETS fpng_test DESTINATION bin)
endif()
EOF

        # Create fpngConfig.cmake.in
        cat > fpngConfig.cmake.in << 'EOF'
@PACKAGE_INIT@

include("${CMAKE_CURRENT_LIST_DIR}/fpngTargets.cmake")

check_required_components(fpng)
EOF
    """,
    cmake_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DBUILD_SHARED_LIBS=ON",
        "-DBUILD_TESTS=OFF",
    ],
    visibility = ["PUBLIC"],
)
