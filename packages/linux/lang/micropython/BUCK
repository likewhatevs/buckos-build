load("//defs:package_defs.bzl", "make_package")

make_package(
    name = "micropython",
    version = "1.18",
    src_uri = "https://github.com/micropython/micropython/releases/download/v1.18/micropython-1.18.tar.xz",
    sha256 = "96fc71b42ed331c64e1adc5a830ec4f29f2975c23e8751109c03f32b80fa3eb4",
    signature_required = False,
    description = "MicroPython - Python for microcontrollers and constrained environments",
    homepage = "https://micropython.org/",
    license = "MIT",

    # USE flags
    iuse = ["ffi"],
    use_defaults = ["ffi"],

    # Make args based on USE flags
    use_make = {
        "-ffi": "MICROPY_PY_FFI=0",
    },

    # Conditional dependencies
    use_deps = {
        "ffi": ["//packages/linux/core/libffi:libffi"],
    },

    # Custom build phases for micropython's non-standard build
    src_compile = """
        # Build mpy-cross first (needed for frozen modules)
        make -C mpy-cross

        # Build unix port
        make -C ports/unix $EXTRA_EMAKE
    """,

    src_install = """
        mkdir -p "$DESTDIR/usr/bin"
        cp ports/unix/build-standard/micropython "$DESTDIR/usr/bin/micropython"
        cp mpy-cross/build/mpy-cross "$DESTDIR/usr/bin/mpy-cross"
    """,

    visibility = ["PUBLIC"],
)
