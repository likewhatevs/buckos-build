load("@root//defs:package_defs.bzl", "cmake_package")
load("@root//defs:use_flags.bzl", "set_use_flags")

# hiredis - Minimalistic C client for Redis
#
# Hiredis is a minimalistic C client library for the Redis database.
# It's small, portable, and supports both synchronous and asynchronous
# operations. The library provides a low-level API for Redis commands
# and supports the Redis protocol (RESP).
#
# USE flags:
#   ssl       - Enable SSL/TLS support
#   examples  - Build example programs
#   static    - Build static library

cmake_package(
    name = "hiredis",
    version = "1.2.0",
    src_uri = "https://github.com/redis/hiredis/archive/refs/tags/v1.2.0.tar.gz",
    sha256 = "82ad632d31ee05da13b537c124f819eb88e18851d9cb0c30ae0552084811588c",
    signature_required = False,
    description = "Minimalistic C client library for Redis",
    homepage = "https://github.com/redis/hiredis",
    license = "BSD-3-Clause",

    # USE flags this package supports
    iuse = [
        "ssl",
        "examples",
        "static",
    ],

    # Default enabled flags
    use_defaults = ["ssl"],

    # Conditional dependencies based on USE flags
    use_deps = {
        "ssl": ["system//libs/crypto/openssl:openssl"],
    },

    # Base CMake arguments (always applied)
    cmake_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DBUILD_SHARED_LIBS=ON",
        "-DENABLE_SSL=ON",
        "-DDISABLE_TESTS=ON",
    ],

    # CMake options based on USE flags
    use_cmake = {
        "ssl": "-DENABLE_SSL=ON",
        "-ssl": "-DENABLE_SSL=OFF",
        "examples": "-DENABLE_EXAMPLES=ON",
        "-examples": "-DENABLE_EXAMPLES=OFF",
        "static": "-DBUILD_SHARED_LIBS=OFF",
        "-static": "-DBUILD_SHARED_LIBS=ON",
    },

    # Base dependencies (always required)
    deps = [],

    visibility = ["PUBLIC"],
)
