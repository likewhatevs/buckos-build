load("//defs:package_defs.bzl", "cmake_package")
load("//defs:use_flags.bzl", "set_use_flags")

# libmysqlclient - MySQL C client library
#
# The MySQL C API provides low-level access to the MySQL client/server protocol.
# It's used by many applications and language bindings (Python, Perl, PHP, etc.)
# to communicate with MySQL and MariaDB servers.
#
# Note: This builds only the client library from MySQL source.
# For the full MySQL server, see databases//mysql:mysql
#
# USE flags:
#   ssl       - Enable SSL/TLS support with OpenSSL
#   zlib      - Enable compression support
#   zstd      - Enable zstd compression
#   static    - Build static library

cmake_package(
    name = "libmysqlclient",
    version = "8.3.0",
    src_uri = "https://dev.mysql.com/get/Downloads/MySQL-8.3/mysql-8.3.0.tar.gz",
    sha256 = "1f21495a0b7a82b24a453d52e2153a814b3ca704eccf999766d545bce52f386e",
    signature_required = False,
    description = "MySQL C client library",
    homepage = "https://dev.mysql.com/doc/c-api/8.3/en/",
    license = "GPL-2.0",

    # USE flags this package supports
    iuse = [
        "ssl",
        "zlib",
        "zstd",
        "static",
    ],

    # Default enabled flags
    use_defaults = ["ssl", "zlib"],

    # Conditional dependencies based on USE flags
    use_deps = {
        "ssl": ["//packages/linux/system/libs/crypto/openssl:openssl"],
        "zlib": ["//packages/linux/core/zlib:zlib"],
        "zstd": ["//packages/linux/dev-libs/compression/zstd:zstd"],
    },

    # Base CMake arguments (always applied)
    cmake_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DBUILD_SHARED_LIBS=ON",
        # Only build the client library, not the server
        "-DWITHOUT_SERVER=ON",
        "-DWITH_UNIT_TESTS=OFF",
        "-DDOWNLOAD_BOOST=OFF",
        "-DWITH_BOOST=bundled",
        # Use system libraries where possible
        "-DWITH_SSL=system",
        "-DWITH_ZLIB=system",
        "-DWITH_EDITLINE=bundled",
        # Disable unnecessary components
        "-DWITH_ROUTER=OFF",
        "-DWITH_MYSQLX=OFF",
    ],

    # CMake options based on USE flags
    use_cmake = {
        "ssl": "-DWITH_SSL=system",
        "-ssl": "-DWITH_SSL=OFF",
        "zlib": "-DWITH_ZLIB=system",
        "-zlib": "-DWITH_ZLIB=bundled",
        "zstd": "-DWITH_ZSTD=system",
        "-zstd": "-DWITH_ZSTD=bundled",
        "static": "-DBUILD_SHARED_LIBS=OFF",
        "-static": "-DBUILD_SHARED_LIBS=ON",
    },

    # Base dependencies (always required)
    deps = [],

    visibility = ["PUBLIC"],
)
