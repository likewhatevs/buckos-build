load("//defs:package.bzl", "package")

# caddy - Fast, multi-platform web server with automatic HTTPS
# This is a pre-built Go binary - USE flags require rebuilding from source

package(
    build_rule = "binary",
    name = "caddy",
    version = "2.8.4",
    url = "https://github.com/caddyserver/caddy/archive/refs/tags/v2.8.4.tar.gz",
    sha256 = "5c2e95ad9e688a18dd9d9099c8c132331e01e0bebd401183e8d9123372cf4fcc",
    description = "Fast, multi-platform web server with automatic HTTPS",
    homepage = "https://caddyserver.com/",
    license = "Apache-2.0",
    install_script = """
cd $SRCS

# Find and install binary (may be in current dir or extracted directly)
if [ -f caddy ]; then
    install -Dm755 caddy "$OUT/usr/bin/caddy"
elif [ -f */caddy ]; then
    install -Dm755 */caddy "$OUT/usr/bin/caddy"
else
    echo "Error: caddy binary not found"
    ls -la
    exit 1
fi

# Create configuration directories
mkdir -p "$OUT/etc/caddy"
mkdir -p "$OUT/var/lib/caddy"
mkdir -p "$OUT/var/log/caddy"

# Create default Caddyfile
cat > "$OUT/etc/caddy/Caddyfile" << 'EOF'
# Global options
{
    admin off
}

# Default site
:80 {
    root * /var/www/html
    file_server
}
EOF

# Create default web root
mkdir -p "$OUT/var/www/html"
""",
    deps = [],
)
