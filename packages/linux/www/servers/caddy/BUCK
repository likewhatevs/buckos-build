load("//defs:package_defs.bzl", "download_source", "binary_package")

# caddy - Fast, multi-platform web server with automatic HTTPS
# This is a pre-built Go binary - USE flags require rebuilding from source

download_source(
    name = "caddy-src",
    src_uri = "https://github.com/caddyserver/caddy/releases/download/v2.8.4/caddy_2.8.4_linux_amd64.tar.gz",
    sha256 = "a7e8306c54138cf88e371c5ec0caf7baf142ecc1d60a30897dfb67d65d3748c8",
    signature_required = False,
    strip_components = 0,
)

binary_package(
    name = "caddy",
    srcs = [":caddy-src"],
    version = "2.8.4",
    description = "Fast, multi-platform web server with automatic HTTPS",
    homepage = "https://caddyserver.com/",
    license = "Apache-2.0",
    install_script = """
cd $SRCS

# Find and install binary (may be in current dir or extracted directly)
if [ -f caddy ]; then
    install -Dm755 caddy "$OUT/usr/bin/caddy"
elif [ -f */caddy ]; then
    install -Dm755 */caddy "$OUT/usr/bin/caddy"
else
    echo "Error: caddy binary not found"
    ls -la
    exit 1
fi

# Create configuration directories
mkdir -p "$OUT/etc/caddy"
mkdir -p "$OUT/var/lib/caddy"
mkdir -p "$OUT/var/log/caddy"

# Create default Caddyfile
cat > "$OUT/etc/caddy/Caddyfile" << 'EOF'
# Global options
{
    admin off
}

# Default site
:80 {
    root * /var/www/html
    file_server
}
EOF

# Create default web root
mkdir -p "$OUT/var/www/html"
""",
    deps = [],
    visibility = ["PUBLIC"],
)
