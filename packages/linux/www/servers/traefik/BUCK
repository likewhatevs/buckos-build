load("//defs:package_defs.bzl", "download_source", "binary_package", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags", "use_dep")

# traefik - Modern HTTP reverse proxy and load balancer
#
# USE flags:
#   This is a pre-built Go binary, minimal USE flag customization available

download_source(
    name = "traefik-src",
    src_uri = "https://github.com/traefik/traefik/releases/download/v3.1.6/traefik_v3.1.6_linux_amd64.tar.gz",
    sha256 = "b1f405ab5985121fa54ece00a951781e368bbb8c7e8d3211f66fe4f347a506b7",
    signature_required = False,
    strip_components = 0,
)

binary_package(
    name = "traefik",
    srcs = [":traefik-src"],
    version = "3.1.6",
    description = "Modern HTTP reverse proxy and load balancer for microservices",
    homepage = "https://traefik.io/",
    license = "MIT",
    install_script = """
cd $SRCS

# Find and install binary
if [ -f traefik ]; then
    install -Dm755 traefik "$OUT/usr/bin/traefik"
elif [ -f */traefik ]; then
    install -Dm755 */traefik "$OUT/usr/bin/traefik"
else
    echo "Error: traefik binary not found"
    ls -la
    exit 1
fi

# Create configuration directories
mkdir -p "$OUT/etc/traefik"
mkdir -p "$OUT/etc/traefik/dynamic"
mkdir -p "$OUT/var/log/traefik"

# Create default static configuration
cat > "$OUT/etc/traefik/traefik.yml" << 'EOF'
api:
  dashboard: true
  insecure: true

entryPoints:
  web:
    address: ":80"
  websecure:
    address: ":443"

providers:
  file:
    directory: /etc/traefik/dynamic
    watch: true

log:
  filePath: /var/log/traefik/traefik.log
  level: INFO

accessLog:
  filePath: /var/log/traefik/access.log
EOF

# Create example dynamic configuration
cat > "$OUT/etc/traefik/dynamic/example.yml" << 'EOF'
# Example dynamic configuration
http:
  routers:
    example:
      rule: "Host(\`example.localhost\`)"
      service: example-service
      entryPoints:
        - web

  services:
    example-service:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:8080"
EOF
""",
    deps = [
    ],
    visibility = ["PUBLIC"],
)
