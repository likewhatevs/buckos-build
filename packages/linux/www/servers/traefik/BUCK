load("//defs:package.bzl", "package")

# traefik - Modern HTTP reverse proxy and load balancer
#
# USE flags:
#   This is a pre-built Go binary, minimal USE flag customization available

package(
    build_rule = "binary",
    name = "traefik",
    version = "3.1.6",
    url = "https://github.com/traefik/traefik/archive/refs/tags/v3.1.6.tar.gz",
    sha256 = "effe8fbcbf81af2a034c436960c5a3505a5406a9189e322c648bb87d27385cb4",
    description = "Modern HTTP reverse proxy and load balancer for microservices",
    homepage = "https://traefik.io/",
    license = "MIT",
    install_script = """
cd $SRCS

# Find and install binary
if [ -f traefik ]; then
    install -Dm755 traefik "$OUT/usr/bin/traefik"
elif [ -f */traefik ]; then
    install -Dm755 */traefik "$OUT/usr/bin/traefik"
else
    echo "Error: traefik binary not found"
    ls -la
    exit 1
fi

# Create configuration directories
mkdir -p "$OUT/etc/traefik"
mkdir -p "$OUT/etc/traefik/dynamic"
mkdir -p "$OUT/var/log/traefik"

# Create default static configuration
cat > "$OUT/etc/traefik/traefik.yml" << 'EOF'
api:
  dashboard: true
  insecure: true

entryPoints:
  web:
    address: ":80"
  websecure:
    address: ":443"

providers:
  file:
    directory: /etc/traefik/dynamic
    watch: true

log:
  filePath: /var/log/traefik/traefik.log
  level: INFO

accessLog:
  filePath: /var/log/traefik/access.log
EOF

# Create example dynamic configuration
cat > "$OUT/etc/traefik/dynamic/example.yml" << 'EOF'
# Example dynamic configuration
http:
  routers:
    example:
      rule: "Host(\`example.localhost\`)"
      service: example-service
      entryPoints:
        - web

  services:
    example-service:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:8080"
EOF
""",
    deps = [
    ],
)
