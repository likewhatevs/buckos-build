load("@root//defs:package_defs.bzl", "download_source", "ebuild_package")

# gopls - Go language server
# Note: gopls lives in the gopls/ subdirectory of golang.org/x/tools
# and has its own go.mod file. ebuild.sh auto-detects subdirectory go.mod files.

download_source(
    name = "gopls-src",
    src_uri = "https://github.com/golang/tools/archive/refs/tags/gopls/v0.20.0.tar.gz",
    sha256 = "1ff2a83be8be5a61b97fc5d72eab66f368ec20b52c513cc6656fc2e502e46f19",
)

ebuild_package(
    name = "gopls",
    source = ":gopls-src",
    version = "0.20.0",
    description = "Go language server providing IDE features",
    homepage = "https://github.com/golang/tools/tree/master/gopls",
    license = "BSD-3-Clause",
    bdepend = [
        "//packages/linux/lang/go:go",
    ],
    # gopls has its own go.mod in the gopls/ subdirectory
    # ebuild.sh now auto-detects and pre-fetches from subdirectories
    src_configure = """
cd gopls
export GOPATH="${GOPATH:-$PWD/../go}"
export GOCACHE="${GOCACHE:-$PWD/../.cache/go-build}"
export GOMODCACHE="${GOMODCACHE:-$GOPATH/pkg/mod}"
export CGO_ENABLED=0
if [ "${GOPROXY:-}" = "off" ] && [ -n "${GOMODCACHE:-}" ]; then
    echo "Using pre-fetched Go module cache: $GOMODCACHE (GOPROXY=off)"
fi
""",
    src_compile = """
cd gopls
go build -v -ldflags="-s -w" -o ../build/gopls .
""",
    src_install = """
mkdir -p "$DESTDIR/usr/bin"
install -m 0755 build/gopls "$DESTDIR/usr/bin/gopls"
""",
    visibility = ["PUBLIC"],
)
