load("//defs:package.bzl", "package")

# =============================================================================
# Djinni - Cross-language type declaration and interface binding generator
# =============================================================================
# Djinni is a tool for generating cross-language type declarations and
# interface bindings between C++, Java, and Objective-C.
# It's designed to connect C++ with either Java or Objective-C for
# cross-platform mobile development.

package(
    build_rule = "binary",
    name = "djinni",
    version = "1.0",
    url = "https://github.com/dropbox/djinni/archive/3aa304c155ac6b601688c6ad721e51c2dad7b443.tar.gz",
    sha256 = "91967ee7e52f05be293c96653255119bb2adca00e50f19d962b8a5ae3fefec85",
    description = "Tool for generating cross-language type declarations and interface bindings",
    homepage = "https://github.com/dropbox/djinni",
    license = "Apache-2.0",
    install_script = """
        cd $SRCS

        # Build using the bundled SBT script
        cd src && ./support/sbt compile stage
        cd ..

        # Install the staged executable and libraries
        mkdir -p "$OUT/usr/lib/djinni"
        if [ -d src/target/universal/stage ]; then
            cp -r src/target/universal/stage/* "$OUT/usr/lib/djinni/"
        fi

        # Create wrapper script in /usr/bin
        mkdir -p "$OUT/usr/bin"
        cat > "$OUT/usr/bin/djinni" << 'WRAPPER_EOF'
#!/bin/bash
exec /usr/lib/djinni/bin/src "$@"
WRAPPER_EOF
        chmod +x "$OUT/usr/bin/djinni"

        # Install the C++ support library headers
        mkdir -p "$OUT/usr/include/djinni"
        mkdir -p "$OUT/usr/include/djinni/jni"
        mkdir -p "$OUT/usr/include/djinni/objc"
        cp -r support-lib/*.hpp "$OUT/usr/include/djinni/" 2>/dev/null || true
        cp -r support-lib/jni/*.hpp "$OUT/usr/include/djinni/jni/" 2>/dev/null || true
        cp -r support-lib/jni/*.cpp "$OUT/usr/include/djinni/jni/" 2>/dev/null || true
        cp -r support-lib/objc/*.h "$OUT/usr/include/djinni/objc/" 2>/dev/null || true
        cp -r support-lib/objc/*.mm "$OUT/usr/include/djinni/objc/" 2>/dev/null || true

        # Install CMakeLists.txt for the support library
        [ -f CMakeLists.txt ] && cp CMakeLists.txt "$OUT/usr/include/djinni/"

        # Install documentation
        mkdir -p "$OUT/usr/share/doc/djinni"
        cp README.md "$OUT/usr/share/doc/djinni/" 2>/dev/null || true
        cp LICENSE "$OUT/usr/share/doc/djinni/" 2>/dev/null || true
    """,
)
