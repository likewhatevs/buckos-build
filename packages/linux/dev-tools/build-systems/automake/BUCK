load("//defs:package_defs.bzl", "download_source", "ebuild_package")
load("//defs:eclasses.bzl", "inherit")
load("//defs:use_flags.bzl", "set_use_flags")

# Automake cannot use autotools_package because it would create a circular dependency
# (autotools eclass depends on automake). Build it manually instead.
download_source(
    name = "automake-src",
    src_uri = "https://mirror.buckos.org/a/automake-1.16.5.tar.xz",
    sha256 = "f01d58cd6d9d77fbdca9eb4bbd5ead1988228fdb73d6f7a201f5f8d6b118b469",
    signature_sha256 = "3a161ab65921eed55e1a94251d97c8451d4ba3431b55ca560e95a951b5f1d73a",
    signature_required = False,
)

ebuild_package(
    name = "automake",
    source = ":automake-src",
    version = "1.16.5",
    category = "dev-tools/build-systems",
    slot = "0",
    description = "Tool for generating GNU Standards-compliant Makefiles",
    homepage = "https://www.gnu.org/software/automake/",
    license = "GPL-2+",

    pre_configure = '''
# Find autoconf dependency and set up environment
for dep_dir in $(echo $DEP_BASE_DIRS | tr ':' ' '); do
    if [ -d "$dep_dir/usr/share/autoconf" ]; then
        echo "Found autoconf in: $dep_dir"
        export AUTOCONF="$dep_dir/usr/bin/autoconf"
        export AUTOM4TE="$dep_dir/usr/bin/autom4te"
        export AC_MACRODIR="$dep_dir/usr/share/autoconf"
        export autom4te_perllibdir="$dep_dir/usr/share/autoconf"
        export PATH="$dep_dir/usr/bin:$PATH"

        # Create wrapper script that sets the correct paths
        mkdir -p "$T/bin"
        cat > "$T/bin/autoconf" << 'WRAPPER_EOF'
#!/bin/bash
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
# Find the real autoconf
for d in $(echo $DEP_BASE_DIRS | tr ':' ' '); do
    if [ -x "$d/usr/bin/autoconf" ]; then
        export AC_MACRODIR="$d/usr/share/autoconf"
        export autom4te_perllibdir="$d/usr/share/autoconf"
        exec "$d/usr/bin/autoconf" "$@"
    fi
done
echo "autoconf not found" >&2
exit 1
WRAPPER_EOF
        chmod +x "$T/bin/autoconf"
        export PATH="$T/bin:$PATH"
        break
    fi
done
''',

    src_configure = '''
# The automake tarball ships with pre-generated configure, so we do not need
# autoconf to regenerate anything. We pass cache variables to skip the runtime
# autoconf checks.

# Create a cache file to pre-set the autoconf check results
cat > config.cache << 'CACHE_EOF'
am_cv_autoconf_works=yes
am_cv_autoconf_version=yes
CACHE_EOF

./configure \
    --cache-file=config.cache \
    --prefix=/usr \
    --build=$(${CC:-gcc} -dumpmachine) \
    --host=$(${CC:-gcc} -dumpmachine) \
    --mandir=/usr/share/man \
    --infodir=/usr/share/info \
    --datadir=/usr/share \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --libdir=/usr/lib64
''',

    src_compile = '''
# Create a dummy help2man if not available on the host
# This avoids cross-compilation issues where help2man tries to run
# the target binaries to generate documentation
if ! command -v help2man >/dev/null 2>&1; then
    mkdir -p "$T/bin"
    cat > "$T/bin/help2man" << 'HELP2MAN_STUB'
#!/bin/sh
# Stub help2man for cross-compilation
# Just create an empty man page
output=""
while [ $# -gt 0 ]; do
    case "$1" in
        -o) output="$2"; shift 2 ;;
        --output=*) output="${1#--output=}"; shift ;;
        *) shift ;;
    esac
done
if [ -n "$output" ]; then
    mkdir -p "$(dirname "$output")"
    echo ".TH AUTOMAKE 1" > "$output"
fi
exit 0
HELP2MAN_STUB
    chmod +x "$T/bin/help2man"
    export PATH="$T/bin:$PATH"
fi

make -j$(nproc)
''',

    src_install = '''
make DESTDIR="$DESTDIR" install

# Create wrapper scripts that set the correct data directory
# aclocal and automake have hardcoded paths that need to be overridden
BINDIR="$DESTDIR/usr/bin"

# Find the version-specific directory (e.g., automake-1.16)
AUTOMAKE_VERSION="1.16"
AUTOMAKE_DATADIR="$DESTDIR/usr/share/automake-$AUTOMAKE_VERSION"
ACLOCAL_DATADIR="$DESTDIR/usr/share/aclocal-$AUTOMAKE_VERSION"

# Patch automake.real to use environment variable for perllibdir
# The script has hardcoded: my $perllibdir = '/usr/share/automake-1.16';
# We change it to use AUTOMAKE_PERLLIBDIR env var if set
for script in "$BINDIR/automake" "$BINDIR/aclocal"; do
    if [ -f "$script" ]; then
        sed -i "s|^my \$perllibdir = '/usr/share/automake-.*';|my \$perllibdir = \$ENV{'AUTOMAKE_PERLLIBDIR'} // '/usr/share/automake-1.16';|" "$script"
    fi
done

# Create wrapper for aclocal
if [ -f "$BINDIR/aclocal" ]; then
    mv "$BINDIR/aclocal" "$BINDIR/aclocal.real"
    cat > "$BINDIR/aclocal" << 'WRAPPER_EOF'
#!/bin/sh
# Wrapper to set correct paths for aclocal
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SHARE_DIR="${SCRIPT_DIR}/../share"
# Find the automake version directory
for d in "$SHARE_DIR"/automake-*; do
    if [ -d "$d" ]; then
        export AUTOMAKE_PERLLIBDIR="$d"
        break
    fi
done
for d in "$SHARE_DIR"/aclocal-*; do
    if [ -d "$d" ]; then
        export ACLOCAL_AUTOMAKE_DIR="$d"
        break
    fi
done
export AUTOMAKE_UNINSTALLED=1
export PERL5LIB="${AUTOMAKE_PERLLIBDIR}${PERL5LIB:+:$PERL5LIB}"
exec "$SCRIPT_DIR/aclocal.real" "$@"
WRAPPER_EOF
    chmod +x "$BINDIR/aclocal"
fi

# Create wrapper for automake
if [ -f "$BINDIR/automake" ]; then
    mv "$BINDIR/automake" "$BINDIR/automake.real"
    cat > "$BINDIR/automake" << 'WRAPPER_EOF'
#!/bin/sh
# Wrapper to set correct paths for automake
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SHARE_DIR="${SCRIPT_DIR}/../share"
# Find the automake version directory
for d in "$SHARE_DIR"/automake-*; do
    if [ -d "$d" ]; then
        export AUTOMAKE_PERLLIBDIR="$d"
        break
    fi
done
export AUTOMAKE_UNINSTALLED=1
export PERL5LIB="${AUTOMAKE_PERLLIBDIR}${PERL5LIB:+:$PERL5LIB}"
exec "$SCRIPT_DIR/automake.real" "$@"
WRAPPER_EOF
    chmod +x "$BINDIR/automake"
fi

# Create versioned wrapper symlinks
for tool in aclocal automake; do
    if [ -f "$BINDIR/${tool}-$AUTOMAKE_VERSION" ]; then
        rm -f "$BINDIR/${tool}-$AUTOMAKE_VERSION"
        ln -sf "$tool" "$BINDIR/${tool}-$AUTOMAKE_VERSION"
    fi
done
''',

    bdepend = [
        "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
    ],
    visibility = ["PUBLIC"],
)
