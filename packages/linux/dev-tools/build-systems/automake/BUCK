load("//defs:package.bzl", "package")

package(
    build_rule = "autotools",
    name = "automake",
    version = "1.16.5",
    url = "https://mirror.buckos.org/a/automake-1.16.5.tar.xz",
    sha256 = "f01d58cd6d9d77fbdca9eb4bbd5ead1988228fdb73d6f7a201f5f8d6b118b469",
    description = "Tool for generating GNU Standards-compliant Makefiles",
    homepage = "https://www.gnu.org/software/automake/",
    license = "GPL-2.0+",
    pre_configure_cmds = [
        # Prevent make from trying to regenerate aclocal.m4 — the tarball
        # ships with pre-generated files but the Makefile has a dependency
        # on aclocal-1.16 which is what we are building.
        "touch aclocal.m4 configure Makefile.in */Makefile.in */*/Makefile.in 2>/dev/null || true",
    ],
    pre_build_cmds = [
        # Stub the doc/help2man script — it tries to run the versioned
        # binaries (aclocal-1.16, automake-1.16) that we are building.
        "printf '#!/bin/sh\\nfor arg; do case \"$arg\" in --output=*) f=\"${arg#--output=}\"; echo \".TH A 1\" > \"$f\"; exit 0;; esac; done\\nexit 0\\n' > doc/help2man && chmod +x doc/help2man",
        # Touch amhello tarball — its recipe runs aclocal-1.16 which we
        # are currently building.
        "touch doc/amhello-1.0.tar.gz",
    ],
    make_args = [
        # Stub out makeinfo — the build host may not have texinfo installed.
        "MAKEINFO=true",
    ],
    post_install_cmds = [
        # Create wrapper scripts so aclocal/automake find their m4 macros
        # when run from Buck2 sandboxed paths instead of /usr/share/...
        """
        BINDIR="$DESTDIR/usr/bin"
        VER="1.16"

        # Wrap aclocal and aclocal-$VER
        for tool in aclocal "aclocal-$VER"; do
            if [ -f "$BINDIR/$tool" ]; then
                mv "$BINDIR/$tool" "$BINDIR/${tool}.real"
                cat > "$BINDIR/$tool" << WRAPPER_EOF
#!/bin/sh
SCRIPT_DIR="\\$(cd "\\$(dirname "\\$0")" && pwd)"
SHARE="\\${SCRIPT_DIR}/../share"
export AUTOMAKE_UNINSTALLED=1
export PERL5LIB="\\$SHARE/automake-$VER:\\${PERL5LIB:+:\\$PERL5LIB}"
export ACLOCAL_AUTOMAKE_DIR="\\$SHARE/aclocal-$VER"
exec "\\$SCRIPT_DIR/${tool}.real" --automake-acdir="\\$SHARE/aclocal-$VER" --system-acdir="\\$SHARE/aclocal" "\\$@"
WRAPPER_EOF
                chmod +x "$BINDIR/$tool"
            fi
        done

        # Rewrite shebangs in .real scripts from absolute buck-out perl
        # paths to portable #!/usr/bin/env perl — absolute paths become
        # stale when actions are cached on one machine and restored on another.
        for real in "\\$BINDIR"/*.real; do
            [ -f "\\$real" ] || continue
            head -1 "\\$real" | grep -q '/perl' || continue
            sed -i '1s|#!.*/perl.*|#!/usr/bin/env perl|' "\\$real"
        done

        # Wrap automake and automake-$VER
        for tool in automake "automake-$VER"; do
            if [ -f "$BINDIR/$tool" ]; then
                mv "$BINDIR/$tool" "$BINDIR/${tool}.real"
                cat > "$BINDIR/$tool" << WRAPPER_EOF
#!/bin/sh
SCRIPT_DIR="\\$(cd "\\$(dirname "\\$0")" && pwd)"
SHARE="\\${SCRIPT_DIR}/../share"
export AUTOMAKE_UNINSTALLED=1
export PERL5LIB="\\$SHARE/automake-$VER:\\${PERL5LIB:+:\\$PERL5LIB}"
export AUTOMAKE_LIBDIR="\\$SHARE/automake-$VER"
# automake traces macros via \$AUTOCONF (defaults to 'true' = no-op)
AUTOCONF_BIN="\\$(command -v autoconf 2>/dev/null)"
[ -n "\\$AUTOCONF_BIN" ] && export AUTOCONF="\\$AUTOCONF_BIN"
exec "\\$SCRIPT_DIR/${tool}.real" "\\$@"
WRAPPER_EOF
                chmod +x "$BINDIR/$tool"
            fi
        done
        """,
    ],
    deps = [
        "//packages/linux/dev-tools/build-systems/autoconf:autoconf",
    ],
)
