load("//defs:package.bzl", "package")

# Autoconf cannot use autotools_package because it would create a circular dependency
# (autotools eclass depends on autoconf). Build it manually instead.
package(
    build_rule = "binary",
    name = "autoconf",
    # NOTE: autoconf is a bootstrap package - it cannot depend on autotools
    # because that would create a circular dependency. The tarball ships with
    # a pre-generated configure script, so we don't need autoreconf.
    version = "2.72",
    url = "https://mirrors.kernel.org/gnu/autoconf/autoconf-2.72.tar.xz",
    sha256 = "ba885c1319578d6c94d46e9b0dceb4014caafe2490e437a0dbca3f270a223f5a",
    description = "Automatic configure script builder",
    homepage = "https://www.gnu.org/software/autoconf/",
    license = "GPL-3+",
    install_script = '''
        cd $SRCS

        # Pre-set cache variable to skip filesystem character test that creates
        # files with special characters in their names (Buck2 cannot handle
        # backslashes in paths).  Passed as a configure ARGUMENT (not env var)
        # so config.status --recheck preserves it — otherwise make-triggered
        # rechecks re-run configure without the variable and momentarily
        # create conftest.t\t, which Buck2 can catch mid-scan.
        # Starlark \\\\ -> bash \\, \\t -> \t.
        ./configure \
            ac_cv_unsupported_fs_chars=$'"<>\\\\|\\t' \
            --prefix=/usr \
            --build=$(./build-aux/config.guess 2>/dev/null || echo x86_64-pc-linux-gnu) \
            --host=${CHOST:-$(${CC:-gcc} -dumpmachine)} \
            --mandir=/usr/share/man \
            --infodir=/usr/share/info \
            --datadir=/usr/share \
            --sysconfdir=/etc \
            --localstatedir=/var \
            --libdir=/usr/lib64 \
            --disable-doc

        # Clean any pre-existing frozen files that may cause format mismatches
        find . -name '*.m4f' -delete 2>/dev/null || true

        # Remove configure test artifacts — filenames with special characters
        # (backslashes, etc.) break Buck2's path handling.
        find . -name 'conftest*' -delete 2>/dev/null || true

        # Uniform timestamps prevent autotools regeneration rules
        find . -type f -exec touch {} + 2>/dev/null || true

        make -j${MAKEOPTS:-$(nproc)} MAKEINFO=true ACLOCAL=true AUTOMAKE=true

        make DESTDIR="$OUT" install MAKEINFO=true ACLOCAL=true AUTOMAKE=true

        # Clean conftest files again — make may recreate them during build
        find . -name 'conftest*' -delete 2>/dev/null || true

        # Create wrapper scripts that set the correct data directory
        # autom4te has /usr/share/autoconf hardcoded, but in Buck2 builds we need
        # to use the package's own share directory
        BINDIR="$OUT/usr/bin"
        DATADIR="$OUT/usr/share/autoconf"

        # Patch autom4te.cfg to remove hardcoded paths - the wrapper will set them dynamically
        # The config file has lines like: args: --prepend-include '/usr/share/autoconf'
        # We replace /usr/share/autoconf with a placeholder that will be expanded by the wrapper
        sed -i "s|--prepend-include '/usr/share/autoconf'|--prepend-include '\\\$AC_MACRODIR'|g" "$DATADIR/autom4te.cfg"

        # Create a wrapper for autom4te that uses -B to prepend the correct include path
        if [ -f "$BINDIR/autom4te" ]; then
            mv "$BINDIR/autom4te" "$BINDIR/autom4te.real"
            cat > "$BINDIR/autom4te" << 'WRAPPER_EOF'
#!/bin/sh
# Wrapper to set correct data directory for autom4te
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
DATA_DIR="${SCRIPT_DIR}/../share/autoconf"
export AC_MACRODIR="$DATA_DIR"
export autom4te_perllibdir="$DATA_DIR"
export trailer_m4="$DATA_DIR/autoconf/trailer.m4"
# Use -B to prepend the correct include directory
exec "$SCRIPT_DIR/autom4te.real" -B "$DATA_DIR" "$@"
WRAPPER_EOF
            chmod +x "$BINDIR/autom4te"
        fi

        # Create a wrapper for autoconf that sets the correct autom4te and trailer_m4
        if [ -f "$BINDIR/autoconf" ]; then
            mv "$BINDIR/autoconf" "$BINDIR/autoconf.real"
            cat > "$BINDIR/autoconf" << 'WRAPPER_EOF'
#!/bin/sh
# Wrapper to set correct paths for autoconf
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
DATA_DIR="${SCRIPT_DIR}/../share/autoconf"
export AC_MACRODIR="$DATA_DIR"
export autom4te_perllibdir="$DATA_DIR"
export trailer_m4="$DATA_DIR/autoconf/trailer.m4"
export AUTOM4TE="$SCRIPT_DIR/autom4te"
exec "$SCRIPT_DIR/autoconf.real" "$@"
WRAPPER_EOF
            chmod +x "$BINDIR/autoconf"
        fi

        # Similarly wrap autoheader and autoreconf
        for tool in autoheader autoreconf autoupdate autoscan ifnames; do
            if [ -f "$BINDIR/$tool" ]; then
                mv "$BINDIR/$tool" "$BINDIR/${tool}.real"
                cat > "$BINDIR/$tool" << WRAPPER_EOF
#!/bin/sh
# Wrapper to set correct paths for $tool
SCRIPT_DIR="\$(cd "\$(dirname "\$0")" && pwd)"
DATA_DIR="\${SCRIPT_DIR}/../share/autoconf"
export AC_MACRODIR="\$DATA_DIR"
export autom4te_perllibdir="\$DATA_DIR"
export trailer_m4="\$DATA_DIR/autoconf/trailer.m4"
export AUTOM4TE="\$SCRIPT_DIR/autom4te"
exec "\$SCRIPT_DIR/${tool}.real" "\$@"
WRAPPER_EOF
                chmod +x "$BINDIR/$tool"
            fi
        done

        # Rewrite shebangs in .real scripts from absolute buck-out perl paths
        # to portable #!/usr/bin/env perl — the absolute paths become stale
        # when actions are cached on one machine and restored on another.
        for real in "$BINDIR"/*.real; do
            [ -f "$real" ] || continue
            head -1 "$real" | grep -q '/perl' || continue
            sed -i '1s|#!.*/perl.*|#!/usr/bin/env perl|' "$real"
        done

        # Also patch the .real scripts to replace hardcoded @include arrays with dynamic paths
        for script in autoscan.real autoupdate.real; do
            if [ -f "$BINDIR/$script" ]; then
                # Replace hardcoded @include with dynamic version using AC_MACRODIR env var
                # Use # as delimiter since | appears in the replacement text (|| operator)
                sed -i "s#my @include = ('/usr/share/autoconf');#my @include = (\$ENV{'AC_MACRODIR'} // '/usr/share/autoconf');#g" "$BINDIR/$script"
            fi
        done

        # Final cleanup: delete any file whose name contains characters that
        # Buck2 cannot relativize (tabs, backslashes).  Despite the cache
        # variable and earlier cleanups, parallel make or autom4te invocations
        # during install may recreate conftest files intermittently.
        find . -name 'conftest*' -delete 2>/dev/null || true
        find "$OUT" -name 'conftest*' -delete 2>/dev/null || true
    ''',
    # No dependencies - autoconf is a bootstrap package
    deps = [],
)
