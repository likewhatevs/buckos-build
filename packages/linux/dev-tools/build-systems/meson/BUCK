load("//defs:package.bzl", "package")

# USE flags: doc, test
# Default: none

package(
    build_rule = "binary",
    name = "meson",
    version = "1.10.1",
    url = "https://github.com/mesonbuild/meson/archive/refs/tags/1.10.1.tar.gz",
    sha256 = "3d4768a76fc63dc4c562edc7892de17b54dfaa7309d148e805b0d763bc085e00",
    description = "High productivity build system",
    homepage = "https://mesonbuild.com/",
    license = "Apache-2.0",
    install_script = """
        # Meson can be installed by copying files directly (no setuptools needed)
        mkdir -p "$OUT/usr/bin"
        mkdir -p "$OUT/usr/lib/python3/dist-packages"

        # Copy the mesonbuild module
        cp -r "$SRCS/mesonbuild" "$OUT/usr/lib/python3/dist-packages/"

        # Create the meson wrapper script
        cat > "$OUT/usr/bin/meson" << 'EOF'
#!/usr/bin/env python3
import sys
import mesonbuild.mesonmain
sys.exit(mesonbuild.mesonmain.main())
EOF
        chmod +x "$OUT/usr/bin/meson"

        # Copy man pages if present
        if [ -d "$SRCS/man" ]; then
            mkdir -p "$OUT/usr/share/man/man1"
            cp -r "$SRCS/man"/*.1 "$OUT/usr/share/man/man1/" 2>/dev/null || true
        fi
    """,
)
