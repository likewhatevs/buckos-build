load("@root//defs:package_defs.bzl", "download_source", "binary_package", "autotools_package")
load("@root//defs:use_flags.bzl", "set_use_flags", "use_dep")

# USE flags: doc, test
# Default: none

download_source(
    name = "meson-src",
    src_uri = "https://github.com/mesonbuild/meson/releases/download/1.3.1/meson-1.3.1.tar.gz",
    sha256 = "6020568bdede1643d4fb41e28215be38eff5d52da28ac7d125457c59e0032ad7",
    signature_sha256 = "573ffb2ff8a6a31c71a990eb56ffab7b78c3e5211a2f1c86d2ecc75519de47cd",
    signature_required = False,
)

binary_package(
    name = "meson",
    srcs = [":meson-src"],
    version = "1.3.1",
    description = "High productivity build system",
    homepage = "https://mesonbuild.com/",
    license = "Apache-2.0",
    install_script = """
        # Meson can be installed by copying files directly (no setuptools needed)
        mkdir -p "$OUT/usr/bin"
        mkdir -p "$OUT/usr/lib/python3/dist-packages"

        # Copy the mesonbuild module
        cp -r "$SRCS/mesonbuild" "$OUT/usr/lib/python3/dist-packages/"

        # Create the meson wrapper script
        cat > "$OUT/usr/bin/meson" << 'EOF'
#!/usr/bin/env python3
import sys
import mesonbuild.mesonmain
sys.exit(mesonbuild.mesonmain.main())
EOF
        chmod +x "$OUT/usr/bin/meson"

        # Copy man pages if present
        if [ -d "$SRCS/man" ]; then
            mkdir -p "$OUT/usr/share/man/man1"
            cp -r "$SRCS/man"/*.1 "$OUT/usr/share/man/man1/" 2>/dev/null || true
        fi
    """,
    visibility = ["PUBLIC"],
)
