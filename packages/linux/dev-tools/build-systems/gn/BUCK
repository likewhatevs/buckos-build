load("@root//defs:package_defs.bzl", "download_source", "binary_package")

# GN - Generate Ninja build files
# GN is a meta-build system that generates Ninja build files.
# It's used primarily by Chromium but also by other projects.
# Using o-lim/generate-ninja fork which has proper releases.

download_source(
    name = "gn-src",
    src_uri = "https://github.com/o-lim/generate-ninja/archive/refs/tags/v0.4.1.tar.gz",
    sha256 = "1b2bec9dd18602a4af9dc8782ca809e44305f1435d43c55f35ec9eec50ca7e9a",
    signature_required = False,
)

binary_package(
    name = "gn",
    srcs = [":gn-src"],
    version = "0.4.1",
    description = "GN meta-build system - generates Ninja build files",
    homepage = "https://github.com/o-lim/generate-ninja",
    license = "BSD-3-Clause",
    install_script = """
        cd $SRCS

        # GN bootstraps itself using a Python script
        python3 build/gen.py --allow-warning

        # Build with ninja
        ninja -C out

        # Install
        mkdir -p "$OUT/usr/bin"
        install -Dm755 out/gn "$OUT/usr/bin/gn"
    """,
    deps = [
        "//packages/linux/lang/python:python",
    ],
    visibility = ["PUBLIC"],
)
