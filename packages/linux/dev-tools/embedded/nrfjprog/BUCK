load("@root//defs:package_defs.bzl", "download_source", "binary_package")

download_source(
    name = "nrfjprog-src",
    src_uri = "https://nsscprodmedia.blob.core.windows.net/prod/software-and-other-downloads/desktop-software/nrf-command-line-tools/sw/versions-10-x-x/10-24-1/nrf-command-line-tools-10.24.1_linux-amd64.tar.gz",
    sha256 = "764592e87da331021777e89fefe5f799894c01eb27aaca59f2368b0d3ee90a19",
)

binary_package(
    name = "nrfjprog",
    srcs = [":nrfjprog-src"],
    version = "10.24.1",
    install_script = """
        mkdir -p "$OUT/opt/nrfjprog"
        cp -r "$SRCS"/* "$OUT/opt/nrfjprog/"

        # Create symlinks in /usr/bin
        mkdir -p "$OUT/usr/bin"
        for bin in nrfjprog mergehex; do
            if [ -f "$OUT/opt/nrfjprog/bin/$bin" ]; then
                ln -sf "/opt/nrfjprog/bin/$bin" "$OUT/usr/bin/$bin"
            elif [ -f "$OUT/opt/nrfjprog/$bin" ]; then
                ln -sf "/opt/nrfjprog/$bin" "$OUT/usr/bin/$bin"
            fi
        done

        # Symlink libraries
        mkdir -p "$OUT/usr/lib64"
        find "$OUT/opt/nrfjprog" -name "*.so*" -exec ln -sf {} "$OUT/usr/lib64/" \; 2>/dev/null || true
    """,
    visibility = ["PUBLIC"],
)
