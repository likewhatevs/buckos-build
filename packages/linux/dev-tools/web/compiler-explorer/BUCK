load("@root//defs:package_defs.bzl", "download_source", "binary_package")

download_source(
    name = "compiler-explorer-src",
    src_uri = "https://github.com/compiler-explorer/compiler-explorer/archive/0fc214edf1602fa260b58d8fe7cfcaa87d7c44d8.tar.gz",
    sha256 = "ca9423a25b49bb6577d8915192713fe44989c087256abc890ca0c46287cb907f",
    signature_required = False,
)

binary_package(
    name = "compiler-explorer",
    srcs = [":compiler-explorer-src"],
    version = "5.0.0",
    description = "Interactively investigate compiler output",
    homepage = "https://compiler-explorer.com/",
    license = "BSD-2-Clause",
    install_script = """
        cd $SRCS

        # Install to /opt/compiler-explorer
        mkdir -p "$OUT/opt/compiler-explorer"
        cp -r * "$OUT/opt/compiler-explorer/"

        # Create wrapper script
        mkdir -p "$OUT/usr/bin"
        cat > "$OUT/usr/bin/compiler-explorer" << 'EOF'
#!/bin/bash
cd /opt/compiler-explorer
exec node --no-warnings=ExperimentalWarning --import=tsx app.ts "$@"
EOF
        chmod +x "$OUT/usr/bin/compiler-explorer"
    """,
    deps = [
        "lang//nodejs:nodejs",
    ],
    visibility = ["PUBLIC"],
)
