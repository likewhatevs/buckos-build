load("//defs:package.bzl", "package")

package(
    build_rule = "binary",
    name = "electric-fence",
    version = "3.0",
    url = "https://github.com/kallisti5/ElectricFence/archive/refs/tags/v3.0.tar.gz",
    sha256 = "a16cd964d2991ca0a384119241d7f310021bdb4d21869e3592c9224d038ff0a5",
    description = "Memory debugger for detecting buffer overruns and use-after-free",
    homepage = "https://github.com/kallisti5/ElectricFence",
    license = "GPL-2.0",
    install_script = """
cd "$SRCS/src"

# Build object files with PIC for shared library
cc -c -fPIC -O2 -g -o efence.o efence.c
cc -c -fPIC -O2 -g -o page.o page.c
cc -c -fPIC -O2 -g -o print.o print.c

# Build static library
ar crv libefence.a efence.o page.o print.o

# Build shared library
cc -shared -o libefence.so.0.0 efence.o page.o print.o -lpthread

# Install libraries
mkdir -p "$OUT/usr/lib"
cp -f libefence.a "$OUT/usr/lib/"
cp -f libefence.so.0.0 "$OUT/usr/lib/"
ln -sf libefence.so.0.0 "$OUT/usr/lib/libefence.so.0"
ln -sf libefence.so.0.0 "$OUT/usr/lib/libefence.so"

# Install headers
mkdir -p "$OUT/usr/include"
cp -f efence.h "$OUT/usr/include/"

# Install man pages
mkdir -p "$OUT/usr/share/man/man3"
cp -f "$SRCS/doc/libefence.3" "$OUT/usr/share/man/man3/" 2>/dev/null || true
""",
)
