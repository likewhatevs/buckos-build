load("//defs:package.bzl", "package")

package(
    build_rule = "binary",
    name = "raddebugger",
    version = "master",
    url = "https://github.com/EpicGames/raddebugger/archive/refs/tags/v0.9.24-alpha.tar.gz",
    sha256 = "cb8488ebf6ec29a42c4c269888f80b48f71a295a92935b0ce8d6b67b9a12989e",
    description = "RAD Debugger - native debugger for Windows and Linux",
    homepage = "https://github.com/EpicGames/raddebugger",
    license = "MIT",
    install_script = """
        cd "$SRCS"

        # Build metagen first
        mkdir -p build local
        cd build

        # Use GCC for better compatibility with raddebugger's designated initializer style
        CC=${CC:-gcc}

        # Build metagen first - this generates necessary headers
        METAGEN_CFLAGS="-O2 -I../src/ -I../local/ -g -DBUILD_DEBUG=0 -DBUILD_GIT_HASH=\\\"unknown\\\" -DBUILD_GIT_HASH_FULL=\\\"unknown\\\" -Wall -Wno-missing-braces -Wno-unused-function -Wno-unused-value -Wno-unused-variable -Wno-return-type -Wno-override-init -D_USE_MATH_DEFINES"
        LDFLAGS="-lpthread -lm -lrt -ldl"

        # Build metagen
        $CC $METAGEN_CFLAGS ../src/metagen/metagen_main.c $LDFLAGS -o metagen
        ./metagen

        # After metagen, we need to include the generated local directory
        # The generated headers are in the local directory at the source root
        CFLAGS="-O2 -I../src/ -I../local/ -I.. -g -DBUILD_DEBUG=0 -DBUILD_GIT_HASH=\\\"unknown\\\" -DBUILD_GIT_HASH_FULL=\\\"unknown\\\" -Wall -Wno-missing-braces -Wno-unused-function -Wno-unused-value -Wno-unused-variable -Wno-return-type -Wno-override-init -Wno-format-truncation -Wno-stringop-overflow -D_USE_MATH_DEFINES"

        # Build rdi_from_dwarf - it needs generated headers from metagen
        # Include all necessary source directories
        $CC $CFLAGS -c ../src/rdi_from_dwarf/rdi_from_dwarf.c -o rdi_from_dwarf.o 2>/dev/null || {
            # If build fails, skip this tool as it may require Windows-specific code
            echo "Warning: rdi_from_dwarf build failed, skipping"
        }

        # Build rdi_dump
        $CC $CFLAGS ../src/rdi_dump/rdi_dump_main.c $LDFLAGS -o rdi_dump 2>/dev/null || {
            echo "Warning: rdi_dump build failed, skipping"
        }

        # Build radlink - linker tool
        $CC $CFLAGS ../src/linker/lnk.c $LDFLAGS -o radlink 2>/dev/null || {
            echo "Warning: radlink build failed, skipping"
        }

        # Install any successfully built binaries
        mkdir -p "$OUT/usr/bin"
        for bin in rdi_from_dwarf rdi_dump radlink metagen; do
            if [ -f "$bin" ]; then
                cp "$bin" "$OUT/usr/bin/"
            fi
        done

        # Ensure at least metagen was built
        if [ ! -f "$OUT/usr/bin/metagen" ]; then
            echo "Error: No binaries were built successfully"
            exit 1
        fi
    """,
    deps = [],
    visibility = ["PUBLIC"],
)
