load("//defs:package_defs.bzl", "download_source", "binary_package")

download_source(
    name = "google-breakpad-src",
    src_uri = "https://github.com/google/breakpad/archive/refs/tags/v2022.07.12.tar.gz",
    sha256 = "f834f3553e72f0f7f30775af2fe1b6a08b718c38c1c97edc421400473d24c96b",
    signature_required = False,
)

binary_package(
    name = "google-breakpad",
    srcs = [":google-breakpad-src"],
    version = "2022.07.12",
    description = "Google Breakpad - crash reporting library",
    homepage = "https://chromium.googlesource.com/breakpad/breakpad",
    license = "BSD-3-Clause",
    install_script = """
        cd "$SRCS"

        # Breakpad needs linux-syscall-support headers
        # Download the full LSS header from upstream
        mkdir -p src/third_party/lss

        # Try to download the official LSS header from Chromium
        if ! curl -sSL "https://chromium.googlesource.com/linux-syscall-support/+/refs/heads/main/linux_syscall_support.h?format=TEXT" 2>/dev/null | base64 -d > src/third_party/lss/linux_syscall_support.h; then
            # Fallback: try GitHub mirror
            if ! curl -sSL "https://raw.githubusercontent.com/chromium/linux-syscall-support/main/linux_syscall_support.h" \
                -o src/third_party/lss/linux_syscall_support.h 2>/dev/null; then
                echo "ERROR: Failed to download linux_syscall_support.h"
                exit 1
            fi
        fi

        # Verify the header was downloaded properly
        if [ ! -s src/third_party/lss/linux_syscall_support.h ] || [ $(wc -l < src/third_party/lss/linux_syscall_support.h) -lt 100 ]; then
            echo "ERROR: linux_syscall_support.h appears to be incomplete or empty"
            exit 1
        fi

        # Apply Gentoo-style patches to use system headers and fix compatibility
        # 1. Change third_party includes to system includes for better compatibility
        find src -name '*.cc' -o -name '*.h' | while read -r file; do
            # Fix curl includes
            sed -i 's|"third_party/curl/curl.h"|<curl/curl.h>|g' "$file" || true
            # Fix libdisasm includes
            sed -i 's|"third_party/libdisasm/libdis.h"|<libdis.h>|g' "$file" || true
        done

        # 2. Add missing include for algorithm header (needed for std::max/min)
        if [ -f src/common/module.cc ]; then
            if ! grep -q "#include <algorithm>" src/common/module.cc; then
                sed -i '/#include <utility>/a #include <algorithm>' src/common/module.cc || true
            fi
        fi

        # 3. Fix reinterpret_cast issues in tests (replace with nullptr)
        if [ -f src/processor/minidump_unittest.cc ]; then
            sed -i 's|reinterpret_cast<MinidumpContext\*>(NULL)|nullptr|g' src/processor/minidump_unittest.cc || true
            sed -i 's|reinterpret_cast<MinidumpMemoryRegion\*>(NULL)|nullptr|g' src/processor/minidump_unittest.cc || true
        fi

        # Run autoreconf if needed
        if [ ! -f configure ] || [ configure.ac -nt configure ]; then
            autoreconf -fiv 2>/dev/null || true
        fi

        # Export compiler variables for configure
        # Disable -Werror since GCC 11+ has stricter warnings that cause build failures
        export CC="${CC:-gcc}"
        export CXX="${CXX:-g++}"
        export CFLAGS="${CFLAGS:--O2} -Wno-error -Wno-deprecated-declarations"
        export CXXFLAGS="${CXXFLAGS:--O2} -Wno-error -Wno-deprecated-declarations"

        ./configure \
            --prefix=/usr \
            --libdir=/usr/lib64 \
            --disable-processor 2>/dev/null || \
        ./configure \
            --prefix=/usr \
            --libdir=/usr/lib64

        # Override the Werror flag in make
        make -j$(nproc) CXXFLAGS="-O2 -fPIC -Wno-error -Wno-deprecated-declarations" || make CXXFLAGS="-O2 -fPIC -Wno-error -Wno-deprecated-declarations"
        make install DESTDIR="$OUT"
    """,
    deps = [
        "//packages/linux/system/libs/network/curl:curl",
    ],
    visibility = ["PUBLIC"],
)
