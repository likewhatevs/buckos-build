load("//defs:package.bzl", "package")
load("//defs/rules:source.bzl", "extract_source")

# Source archive
http_file(
    name = "google-breakpad-archive",
    urls = ["https://github.com/google/breakpad/archive/refs/tags/v2022.07.12.tar.gz"],
    sha256 = "f834f3553e72f0f7f30775af2fe1b6a08b718c38c1c97edc421400473d24c96b",
    out = "google-breakpad-2022.07.12.tar.gz",
)

extract_source(
    name = "google-breakpad-src",
    source = ":google-breakpad-archive",
)

# Linux syscall support header required by breakpad at build time.
# TODO: Pin to a specific commit and add sha256 for reproducibility.
http_file(
    name = "lss-header",
    urls = ["https://raw.githubusercontent.com/chromium/linux-syscall-support/main/linux_syscall_support.h"],
    sha256 = "",
    out = "linux_syscall_support.h",
)

# Merge the LSS header into the breakpad source tree
genrule(
    name = "google-breakpad-patched-src",
    out = "breakpad-src",
    cmd = """
mkdir -p "$OUT"
cp -a "$(location :google-breakpad-src)"/. "$OUT/"
mkdir -p "$OUT/src/third_party/lss"
cp "$(location :lss-header)" "$OUT/src/third_party/lss/linux_syscall_support.h"
""",
)

package(
    build_rule = "binary",
    name = "google-breakpad",
    version = "2022.07.12",
    url = "https://github.com/google/breakpad/archive/refs/tags/v2022.07.12.tar.gz",
    sha256 = "f834f3553e72f0f7f30775af2fe1b6a08b718c38c1c97edc421400473d24c96b",
    source = ":google-breakpad-patched-src",
    description = "Google Breakpad - crash reporting library",
    homepage = "https://chromium.googlesource.com/breakpad/breakpad",
    license = "BSD-3-Clause",
    install_script = """
        cd "$SRCS"

        # Verify the LSS header was included (pre-downloaded via http_file)
        if [ ! -s src/third_party/lss/linux_syscall_support.h ] || [ $(wc -l < src/third_party/lss/linux_syscall_support.h) -lt 100 ]; then
            echo "ERROR: linux_syscall_support.h appears to be incomplete or empty"
            exit 1
        fi

        # Apply Gentoo-style patches to use system headers and fix compatibility
        # 1. Change third_party includes to system includes for better compatibility
        find src -name '*.cc' -o -name '*.h' | while read -r file; do
            # Fix curl includes
            sed -i 's|"third_party/curl/curl.h"|<curl/curl.h>|g' "$file" || true
            # Fix libdisasm includes
            sed -i 's|"third_party/libdisasm/libdis.h"|<libdis.h>|g' "$file" || true
        done

        # 2. Add missing include for algorithm header (needed for std::max/min)
        if [ -f src/common/module.cc ]; then
            if ! grep -q "#include <algorithm>" src/common/module.cc; then
                sed -i '/#include <utility>/a #include <algorithm>' src/common/module.cc || true
            fi
        fi

        # 3. Fix reinterpret_cast issues in tests (replace with nullptr)
        if [ -f src/processor/minidump_unittest.cc ]; then
            sed -i 's|reinterpret_cast<MinidumpContext\*>(NULL)|nullptr|g' src/processor/minidump_unittest.cc || true
            sed -i 's|reinterpret_cast<MinidumpMemoryRegion\*>(NULL)|nullptr|g' src/processor/minidump_unittest.cc || true
        fi

        # Run autoreconf if needed
        if [ ! -f configure ] || [ configure.ac -nt configure ]; then
            autoreconf -fiv 2>/dev/null || true
        fi

        # Export compiler variables for configure
        # Disable -Werror since GCC 11+ has stricter warnings that cause build failures
        export CC="${CC:-gcc}"
        export CXX="${CXX:-g++}"
        export CFLAGS="${CFLAGS:--O2} -Wno-error -Wno-deprecated-declarations"
        export CXXFLAGS="${CXXFLAGS:--O2} -Wno-error -Wno-deprecated-declarations"

        ./configure \
            --prefix=/usr \
            --libdir=/usr/lib64 \
            --disable-processor 2>/dev/null || \
        ./configure \
            --prefix=/usr \
            --libdir=/usr/lib64

        # Override the Werror flag in make
        make -j${MAKEOPTS:-$(nproc)} CXXFLAGS="-O2 -fPIC -Wno-error -Wno-deprecated-declarations" || make CXXFLAGS="-O2 -fPIC -Wno-error -Wno-deprecated-declarations"
        make install DESTDIR="$OUT"
    """,
    deps = [
        "//packages/linux/system/libs/network/curl:curl",
    ],
)
