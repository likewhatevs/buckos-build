load("//defs:package_defs.bzl", "download_source", "autotools_package")

autotools_package(
    name = "subversion",
    version = "1.14.3",
    src_uri = "https://archive.apache.org/dist/subversion/subversion-1.14.3.tar.bz2",
    sha256 = "949efd451a09435f7e8573574c71c7b71b194d844890fa49cd61d2262ea1a440",
    signature_sha256 = "6164b9d4fb2b1086c25849b94597dd4e5c809da8dab8dab1d4acef51d70f9e34",
    signature_required = False,
    description = "Enterprise-class centralized version control for the masses",
    homepage = "https://subversion.apache.org/",
    license = "Apache-2.0",

    # USE flags this package supports
    iuse = [
        "apache2",
        "berkdb",
        "debug",
        "extras",
        "java",
        "keyring",
        "kwallet",
        "nls",
        "perl",
        "plaintext-password-storage",
        "python",
        "ruby",
        "sasl",
        "sqlite",
        "static-libs",
    ],

    # Default USE flags
    use_defaults = ["sqlite"],

    # Conditional dependencies
    use_deps = {
        "perl": ["//packages/linux/lang/perl:perl"],
        "python": ["//packages/linux/lang/python:python"],
        "ruby": ["//packages/linux/lang/ruby:ruby"],
    },

    # Conditional configure arguments
    use_configure = {
        "-apache2": "--disable-apache2",
        "-berkdb": "--disable-berkdb",
        "-debug": "--disable-debug",
        "-extras": "--disable-extras",
        "-java": "--disable-java",
        "-keyring": "--disable-keyring",
        "-kwallet": "--disable-kwallet",
        "-nls": "--disable-nls",
        "-perl": "--without-swig",
        "-plaintext-password-storage": "--disable-plaintext-password-storage",
        "-python": "--disable-python-bindings",
        "-ruby": "--disable-ruby-bindings",
        "-sasl": "--disable-sasl",
        "-static-libs": "--disable-static",
        "apache2": "--enable-apache2",
        "berkdb": "--enable-berkdb",
        "debug": "--enable-debug",
        "extras": "--enable-extras",
        "java": "--enable-java",
        "keyring": "--enable-keyring",
        "kwallet": "--enable-kwallet",
        "nls": "--enable-nls",
        "perl": "--with-swig=/usr/bin/swig",
        "plaintext-password-storage": "--enable-plaintext-password-storage",
        "python": "--enable-python-bindings",
        "ruby": "--enable-ruby-bindings",
        "sasl": "--enable-sasl",
        "static-libs": "--enable-static",
    },

    # Custom configure to find APR correctly
    src_configure = """
# Find apr-1-config in PATH (set by build system from deps)
APR_CONFIG=$(which apr-1-config 2>/dev/null || true)
APU_CONFIG=$(which apu-1-config 2>/dev/null || true)

if [ -z "$APR_CONFIG" ] || [ ! -x "$APR_CONFIG" ]; then
    echo "Error: apr-1-config not found in PATH"
    echo "PATH: $PATH"
    exit 1
fi

if [ -z "$APU_CONFIG" ] || [ ! -x "$APU_CONFIG" ]; then
    echo "Warning: apu-1-config not found, will use apr-util from apr location"
fi

APR_DIR=$(dirname $(dirname "$APR_CONFIG"))
echo "Found APR at: $APR_DIR (config: $APR_CONFIG)"

./configure --prefix=/usr \\
    --with-apr="$APR_CONFIG" \\
    --with-apr-util="${APU_CONFIG:-$APR_DIR}" \\
    --with-zlib=/usr \\
    --disable-static
""",
    configure_args = [],

    deps = [
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/dev-libs/misc/apr:apr",
        "//packages/linux/dev-libs/misc/apr-util:apr-util",
    ],
    visibility = ["PUBLIC"],
)
