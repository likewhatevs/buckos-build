load("//defs:package.bzl", "package")

package(
    build_rule = "autotools",
    name = "git",
    version = "2.43.0",
    url = "https://mirrors.edge.kernel.org/pub/software/scm/git/git-2.43.0.tar.xz",
    sha256 = "5446603e73d911781d259e565750dcd277a42836c8e392cac91cf137aa9b76ec",
    # GCC 15 exposes C23 unreachable() which conflicts with git's own macro
    env = {"CFLAGS": "-std=gnu17"},
    description = "Fast, scalable, distributed revision control system",
    homepage = "https://git-scm.com/",
    license = "GPL-2",

    configure_args = [
        "--with-expat",
        "--with-openssl",
        "--with-zlib",
        "--without-curl",
        "--without-libpcre2",
        "--without-python",
        # Cross-compilation cache variables (cannot run test programs on target)
        "ac_cv_iconv_omits_bom=no",
        "ac_cv_fread_reads_directories=no",
        "ac_cv_snprintf_returns_bogus=no",
    ],

    make_args = [
        "prefix=/usr",
        "gitexecdir=/usr/libexec/git-core",
        "NO_CROSS_DIRECTORY_HARDLINKS=1",
        "NO_INSTALL_HARDLINKS=1",
    ],
    deps = [
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/system/libs/data/expat:expat",
        "//packages/linux/lang/perl:perl",
    ],
)
