load("//defs:package_defs.bzl", "binary_package", "download_source")

# =============================================================================
# BuckOS Installer - Graphical System Installer
# =============================================================================
# The installer provides a user-friendly way to install BuckOS to disk.
# It uses egui for the GUI and supports both graphical and CLI modes.
#
# IMPORTANT: The installer source is in the separate ~/buckos/ repository.
# Before building this package, you must:
#   1. cd ~/buckos
#   2. cargo build --release
#   3. The binary will be at ~/buckos/target/release/buckos-installer
#
# This package creates a script that wraps the installer binary.

# Create installer package from pre-built binary
# Uses genrule to build installer from the buckos workspace
genrule(
    name = "buckos-installer-build",
    out = "installer-package",
    cmd = """
set -e
mkdir -p $OUT/usr/bin
mkdir -p $OUT/usr/share/applications
mkdir -p $OUT/usr/share/icons/hicolor/48x48/apps
mkdir -p $OUT/usr/share/buckos

# Check for pre-built installer binary
INSTALLER_BIN="${HOME}/buckos/target/release/buckos-installer"
if [ -f "$INSTALLER_BIN" ]; then
    cp "$INSTALLER_BIN" "$OUT/usr/bin/buckos-installer"
    chmod 755 "$OUT/usr/bin/buckos-installer"
    echo "Copied pre-built installer from $INSTALLER_BIN"
else
    # Try to build the installer
    if [ -d "${HOME}/buckos" ] && [ -f "${HOME}/buckos/Cargo.toml" ]; then
        echo "Building installer from ${HOME}/buckos..."
        cd "${HOME}/buckos"
        cargo build --release --package buckos-installer 2>&1 || {
            echo "Warning: cargo build failed, creating placeholder"
            cat > "$OUT/usr/bin/buckos-installer" << 'PLACEHOLDER_EOF'
#!/bin/bash
echo "BuckOS Installer Placeholder"
echo ""
echo "The installer binary was not built. To build it:"
echo "  cd ~/buckos"
echo "  cargo build --release"
echo ""
echo "Then rebuild the ISO with: POST /iso"
exit 1
PLACEHOLDER_EOF
            chmod 755 "$OUT/usr/bin/buckos-installer"
        }
        if [ -f "target/release/buckos-installer" ]; then
            cp "target/release/buckos-installer" "$OUT/usr/bin/buckos-installer"
            chmod 755 "$OUT/usr/bin/buckos-installer"
            echo "Built and copied installer"
        fi
    else
        echo "Warning: ~/buckos directory not found, creating placeholder"
        cat > "$OUT/usr/bin/buckos-installer" << 'PLACEHOLDER_EOF'
#!/bin/bash
echo "BuckOS Installer Placeholder"
echo ""
echo "The installer source was not found at ~/buckos"
echo "Please clone the buckos repository and build the installer."
exit 1
PLACEHOLDER_EOF
        chmod 755 "$OUT/usr/bin/buckos-installer"
    fi
fi

# Create desktop entry for the installer
cat > "$OUT/usr/share/applications/buckos-installer.desktop" << 'DESKTOP_EOF'
[Desktop Entry]
Type=Application
Name=Install BuckOS
GenericName=System Installer
Comment=Install BuckOS to your computer
Exec=pkexec /usr/bin/buckos-installer
Icon=buckos-installer
Terminal=false
Categories=System;
Keywords=install;installer;setup;
X-KDE-StartupNotify=false
X-GNOME-Autostart-enabled=false
DESKTOP_EOF

# Create a simple icon placeholder (SVG)
cat > "$OUT/usr/share/icons/hicolor/48x48/apps/buckos-installer.svg" << 'ICON_EOF'
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
  <circle cx="24" cy="24" r="22" fill="#1a73e8"/>
  <text x="24" y="32" font-size="24" fill="white" text-anchor="middle" font-family="sans-serif">B</text>
</svg>
ICON_EOF

echo "Installer package created"
ls -la "$OUT/usr/bin/"
""",
    visibility = ["PUBLIC"],
)

# Package the installer for rootfs inclusion
filegroup(
    name = "buckos-installer",
    srcs = [":buckos-installer-build"],
    default_target_platform = "//platforms:linux-target",
    visibility = ["PUBLIC"],
)

# =============================================================================
# BuckOS Build Definitions - Package definitions for the installer
# =============================================================================
# This package bundles the buckos-build definitions (defs/, packages/) for
# inclusion in the live ISO. The installer needs these to build packages
# during installation.

# Bundle the build definitions
genrule(
    name = "buckos-build-defs-gen",
    out = "buckos-build-defs",
    cmd = """
set -e
mkdir -p $OUT/usr/share/buckos-build

# Get the path to the buckos-build repository root
REPO_ROOT="${HOME}/buckos-build"

if [ -d "$REPO_ROOT/defs" ] && [ -d "$REPO_ROOT/packages" ]; then
    echo "Copying buckos-build definitions from $REPO_ROOT..."

    # Copy defs/ directory (build rules)
    cp -a "$REPO_ROOT/defs" "$OUT/usr/share/buckos-build/"

    # Copy packages/ directory (package definitions)
    cp -a "$REPO_ROOT/packages" "$OUT/usr/share/buckos-build/"

    # Copy platforms/ directory
    if [ -d "$REPO_ROOT/platforms" ]; then
        cp -a "$REPO_ROOT/platforms" "$OUT/usr/share/buckos-build/"
    fi

    # Copy config files needed for buck2
    for f in .buckconfig .buckroot; do
        if [ -e "$REPO_ROOT/$f" ]; then
            cp -a "$REPO_ROOT/$f" "$OUT/usr/share/buckos-build/"
        fi
    done

    # Copy prelude if present
    if [ -d "$REPO_ROOT/prelude" ]; then
        cp -a "$REPO_ROOT/prelude" "$OUT/usr/share/buckos-build/"
    fi

    # Create a version file
    echo "version: 0.1.0" > "$OUT/usr/share/buckos-build/VERSION"
    echo "source: buckos-build" >> "$OUT/usr/share/buckos-build/VERSION"

    echo "buckos-build definitions bundled:"
    du -sh "$OUT/usr/share/buckos-build/"* 2>/dev/null || ls -la "$OUT/usr/share/buckos-build/"
else
    echo "Warning: buckos-build repository not found at $REPO_ROOT"
    echo "Creating placeholder..."
    mkdir -p "$OUT/usr/share/buckos-build"
    cat > "$OUT/usr/share/buckos-build/README" << 'EOF'
BuckOS Build Definitions Placeholder

The buckos-build definitions were not found during ISO creation.
This means the installer will not be able to build packages from source.

To fix this, ensure the buckos-build repository is available at ~/buckos-build
and rebuild the ISO.
EOF
fi

echo "Done"
""",
    visibility = ["PUBLIC"],
)

# Package the build definitions for rootfs inclusion
filegroup(
    name = "buckos-build-defs",
    srcs = [":buckos-build-defs-gen"],
    default_target_platform = "//platforms:linux-target",
    visibility = ["PUBLIC"],
)
