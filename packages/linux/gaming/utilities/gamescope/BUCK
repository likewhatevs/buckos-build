# Gamescope - SteamOS session compositing window manager
# Micro-compositor for running games with improved display features

load("//defs:package_defs.bzl", "autotools_package", "download_source", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags")

download_source(
    name = "gamescope-src",
    src_uri = "https://github.com/ValveSoftware/gamescope/archive/refs/tags/3.14.24.tar.gz",
    sha256 = "429ef04aab9b3ca5cac76752f59e2219d8326010c0cd9533ad580f65f5bfd3a3",
    signature_required = False,
)

# USE flags: See use_flags.bzl for available flags

autotools_package(
    name = "gamescope",
    source = ":gamescope-src",
    iuse = [
        "avif",
        "libei",
        "pipewire",
        "sdl",
        "systemd",
        "wsi-layer",
    ],
    use_configure = {
        "-avif": "--disable-avif",
        "-libei": "--disable-libei",
        "-pipewire": "--disable-pipewire",
        "-sdl": "--disable-sdl",
        "-systemd": "--disable-systemd",
        "-wsi-layer": "--disable-wsi-layer",
        "avif": "--enable-avif",
        "libei": "--enable-libei",
        "pipewire": "--enable-pipewire",
        "sdl": "--enable-sdl",
        "systemd": "--enable-systemd",
        "wsi-layer": "--enable-wsi-layer",
    },
    version = "3.14.24",
    description = "SteamOS session compositing window manager",
    homepage = "https://github.com/ValveSoftware/gamescope",
    license = "BSD-2-Clause",
    pre_configure = """
# Initialize and update submodules
git submodule update --init --recursive || true

# Gamescope uses Meson build system
meson setup build \
    --prefix=/usr \
    --libdir=/usr/lib \
    --buildtype=release \
    -Dpipewire=enabled \
    -Denable_openvr_support=false
    """,
    configure_args = [],
    post_install = """
#!/bin/bash
set -e

cd "$SRC_DIR"
meson compile -C build
DESTDIR="$DESTDIR" meson install -C build

# Install CAP_SYS_NICE capability helper
mkdir -p "$DESTDIR/usr/share/doc/gamescope"
cat > "$DESTDIR/usr/share/doc/gamescope/README.capabilities" << 'EOF'
Gamescope can benefit from CAP_SYS_NICE to improve scheduling.

To enable, run:
    sudo setcap 'cap_sys_nice=eip' /usr/bin/gamescope

This allows gamescope to set real-time scheduling for better performance.
EOF
    """,
    deps = [
        "//packages/linux/core/libffi:libffi",
        "//packages/linux/graphics/rendering/wayland:wayland",
        "//packages/linux/system/libs/multimedia/sdl2:sdl2",
    ],
    visibility = ["PUBLIC"],
)
