load("//defs:package.bzl", "package")

# Gamescope - SteamOS session compositing window manager
# Micro-compositor for running games with improved display features

# USE flags: See use_flags.bzl for available flags

package(
    build_rule = "autotools",
    name = "gamescope",
    url = "https://github.com/ValveSoftware/gamescope/archive/refs/tags/3.14.24.tar.gz",

    sha256 = "429ef04aab9b3ca5cac76752f59e2219d8326010c0cd9533ad580f65f5bfd3a3",
    use_configure = {
        "avif": ("--enable-avif", "--disable-avif"),
        "libei": ("--enable-libei", "--disable-libei"),
        "pipewire": ("--enable-pipewire", "--disable-pipewire"),
        "sdl": ("--enable-sdl", "--disable-sdl"),
        "systemd": ("--enable-systemd", "--disable-systemd"),
        "wsi-layer": ("--enable-wsi-layer", "--disable-wsi-layer"),
    },
    version = "3.14.24",
    description = "SteamOS session compositing window manager",
    homepage = "https://github.com/ValveSoftware/gamescope",
    license = "BSD-2-Clause",
    configure_args = [],
    post_install_cmds = ["""
#!/bin/bash
set -e

cd "$SRC_DIR"
meson compile -C build
DESTDIR="$DESTDIR" meson install -C build

# Install CAP_SYS_NICE capability helper
mkdir -p "$DESTDIR/usr/share/doc/gamescope"
cat > "$DESTDIR/usr/share/doc/gamescope/README.capabilities" << 'EOF'
Gamescope can benefit from CAP_SYS_NICE to improve scheduling.

To enable, run:
    sudo setcap 'cap_sys_nice=eip' /usr/bin/gamescope

This allows gamescope to set real-time scheduling for better performance.
EOF
    """],
    deps = [
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/graphics/rendering/wayland:wayland",
        "//packages/linux/system/libs/multimedia/sdl2:sdl2",
    ],
    visibility = ["PUBLIC"],
)
