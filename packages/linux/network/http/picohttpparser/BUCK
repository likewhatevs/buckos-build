load("//defs:package_defs.bzl", "simple_package", "gen_pkgconfig")

simple_package(
    name = "picohttpparser",
    version = "1.0",
    src_uri = "https://github.com/h2o/picohttpparser/archive/refs/heads/master.tar.gz",
    sha256 = "69f6f59dcc0c73138273f56f7348f566c4cdb92daf046ef6b712a2cac89029ce",
    src_configure = """
# picohttpparser doesn't use configure, skip this phase
true
""",
    src_compile = """
# Build static library
$CC $CFLAGS -c picohttpparser.c -o picohttpparser.o
$AR rcs libpicohttpparser.a picohttpparser.o

# Build shared library
$CC $CFLAGS -fPIC -c picohttpparser.c -o picohttpparser_shared.o
$CC -shared -o libpicohttpparser.so.1.0 picohttpparser_shared.o
ln -sf libpicohttpparser.so.1.0 libpicohttpparser.so.1
ln -sf libpicohttpparser.so.1 libpicohttpparser.so
""",
    src_install = """
# Install libraries
mkdir -p "$DESTDIR/usr/lib"
cp libpicohttpparser.a "$DESTDIR/usr/lib/"
cp libpicohttpparser.so* "$DESTDIR/usr/lib/"

# Install headers
mkdir -p "$DESTDIR/usr/include"
cp picohttpparser.h "$DESTDIR/usr/include/"
""" + gen_pkgconfig(
        name = "picohttpparser",
        description = "Tiny, primitive, fast HTTP request/response parser",
        destvar = "DESTDIR",
        libdir = "lib",
    ),
    visibility = ["PUBLIC"],
)
