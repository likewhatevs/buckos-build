load("@root//defs:package_defs.bzl", "cmake_package")

cmake_package(
    name = "uwebsockets",
    version = "20.65.0",
    src_uri = "https://github.com/uNetworking/uWebSockets/archive/v20.65.0.tar.gz",
    sha256 = "e261f7c124b3b9e217fc766d6e51d4fdc4b227aa52c7a0ca5952a9e65cea4213",
    description = "High performance WebSocket and HTTP library",
    homepage = "https://github.com/uNetworking/uWebSockets",
    license = "Apache-2.0",
    deps = [],
    pre_configure = """
cat > CMakeLists.txt << 'EOF'
cmake_minimum_required(VERSION 3.10)
project(uwebsockets VERSION 20.65.0 LANGUAGES CXX)

add_library(uwebsockets INTERFACE)
target_include_directories(uwebsockets INTERFACE
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src>
    $<INSTALL_INTERFACE:include>
)
target_compile_definitions(uwebsockets INTERFACE LIBUS_NO_SSL)

install(DIRECTORY src/ DESTINATION include/uwebsockets FILES_MATCHING PATTERN "*.h")
install(TARGETS uwebsockets EXPORT uwebsocketsTargets)
install(EXPORT uwebsocketsTargets DESTINATION lib/cmake/uwebsockets)
EOF
""",
    cmake_args = [
        "-DCMAKE_BUILD_TYPE=Release",
    ],
    visibility = ["PUBLIC"],
)
