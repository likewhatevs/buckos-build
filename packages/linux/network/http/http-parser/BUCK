load("@root//defs:package_defs.bzl", "simple_package", "gen_pkgconfig")

# http-parser - HTTP request/response parser for C
#
# This is a parser for HTTP messages written in C. It parses both requests
# and responses. The parser is designed to be used in performance HTTP
# applications. It does not make any syscalls nor allocations, it does not
# buffer data, it can be interrupted at anytime. Depending on your architecture,
# it only requires about 40 bytes of data per message stream.
#
# Originally from Node.js, now maintained separately.

simple_package(
    name = "http-parser",
    version = "2.9.4",
    src_uri = "https://github.com/nodejs/http-parser/archive/refs/tags/v2.9.4.tar.gz",
    sha256 = "467b9e30fd0979ee301065e70f637d525c28193449e1b13fbcb1b1fab3ad224f",
    description = "HTTP request/response parser for C",
    homepage = "https://github.com/nodejs/http-parser",
    license = "MIT",
    build_cmd = """
# Build shared and static libraries
make library

# Build the shared library explicitly
make libhttp_parser.so
""",
    install_cmd = """
# Install libraries
mkdir -p "$DESTDIR/usr/lib"
cp libhttp_parser.so* "$DESTDIR/usr/lib/" || true
cp libhttp_parser.a "$DESTDIR/usr/lib/" || true

# Install headers
mkdir -p "$DESTDIR/usr/include"
cp http_parser.h "$DESTDIR/usr/include/"
""" + gen_pkgconfig(
        name = "http-parser",
        description = "HTTP request/response parser for C",
        libs = "-lhttp_parser",
        destvar = "DESTDIR",
        libdir = "lib",
    ),
    visibility = ["PUBLIC"],
)
