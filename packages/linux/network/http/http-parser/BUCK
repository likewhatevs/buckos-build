load("//defs:package.bzl", "package")

# http-parser - HTTP request/response parser for C
#
# This is a parser for HTTP messages written in C. It parses both requests
# and responses. The parser is designed to be used in performance HTTP
# applications. It does not make any syscalls nor allocations, it does not
# buffer data, it can be interrupted at anytime. Depending on your architecture,
# it only requires about 40 bytes of data per message stream.
#
# Originally from Node.js, now maintained separately.

package(
    name = "http-parser",
    build_rule = "binary",
    version = "2.9.4",
    url = "https://github.com/nodejs/http-parser/archive/refs/tags/v2.9.4.tar.gz",
    sha256 = "467b9e30fd0979ee301065e70f637d525c28193449e1b13fbcb1b1fab3ad224f",
    description = "HTTP request/response parser for C",
    homepage = "https://github.com/nodejs/http-parser",
    license = "MIT",
    install_script = """
mkdir -p "$OUT"
BUILD=$(mktemp -d)
cp -a "$SRCS"/. "$BUILD/"
cd "$BUILD"

# Build shared and static libraries
make library
make libhttp_parser.so

# Install libraries
mkdir -p "$OUT/usr/lib"
cp libhttp_parser.so* "$OUT/usr/lib/" || true
cp libhttp_parser.a "$OUT/usr/lib/" || true

# Install headers
mkdir -p "$OUT/usr/include"
cp http_parser.h "$OUT/usr/include/"

# Generate pkg-config file
mkdir -p "$OUT/usr/lib/pkgconfig"
cat > "$OUT/usr/lib/pkgconfig/http-parser.pc" << EOF
prefix=/usr
exec_prefix=\${prefix}
libdir=\${prefix}/lib
includedir=\${prefix}/include

Name: http-parser
Description: HTTP request/response parser for C
Version: $PV
Libs: -lhttp_parser
Cflags: -I\${includedir}
EOF
""",
)
