load("//defs:package.bzl", "package")

package(
    build_rule = "binary",
    name = "dnsmasq",
    version = "2.90",
    url = "https://thekelleys.org.uk/dnsmasq/dnsmasq-2.90.tar.xz",
    sha256 = "8e50309bd837bfec9649a812e066c09b6988b73d749b7d293c06c57d46a109e4",
    description = "Lightweight DNS forwarder and DHCP server",
    homepage = "https://thekelleys.org.uk/dnsmasq/doc.html",
    license = "GPL-2.0-or-later",
    install_script = """
cd "$SRCS"

COPTS="-DHAVE_DNSSEC -DHAVE_LIBIDN2 -DHAVE_IPV6"

make -j${MAKEOPTS:-$(nproc)} PREFIX=/usr SYSCONFDIR=/etc LOCALSTATEDIR=/var COPTS="$COPTS"

make install PREFIX="$OUT/usr" SYSCONFDIR="$OUT/etc" LOCALSTATEDIR="$OUT/var" DESTDIR=""

mkdir -p "$OUT/etc"
mkdir -p "$OUT/usr/share/dnsmasq"
install -Dm644 dnsmasq.conf.example "$OUT/etc/dnsmasq.conf"
if [ -f trust-anchors.conf ]; then
    install -Dm644 trust-anchors.conf "$OUT/usr/share/dnsmasq/trust-anchors.conf"
fi
""",
    deps = [
        "//packages/linux/network/dns/libraries/libidn2:libidn2",
        "//packages/linux/system/libs/crypto/nettle:nettle",
    ],
    visibility = ["PUBLIC"],
)
