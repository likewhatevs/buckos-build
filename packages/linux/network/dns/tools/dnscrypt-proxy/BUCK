load("//defs:package_defs.bzl", "download_source", "binary_package")

download_source(
    name = "dnscrypt-proxy-src",
    src_uri = "https://github.com/DNSCrypt/dnscrypt-proxy/releases/download/2.1.5/dnscrypt-proxy-linux_x86_64-2.1.5.tar.gz",
    sha256 = "eeb5e78e8930cd5ef8e332a4ee2730d02a19bb5097221a56d15ae4b582f4abd2",
    signature_required = False,
)

binary_package(
    name = "dnscrypt-proxy",
    srcs = [":dnscrypt-proxy-src"],
    version = "2.1.5",
    description = "Flexible DNS proxy with encrypted DNS protocols support",
    homepage = "https://dnscrypt.info/",
    license = "ISC",
    install_script = """
cd $SRCS
install -Dm755 dnscrypt-proxy "$OUT/usr/bin/dnscrypt-proxy"

# Install default configuration
mkdir -p "$OUT/etc/dnscrypt-proxy"
if [ -f example-dnscrypt-proxy.toml ]; then
    install -Dm644 example-dnscrypt-proxy.toml "$OUT/etc/dnscrypt-proxy/dnscrypt-proxy.toml"
fi

# Install blocklist and other example files
for f in *.txt *.md; do
    if [ -f "$f" ]; then
        install -Dm644 "$f" "$OUT/usr/share/dnscrypt-proxy/$f"
    fi
done
""",
    deps = [],
    visibility = ["PUBLIC"],
)
