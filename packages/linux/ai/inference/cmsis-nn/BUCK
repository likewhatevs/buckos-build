load("//defs:package.bzl", "package")

# ARM CMSIS-NN - Neural Network library for Cortex-M processors
# Optimized kernels for neural network operations on embedded devices

package(
    build_rule = "binary",
    name = "cmsis-nn",
    version = "5.0.0",
    url = "https://github.com/ARM-software/CMSIS-NN/archive/refs/tags/v5.0.0.tar.gz",
    sha256 = "284ebec8594d5169f43fdd76d776cc42a5ca2561179dcc280bd80c1de5ff27db",
    description = "CMSIS Neural Network Library - optimized NN kernels for Cortex-M",
    homepage = "https://github.com/ARM-software/CMSIS-NN",
    license = "Apache-2.0",
    install_script = """
        # CMSIS-NN requires CMSIS headers for Core and DSP
        # For now, we'll use the bundled headers from the source
        cd "$SRCS"

        # Create a minimal CMSIS structure for headers
        # In production, this should depend on a proper CMSIS-Core package
        mkdir -p cmsis_temp/CMSIS/Core/Include
        mkdir -p cmsis_temp/CMSIS/DSP/Include

        # Build the library
        mkdir -p build && cd build
        cmake .. \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_INSTALL_LIBDIR=lib64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMSIS_PATH="$SRCS/cmsis_temp" \
            -DCONCATENATION=ON \
            -DFULLYCONNECTED=ON \
            -DCONVOLUTION=ON \
            -DACTIVATION=ON \
            -DPOOLING=ON \
            -DSOFTMAX=ON \
            -DBASICMATHSNN=ON \
            -DRESHAPE=ON \
            -DSVDF=ON \
            -DLSTM=ON \
            -DNNSUPPORT=ON

        make -j${MAKEOPTS:-$(nproc)}

        # Install the library
        mkdir -p "$OUT/usr/lib64"
        cp libcmsis-nn.a "$OUT/usr/lib64/"

        # Install headers
        mkdir -p "$OUT/usr/include/cmsis-nn"
        cp -r ../Include/* "$OUT/usr/include/cmsis-nn/"
    """ + gen_pkgconfig(
        name = "cmsis-nn",
        description = "CMSIS Neural Network Library",
        libs = "-lcmsis-nn",
        cflags = "-I${includedir}/cmsis-nn",
    ),
    deps = [],
    visibility = ["PUBLIC"],
)
