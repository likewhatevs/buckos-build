load("//defs:package_defs.bzl", "meson_package")

# wayland-protocols - Wayland protocol extension files
# These are XML protocol definitions that get compiled by wayland-scanner
# into C header files and source code.

meson_package(
    name = "wayland-protocols",
    version = "1.43",
    src_uri = "https://gitlab.freedesktop.org/wayland/wayland-protocols/-/releases/1.43/downloads/wayland-protocols-1.43.tar.xz",
    sha256 = "ba3c3425dd27c57b5291e93dba97be12479601e00bcab24d26471948cb643653",
    description = "Wayland protocol extension definitions",
    homepage = "https://gitlab.freedesktop.org/wayland/wayland-protocols",
    license = "MIT",
    deps = [
        "//packages/linux/graphics/rendering/wayland:wayland",
        "//packages/linux/system/libs/utility/libffi:libffi",
    ],
    # wayland-scanner runs on the build machine during meson configure
    depend = [
        "//packages/linux/graphics/rendering/wayland:wayland-scanner",
    ],
    meson_args = [
        "-Dtests=false",
    ],
    # Set up environment to find native wayland-scanner
    pre_configure = "",
    src_configure = '''
# Find native wayland-scanner from CMAKE_PREFIX_PATH
IFS=";" read -ra PREFIX_DIRS <<< "$CMAKE_PREFIX_PATH"
for prefix in "${PREFIX_DIRS[@]}"; do
    if [ -x "$prefix/bin/wayland-scanner" ]; then
        export WAYLAND_SCANNER="$prefix/bin/wayland-scanner"
        SCANNER_PKG="$prefix/lib64/pkgconfig"
        echo "Found native wayland-scanner: $WAYLAND_SCANNER"
        break
    fi
done
[ -z "${WAYLAND_SCANNER:-}" ] && { echo "ERROR: wayland-scanner not found"; exit 1; }

export PATH="$(dirname "$WAYLAND_SCANNER"):$PATH"
export PKG_CONFIG_PATH_FOR_BUILD="${SCANNER_PKG:-}${PKG_CONFIG_PATH_FOR_BUILD:+:$PKG_CONFIG_PATH_FOR_BUILD}"

# The wayland dep's .pc file has wayland_scanner=${bindir}/wayland-scanner
# which resolves to /usr/bin/wayland-scanner. Meson's find_program() then
# fails. Set PKG_CONFIG_SYSROOT_DIR to the scanner's prefix so the path
# resolves correctly, and create an override .pc with the absolute path.
SCANNER_PREFIX=$(dirname "$(dirname "$WAYLAND_SCANNER")")
OVERRIDE_PC="$T/pkgconfig"
mkdir -p "$OVERRIDE_PC"
cat > "$OVERRIDE_PC/wayland-scanner.pc" << PCEOF
prefix=$SCANNER_PREFIX
bindir=\${prefix}/bin
wayland_scanner=\${bindir}/wayland-scanner
datarootdir=\${prefix}/share
pkgdatadir=\${datarootdir}/wayland

Name: Wayland Scanner
Description: Wayland scanner
Version: 1.23.1
PCEOF
# Override must come first in both target and build pkg-config paths
export PKG_CONFIG_PATH="$OVERRIDE_PC:$PKG_CONFIG_PATH"
export PKG_CONFIG_PATH_FOR_BUILD="$OVERRIDE_PC:${PKG_CONFIG_PATH_FOR_BUILD:-}"

cat > native.ini << NEOF
[binaries]
wayland-scanner = '$WAYLAND_SCANNER'

[built-in options]
pkg_config_path = ['${SCANNER_PKG:-}']
NEOF

# The wayland dep's .pc file uses wayland_scanner=${bindir}/wayland-scanner
# which resolves to /usr/bin/wayland-scanner. meson's find_program() then
# fails with the absolute path. Patch the source meson.build to use our
# scanner directly from the native file instead.
sed -i "s|dep_scanner.get_variable(pkgconfig: 'wayland_scanner', internal: 'wayland_scanner')|'$WAYLAND_SCANNER'|g" meson.build 2>/dev/null || true

cat > native.ini << NEOF
[binaries]
wayland-scanner = '$WAYLAND_SCANNER'
NEOF

rm -rf "${BUILD_DIR:-build}"
meson setup "${BUILD_DIR:-build}" \
    --prefix="${EPREFIX:-/usr}" \
    --libdir="${LIBDIR:-lib64}" \
    --buildtype="${MESON_BUILD_TYPE:-release}" \
    --native-file=native.ini \
    -Dtests=false
''',
    visibility = ["PUBLIC"],
)
