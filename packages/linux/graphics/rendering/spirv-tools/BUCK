load("@root//defs:package_defs.bzl", "cmake_package")

# SPIRV-Tools - API and commands for processing SPIR-V modules
#
# The SPIR-V Tools project provides an API and commands for processing SPIR-V
# modules. The project includes an assembler, binary module parser, disassembler,
# validator, and optimizer for SPIR-V.

cmake_package(
    name = "spirv-tools",
    version = "2024.1",
    src_uri = "https://github.com/KhronosGroup/SPIRV-Tools/archive/refs/tags/v2024.1.tar.gz",
    sha256 = "137780e2a8b5c722888f9ec0fb553e6e92f38a0a5c7fcdad9b715152448b9d82",
    description = "API and commands for processing SPIR-V modules - assembler, parser, disassembler, validator, and optimizer",
    homepage = "https://github.com/KhronosGroup/SPIRV-Tools",
    license = "Apache-2.0",
    deps = [
        # SPIRV-Tools requires SPIRV-Headers
        # TODO: Add spirv-headers package dependency when available
        # "graphics//rendering/spirv-headers:spirv-headers",
    ],
    cmake_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DBUILD_SHARED_LIBS=ON",
        # Disable tests and executables for lighter build
        "-DSPIRV_SKIP_TESTS=ON",
        "-DSPIRV_SKIP_EXECUTABLES=OFF",
        # Enable color terminal output
        "-DSPIRV_COLOR_TERMINAL=ON",
        # Disable werror for compatibility
        "-DSPIRV_WERROR=OFF",
        # Note: SPIRV-Headers will need to be provided externally
        # The package expects to find SPIRV-Headers in external/SPIRV-Headers
        # or via SPIRV-Headers_SOURCE_DIR variable
    ],
    pre_configure = """
        # SPIRV-Tools expects SPIRV-Headers to be available
        # For now, we'll need to handle this dependency manually
        # TODO: Once spirv-headers package is available, this can be removed
        echo "Note: SPIRV-Tools requires SPIRV-Headers dependency"
        echo "      This may need to be configured when building"
    """,
    visibility = ["PUBLIC"],
)
