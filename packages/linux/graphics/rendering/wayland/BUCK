load("//defs:package.bzl", "package")

# wayland - Wayland display protocol libraries and scanner tool
# Following Gentoo's approach: disable dtd_validation to avoid libxml2 runtime dependency

# Native wayland-scanner build for cross-compilation
# This builds wayland-scanner with the host toolchain so it can run during cross builds
package(
    name = "wayland-scanner",
    build_rule = "binary",
    version = "1.23.1",
    url = "https://gitlab.freedesktop.org/wayland/wayland/-/releases/1.23.1/downloads/wayland-1.23.1.tar.xz",
    sha256 = "864fb2a8399e2d0ec39d56e9d9b753c093775beadc6022ce81f441929a81e5ed",
    description = "Native wayland-scanner for cross-compilation",
    homepage = "https://gitlab.freedesktop.org/wayland/wayland",
    license = "MIT",
    deps = [
        "//packages/linux/system/libs/data/expat:expat-host",
    ],
    install_script = """
# Use host compiler for native build
unset CC CXX AR RANLIB LD STRIP
unset CFLAGS CXXFLAGS LDFLAGS CPPFLAGS
export CC=gcc
export CXX=g++

# Find buckos-built expat-host in deps
for dep in $DEPS_DIRS; do
    if [ -f "$dep/usr/lib64/pkgconfig/expat.pc" ]; then
        export PKG_CONFIG_PATH="$dep/usr/lib64/pkgconfig:$dep/usr/share/pkgconfig"
        export CFLAGS="-I$dep/usr/include"
        export LDFLAGS="-L$dep/usr/lib64 -Wl,-rpath,$dep/usr/lib64"
        echo "Found expat-host at: $dep"
        break
    elif [ -f "$dep/usr/lib/pkgconfig/expat.pc" ]; then
        export PKG_CONFIG_PATH="$dep/usr/lib/pkgconfig:$dep/usr/share/pkgconfig"
        export CFLAGS="-I$dep/usr/include"
        export LDFLAGS="-L$dep/usr/lib -Wl,-rpath,$dep/usr/lib"
        echo "Found expat-host at: $dep"
        break
    fi
done

# Ensure host meson/ninja are in PATH
export PATH="/usr/bin:/bin:/usr/sbin:/sbin:$PATH"

mkdir -p build
meson setup build \
    --prefix=/usr \
    --libdir=lib64 \
    --buildtype=release \
    -Ddocumentation=false \
    -Dtests=false \
    -Ddtd_validation=false \
    -Dlibraries=false \
    -Dscanner=true

# List available targets and find the scanner
echo "Available ninja targets:"
ninja -C build -t targets | head -20 || true

# Try to find the wayland-scanner target
SCANNER_TARGET=""
if ninja -C build -t targets | grep -q "^wayland-scanner:"; then
    SCANNER_TARGET="wayland-scanner"
elif ninja -C build -t targets | grep -q "^src/wayland-scanner:"; then
    SCANNER_TARGET="src/wayland-scanner"
else
    # Just build all targets
    SCANNER_TARGET=""
fi

if [ -n "$SCANNER_TARGET" ]; then
    ninja -C build "$SCANNER_TARGET"
else
    # Build everything if we can't find the specific target
    ninja -C build
fi

mkdir -p "$DESTDIR/usr/bin"
cp build/src/wayland-scanner "$DESTDIR/usr/bin/"
chmod +x "$DESTDIR/usr/bin/wayland-scanner"

# Install wayland protocol files needed by Qt and KDE
mkdir -p "$DESTDIR/usr/share/wayland"
cp protocol/wayland.xml "$DESTDIR/usr/share/wayland/"

# Also install pkg-config file for wayland-scanner
mkdir -p "$DESTDIR/usr/lib64/pkgconfig"
cat > "$DESTDIR/usr/lib64/pkgconfig/wayland-scanner.pc" << 'EOF'
prefix=/usr
exec_prefix=${prefix}
bindir=${exec_prefix}/bin
datarootdir=${prefix}/share
pkgdatadir=${datarootdir}/wayland
wayland_scanner=${bindir}/wayland-scanner

Name: Wayland Scanner
Description: Wayland scanner tool
Version: 1.23.1
EOF

# Install CMake config for WaylandScanner so find_package(WaylandScanner) works
mkdir -p "$DESTDIR/usr/lib64/cmake/WaylandScanner"
cat > "$DESTDIR/usr/lib64/cmake/WaylandScanner/WaylandScannerConfig.cmake" << 'EOF'
# WaylandScanner CMake config for cross-compilation
# This is the native (host) scanner tool

# Get the directory where this config file is located
get_filename_component(_WaylandScanner_PREFIX "${CMAKE_CURRENT_LIST_DIR}/../../.." ABSOLUTE)

set(WaylandScanner_FOUND TRUE)
set(WaylandScanner_VERSION "1.23.1")
set(WaylandScanner_EXECUTABLE "${_WaylandScanner_PREFIX}/bin/wayland-scanner" CACHE FILEPATH "Path to wayland-scanner executable")

# For compatibility with different CMake variable names
set(WAYLAND_SCANNER_EXECUTABLE "${WaylandScanner_EXECUTABLE}" CACHE FILEPATH "Path to wayland-scanner executable")

mark_as_advanced(WaylandScanner_EXECUTABLE WAYLAND_SCANNER_EXECUTABLE)
unset(_WaylandScanner_PREFIX)
EOF

cat > "$DESTDIR/usr/lib64/cmake/WaylandScanner/WaylandScannerConfigVersion.cmake" << 'EOF'
set(PACKAGE_VERSION "1.23.1")
if(PACKAGE_VERSION VERSION_LESS PACKAGE_FIND_VERSION)
    set(PACKAGE_VERSION_COMPATIBLE FALSE)
else()
    set(PACKAGE_VERSION_COMPATIBLE TRUE)
    if(PACKAGE_FIND_VERSION STREQUAL PACKAGE_VERSION)
        set(PACKAGE_VERSION_EXACT TRUE)
    endif()
endif()
EOF
""",
    visibility = ["PUBLIC"],
)

package(
    name = "wayland",
    build_rule = "meson",
    version = "1.23.1",
    url = "https://gitlab.freedesktop.org/wayland/wayland/-/releases/1.23.1/downloads/wayland-1.23.1.tar.xz",
    sha256 = "864fb2a8399e2d0ec39d56e9d9b753c093775beadc6022ce81f441929a81e5ed",
    description = "Wayland display protocol libraries and scanner",
    homepage = "https://gitlab.freedesktop.org/wayland/wayland",
    license = "MIT",
    deps = [
        "//packages/linux/system/libs/utility/libffi:libffi",
        "//packages/linux/system/libs/data/expat:expat",
        ":wayland-scanner",
    ],
    pre_configure_cmds = [
        # Fix wayland-util.h for C++ consumers: __STDC_VERSION__ is undefined in C++
        # mode, triggering -Werror=undef in KDE builds (ECM enables -Wundef globally).
        "sed -i 's/#if __STDC_VERSION__ >= 202311L/#if defined(__STDC_VERSION__) \\&\\& __STDC_VERSION__ >= 202311L/g' src/wayland-util.h",
    ],
    meson_args = [
        "-Ddocumentation=false",
        "-Dtests=false",
        # Disable DTD validation - this removes the libxml2 dependency from wayland-scanner
        "-Ddtd_validation=false",
        # Build scanner to install wayland-scanner.pc and protocol files
        # The actual scanner binary will be from native wayland-scanner via meson native file
        "-Dscanner=true",
        "-Dlibraries=true",
    ],
    visibility = ["PUBLIC"],
)
