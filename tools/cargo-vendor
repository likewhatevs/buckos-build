#!/bin/bash
# cargo-vendor - Generate vendor tarballs for Cargo packages
#
# This script downloads a Cargo package's source, runs cargo vendor,
# and creates a vendor tarball for offline builds.
#
# Usage:
#   ./tools/cargo-vendor --src-uri URL --sha256 HASH [--output DIR]
#   ./tools/cargo-vendor --target //path/to:package  # Auto-detect from BUCK file
#
# The output is a vendor.tar.gz in the package's .vendor/ directory

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Parse arguments
SRC_URI=""
SHA256=""
OUTPUT_DIR=""
TARGET=""
KEEP_TEMP=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --src-uri)
            SRC_URI="$2"
            shift 2
            ;;
        --sha256)
            SHA256="$2"
            shift 2
            ;;
        --output)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        --target)
            TARGET="$2"
            shift 2
            ;;
        --keep-temp)
            KEEP_TEMP="true"
            shift
            ;;
        -h|--help)
            echo "Usage: $0 --src-uri URL --sha256 HASH [--output DIR]"
            echo "       $0 --target //path/to:package"
            echo ""
            echo "Options:"
            echo "  --src-uri URL    Source tarball URL"
            echo "  --sha256 HASH    SHA256 checksum of source tarball"
            echo "  --output DIR     Output directory (default: package's .vendor/)"
            echo "  --target TARGET  Buck target to auto-detect src_uri/sha256 from BUCK file"
            echo "  --keep-temp      Keep temporary directory for debugging"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
    esac
done

# If target specified, extract info from BUCK file
if [[ -n "$TARGET" ]]; then
    # Convert target to path
    # //packages/linux/foo/bar:baz -> packages/linux/foo/bar
    PACKAGE_PATH="${TARGET#//}"
    PACKAGE_PATH="${PACKAGE_PATH%:*}"
    BUCK_FILE="$REPO_ROOT/$PACKAGE_PATH/BUCK"

    if [[ ! -f "$BUCK_FILE" ]]; then
        echo "ERROR: BUCK file not found: $BUCK_FILE" >&2
        exit 1
    fi

    # Extract src_uri and sha256 from BUCK file (simple grep, assumes standard format)
    SRC_URI=$(grep -oP 'src_uri\s*=\s*"\K[^"]+' "$BUCK_FILE" | head -1)
    SHA256=$(grep -oP 'sha256\s*=\s*"\K[^"]+' "$BUCK_FILE" | head -1)
    OUTPUT_DIR="$REPO_ROOT/$PACKAGE_PATH/.vendor"

    if [[ -z "$SRC_URI" || -z "$SHA256" ]]; then
        echo "ERROR: Could not extract src_uri/sha256 from $BUCK_FILE" >&2
        exit 1
    fi

    echo "Auto-detected from BUCK file:"
    echo "  src_uri: $SRC_URI"
    echo "  sha256:  $SHA256"
    echo "  output:  $OUTPUT_DIR"
fi

# Validate required arguments
if [[ -z "$SRC_URI" || -z "$SHA256" ]]; then
    echo "ERROR: --src-uri and --sha256 are required (or use --target)" >&2
    exit 1
fi

# Default output directory
if [[ -z "$OUTPUT_DIR" ]]; then
    OUTPUT_DIR="$PWD"
fi

# Create temp directory
TEMP_DIR=$(mktemp -d)
cleanup() {
    if [[ -z "$KEEP_TEMP" ]]; then
        rm -rf "$TEMP_DIR"
    else
        echo "Temp directory kept: $TEMP_DIR"
    fi
}
trap cleanup EXIT

echo "=== Cargo Vendor Tool ==="
echo "Source: $SRC_URI"
echo "Output: $OUTPUT_DIR"
echo ""

# Download source tarball
echo "Downloading source tarball..."
TARBALL="$TEMP_DIR/source.tar.gz"
curl -fsSL --retry 3 -o "$TARBALL" "$SRC_URI"

# Verify checksum
echo "Verifying SHA256..."
ACTUAL_SHA256=$(sha256sum "$TARBALL" | cut -d' ' -f1)
if [[ "$ACTUAL_SHA256" != "$SHA256" ]]; then
    echo "ERROR: SHA256 mismatch!" >&2
    echo "  Expected: $SHA256" >&2
    echo "  Actual:   $ACTUAL_SHA256" >&2
    exit 1
fi
echo "SHA256 verified: $ACTUAL_SHA256"

# Extract source
echo "Extracting source..."
mkdir -p "$TEMP_DIR/src"
tar -xf "$TARBALL" -C "$TEMP_DIR/src" --strip-components=1

# Change to source directory
cd "$TEMP_DIR/src"

# Check for Cargo.toml
if [[ ! -f "Cargo.toml" ]]; then
    echo "ERROR: No Cargo.toml found in source" >&2
    exit 1
fi

# Run cargo vendor
echo "Running cargo vendor..."
mkdir -p .cargo

# Try with --locked first, fall back to without
if cargo vendor --locked vendor > .cargo/config.toml 2>/dev/null; then
    echo "Vendored with --locked"
elif cargo vendor vendor > .cargo/config.toml 2>/dev/null; then
    echo "Vendored without --locked (Cargo.lock may have been updated)"
else
    echo "ERROR: cargo vendor failed" >&2
    echo "This may be due to network issues or missing dependencies" >&2
    exit 1
fi

# Check vendor directory was created
if [[ ! -d "vendor" ]]; then
    echo "ERROR: vendor directory not created" >&2
    exit 1
fi

# Count vendored crates
CRATE_COUNT=$(find vendor -maxdepth 1 -type d | wc -l)
echo "Vendored $((CRATE_COUNT - 1)) crates"

# Create vendor tarball
echo "Creating vendor tarball..."
VENDOR_TARBALL="$TEMP_DIR/vendor.tar.gz"
tar -czf "$VENDOR_TARBALL" vendor .cargo

# Calculate checksum
VENDOR_SHA256=$(sha256sum "$VENDOR_TARBALL" | cut -d' ' -f1)
VENDOR_SIZE=$(du -h "$VENDOR_TARBALL" | cut -f1)

# Copy to output directory
mkdir -p "$OUTPUT_DIR"
cp "$VENDOR_TARBALL" "$OUTPUT_DIR/vendor.tar.gz"

# Update manifest if it exists
MANIFEST="$OUTPUT_DIR/MANIFEST.json"
if command -v jq &> /dev/null; then
    if [[ ! -f "$MANIFEST" ]]; then
        echo '{"version": 1, "sources": []}' > "$MANIFEST"
    fi

    # Add or update vendor tarball entry
    tmp_manifest=$(mktemp)
    jq --arg sha256 "$VENDOR_SHA256" \
       --arg size "$VENDOR_SIZE" \
       --arg crates "$((CRATE_COUNT - 1))" \
       --arg vendored_at "$(date -Iseconds)" \
       '. + {vendor_tarball: {sha256: $sha256, size: $size, crate_count: ($crates | tonumber), vendored_at: $vendored_at}}' \
       "$MANIFEST" > "$tmp_manifest"
    mv "$tmp_manifest" "$MANIFEST"
fi

echo ""
echo "=== Done ==="
echo "Vendor tarball: $OUTPUT_DIR/vendor.tar.gz"
echo "SHA256: $VENDOR_SHA256"
echo "Size: $VENDOR_SIZE"
echo ""
echo "To use in BUCK file, add:"
echo "    vendor_tarball_uri = \"<upload-url>/vendor.tar.gz\","
echo "    vendor_tarball_sha256 = \"$VENDOR_SHA256\","
