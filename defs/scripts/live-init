#!/bin/sh
# BuckOS Live System Init Script
# This script runs from initramfs to set up the live environment
# by mounting the squashfs root filesystem and pivoting to it.

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[LIVE]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Mount essential filesystems
mount_essential() {
    log "Mounting essential filesystems..."
    mount -t proc proc /proc 2>/dev/null || true
    mount -t sysfs sysfs /sys 2>/dev/null || true
    mount -t devtmpfs devtmpfs /dev 2>/dev/null || mount -t tmpfs tmpfs /dev

    # Create essential device nodes if devtmpfs failed
    if [ ! -c /dev/null ]; then
        mknod -m 666 /dev/null c 1 3
        mknod -m 666 /dev/zero c 1 5
        mknod -m 666 /dev/random c 1 8
        mknod -m 666 /dev/urandom c 1 9
        mknod -m 600 /dev/console c 5 1
        mknod -m 666 /dev/tty c 5 0
        mknod -m 660 /dev/ttyS0 c 4 64
    fi

    mkdir -p /dev/pts /run
    mount -t devpts devpts /dev/pts 2>/dev/null || true
    mount -t tmpfs tmpfs /run 2>/dev/null || true
}

# Find the boot device (CD/USB with the live filesystem)
find_boot_device() {
    log "Searching for live boot media..."

    # Try to find the device with our live filesystem
    # Check common locations: CD-ROM, USB drives, IDE (for QEMU), VirtIO, NVMe
    for dev in /dev/sr0 /dev/sr1 /dev/cdrom \
               /dev/hda /dev/hdb /dev/hdc /dev/hdd \
               /dev/sda /dev/sda1 /dev/sdb /dev/sdb1 \
               /dev/nvme0n1 /dev/nvme0n1p1 /dev/vda /dev/vda1; do
        if [ -b "$dev" ]; then
            log "Checking $dev..."
            mkdir -p /mnt/cdrom
            if mount -o ro "$dev" /mnt/cdrom 2>/dev/null; then
                if [ -f /mnt/cdrom/live/filesystem.squashfs ]; then
                    log "Found live filesystem on $dev"
                    BOOT_DEVICE="$dev"
                    return 0
                fi
                umount /mnt/cdrom 2>/dev/null || true
            fi
        fi
    done

    # Also check for findfs command (by label)
    if command -v findfs >/dev/null 2>&1; then
        for label in BUCKOS_LIVE BUCKOS; do
            dev=$(findfs "LABEL=$label" 2>/dev/null) || true
            if [ -n "$dev" ] && [ -b "$dev" ]; then
                log "Found device by label $label: $dev"
                mkdir -p /mnt/cdrom
                if mount -o ro "$dev" /mnt/cdrom 2>/dev/null; then
                    if [ -f /mnt/cdrom/live/filesystem.squashfs ]; then
                        log "Found live filesystem on $dev (label: $label)"
                        BOOT_DEVICE="$dev"
                        return 0
                    fi
                    umount /mnt/cdrom 2>/dev/null || true
                fi
            fi
        done
    fi

    return 1
}

# Mount the live squashfs filesystem
mount_live_rootfs() {
    log "Setting up live root filesystem..."

    # Create mount points
    mkdir -p /mnt/live /mnt/root /mnt/overlay/upper /mnt/overlay/work

    # Mount the squashfs
    if ! mount -t squashfs -o ro /mnt/cdrom/live/filesystem.squashfs /mnt/live; then
        error "Failed to mount squashfs filesystem"
        return 1
    fi
    log "Mounted squashfs filesystem"

    # Create an overlay filesystem for writability
    # Lower = squashfs (read-only), Upper = tmpfs (read-write)
    mount -t tmpfs tmpfs /mnt/overlay

    mkdir -p /mnt/overlay/upper /mnt/overlay/work

    if mount -t overlay overlay -o \
        lowerdir=/mnt/live,upperdir=/mnt/overlay/upper,workdir=/mnt/overlay/work \
        /mnt/root; then
        log "Created overlay filesystem for live session"
    else
        warn "Overlay not supported, falling back to read-only mode"
        mount --bind /mnt/live /mnt/root
    fi

    return 0
}

# Set up the live environment
setup_live_environment() {
    log "Configuring live environment..."

    # Mount essential filesystems in the new root
    mkdir -p /mnt/root/proc /mnt/root/sys /mnt/root/dev /mnt/root/run
    mount --move /proc /mnt/root/proc 2>/dev/null || mount -t proc proc /mnt/root/proc
    mount --move /sys /mnt/root/sys 2>/dev/null || mount -t sysfs sysfs /mnt/root/sys
    mount --move /dev /mnt/root/dev 2>/dev/null || mount -t devtmpfs devtmpfs /mnt/root/dev
    mount --move /run /mnt/root/run 2>/dev/null || mount -t tmpfs tmpfs /mnt/root/run

    # Create home directory for live user
    mkdir -p /mnt/root/home/live
    chmod 755 /mnt/root/home/live

    # Create live user if passwd is writable (overlay mode)
    if [ -w /mnt/root/etc/passwd ]; then
        # Check if live user already exists
        if ! grep -q "^live:" /mnt/root/etc/passwd; then
            echo "live:x:1000:1000:Live User:/home/live:/bin/bash" >> /mnt/root/etc/passwd
            echo "live:x:1000:" >> /mnt/root/etc/group
            echo "live:*:19000:0:99999:7:::" >> /mnt/root/etc/shadow 2>/dev/null || true
            chown 1000:1000 /mnt/root/home/live
        fi
    fi

    # Set hostname
    if [ -w /mnt/root/etc/hostname ]; then
        echo "buckos-live" > /mnt/root/etc/hostname
    fi

    # Configure autologin if we have a display manager config
    if [ -d /mnt/root/etc/sddm.conf.d ] && [ -w /mnt/root/etc/sddm.conf.d ]; then
        cat > /mnt/root/etc/sddm.conf.d/autologin.conf << 'EOF'
[Autologin]
User=live
Session=plasma.desktop
EOF
    fi

    # Create desktop entry for installer
    mkdir -p /mnt/root/home/live/Desktop
    if [ -f /mnt/root/usr/bin/buckos-installer ]; then
        cat > /mnt/root/home/live/Desktop/Install-BuckOS.desktop << 'EOF'
[Desktop Entry]
Type=Application
Name=Install BuckOS
Comment=Install BuckOS to your computer
Exec=pkexec /usr/bin/buckos-installer
Icon=system-software-install
Terminal=false
Categories=System;
EOF
        chmod 755 /mnt/root/home/live/Desktop/Install-BuckOS.desktop
        chown 1000:1000 /mnt/root/home/live/Desktop/Install-BuckOS.desktop 2>/dev/null || true
    fi

    # Configure network (DHCP by default)
    if [ -w /mnt/root/etc ]; then
        mkdir -p /mnt/root/etc/NetworkManager/conf.d
        cat > /mnt/root/etc/NetworkManager/conf.d/live.conf << 'EOF'
[main]
plugins=ifupdown,keyfile
dns=default

[ifupdown]
managed=true
EOF
    fi

    log "Live environment configured"
}

# Switch to the new root filesystem
switch_root() {
    log "Switching to live root filesystem..."

    # Clean up
    cd /mnt/root

    # Find init in new root
    INIT="/sbin/init"
    if [ ! -x "/mnt/root$INIT" ]; then
        if [ -x "/mnt/root/lib/systemd/systemd" ]; then
            INIT="/lib/systemd/systemd"
        elif [ -x "/mnt/root/usr/lib/systemd/systemd" ]; then
            INIT="/usr/lib/systemd/systemd"
        elif [ -x "/mnt/root/bin/init" ]; then
            INIT="/bin/init"
        fi
    fi

    log "Using init: $INIT"

    # Pivot root or switch_root
    if command -v switch_root >/dev/null 2>&1; then
        exec switch_root /mnt/root "$INIT"
    else
        # Fallback: use pivot_root
        mkdir -p /mnt/root/mnt/initramfs
        cd /mnt/root
        pivot_root . mnt/initramfs
        exec chroot . "$INIT" <dev/console >dev/console 2>&1
    fi
}

# Emergency shell
emergency_shell() {
    error "Boot failed! Dropping to emergency shell..."
    error "You can try to manually mount the live filesystem."
    echo ""
    echo "Available block devices:"
    ls -la /dev/sd* /dev/sr* /dev/nvme* /dev/vd* 2>/dev/null || true
    echo ""
    echo "Try: mount /dev/<device> /mnt/cdrom"
    echo "     mount -t squashfs /mnt/cdrom/live/filesystem.squashfs /mnt/live"
    echo ""
    exec /bin/sh
}

# Main
main() {
    echo ""
    echo -e "${BLUE}╔════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║                    BuckOS Live System Boot                     ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    mount_essential

    if ! find_boot_device; then
        error "Could not find live boot media!"
        emergency_shell
    fi

    if ! mount_live_rootfs; then
        error "Could not mount live filesystem!"
        emergency_shell
    fi

    setup_live_environment

    switch_root

    # Should not reach here
    emergency_shell
}

# Parse kernel command line for options
parse_cmdline() {
    for arg in $(cat /proc/cmdline); do
        case "$arg" in
            live)
                # Live boot mode (default)
                ;;
            toram)
                # Copy squashfs to RAM (faster but uses more memory)
                TORAM=1
                ;;
            debug)
                # Enable debug output
                set -x
                ;;
        esac
    done
}

# Run main
parse_cmdline
main
