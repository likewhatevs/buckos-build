"""
Execution platform definitions and bootstrap mode constraints for BuckOS.

The :platforms target aggregates available execution platforms and is
registered in .buckconfig:

    [build]
    execution_platforms = //tc/exec:platforms

When buckos is a subcell in a monorepo, the monorepo root registers
buckos execution platforms alongside its own:

    [build]
    execution_platforms = //exec:platforms, buckos//tc/exec:platforms
"""

load("//tc:defs.bzl", "buckos_execution_platforms")

# ── Bootstrap mode constraints ───────────────────────────────────────
#
# The bootstrap transition flips bootstrap-mode-setting to
# bootstrap-mode-true so TOOLCHAIN_ATTRS select() resolves to the host
# PATH toolchain instead of the seed.  This breaks the circular
# dependency: seed needs host tools → host tools need a toolchain →
# but not the seed toolchain.

constraint_setting(
    name = "bootstrap-mode-setting",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "bootstrap-mode-true",
    constraint_setting = ":bootstrap-mode-setting",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "bootstrap-mode-false",
    constraint_setting = ":bootstrap-mode-setting",
    visibility = ["PUBLIC"],
)

config_setting(
    name = "is-bootstrap-mode",
    constraint_values = [":bootstrap-mode-true"],
    visibility = ["PUBLIC"],
)

# ── Bootstrap transition target ─────────────────────────────────────
#
# Used via attrs.transition_dep(cfg = "//tc/exec:bootstrap-transition")
# to apply the bootstrap mode to deps that need to build with the host
# PATH toolchain instead of the seed.

load("//tc:transitions.bzl", "bootstrap_transition")

bootstrap_transition(
    name = "bootstrap-transition",
    visibility = ["PUBLIC"],
)

# ── Platform registry ────────────────────────────────────────────────

buckos_execution_platforms(
    name = "platforms",
    remote_cache_enabled = read_config("buckos", "remote_cache", "") == "true",
    remote_execution_enabled = read_config("buckos", "remote_execution", "") == "true",
    visibility = ["PUBLIC"],
)
