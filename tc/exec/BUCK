"""
Execution platform definitions and bootstrap mode constraints for BuckOS.

The :platforms target aggregates available execution platforms and is
registered in .buckconfig:

    [build]
    execution_platforms = //tc/exec:platforms

When buckos is a subcell in a monorepo, the monorepo root registers
buckos execution platforms alongside its own:

    [build]
    execution_platforms = //exec:platforms, buckos//tc/exec:platforms
"""

load("//tc:defs.bzl", "buckos_execution_platforms")

# ── Toolchain mode constraints ──────────────────────────────────────
#
# TOOLCHAIN_ATTRS select() uses these to choose between toolchains:
#   is-bootstrap-mode → host PATH toolchain (escape hatch)
#   is-stage3-mode    → stage 2 toolchain (hermetic rebuild)
#   DEFAULT           → seed toolchain (toolchains//:buckos)
#
# The stage3 transition is the active one: applied by toolchain_export
# to the host_tools dep so stage 3 tools are built hermetically.

constraint_setting(
    name = "bootstrap-mode-setting",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "bootstrap-mode-true",
    constraint_setting = ":bootstrap-mode-setting",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "bootstrap-mode-false",
    constraint_setting = ":bootstrap-mode-setting",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "stage3-mode-true",
    constraint_setting = ":bootstrap-mode-setting",
    visibility = ["PUBLIC"],
)

config_setting(
    name = "is-bootstrap-mode",
    constraint_values = [":bootstrap-mode-true"],
    visibility = ["PUBLIC"],
)

config_setting(
    name = "is-stage3-mode",
    constraint_values = [":stage3-mode-true"],
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "host-target-mode",
    constraint_setting = ":bootstrap-mode-setting",
    visibility = ["PUBLIC"],
)

config_setting(
    name = "is-host-target",
    constraint_values = [":host-target-mode"],
    visibility = ["PUBLIC"],
)

# ── Transition targets ─────────────────────────────────────────────

load("//tc:transitions.bzl", "default_transition", "stage3_transition")

default_transition(
    name = "default-transition",
    visibility = ["PUBLIC"],
)

stage3_transition(
    name = "stage3-transition",
    visibility = ["PUBLIC"],
)

# ── Platform registry ────────────────────────────────────────────────

buckos_execution_platforms(
    name = "platforms",
    remote_cache_enabled = read_config("buckos", "remote_cache", "") == "true",
    remote_execution_enabled = read_config("buckos", "remote_execution", "") == "true",
    visibility = ["PUBLIC"],
)
