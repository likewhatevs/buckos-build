# Test fixtures for USE flag resolution via .buckconfig
#
# Covers all build system macros and their USE flag plumbing:
#   autotools  → configure_args    (use_configure)
#   cmake      → cmake_args        (use_configure)
#   meson      → meson_args        (use_configure)
#   cargo      → features          (use_features)
#   go         → configure_args    (use_configure)
#
# Resolution order:
#   1. use_defaults
#   2. [use] section
#   3. [use.PKGNAME] section
#
# These fixtures use a local dummy source (export_file) so that
# graph-level analysis and buck2 test work without network access.

load("//defs:package.bzl", "package")
load("//defs/rules:source.bzl", "extract_source")

# Local dummy source archive shared by all fixtures
export_file(
    name = "dummy-archive",
    src = "dummy-src.tar.gz",
    visibility = ["//tests/..."],
)

extract_source(
    name = "dummy-src",
    source = ":dummy-archive",
    visibility = ["//tests/..."],
)

# --- autotools: use_configure → configure_args ---
package(
    name = "test-use-flags",
    build_rule = "autotools",
    version = "1.0.0",
    local_only = True,
    source = ":dummy-src",
    use_configure = {
        "ssl": ("--with-ssl", "--without-ssl"),
        "zstd": ("--with-zstd", "--without-zstd"),
        "debug": ("--enable-debug", "--disable-debug"),
    },
    use_deps = {
        "ssl": "//packages/linux/system/libs/crypto/openssl:openssl",
        "zstd": "//packages/linux/system/libs/compression/zstd:zstd",
    },
    description = "Test fixture for autotools USE flag resolution",
    visibility = ["PUBLIC"],
)

# --- cmake: use_configure → cmake_args ---
package(
    name = "test-cmake-use",
    build_rule = "cmake",
    version = "1.0.0",
    local_only = True,
    source = ":dummy-src",
    use_configure = {
        "ssl": ("-DWITH_SSL=ON", "-DWITH_SSL=OFF"),
        "zstd": ("-DWITH_ZSTD=ON", "-DWITH_ZSTD=OFF"),
        "debug": ("-DENABLE_DEBUG=ON", "-DENABLE_DEBUG=OFF"),
    },
    use_deps = {
        "ssl": "//packages/linux/system/libs/crypto/openssl:openssl",
    },
    description = "Test fixture for cmake USE flag resolution",
    visibility = ["PUBLIC"],
)

# --- meson: use_configure → meson_args ---
package(
    name = "test-meson-use",
    build_rule = "meson",
    version = "1.0.0",
    local_only = True,
    source = ":dummy-src",
    use_configure = {
        "ssl": ("-Dssl=enabled", "-Dssl=disabled"),
        "zstd": ("-Dzstd=enabled", "-Dzstd=disabled"),
        "debug": ("-Ddebug=true", "-Ddebug=false"),
    },
    use_deps = {
        "ssl": "//packages/linux/system/libs/crypto/openssl:openssl",
    },
    description = "Test fixture for meson USE flag resolution",
    visibility = ["PUBLIC"],
)

# --- cargo: use_features ---
package(
    name = "test-cargo-use",
    build_rule = "cargo",
    version = "1.0.0",
    local_only = True,
    source = ":dummy-src",
    use_features = {
        "ssl": "openssl-tls",
        "zstd": "zstd-compression",
        "debug": "debug-mode",
    },
    use_deps = {
        "ssl": "//packages/linux/system/libs/crypto/openssl:openssl",
    },
    description = "Test fixture for cargo USE flag resolution",
    visibility = ["PUBLIC"],
)

# --- go: use_configure ---
package(
    name = "test-go-use",
    build_rule = "go",
    version = "1.0.0",
    local_only = True,
    source = ":dummy-src",
    use_configure = {
        "ssl": "-tags=with_ssl",
        "zstd": "-tags=with_zstd",
        "debug": "-tags=debug",
    },
    use_deps = {
        "ssl": "//packages/linux/system/libs/crypto/openssl:openssl",
    },
    description = "Test fixture for go USE flag resolution",
    visibility = ["PUBLIC"],
)
