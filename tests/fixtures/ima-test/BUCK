load("//defs/rules:kernel.bzl", "kernel_build")
load("//tests/fixtures:test_package.bzl", "test_c_binary")

# ── Static test binary: prints "IMA-TEST-PASS" and exits 0 ──────────

test_c_binary(
    name = "ima-test-binary",
    src = "ima-test.c",
    pkg_name = "ima-test",
    binary_name = "ima-test",
    cflags = ["-static"],
    visibility = ["PUBLIC"],
)

# ── Static PID-1 init for QEMU ──────────────────────────────────────

test_c_binary(
    name = "ima-init",
    src = "init.c",
    pkg_name = "ima-init",
    binary_name = "init",
    cflags = ["-static"],
    visibility = ["PUBLIC"],
)

# ── IMA kernel (tinyconfig + IMA + test cert) ───────────────────────

kernel_build(
    name = "ima-kernel",
    source = "//packages/linux/kernel/src:linux-lts-src",
    version = "6.12.60",
    config = "ima-test-kernel.config",
    config_base = "tinyconfig",
    inject_files = {
        "certs/signing_key.pem": "//defs/keys:ima-test-cert",
    },
    visibility = ["PUBLIC"],
)

# ── ext4 disk image with IMA-signed binary ──────────────────────────

genrule(
    name = "ima-disk-signed",
    out = "disk-signed.img",
    cmd = """
        set -e
        BINARY=$(location :ima-test-binary)/usr/bin/ima-test
        KEY=$(location //defs/keys:ima-test-key)
        WORK=$BUCK_SCRATCH_PATH/work
        mkdir -p "$WORK/empty"

        # $OUT is relative — ensure parent dir exists
        mkdir -p `dirname $OUT`

        mke2fs -t ext4 -d "$WORK/empty" "$OUT" 8M 2>/dev/null

        cp "$BINARY" "$WORK/ima-test"
        evmctl ima_sign --sigfile --key "$KEY" "$WORK/ima-test" 2>/dev/null || true

        printf 'write %s /ima-test\\nset_inode_field /ima-test mode 0100755\\nea_set /ima-test security.ima -f %s\\n' \
            "$WORK/ima-test" "$WORK/ima-test.sig" > "$WORK/debugfs.cmds"
        debugfs -w -f "$WORK/debugfs.cmds" "$OUT" 2>/dev/null
    """,
    visibility = ["PUBLIC"],
)

# ── ext4 disk image with unsigned binary ─────────────────────────────

genrule(
    name = "ima-disk-unsigned",
    out = "disk-unsigned.img",
    cmd = """
        set -e
        BINARY=$(location :ima-test-binary)/usr/bin/ima-test
        WORK=$BUCK_SCRATCH_PATH/work
        mkdir -p "$WORK/empty"
        mkdir -p `dirname $OUT`

        mke2fs -t ext4 -d "$WORK/empty" "$OUT" 8M 2>/dev/null

        printf 'write %s /ima-test\\nset_inode_field /ima-test mode 0100755\\n' \
            "$BINARY" > "$WORK/debugfs.cmds"
        debugfs -w -f "$WORK/debugfs.cmds" "$OUT" 2>/dev/null
    """,
    visibility = ["PUBLIC"],
)

# ── Initramfs with custom init + IMA cert ────────────────────────────

genrule(
    name = "ima-initramfs",
    out = "initramfs.cpio.gz",
    cmd = """
        set -e
        INIT=$(location :ima-init)/usr/bin/init
        CERT=$(location //defs/keys:ima-test-cert)
        WORK=$BUCK_SCRATCH_PATH/rootfs
        mkdir -p "$WORK"/{dev,etc/keys,mnt,proc,sys}
        mkdir -p `dirname $OUT`

        cp "$INIT" "$WORK/init"
        chmod 755 "$WORK/init"

        openssl x509 -in "$CERT" -outform DER -out "$WORK/etc/keys/x509_ima.der"

        # Build cpio.gz — use absolute path for output since we cd
        ABS_OUT=`pwd`/$OUT
        cd "$WORK"
        find . -print0 | cpio --null -o -H newc --quiet | gzip > "$ABS_OUT"
    """,
    visibility = ["PUBLIC"],
)
