load("//defs/rules:runtime_env.bzl", "runtime_env")

# Test targets — run with: buck2 test //tests:

# ── Provenance stamp unit tests ──────────────────────────────────────
# Tests defs/scripts/provenance-stamp.sh directly with controlled env.
# No buck build deps — pure unit test.

sh_test(
    name = "test-provenance-stamp",
    test = "test_provenance_stamp.py",
    labels = ["unit"],
)

# ── Python helper unit tests ─────────────────────────────────────────
# Pure unit tests of tools/*.py logic — no buck build deps.
# Run with: buck2 test //tests: --labels tools-unit

sh_test(
    name = "test-env-unit",
    test = "test_env_unit.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-path-resolution",
    test = "test_path_resolution.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-extract-unit",
    test = "test_extract_unit.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-rootfs-unit",
    test = "test_rootfs_unit.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-small-helpers",
    test = "test_small_helpers.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-merge-and-hash",
    test = "test_merge_and_hash.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-kernel-helpers",
    test = "test_kernel_helpers.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-iso-config",
    test = "test_iso_config.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-build-install",
    test = "test_build_install.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-stage3-strip",
    test = "test_stage3_strip.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-bootstrap-helpers",
    test = "test_bootstrap_helpers.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-lang-helpers",
    test = "test_lang_helpers.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-patch-acct",
    test = "test_patch_acct.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-sysroot-merge",
    test = "test_sysroot_merge.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-toolchain-unpack",
    test = "test_toolchain_unpack.py",
    labels = ["unit", "tools-unit"],
)

sh_test(
    name = "test-vm-helpers",
    test = "test_vm_helpers.py",
    labels = ["unit", "tools-unit"],
)

# ── Provenance integration: hello executable ─────────────────────────

sh_test(
    name = "test-hello-provenance",
    test = "verify_provenance.py",
    deps = ["//tests/fixtures/hello:hello"],
    env = {
        "OUTPUT_DIR": "$(location //tests/fixtures/hello:hello)",
        "EXPECT_PROVENANCE": "true",
        "EXPECT_NAME": "hello",
        "EXPECT_VERSION": "0.1.0",
    },
    labels = ["integration"],
)

sh_test(
    name = "test-hello-no-provenance",
    test = "verify_provenance.py",
    deps = ["//tests/fixtures/hello:hello-no-stamp"],
    env = {
        "OUTPUT_DIR": "$(location //tests/fixtures/hello:hello-no-stamp)",
        "EXPECT_PROVENANCE": "false",
    },
    labels = ["integration"],
)

# ── Provenance integration: shared library ───────────────────────────

sh_test(
    name = "test-testlib-provenance",
    test = "verify_provenance.py",
    deps = ["//tests/fixtures/testlib:testlib"],
    env = {
        "OUTPUT_DIR": "$(location //tests/fixtures/testlib:testlib)",
        "EXPECT_PROVENANCE": "true",
        "EXPECT_NAME": "testlib",
        "EXPECT_VERSION": "0.1.0",
        "EXPECT_LIB": "true",
    },
    labels = ["integration"],
)

# ── IMA signing ──────────────────────────────────────────────────────

sh_test(
    name = "test-hello-ima",
    test = "verify_provenance.py",
    deps = ["//tests/fixtures/hello:hello-ima"],
    env = {
        "OUTPUT_DIR": "$(location //tests/fixtures/hello:hello-ima)",
        "EXPECT_PROVENANCE": "true",
        "EXPECT_NAME": "hello",
        "EXPECT_VERSION": "0.1.0",
        "EXPECT_IMA": "true",
    },
    labels = ["integration"],
)

# ── IMA QEMU enforcement ────────────────────────────────────────────

sh_test(
    name = "test-ima-enforce-signed",
    test = "verify_ima_qemu.py",
    deps = [
        "//tests/fixtures/ima-test:ima-kernel",
        "//tests/fixtures/ima-test:ima-initramfs",
        "//tests/fixtures/ima-test:ima-disk-signed",
        "//packages/linux/emulation/hypervisors/qemu:qemu",
        ":qemu-env",
    ],
    env = {
        "KERNEL": "$(location //tests/fixtures/ima-test:ima-kernel)",
        "INITRAMFS": "$(location //tests/fixtures/ima-test:ima-initramfs)",
        "DISK": "$(location //tests/fixtures/ima-test:ima-disk-signed)",
        "CMDLINE_EXTRA": "ima_appraise=enforce ima_test_mode=enforce_signed",
        "EXPECT_MARKER": "IMA-RESULT:PASS",
        "EXPECT_TEST_OUTPUT": "IMA-FILE-CONTENT",
        "QEMU_DIR": "$(location //packages/linux/emulation/hypervisors/qemu:qemu)",
        "RUN_ENV": "$(location :qemu-env)",
    },
    run_test_separately = True,
    labels = ["vm", "slow"],
)

sh_test(
    name = "test-ima-enforce-unsigned",
    test = "verify_ima_qemu.py",
    deps = [
        "//tests/fixtures/ima-test:ima-kernel",
        "//tests/fixtures/ima-test:ima-initramfs",
        "//tests/fixtures/ima-test:ima-disk-unsigned",
        "//packages/linux/emulation/hypervisors/qemu:qemu",
        ":qemu-env",
    ],
    env = {
        "KERNEL": "$(location //tests/fixtures/ima-test:ima-kernel)",
        "INITRAMFS": "$(location //tests/fixtures/ima-test:ima-initramfs)",
        "DISK": "$(location //tests/fixtures/ima-test:ima-disk-unsigned)",
        "CMDLINE_EXTRA": "ima_appraise=enforce ima_test_mode=enforce_unsigned",
        "EXPECT_MARKER": "IMA-RESULT:PASS",
        "EXPECT_NO_TEST_OUTPUT": "IMA-TEST-PASS",
        "QEMU_DIR": "$(location //packages/linux/emulation/hypervisors/qemu:qemu)",
        "RUN_ENV": "$(location :qemu-env)",
    },
    run_test_separately = True,
    labels = ["vm", "slow"],
)

sh_test(
    name = "test-ima-noima",
    test = "verify_ima_qemu.py",
    deps = [
        "//tests/fixtures/ima-test:ima-kernel",
        "//tests/fixtures/ima-test:ima-initramfs",
        "//tests/fixtures/ima-test:ima-disk-unsigned",
        "//packages/linux/emulation/hypervisors/qemu:qemu",
        ":qemu-env",
    ],
    env = {
        "KERNEL": "$(location //tests/fixtures/ima-test:ima-kernel)",
        "INITRAMFS": "$(location //tests/fixtures/ima-test:ima-initramfs)",
        "DISK": "$(location //tests/fixtures/ima-test:ima-disk-unsigned)",
        "CMDLINE_EXTRA": "ima_appraise=off ima_test_mode=noima",
        "EXPECT_MARKER": "IMA-RESULT:PASS",
        "EXPECT_TEST_OUTPUT": "IMA-FILE-CONTENT",
        "QEMU_DIR": "$(location //packages/linux/emulation/hypervisors/qemu:qemu)",
        "RUN_ENV": "$(location :qemu-env)",
    },
    run_test_separately = True,
    labels = ["vm", "slow"],
)

# ── IMA QEMU FILE_CHECK enforcement ─────────────────────────────────

# FILE_CHECK: signed binary + signed data file — both pass
sh_test(
    name = "test-ima-file-signed",
    test = "verify_ima_qemu.py",
    deps = [
        "//tests/fixtures/ima-test:ima-kernel",
        "//tests/fixtures/ima-test:ima-initramfs",
        "//tests/fixtures/ima-test:ima-disk-signed",
        "//packages/linux/emulation/hypervisors/qemu:qemu",
        ":qemu-env",
    ],
    env = {
        "KERNEL": "$(location //tests/fixtures/ima-test:ima-kernel)",
        "INITRAMFS": "$(location //tests/fixtures/ima-test:ima-initramfs)",
        "DISK": "$(location //tests/fixtures/ima-test:ima-disk-signed)",
        "CMDLINE_EXTRA": "ima_appraise=enforce ima_test_mode=file_signed",
        "EXPECT_MARKER": "IMA-RESULT:PASS",
        "EXPECT_TEST_OUTPUT": "IMA-FILE-CONTENT",
        "QEMU_DIR": "$(location //packages/linux/emulation/hypervisors/qemu:qemu)",
        "RUN_ENV": "$(location :qemu-env)",
    },
    run_test_separately = True,
    labels = ["vm", "slow"],
)

# FILE_CHECK: signed binary + unsigned data file — file read denied
sh_test(
    name = "test-ima-file-unsigned",
    test = "verify_ima_qemu.py",
    deps = [
        "//tests/fixtures/ima-test:ima-kernel",
        "//tests/fixtures/ima-test:ima-initramfs",
        "//tests/fixtures/ima-test:ima-disk-file-unsigned",
        "//packages/linux/emulation/hypervisors/qemu:qemu",
        ":qemu-env",
    ],
    env = {
        "KERNEL": "$(location //tests/fixtures/ima-test:ima-kernel)",
        "INITRAMFS": "$(location //tests/fixtures/ima-test:ima-initramfs)",
        "DISK": "$(location //tests/fixtures/ima-test:ima-disk-file-unsigned)",
        "CMDLINE_EXTRA": "ima_appraise=enforce ima_test_mode=file_unsigned",
        "EXPECT_MARKER": "IMA-RESULT:PASS",
        "EXPECT_TEST_OUTPUT": "IMA-FILE-DENIED",
        "EXPECT_NO_TEST_OUTPUT": "IMA-FILE-CONTENT",
        "QEMU_DIR": "$(location //packages/linux/emulation/hypervisors/qemu:qemu)",
        "RUN_ENV": "$(location :qemu-env)",
    },
    run_test_separately = True,
    labels = ["vm", "slow"],
)

# ── Build smoke tests ────────────────────────────────────────────────

sh_test(
    name = "build-smoke-zlib",
    test = "verify_build_smoke.py",
    deps = ["//packages/linux/core/zlib:zlib"],
    env = {
        "OUTPUT_DIR": "$(location //packages/linux/core/zlib:zlib)",
        "EXPECT_FILES": "usr/lib64/libz.so:usr/include/zlib.h",
    },
    labels = ["build"],
)

sh_test(
    name = "build-smoke-ch",
    test = "verify_build_smoke.py",
    deps = ["//packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor"],
    env = {
        "OUTPUT_DIR": "$(location //packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor)",
    },
    labels = ["build", "slow"],
)

# ── Cloud Hypervisor: boot script verification ───────────────────────

sh_test(
    name = "test-ch-boot-script",
    test = "verify_ch_boot_script.py",
    deps = ["//packages/linux/boot/cloud-hypervisor-boot:ch-boot-direct-minimal"],
    env = {
        "SCRIPT_DIR": "$(location //packages/linux/boot/cloud-hypervisor-boot:ch-boot-direct-minimal)",
    },
    labels = ["build", "slow"],
)

# ── Cloud Hypervisor: VM boot integration ────────────────────────────

sh_test(
    name = "test-ch-vm-boot",
    test = "verify_ch_vm_boot.py",
    deps = [
        "//packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor",
        "//packages/linux/kernel/buckos-kernel:buckos-kernel-ch",
        "//packages/linux/system/cloud-hypervisor:ch-initramfs",
    ],
    env = {
        "CH_BINARY": "$(location //packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor)",
        "KERNEL": "$(location //packages/linux/kernel/buckos-kernel:buckos-kernel-ch)",
        "INITRAMFS": "$(location //packages/linux/system/cloud-hypervisor:ch-initramfs)",
    },
    run_test_separately = True,
    labels = ["vm", "slow", "integration"],
)

# ── Cloud Hypervisor: IMA binary execution ───────────────────────────
# Reuses the IMA test fixtures (init, cert, disk images) with CH kernel.
# The CH kernel config includes security.config which has CONFIG_IMA=y.

# Non-IMA: unsigned binary runs when IMA is off
sh_test(
    name = "test-ch-ima-noima",
    test = "verify_ch_ima.py",
    deps = [
        "//packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor",
        "//tests/fixtures/ima-test:ima-kernel",
        "//tests/fixtures/ima-test:ima-initramfs",
        "//tests/fixtures/ima-test:ima-disk-unsigned",
    ],
    env = {
        "CH_BINARY": "$(location //packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor)",
        "KERNEL": "$(location //tests/fixtures/ima-test:ima-kernel)",
        "INITRAMFS": "$(location //tests/fixtures/ima-test:ima-initramfs)",
        "DISK": "$(location //tests/fixtures/ima-test:ima-disk-unsigned)",
        "CMDLINE_EXTRA": "ima_appraise=off ima_test_mode=noima",
        "EXPECT_MARKER": "IMA-RESULT:PASS",
        "EXPECT_TEST_OUTPUT": "IMA-FILE-CONTENT",
    },
    run_test_separately = True,
    labels = ["vm", "slow", "integration"],
)

# IMA enforce: signed binary runs under IMA enforcement
sh_test(
    name = "test-ch-ima-enforce-signed",
    test = "verify_ch_ima.py",
    deps = [
        "//packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor",
        "//tests/fixtures/ima-test:ima-kernel",
        "//tests/fixtures/ima-test:ima-initramfs",
        "//tests/fixtures/ima-test:ima-disk-signed",
    ],
    env = {
        "CH_BINARY": "$(location //packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor)",
        "KERNEL": "$(location //tests/fixtures/ima-test:ima-kernel)",
        "INITRAMFS": "$(location //tests/fixtures/ima-test:ima-initramfs)",
        "DISK": "$(location //tests/fixtures/ima-test:ima-disk-signed)",
        "CMDLINE_EXTRA": "ima_appraise=enforce ima_test_mode=enforce_signed",
        "EXPECT_MARKER": "IMA-RESULT:PASS",
        "EXPECT_TEST_OUTPUT": "IMA-FILE-CONTENT",
    },
    run_test_separately = True,
    labels = ["vm", "slow", "integration"],
)

# ── ISO boot ─────────────────────────────────────────────────────

runtime_env(
    name = "qemu-env",
    package = "//packages/linux/emulation/hypervisors/qemu:qemu",
)

sh_test(
    name = "test-iso-boot",
    test = "verify_iso_boot.py",
    deps = [
        "//packages/linux/system:buckos-minimal-iso",
        "//packages/linux/emulation/hypervisors/qemu:qemu",
        ":qemu-env",
    ],
    env = {
        "ISO": "$(location //packages/linux/system:buckos-minimal-iso)",
        "QEMU_DIR": "$(location //packages/linux/emulation/hypervisors/qemu:qemu)",
        "RUN_ENV": "$(location :qemu-env)",
    },
    run_test_separately = True,
    labels = ["vm", "slow", "integration"],
)

# ── Seed isolation ────────────────────────────────────────────────
# Verifies the seed archive has no build-path leaks in RPATH/RUNPATH,
# no cross-contamination between host-tools and sysroot, valid metadata.
# Requires full bootstrap so tagged slow.

sh_test(
    name = "test-seed-isolation",
    test = "verify_seed_isolation.py",
    deps = ["//tc/bootstrap:seed-export"],
    env = {
        "SEED_ARCHIVE": "$(location //tc/bootstrap:seed-export)",
    },
    run_test_separately = True,
    labels = ["slow"],
)

# IMA enforce: unsigned binary rejected
sh_test(
    name = "test-ch-ima-enforce-unsigned",
    test = "verify_ch_ima.py",
    deps = [
        "//packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor",
        "//tests/fixtures/ima-test:ima-kernel",
        "//tests/fixtures/ima-test:ima-initramfs",
        "//tests/fixtures/ima-test:ima-disk-unsigned",
    ],
    env = {
        "CH_BINARY": "$(location //packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor)",
        "KERNEL": "$(location //tests/fixtures/ima-test:ima-kernel)",
        "INITRAMFS": "$(location //tests/fixtures/ima-test:ima-initramfs)",
        "DISK": "$(location //tests/fixtures/ima-test:ima-disk-unsigned)",
        "CMDLINE_EXTRA": "ima_appraise=enforce ima_test_mode=enforce_unsigned",
        "EXPECT_MARKER": "IMA-RESULT:PASS",
        "EXPECT_NO_TEST_OUTPUT": "IMA-TEST-PASS",
    },
    run_test_separately = True,
    labels = ["vm", "slow", "integration"],
)

# ── Cloud Hypervisor: IMA FILE_CHECK enforcement ────────────────────

# CH FILE_CHECK: signed binary + signed data file — both pass
sh_test(
    name = "test-ch-ima-file-signed",
    test = "verify_ch_ima.py",
    deps = [
        "//packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor",
        "//tests/fixtures/ima-test:ima-kernel",
        "//tests/fixtures/ima-test:ima-initramfs",
        "//tests/fixtures/ima-test:ima-disk-signed",
    ],
    env = {
        "CH_BINARY": "$(location //packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor)",
        "KERNEL": "$(location //tests/fixtures/ima-test:ima-kernel)",
        "INITRAMFS": "$(location //tests/fixtures/ima-test:ima-initramfs)",
        "DISK": "$(location //tests/fixtures/ima-test:ima-disk-signed)",
        "CMDLINE_EXTRA": "ima_appraise=enforce ima_test_mode=file_signed",
        "EXPECT_MARKER": "IMA-RESULT:PASS",
        "EXPECT_TEST_OUTPUT": "IMA-FILE-CONTENT",
    },
    run_test_separately = True,
    labels = ["vm", "slow", "integration"],
)

# CH FILE_CHECK: signed binary + unsigned data file — file read denied
sh_test(
    name = "test-ch-ima-file-unsigned",
    test = "verify_ch_ima.py",
    deps = [
        "//packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor",
        "//tests/fixtures/ima-test:ima-kernel",
        "//tests/fixtures/ima-test:ima-initramfs",
        "//tests/fixtures/ima-test:ima-disk-file-unsigned",
    ],
    env = {
        "CH_BINARY": "$(location //packages/linux/emulation/utilities/cloud-hypervisor:cloud-hypervisor)",
        "KERNEL": "$(location //tests/fixtures/ima-test:ima-kernel)",
        "INITRAMFS": "$(location //tests/fixtures/ima-test:ima-initramfs)",
        "DISK": "$(location //tests/fixtures/ima-test:ima-disk-file-unsigned)",
        "CMDLINE_EXTRA": "ima_appraise=enforce ima_test_mode=file_unsigned",
        "EXPECT_MARKER": "IMA-RESULT:PASS",
        "EXPECT_TEST_OUTPUT": "IMA-FILE-DENIED",
        "EXPECT_NO_TEST_OUTPUT": "IMA-FILE-CONTENT",
    },
    run_test_separately = True,
    labels = ["vm", "slow", "integration"],
)

