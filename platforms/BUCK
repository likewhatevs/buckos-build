# Target platform detection
platform(
    name = "detect",
    constraint_values = [],
)

# x86_64 Linux target
platform(
    name = "linux-x86_64",
    constraint_values = [
        "prelude//cpu/constraints:x86_64",
        "prelude//os/constraints:linux",
    ],
)

# aarch64 (ARM64) Linux target
platform(
    name = "linux-aarch64",
    constraint_values = [
        "prelude//cpu/constraints:arm64",
        "prelude//os/constraints:linux",
    ],
)

# Architecture detection config settings for select()
config_setting(
    name = "is_aarch64",
    constraint_values = ["prelude//cpu/constraints:arm64"],
    visibility = ["PUBLIC"],
)

config_setting(
    name = "is_x86_64",
    constraint_values = ["prelude//cpu/constraints:x86_64"],
    visibility = ["PUBLIC"],
)

# Configuration for building packages
constraint_setting(
    name = "build_type",
)

constraint_value(
    name = "release",
    constraint_setting = ":build_type",
)

constraint_value(
    name = "debug",
    constraint_setting = ":build_type",
)

# Platform targeting constraint setting
# Used to tag packages by their supported platforms
constraint_setting(
    name = "target_platform",
    visibility = ["PUBLIC"],
)

# Platform constraint values
constraint_value(
    name = "linux",
    constraint_setting = ":target_platform",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "bsd",
    constraint_setting = ":target_platform",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "macos",
    constraint_setting = ":target_platform",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "windows",
    constraint_setting = ":target_platform",
    visibility = ["PUBLIC"],
)

# Distribution compatibility constraint setting
# Used to tag packages by their distribution compatibility
constraint_setting(
    name = "distro_compat",
    visibility = ["PUBLIC"],
)

# Distribution compatibility values
constraint_value(
    name = "buckos-native",
    constraint_setting = ":distro_compat",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "fedora",
    constraint_setting = ":distro_compat",
    visibility = ["PUBLIC"],
)

# Toolchain mode constraint setting
# Controls whether to use bootstrap toolchain or host system toolchain
constraint_setting(
    name = "toolchain_mode",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "bootstrap-toolchain",
    constraint_setting = ":toolchain_mode",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "host-toolchain",
    constraint_setting = ":toolchain_mode",
    visibility = ["PUBLIC"],
)

# Config settings for select() in build rules
# These match on platform constraints (for --target-platforms flag)
config_setting(
    name = "use_bootstrap_toolchain",
    constraint_values = [":bootstrap-toolchain"],
    visibility = ["PUBLIC"],
)

config_setting(
    name = "use_host_toolchain_platform",
    constraint_values = [":host-toolchain"],
    visibility = ["PUBLIC"],
)

# This matches on config value (for --config buckos.use_host_toolchain=true flag)
config_setting(
    name = "use_host_toolchain",
    values = {
        "buckos.use_host_toolchain": "true",
    },
    visibility = ["PUBLIC"],
)

# Multi-platform target platforms
platform(
    name = "linux-target",
    constraint_values = [
        ":linux",
        ":bootstrap-toolchain",  # Default to bootstrap toolchain for reproducibility
        "prelude//cpu/constraints:x86_64",  # Default to x86_64
    ],
    visibility = ["PUBLIC"],
)

# Linux target with host toolchain (for development)
platform(
    name = "linux-target-host",
    constraint_values = [
        ":linux",
        ":host-toolchain",
        "prelude//cpu/constraints:x86_64",  # Default to x86_64
    ],
    visibility = ["PUBLIC"],
)

# aarch64 Linux target with bootstrap toolchain
platform(
    name = "linux-aarch64-target",
    constraint_values = [
        ":linux",
        ":bootstrap-toolchain",
        "prelude//cpu/constraints:arm64",
    ],
    visibility = ["PUBLIC"],
)

# aarch64 Linux target with host toolchain (for cross-compilation development)
platform(
    name = "linux-aarch64-target-host",
    constraint_values = [
        ":linux",
        ":host-toolchain",
        "prelude//cpu/constraints:arm64",
    ],
    visibility = ["PUBLIC"],
)

platform(
    name = "bsd-target",
    constraint_values = [
        ":bsd",
    ],
    visibility = ["PUBLIC"],
)

platform(
    name = "macos-target",
    constraint_values = [
        ":macos",
    ],
    visibility = ["PUBLIC"],
)

platform(
    name = "windows-target",
    constraint_values = [
        ":windows",
    ],
    visibility = ["PUBLIC"],
)
